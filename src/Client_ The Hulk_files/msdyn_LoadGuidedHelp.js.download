// JavaScript source code
var ConfigWarningString1033 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1025 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1026 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1027 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1028 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1029 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1030 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1031 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1032 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1035 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1036 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1037 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1038 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1040 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1041 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1042 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1043 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1044 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1045 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1046 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1048 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1049 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1050 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1051 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1053 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1054 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1055 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1057 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1058 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1060 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1061 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1062 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1063 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1066 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1069 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1081 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1086 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1087 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString1110 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString2052 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString2070 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString2074 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString3076 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString3082 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";
var ConfigWarningString3098 = "We cannot open the Content Library because your CRM organization is not configured to use Learning Path.";

var marsV1Link = "https://go.microsoft.com/fwlink/?LinkID=746342";
var marsV2Link = "https://go.microsoft.com/fwlink/?linkid=784821";

function LoadedGuidedHelp() {
	var isUCI = !!document.getElementById("ClientApiFrame_MARS");
	if (isUCI){
		loadMars(marsV2Link);
	}
	else{
		LoadedGuidedHelpWeb();		
	}
}

function getWhitelistedPageTokens() {
    return ["dashboardId", "pagetype", "id", "etn", "pid", "dashboardid", "viewid"];
}

function LoadedGuidedHelpWeb() {
	var isMarsEnabledForUser = window['Xrm'].Internal.isGuidedHelpEnabledForUser();
    var isMarsEnabledForOrg = window['Xrm'].Internal.isFeatureEnabled("FCB.GuidedHelp");
    var isCustomizableHelp = window.CUSTOMIZED_HELP_ENABLED;

    //If sitemap clicked from tablet/phone browser
    var windowObj = window.parent;
    if (localStorage.getItem("launchMARSDesigner") == "true") {
        if (Xrm.Page.context.client.getClient() == Xrm.ClientName.web && Xrm.Page.context.client.getFormFactor() != Xrm.FormFactor.desktop) {
            var alertString = new windowObj['Xrm'].AlertDialogStrings();
            alertString.text = window["ConfigWarningString" + windowObj['Xrm'].Page.context.getUserLcid()];
            windowObj['Xrm'].Dialog.openAlertDialog(alertString, null, null);
            localStorage.removeItem("launchMARSDesigner");
        }
    }

    //If phone, do not load Learning Path.
    if (Xrm.Page.context.client.getClient() == Xrm.ClientName.web && Xrm.Page.context.client.getFormFactor() != Xrm.FormFactor.desktop && Xrm.Page.context.client.getFormFactor() != Xrm.FormFactor.tablet) {
        return;
    }

    //If Mars FCB is enabled and custom help is not used
    if (isMarsEnabledForOrg && isMarsEnabledForUser && !isCustomizableHelp) {
		document.addEventListener('DOMContentLoaded', function() {
			$(document).on('helpIconLoaded', function (e, eventInfo) {
				try {
					var windowObj = window.parent;
					//If sitemap clicked from tablet/phone browser
					if (localStorage.getItem("launchMARSDesigner") == "true") {
						if (Xrm.Page.context.client.getClient() == Xrm.ClientName.web && Xrm.Page.context.client.getFormFactor() != Xrm.FormFactor.desktop) {
							var alertString = new windowObj['Xrm'].AlertDialogStrings();
							alertString.text = window["ConfigWarningString" + windowObj['Xrm'].Page.context.getUserLcid()];
							windowObj['Xrm'].Dialog.openAlertDialog(alertString, null, null);
							localStorage.removeItem("launchMARSDesigner");
						}
					}
					if (window["_MicrosoftMars"] && window["_MicrosoftMars"]["Client"] && window["_MicrosoftMars"]["Client"]["Utility"]) {
						window.marsLoader = new _MicrosoftMars.Client.Loader.MarsLoader(window["_MicrosoftMars"]["Client"] && window["_MicrosoftMars"]["Client"]["Designer"] && window["_MicrosoftMars"]["Client"]["Designer"]["App"] && window["_MicrosoftMars"]["Client"]["Designer"]["App"]["isDesignerLaunched"]);
					}
					else {
						console.log("Error in loading MARS : Client Utility not found");
					}
				} catch (err) {
					console.log("Error in initializing MARS");
				}
			});
		});
        if (Xrm.Page.context.isCrmOnline() && Xrm.Internal.isFeatureEnabled("FCB.MarsLegacyClientEnabled")) {
            //MARS v1
            loadMars(marsV1Link);
			loadMars(window["Xrm"]["Page"]["context"]["getClientUrl"]("") + "/WebResources/" + "msdyn_MarsCustomScripts.js");
        }
        else {
            //MARS v2
            loadMars(marsV2Link);
        }
    }
}

/** Load script function with callback to handle synchronicity
	* @param src - script file path.
	* @param scripts - script tag.
	*/
function loadMars(src) {
    var that = this;

    if (!document.getElementById(src)) {
        var script = document.createElement('script');
        script.onerror = function () {
            // handling error when loading script
            console.log('Error in loading script');
        };

        script.onload = function () {
            console.log(src + ' loaded ');
        };

        script.src = src;
        script.id = src;
        document.getElementsByTagName('head')[0].appendChild(script);
    }
    else {
        console.log(src + ' already loaded ');
    }
}

LoadedGuidedHelp();
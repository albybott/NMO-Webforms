<!DOCTYPE html>
<!-- saved from url=(0072)https://tehi.crm6.dynamics.com/form/ClientApiWrapper.aspx?ver=1888157098 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script language="javascript" src="./MicrosoftAjax.js.download"></script>
<script language="javascript" src="./es6-shim.js.download"></script>
<script language="javascript">
Xrm = parent.Xrm;
var Mscrm = {};
Mscrm.CrmUri = parent.Mscrm.CrmUri;
Mscrm.GlobalImported = {};
Mscrm.GlobalImported.CrmUri = Mscrm.CrmUri;
Mscrm.InternalUtilities = parent.Mscrm.InternalUtilities;
Mscrm.CommandBarActions = parent.Mscrm.CommandBarActions;
Mscrm.GridCommandActions = parent.Mscrm.GridCommandActions;
Mscrm.EntitlementCommandBarAction = parent.Mscrm.EntitlementCommandBarAction;
Mscrm.EntityPageHandlerFactory = parent.Mscrm.EntityPageHandlerFactory;
Mscrm.FeatureNames = parent.Mscrm.FeatureNames;
Mscrm.ListCommands = parent.Mscrm.ListCommands;
Mscrm.OpportunityQOIControl = parent.Mscrm.OpportunityQOIControl;
Mscrm.QOIDetail = parent.Mscrm.QOIDetail;
Mscrm.BusinessRules = parent.Mscrm.BusinessRules;
Mscrm.SdkSerializationHelper = parent.Mscrm.SdkSerializationHelper;
var Microsoft = {};
Microsoft.Crm = {};
Microsoft.Crm.Client = {};
Microsoft.Crm.Client.Core = {};
Microsoft.Crm.Client.Core.Storage = parent.Microsoft.Crm.Client.Core.Storage;
Microsoft.Crm.Client.Core.Framework = parent.Microsoft.Crm.Client.Core.Framework;
CrmEncodeDecode = parent.CrmEncodeDecode;
XUI = parent.XUI;

jQueryApi = parent.jQueryApi;

IsNull = parent.IsNull;
IsArray = parent.IsArray;
IsInstanceOfTypeAcrossFrames = parent.IsInstanceOfTypeAcrossFrames;
IsNullOrEmptyString = parent.IsNullOrEmptyString;
GetClass = parent.GetClass;
IsOfClass = parent.IsOfClass;

var currentHandlerIndex = 0;
var handlerQueue = [];
var pendingScriptLoadCounts = 0;
var loadedScripts = {};
var currentTopHandler = null;

window.onerror = parent.onerror;
window.isRichClient = parent.isRichClient;
window.getOutlookHostedWindow = parent.getOutlookHostedWindow;
window.isOutlookHostedWindow = parent.isOutlookHostedWindow;

window.alert = function (message) {
Xrm.Utility.alertDialog(message);
};

function ExecuteHandler(parameters)
{
var method = parameters[0];
var functionParameters = parameters[1];
var executionContext = parameters[2];
var executeIfAvailableOnly = parameters[3]
var handlerInfo = {
method: method,
parameters: functionParameters,
executionContext: executionContext,
executeIfAvailableOnly: executeIfAvailableOnly
}



if (currentTopHandler)
{
handlerQueue.splice(currentHandlerIndex, 0, handlerInfo);
}
else
{
handlerQueue[handlerQueue.length] = handlerInfo;
}

RunHandlers();
}

function CreateTurboFormPreOnLoadPerfMarker() {
parent.Mscrm.Performance.PerformanceMarkerManager.get_instance().addMarker('TurboFormPreOnloadTimestamp', 1);
parent.window['TurboFormPreOnloadTimestamp'] = (new Date()).getTime();
}

function HasPageLoaded() {

if (window.parent.location.pathname.indexOf("DialogPage.aspx") > -1) {
return true;
}
return window.parent.Mscrm.TurboForm.Control.PageBootstrapper.hasPageLoaded;
}

function RunHandlers()
{

if (!HasPageLoaded())
{
window.setTimeout(Function.createDelegate(this, function () { RunHandlers(); }), 15);
return;
}

if (pendingScriptLoadCounts == 0)
{
while (currentHandlerIndex < (handlerQueue != undefined ? handlerQueue.length : 0))
{
var handlerInfo = handlerQueue[currentHandlerIndex];
currentHandlerIndex++;

if (!currentTopHandler)
{
currentTopHandler = handlerInfo;
}

RunHandlerInternal(handlerInfo.method, handlerInfo.parameters, handlerInfo.executionContext, handlerInfo.executeIfAvailableOnly);


if (currentTopHandler == handlerInfo)
{
currentTopHandler = null;
}
}
}
}

function RunHandlerInternal(method, parameters, executionContext, executeIfAvailableOnly)
{
var perfMetric = Xrm.Internal.startMetricsStopwatch("Run form Onload method: " + method);
perfMetric.start();

try
{
if (executionContext != null)
{
if (parameters != null && parameters != "")
{
parameters = "executionContext, " + parameters;
}
else
{
parameters = "executionContext";
}
}

var isFunctionAvailable = false;
if (executeIfAvailableOnly == true)
{
if (method.indexOf(".") < 0)
{
isFunctionAvailable = method in window;
}
}

if (isFunctionAvailable || !executeIfAvailableOnly)
{
SaveHandlerCorrelationToken(method);
eval(method + "(" + parameters + ");");
ClearHandlerCorrelationToken(method);
}
}
catch (e)
{
window.parent.Mscrm.TurboForm.Control.CustomScriptsManager.handleCustomScriptException(e);
}

perfMetric.stop();
};

function ClearHandlerCorrelationToken(methodName)
{
try
{
var reportedHandlers = window.top.HandlerListToReport;
if (reportedHandlers != null && reportedHandlers.length > 0)
{
var reportedHandler = reportedHandlers.find(function (handler) { return handler.HandlerName === methodName });
if (reportedHandler)
{
window.parent.Mscrm.InternalUtilities.ClientApiUtility.clearCurrentCorrelationToken('CurrentHandlerId');
}
}
}
catch (e)
{
window.parent.Mscrm.Utilities.reportScriptErrorInTelemetryCode("ClearHandlerCorrelationToken", e);
}
}

function SaveHandlerCorrelationToken(methodName)
{
try
{
var reportedHandlers = window.top.HandlerListToReport;
if (reportedHandlers != null && reportedHandlers.length > 0)
{
var reportedHandler = reportedHandlers.find(function(handler) { return handler.HandlerName === methodName});
if(reportedHandler)
{
window.parent.Mscrm.InternalUtilities.ClientApiUtility.saveCurrentHandlerCorrelationId(reportedHandler.HandlerUniqueId);
}
}
}
catch (e)
{
window.parent.Mscrm.Utilities.reportScriptErrorInTelemetryCode("SaveHandlerCorrelationToken", e);
}
}

function AppendScriptTag(parameters)
{
var url = parameters[0];
var async = parameters[1];
if (loadedScripts[url] == null)
{
var perfMetric = Xrm.Internal.startMetricsStopwatch("Append Script: " + url);
if (!async)
{
perfMetric.start();
}

loadedScripts[url] = false;

var container = document.getElementsByTagName('head')[0];
var scriptTag = document.createElement('script');
container.appendChild(scriptTag);

scriptTag.type = "text/javascript";

pendingScriptLoadCounts++;

if (async)
{
scriptTag.onerror = scriptTag.onreadystatechange = scriptTag.onload = function ()
{
if (!loadedScripts[url] && (!scriptTag.readyState || scriptTag.readyState === "loaded" || scriptTag.readyState === "complete"))
{
scriptTag.onerror = scriptTag.onreadystatechange = scriptTag.onload = null;
loadedScripts[url] = true;
window.setTimeout(function()
{
OnScriptTagLoaded(url);
}, 0);
}
}

scriptTag.src = url;
}
else
{
var request = new XMLHttpRequest();
request.open("GET", url, async);
request.onreadystatechange = function()
{
if (!loadedScripts[url] && request.readyState == 4)
{
request.onreadystatechange = null;
scriptTag.text = request.responseText;
loadedScripts[url] = true;
OnScriptTagLoaded(url);
perfMetric.stop();
}
};

request.send();
}
}
}

function OnScriptTagLoaded(url)
{
pendingScriptLoadCounts--;
RunHandlers();
}

function SendMessageToPageManager(message)
{
try
{
window.parent.Mscrm.TurboForm.Control.CustomScriptsManager.processMessage(message);
}
catch(e)
{
parent.Mscrm.CrmDebug.fail("Exception encountered processing message: " + message);
parent.catchError(e.message, parent.window.location.href, 0, true);
}
}

function FireDataLoad()
{

window.parent.Mscrm.TurboForm.Control.PageManager.get_instance().get_primaryForm().getPageData().invokeDataOnLoadHandlers(1);
Mscrm.CommandBarActions.mapAttributesToRegardingForm();
}
</script>
<script type="text/javascript" src="./Contact_main_system_library.js.download"></script><script type="text/javascript" src="./clientutility.js.download"></script><script type="text/javascript" src="./resourcestringprovider.js.download"></script><script type="text/javascript" src="./msdyn_talkingpointsloader.js.download"></script><script type="text/javascript" src="./nmo.global.js.download"></script><script type="text/javascript" src="./formscript.js.aspx"></script><script type="text/javascript">function _retrieveActivityDetails(){return Promise.all([Common.Utils.getExternalContextProperty(Constants.PropertyIds.MailboxItem),Common.Utils.getExternalContextProperty(Constants.PropertyIds.TrackStatus)]).then(function(e){var t=e[0],n=e[1],r=Utility.TrimGuid(n&&n.crmId),o=n&&n.crmObjectTypeCode,a=o&&Xrm.Internal.getEntityName(o)||Constants.MailboxItemTypeToCrmTypeMap[t.ItemType];return[r,a]})}function AlertNotImplemented(){alert("Not Implemented!")}function MailContextProperty(e){return HasMailContextProperty(e)?(getPropertyPromiseCache[e]||(getPropertyPromiseCache[e]=Common.Utils.getExternalContextProperty(e).then(function(t){return getPropertyPromiseCache[e]=null,t},function(t){return getPropertyPromiseCache[e]=null,!1})),getPropertyPromiseCache[e]):Promise.resolve(!1)}function HasMailContextProperty(e){var t=Xrm&&Xrm.ExternalContext?Xrm.ExternalContext.getAvailableExternalContexts():null;return t&&t.get(Constants.contextId)&&t.get(Constants.contextId).properties&&t.get(Constants.contextId).properties.get(e)}function HasMailContextAction(e){var t=Xrm&&Xrm.ExternalContext?Xrm.ExternalContext.getAvailableExternalContexts():null;return t&&t.get(Constants.contextId)&&t.get(Constants.contextId).actions&&t.get(Constants.contextId).actions.get(e)}function IsSetRegardingRecord(e){return e?MailContextProperty(Constants.PropertyIds.TrackStatus).then(function(t){var n=e.toLowerCase().replace(/[{}]/g,""),r=t&&t.crmRegardingObjectId&&t.crmRegardingObjectId.toLowerCase().replace(/[{}]/g,"");return!(!r||n!==r||t.crmTrackingState!==Models.TrackingState.IsLinked&&t.crmTrackingState!==Models.TrackingState.WillBeLinked&&t.crmTrackingState!==Models.TrackingState.LinkFailed)}):Promise.resolve(!1)}function IsSetRegardingSelectedRecord(e){return e&&1===e.length&&e[0]&&e[0].Id?IsSetRegardingRecord(e[0].Id.toString()):Promise.resolve(!1)}function IsRecordSaved(){return Xrm&&Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&!!Xrm.Page.data.entity.getId()}function IsSetRegardingCurrentRecord(){return Xrm&&Xrm.Page&&Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getId()?IsSetRegardingRecord(Xrm.Page.data.entity.getId()):Promise.resolve(!1)}function IsSpecifiedControl(e,t){var n=t.split(";");return e&&-1!==n.indexOf(e.CustomControlType)}function IsTracked(){return MailContextProperty(Constants.PropertyIds.TrackStatus).then(function(e){return e&&e.crmTrackingState===Models.TrackingState.IsLinked})}function IsTrackedOrPending(){return MailContextProperty(Constants.PropertyIds.TrackStatus).then(function(e){return e&&(e.crmTrackingState===Models.TrackingState.IsLinked||e.crmTrackingState===Models.TrackingState.WillBeLinked)})}function IsNotTrackedOrPending(){return MailContextProperty(Constants.PropertyIds.TrackStatus).then(function(e){return e&&(e.crmTrackingState===Models.TrackingState.NotLinked||e.crmTrackingState===Models.TrackingState.WillBeUnlinked||e.crmTrackingState===Models.TrackingState.WillBeUnlinkedAndDeleted)})}function IsTrackAllowed(){return MailContextProperty(Constants.PropertyIds.TrackAllowedStatus).then(function(e){return e===Enums.TrackAllowedStatus.Allowed})}function HasMailContext(){var e=Xrm&&Xrm.ExternalContext?Xrm.ExternalContext.getAvailableExternalContexts():null;return e&&e.get(Constants.contextId)}function HasEntityReadPrivilege(e){return Xrm?Common.Utils.hasEntityPrivilege(e,2):void Promise.resolve(!1)}function IsMailboxItemTypeOf(e){return MailContextProperty(Constants.PropertyIds.ItemType).then(function(t){return t===e})}function IsEmail(){return this.IsMailboxItemTypeOf(Constants.MailboxItemTypes.Message)}function IsAppointment(){return this.IsMailboxItemTypeOf(Constants.MailboxItemTypes.Appointment)}function IsMobile(){return Common.UserAgent.getInstance().getIsAndroid()||Common.UserAgent.getInstance().getIsWindowsPhone()||Common.UserAgent.getInstance().getIsIPhone()||Common.UserAgent.getInstance().getIsIPad()||Common.UserAgent.getInstance().getIsIPod()}function IsCRMIDNotEmpty(){return MailContextProperty(Constants.PropertyIds.TrackStatus).then(function(e){return!!e.crmId})}function IsComposeItemEnabled(e,t){var n,r;try{if(n=JSON.parse(e),r=JSON.parse(t),null==n||null==n.and&&null==n.or||null==r||null==r.and&&null==r.or)return Promise.resolve(!1)}catch(o){return Promise.resolve(!1)}if(n.and)for(var a=0,i=n.and;a<i.length;a++){var s=i[a];if(!HasMailContextAction(s))return Promise.resolve(!1)}if(n.or){for(var m=!1,c=0,l=n.or;c<l.length;c++){var s=l[c];if(HasMailContextAction(s)){m=!0;break}}if(!m)return Promise.resolve(!1)}return IsEmail().then(function(e){return e===!0?MailContextProperty(Constants.PropertyIds.IsComposeMode):Promise.resolve(!1)},function(e){return Promise.resolve(!1)}).then(function(e){return e===!0?Promise.all(r.or.map(function(e){return Common.Utils.hasEntityPrivilege(e,2)})):Promise.all([Promise.resolve(!1)])},function(e){return Promise.all([Promise.resolve(!1)])}).then(function(e){return Promise.resolve(e.indexOf(!0)>-1)},function(e){return Promise.resolve(!1)})}function IsFollowed(){return MailContextProperty(Constants.PropertyIds.TrackStatus).then(function(e){return e&&e.crmIsFollowed===Models.FollowState.IsFollowed})}var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Utility;!function(e){function t(e){return e?e.slice(0===e.indexOf("{")?1:0,e.indexOf("}")===e.length-1?e.length-1:e.length):e}function n(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return e.replace(/{(\d+)}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e})}function r(e){for(var t="",n=0;n<e.length;++n){var r=e.charCodeAt(n).toString(16);t+=2===r.length?r:"0"+r}return t.toUpperCase()}function o(e){var t={};return e?Object.getOwnPropertyNames(e).forEach(function(n){t[n]=e[n]}):t.error="undefined",t}e.TrimGuid=t,e.formatString=n,e.binToHex=r,e.errorToObject=o}(Utility||(Utility={}));var Telemetry;!function(e){function t(t,o,a,i){var s=[r(e.ParameterNames.ComponentName,t),r(e.ParameterNames.Message,a),r(e.ParameterNames.EventLevel,o)];i&&(s=s.concat(i));var m=n("uci_trace",s);Xrm.Reporting.reportEvent(m)}function n(e,t){return void 0===t&&(t=[]),{eventName:e,eventParameters:t}}function r(e,t){return{name:e,value:t}}function o(n,o,a){var i=[];a&&i.push(r(e.ParameterNames.Data,JSON.stringify(a))),t(n,s.Info,o,i)}function a(n,o,a,i){var m=[];if(a){var c=Utility.errorToObject(a);m.push(r(e.ParameterNames.Error,JSON.stringify(c)))}i&&m.push(r(e.ParameterNames.Data,JSON.stringify(i))),t(n,s.Warning,o,m)}function i(n,o,a,i){var m=[];if(a){var c=Utility.errorToObject(a);m.push(r(e.ParameterNames.Error,JSON.stringify(c)))}i&&m.push(r(e.ParameterNames.Data,JSON.stringify(i))),t(n,s.Error,o,m)}var s;!function(e){e[e.Log=0]="Log",e[e.Info=1]="Info",e[e.Verbose=2]="Verbose",e[e.Warning=3]="Warning",e[e.Error=4]="Error"}(s||(s={})),e.createEvent=n,e.createParameter=r,e.reportTraceInfo=o,e.reportTraceWarning=a,e.reportTraceError=i,e.ParameterNames={OperationDuration:"OperationDuration",RecipientsCount:"RecipientsCount",RestrictedRecipientsCount:"RestrictedRecipientsCount",IsTracked:"IsTracked",Message:"Message",Error:"Error",Data:"Data",EventLevel:"ApplicationEventLevel",ComponentName:"ComponentName"},e.ComponentNames={ExternalContextInvokeAction:"MailApp.ExternalContext.invokeAction",ExternalContextGetProperty:"MailApp.ExternalContext.getProperty",TrackCommand:"MailApp.Command.Track",UntrackCommand:"MailApp.Command.Untrack",AddEmailTemplateCommand:"MailApp.Command.AddEmailTemplate",AddSalesLiteratureCommand:"MailApp.Command.AddSalesLiterature",AddKnowledgeArticleCommand:"MailApp.Command.AddKnowledgeArticle",AddActivityCommand:"MailApp.Command.AddActivity",ViewActivityCommand:"MailApp.Command.ViewActivity",UnfollowCommand:"MailApp.Command.Unfollow",OpenRecordOnWeb:"MailApp.Command.OpenRecordOnWeb"}}(Telemetry||(Telemetry={}));var Commands;!function(e){!function(e){e[e.AnalyzingEmailBody=0]="AnalyzingEmailBody",e[e.RemovingFollowInfo=1]="RemovingFollowInfo",e[e.FinishingUp=2]="FinishingUp"}(e.UnfollowStep||(e.UnfollowStep={}));var t=e.UnfollowStep,n=function(){function e(e){this._statusUpdateCallback=e}return e.prototype.unfollow=function(){return this._updateStatus(t.AnalyzingEmailBody),Common.Utils.getExternalContextProperty(Constants.PropertyIds.TrackStatus).then(this._removeTrackingInfo.bind(this)).then(this._unfollow.bind(this)).then(function(){return Xrm.Reporting.reportSuccess(e.telemetryCommandName)})["catch"](function(t){return Xrm.Reporting.reportFailure(e.telemetryCommandName,t,null)})},e.prototype._removeTrackingInfo=function(e){this._updateStatus(t.RemovingFollowInfo);var n={args:{crmId:e.crmId}};return Common.Utils.invokeExternalContextAction(Constants.ActionIds.RemoveTrackingInfo,n)},e.prototype._unfollow=function(){return this._updateStatus(t.FinishingUp),Common.Utils.invokeExternalContextAction(Constants.ActionIds.Unfollow).then(function(){return Common.Utils.performPageRefresh()})},e.prototype._updateStatus=function(e){this._statusUpdateCallback&&this._statusUpdateCallback(e)},e.telemetryCommandName="MailApp.Command.Unfollow",e}();e.UnfollowCommand=n}(Commands||(Commands={}));var Constants;!function(e){e.contextId="MAIL_CONTEXT",e.PropertyIds={Subject:"SUBJECT",PlainBody:"PLAIN_BODY",HtmlBody:"HTML_BODY",ReceivedOn:"RECEIVED_ON",TrackStatus:"TRACK_STATUS",TrackAllowedStatus:"TRACK_ALLOWED_STATUS",MailboxItem:"MAILBOX_ITEM",ItemType:"ITEM_TYPE",AttachmentIds:"ATTACHMENT_IDS",EwsUrl:"EWS_URL",EwsToken:"EWS_TOKEN",IsComposeMode:"IS_COMPOSE_MODE",MessageRecipients:"MESSAGE_RECIPIENTS",MeetingAttendees:"MEETING_ATTENDEES",IsDesktopOutlook:"IS_DESKTOP_OUTLOOK",IsSent:"IS_SENT",IsDelegatedMailbox:"IS_DELEGATED_MAILBOX",ResolvedRecipients:"RESOLVED_RECIPIENTS",SelectedRecipient:"SELECTED_RECIPIENT",IsOrganizerResolvedAsUser:"IS_ORGANIZER_RESOLVED_AS_USER",MailboxItemFromServer:"MAILBOX_ITEM_FROM_SERVER"},e.ActionIds={Track:"TRACK",Untrack:"UNTRACK",Follow:"FOLLOW",Unfollow:"UNFOLLOW",InsertBody:"INSERT_BODY",AddAttachments:"ADD_ATTACHMENTS",SetSubject:"SET_SUBJECT",GetEmailLinks:"GET_EMAIL_LINKS",SetTrackingInfo:"SET_TRACKING_INFO",RemoveTrackingInfo:"REMOVE_TRACKING_INFO",ResolveRecipientFromScratch:"RESOLVE_RECIPIENT_FROM_SCRATCH",SetSelectedRecipient:"SET_SELECTED_RECIPIENT",RetryTrack:"RETRY_TRACK"},e.DialogNames={Follow:"new_FollowEmail",Unfollow:"new_UnfollowEmail",EmailTemplate:"InsertEmailTemplate_MultiPage_MDD",SalesLiterature:"MailAppSalesLiterature",KnowledgeArticle:"MailAppKnowledgeArticle",AppointmentConflict:"MailAppAppointmentConflict"},e.MailboxItemTypes={Message:"message",Appointment:"appointment"},e.CalendarItemTypes={Single:"Single",Occurence:"Occurence",Exception:"Exception",RecurringMaster:"RecurringMaster"},e.CrmTypeNames={User:"systemuser",Contact:"contact",Lead:"lead",Email:"email",Appointment:"appointment",RecurringAppointmentMaster:"recurringappointmentmaster",ExchangeSyncIdMapping:"exchangesyncidmapping"},e.PropertyNames={Email:"emailaddress",StatusCode:"statecode",IsDisabled:"isdisabled",OwnerId:"ownerid",FollowEmail:"followemail",RecipientRole:"role"},e.CrmTypeCodes={User:8,Contact:2,Lead:4,Appointment:4201,RecurringAppointmentMaster:4251},e.MailboxItemTypeToCrmTypeMap=(t={},t[e.MailboxItemTypes.Message]=e.CrmTypeNames.Email,t[e.MailboxItemTypes.Appointment]=e.CrmTypeNames.Appointment,t),e.FeatureNames={SSSReliablePromote:"SSSReliablePromote",MailAppAttachmentsReliablePromote:"MailAppAttachmentsReliablePromote",MailAppAppointmentsReliablePromote:"MailAppAppointmentsReliablePromote"},e.GlobalCommandManagerId="crm_header_global";var t}(Constants||(Constants={}));var Resources;!function(e){var t=function(){function e(){}return e.getString=function(e){try{return Xrm.Utility.getResourceString(this._webResourceName,e)}catch(t){return e}},e._webResourceName="new_MailAppLocalization",e}();e.ResourceManager=t}(Resources||(Resources={}));var Models;!function(e){!function(e){e[e.IsNotFollowed=0]="IsNotFollowed",e[e.IsFollowed=1]="IsFollowed"}(e.FollowState||(e.FollowState={}));e.FollowState}(Models||(Models={}));var Commands;!function(e){var t={text:"EMAIL_ACTIVITY_DELETION",confirmButtonLabel:"YES",cancelButtonLabel:"NO"},n={text:"APPOINTMENT_ACTIVITY_DELETION",confirmButtonLabel:"DELETE",cancelButtonLabel:"UNTRACK"},r={text:"FUTURE_APPPOINTMENT_DELETION",confirmButtonLabel:"DELETE",cancelButtonLabel:"UNTRACK"},o={text:"UNTRACK_FOLLOWED",confirmButtonLabel:"YES",cancelButtonLabel:"NO"},a={email:"UNTRACK_EMAIL_FAILURE",appointment:"UNTRACK_APPOINTMENT_FAILURE",ews:"EWS_FAILURE"},i=function(){function i(){}return i.prototype.untrack=function(){var e=this;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Start item untracking"),this._untrack()["catch"](function(t){return e._untrackFailed(t)})},i.prototype._untrack=function(){var e=this;return this._getUntrackParameters().then(function(){if(e._item.ItemType===Constants.MailboxItemTypes.Message)return e._untrackMessage();if(e._item.ItemType===Constants.MailboxItemTypes.Appointment)return e._untrackAppointment();throw new Error("Unexpected item type was received from the externalContext")})},i.prototype._getUntrackParameters=function(){var e=this;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Getting untracking parameters from shim"),Promise.all([Common.Utils.getExternalContextProperty(Constants.PropertyIds.MailboxItem),Common.Utils.getExternalContextProperty(Constants.PropertyIds.TrackStatus),Common.Utils.getExternalContextProperty(Constants.PropertyIds.IsComposeMode)]).then(function(t){e._item=t[0],e._trackStatus=t[1],e._isComposeMode=t[2],Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Received parameters: Item "+e._item.ItemType+" in "+(e._isComposeMode?"compose":"read")+" mode")})},i.prototype._untrackAppointment=function(){if(Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Start untracking appointment item"),this._isComposeMode&&!this._trackStatus.crmId)return this._untrackUnsyncedItem();var e=this._item;if(e.CalendarItemType===Constants.CalendarItemTypes.Single||e.CalendarItemType===Constants.CalendarItemTypes.Exception)return!e.ScheduleEnd||new Date(e.ScheduleEnd).getTime()<(new Date).getTime()?this._untrackWithoutDeletion():this._showDeleteAndUntrack(n);if(e.CalendarItemType===Constants.CalendarItemTypes.RecurringMaster)return this._isFutureRecurrence()?this._showDeleteAndUntrack(r):this._untrackWithoutDeletion();throw new Error("Can't untrack appointment with type occurrence.")},i.prototype._untrackMessage=function(){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Start untracking email item"),this._isComposeMode?this._trackStatus.crmIsFollowed===Models.FollowState.IsFollowed?this._showUnfollowAndUntrack():this._untrackUnsyncedItem():this._showDeleteAndUntrack(t)},i.prototype._showDeleteAndUntrack=function(e){var t=this;return this._trackStatus.crmId?(Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Showing deletion confirmation dialog"),this._showConfirmation(e).then(function(e){return e&&void 0!==e.confirmed?e.confirmed?(Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"User confirmed activity deletion"),Common.Utils.hasEntityPrivilege(Xrm.Constants.EntityNames.ActivityPointer,4).then(function(e){return e?t._deleteAndUntrack():(Telemetry.reportTraceWarning(Telemetry.ComponentNames.UntrackCommand,'User has no privilege to delete "'+Xrm.Constants.EntityNames.ActivityPointer+'"'),Common.Notifications.showError("INSUFFICIENT_RECORD_PERMISSIONS"))})):(Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"User decided to keep activity in CRM"),t._untrackWithoutDeletion()):(Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"User closed confirmation dialog. Aborting untracking."),Promise.resolve())})):this._untrackUnsyncedItem()},i.prototype._showUnfollowAndUntrack=function(){var n=this;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Showing Unfollow confirmation dialog"),this._showConfirmation(o).then(function(r){if(r){if(r&&r.confirmed)return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"User confirmed to Unfollow"),(new e.UnfollowCommand).unfollow().then(function(){return Common.Utils.getExternalContextProperty(Constants.PropertyIds.IsSent).then(function(e){return e?n._showDeleteAndUntrack(t):n._untrackWithoutDeletion()})});Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"User didn't confirm to Unfollow. Abort untracking.")}else Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"User closed Unfollow confirmation dialog. Abort untracking.")})},i.prototype._deleteAndUntrack=function(){var e=this;return this._deleteActivity(this._trackStatus.crmId).then(function(){return e._setItemTrackingProperties(!0,!1)})["catch"](function(){return e._setItemTrackingProperties(!0)})},i.prototype._untrackUnsyncedItem=function(){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Untracking not synchronized item"),this._setItemTrackingProperties(!1,!1)},i.prototype._untrackWithoutDeletion=function(){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Untracking item without activity deletion"),this._trackStatus.crmId?this._setItemTrackingProperties(!1):this._untrackUnsyncedItem()},i.prototype._setItemTrackingProperties=function(e,t){var n=this;void 0===t&&(t=!0);var r=Models.TrackingState.NotLinked;return t&&(r=e?Models.TrackingState.WillBeUnlinkedAndDeleted:Models.TrackingState.WillBeUnlinked),Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Invoking external context UNTRACK action",{TrackingState:Models.TrackingState[r],ShouldBeProcessedBySSS:t}),Common.Utils.invokeExternalContextAction(Constants.ActionIds.Untrack,{args:{trackingState:r}}).then(function(){return n._untrackSuccess(e,t)})},i.prototype._untrackSuccess=function(e,t){Common.Utils.performPageRefresh(),t&&(e?Common.Notifications.showSuccess("PENDING_UNTRACK_AND_DELETE"):Common.Notifications.showSuccess("PENDING_UNTRACK")),e&&(this._item.ItemType===Constants.MailboxItemTypes.Message?Common.Notifications.showSuccess("EMAIL_TO_BE_DELETED"):Common.Notifications.showSuccess("APPT_TO_BE_DELETED"))},i.prototype._untrackFailed=function(e){var t=this._item?this._item.ItemType===Constants.MailboxItemTypes.Message?a.email:a.appointment:a.ews;throw Common.Utils.openErrorDialog(t,e),e},i.prototype._isFutureRecurrence=function(){if(this._item.ItemType!==Constants.MailboxItemTypes.Appointment)return!1;var e=this._item;if(e.CalendarItemType!==Constants.CalendarItemTypes.RecurringMaster)return!1;var t=e.RecurrencePatternDetails.PatternEndDate;return!t||new Date(t).getTime()>(new Date).getTime()},i.prototype._deleteActivity=function(e){Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Deleting activity from CRM");var t=Constants.CrmTypeNames.Email;if(this._item.ItemType===Constants.MailboxItemTypes.Appointment){var n=this._item;if(n.CalendarItemType===Constants.CalendarItemTypes.RecurringMaster)return this._deleteOpenInstances(e);t=Constants.CrmTypeNames.Appointment}return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Deleting activity from CRM",{EntityType:t,ActivityId:e}),Xrm.WebApi.deleteRecord(t,e).then(function(){Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Activity successfully deleted from CRM")})["catch"](function(e){throw Telemetry.reportTraceWarning(Telemetry.ComponentNames.UntrackCommand,"Failed to delete activity from CRM"),e})},i.prototype._deleteOpenInstances=function(e){Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,"Deleting appointment open instances from CRM",{ActivityId:e});var t=this._item,n=new ODataContract.Appointment;n.activityid=e;var r=new ODataContract.DeleteOpenInstances;return r.Target=n,r.StateOfPastInstances=0,r.SeriesEndDate=new Date(t.RecurrencePatternDetails.PatternStartDate),Common.Utils.WebApiRequest(r)},i.prototype._showConfirmation=function(e){return Xrm.Navigation.openConfirmDialog({text:Resources.ResourceManager.getString(e.text),confirmButtonLabel:Resources.ResourceManager.getString(e.confirmButtonLabel),cancelButtonLabel:Resources.ResourceManager.getString(e.cancelButtonLabel)})},i}();e.UntrackCommand=i}(Commands||(Commands={}));var Models;!function(e){!function(e){e[e.NotLinked=0]="NotLinked",e[e.WillBeLinked=1]="WillBeLinked",e[e.IsLinked=2]="IsLinked",e[e.WillBeUnlinked=3]="WillBeUnlinked",e[e.WillBeUnlinkedAndDeleted=4]="WillBeUnlinkedAndDeleted",e[e.LinkFailed=5]="LinkFailed",e[e.InProgress=6]="InProgress"}(e.TrackingState||(e.TrackingState={}));e.TrackingState}(Models||(Models={}));var ODataContract;!function(e){var t=function(){function e(){}return e.prototype.getMetadata=function(){var e={boundParameter:"entity",operationName:"DeliverPromoteEmail",operationType:0,parameterTypes:{entity:{typeName:"Microsoft.Dynamics.CRM.email",structuralProperty:5},MessageId:{typeName:"Edm.String",structuralProperty:1},Subject:{typeName:"Edm.String",structuralProperty:1},From:{typeName:"Edm.String",structuralProperty:1},To:{typeName:"Edm.String",structuralProperty:1},Cc:{typeName:"Edm.String",structuralProperty:1},Bcc:{typeName:"Edm.String",structuralProperty:1},ReceivedOn:{typeName:"Edm.DateTimeOffset",structuralProperty:1},SubmittedBy:{typeName:"Edm.String",structuralProperty:1},Importance:{typeName:"Edm.String",structuralProperty:1},Body:{typeName:"Edm.String",structuralProperty:1},Attachments:{typeName:"mscrm.activitymimeattachment",structuralProperty:4},ExtraProperties:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5}}};return e},e}();e.DeliverPromoteEmailRequest=t}(ODataContract||(ODataContract={}));var ODataContract;!function(e){var t=function(){function e(){}return e.prototype.getMetadata=function(){var e={boundParameter:"entity",operationName:"DeliverImmediatePromoteEmail",operationType:0,parameterTypes:{entity:{typeName:"Microsoft.Dynamics.CRM.email",structuralProperty:5},MessageId:{typeName:"Edm.String",structuralProperty:1},Subject:{typeName:"Edm.String",structuralProperty:1},From:{typeName:"Edm.String",structuralProperty:1},To:{typeName:"Edm.String",structuralProperty:1},Cc:{typeName:"Edm.String",structuralProperty:1},Bcc:{typeName:"Edm.String",structuralProperty:1},ReceivedOn:{typeName:"Edm.DateTimeOffset",structuralProperty:1},SubmittedBy:{typeName:"Edm.String",structuralProperty:1},Importance:{typeName:"Edm.String",structuralProperty:1},Body:{typeName:"Edm.String",structuralProperty:1},ExtraProperties:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},AttachmentIds:{typeName:"Edm.String",structuralProperty:4},EWSUrl:{typeName:"Edm.String",structuralProperty:1},AttachmentToken:{typeName:"Edm.String",structuralProperty:1}}};return e},e}();e.DeliverPromoteEmailWithAttachmentsRequest=t}(ODataContract||(ODataContract={}));var ODataContract;!function(e){var t=function(){function e(){}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"Book",operationType:0,parameterTypes:{Target:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},ReturnNotifications:{typeName:"Edm.Boolean",structuralProperty:1}}};return e},e}();e.BookRequest=t}(ODataContract||(ODataContract={}));var ODataContract;!function(e){!function(e){e[e.Sender=1]="Sender",e[e.To=2]="To",e[e.CC=3]="CC",e[e.BCC=4]="BCC",e[e.Required=5]="Required",e[e.Optional=6]="Optional",e[e.Organizer=7]="Organizer",e[e.Regarding=8]="Regarding",e[e.Owner=9]="Owner",e[e.Resource=10]="Resource",e[e.Customer=11]="Customer"}(e.ParticipationTypeMask||(e.ParticipationTypeMask={}));var t=(e.ParticipationTypeMask,function(){function e(){}return e}());e.Appointment=t;var n=function(){function e(){}return e}();e.ExchangeSyncIdMapping=n}(ODataContract||(ODataContract={}));var ODataContract;!function(e){var t=function(){function e(){}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"ImmediateBook",operationType:0,parameterTypes:{Target:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},AttachmentIds:{typeName:"Edm.String",structuralProperty:4},EWSUrl:{typeName:"Edm.String",structuralProperty:1},AttachmentToken:{typeName:"Edm.String",structuralProperty:1}}};return e},e}();e.BookWithAttachmentsRequest=t}(ODataContract||(ODataContract={}));var ODataContract;!function(e){var t=function(){function e(){}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"PreValidateAppointment",operationType:0,parameterTypes:{Target:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5}}};return e},e}();e.PreValidateAppointment=t}(ODataContract||(ODataContract={}));var Common;!function(e){var t=function(){function t(){}return t.isOrganizerResolvedAsUser=function(){return t.getExternalContextProperty(Constants.PropertyIds.IsOrganizerResolvedAsUser).then(function(e){if(null===e||void 0===e)throw new Error("Unable to check if organizer is resolved as CRM user. Incorrect external context response recieved.");return e})},t.resolveRecipients=function(){return t.getExternalContextProperty(Constants.PropertyIds.ResolvedRecipients).then(function(e){return e?e.recipients:[]})},t.isMac=function(){return-1!==window.navigator.appVersion.indexOf("Mac")},t.createBookRequest=function(e){var t=new ODataContract.BookRequest;return t.Target=e,t},t.createBookRequestWithAttachments=function(e,n){var r=new ODataContract.BookWithAttachmentsRequest;return r.Target=e,t._addAttachmentsToPromoteRequest(r,n)},t.createPreValidateAppointmentRequest=function(e){var t=new ODataContract.PreValidateAppointment;return t.Target=e,t},t.createAppointmentRecord=function(e,t,n,r,o,a){var i=e.RecurrencePatternDetails,s=this.getCrmType(e),m=new ODataContract.Appointment;if(m["@odata.type"]="Microsoft.Dynamics.CRM."+s,m.description=n,m.instancetypecode=0,m.isalldayevent=e.IsAllDayEvent,m.location=e.Location,m.scheduledstart=new Date(e.ScheduleStart),m.scheduledend=new Date(e.ScheduleEnd),m.subject=t,m.activitypointer_activity_parties=[],m.globalobjectid=e.GlobalObjectId,o.sender&&m.activitypointer_activity_parties.push({addressused:o.sender.emailAddress,participationtypemask:ODataContract.ParticipationTypeMask.Organizer}),o.requiredAttendees&&o.requiredAttendees.forEach(function(e){m.activitypointer_activity_parties.push({addressused:e.emailAddress,participationtypemask:ODataContract.ParticipationTypeMask.Required})}),o.optionalAttendees&&o.optionalAttendees.forEach(function(e){m.activitypointer_activity_parties.push({addressused:e.emailAddress,participationtypemask:ODataContract.ParticipationTypeMask.Optional})}),r){var c="regardingobjectid_"+r.entityType+"_"+s+"@odata.bind";m[c]="/"+a.EntitySetName+"("+Utility.TrimGuid(r.id)+")"}if(e.IsRecurring&&i)switch(m.recurrencepatterntype=i.RecurrencePatternType,m.patternendtype=i.PatternEndType,m.interval=i.Interval,m.isweekdaypattern=i.IsWeekDayPattern,m.isnthmonthly=i.IsNthMonthly,m.isnthyearly=i.IsNthYearly,m.monthofyear=i.MonthOfYear,i.PatternStartDate&&(m.patternstartdate=new Date(i.PatternStartDate)),3===i.PatternEndType?m.patternenddate=new Date(i.PatternEndDate):2===i.PatternEndType&&(m.occurrences=i.NumberOfOccurrences),i.RecurrencePatternType){case 1:m.daysofweekmask=i.DaysOfWeekMask;break;case 2:case 3:i.IsRelativeMonthlyRecurrencePattern||i.IsRelativeYearlyRecurrencePattern?(m.daysofweekmask=i.DaysOfWeekMask,m.instance=i.DayOfWeekIndex):m.dayofmonth=i.DayOfMonth}return m},t.getCrmType=function(e){return e.ItemType===Constants.MailboxItemTypes.Message?Constants.CrmTypeNames.Email:e.IsRecurring?Constants.CrmTypeNames.RecurringAppointmentMaster:Constants.CrmTypeNames.Appointment},t.createSyncIdMapping=function(e,t){Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Getting Exchange Sync Id Mapping Record");var n=new ODataContract.ExchangeSyncIdMapping;return n.exchangeentryid=t.Id,n.objectid=e,n.objecttypecode=t.IsRecurring?Constants.CrmTypeCodes.RecurringAppointmentMaster:Constants.CrmTypeCodes.Appointment,n.retries=-1,n.tocrmchangetype=0,n.fromcrmchangetype=0,n.lastsyncerrorcode=0,n.userdecision=-1,n["@odata.type"]="Microsoft.Dynamics.CRM."+Constants.CrmTypeNames.ExchangeSyncIdMapping,n},t._toEmailString=function(e){return e.reduce(function(e,t){return e+' "'+t.displayName+'" '+t.emailAddress+";"},"")},t.WebApiRequest=function(e){var t=e.getMetadata(),n="MailApp.WebApiRequest."+t.operationName;return Telemetry.reportTraceInfo(n,"Starting WebApi request"),Xrm.WebApi.online.execute(e).then(function(e){return Xrm.Reporting.reportSuccess(n),e.json()})["catch"](function(e){throw Xrm.Reporting.reportFailure(n,e),e})},t.createDeliverPromoteRequest=function(e){var n=t._addDetailsToPromoteRequest(new ODataContract.DeliverPromoteEmailRequest,e);return n.Attachments=[],n},t.createDeliverPromoteWithAttachmentsRequest=function(e,n){var r=t._addDetailsToPromoteRequest(new ODataContract.DeliverPromoteEmailWithAttachmentsRequest,e);return t._addAttachmentsToPromoteRequest(r,n)},t._addAttachmentsToPromoteRequest=function(e,t){return t&&t.attachmentIds&&t.attachmentIds.length&&(e.AttachmentIds=t.attachmentIds,e.AttachmentToken=t.ewsToken,e.EWSUrl=t.ewsUrl),e},t._addDetailsToPromoteRequest=function(e,t){if(!t)return e;if(e.entity={entityType:"email",id:null},e.Subject=t.subject,e.Body=t.body,e.Bcc=this._toEmailString(t.recipients.bcc||[]),e.Cc=this._toEmailString(t.recipients.cc||[]),e.To=this._toEmailString(t.recipients.to||[]),e.From=this._toEmailString([t.recipients.sender]),e.MessageId=t.message.InternetMessageId,e.ReceivedOn=new Date(t.receivedOn),e.SubmittedBy="",e.Importance="",e.ExtraProperties={"@odata.type":"Microsoft.Dynamics.CRM."+Constants.CrmTypeNames.Email,directioncode:t.isSent?"true":"false"},t.message.ConversationIndex&&(e.ExtraProperties.conversationindex=Utility.binToHex(atob(t.message.ConversationIndex))),t.regardingObject){var n="regardingobjectid_"+t.regardingObject.entityType+"_"+Constants.CrmTypeNames.Email+"@odata.bind",r="/"+t.regardingObjectMetadata.EntitySetName+"("+Utility.TrimGuid(t.regardingObject.id)+")";e.ExtraProperties[n]=r}return e},t.performPageRefresh=function(){Xrm.Page.ui.refreshRibbon(!0)},t.isCRMRecord=function(e){var t=e&&e.entityReference&&e.entityReference.LogicalName;return"contact"===t||"lead"===t||"systemuser"===t},t.isMacDesktopOutlook=function(){return t.getExternalContextProperty(Constants.PropertyIds.IsDesktopOutlook).then(function(t){return t&&e.Utils.isMac()})},t.hasEntityPrivilege=function(e,t){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.UntrackCommand,'Checking "'+e+'" entity privilege'),Xrm.Utility.getEntityMetadata(e).then(function(e){if(e&&e.Privileges&&e.Privileges.length){var n=e.Privileges.find(function(e){return e.PrivilegeType===t});return!!n&&-1!==Xrm.Utility.getGlobalContext().userSettings.securityRolePrivileges.indexOf(n.PrivilegeId)}return!1})["catch"](function(){return!1})},t.openErrorDialog=function(e,t){var n="";t&&(t.message&&(n+="Message: "+t.message+" "),t.code&&(n+="Code: "+t.code+" "),t.stack&&(n+="Stack: "+t.stack+" "),n=n.trim());var r;if(Array.isArray(e)){var o=e.map(Resources.ResourceManager.getString),a=o[0],i=o.slice(1);r=Utility.formatString.apply(Utility,[a].concat(i))}else r=Resources.ResourceManager.getString(e);return Xrm.Navigation.openErrorDialog({message:r,details:n?n:null})},t.invokeExternalContextAction=function(e,t){var n=Telemetry.ComponentNames.ExternalContextInvokeAction+"."+e;return Telemetry.reportTraceInfo(n,'Invoking external context "'+e+'" action'),Xrm.ExternalContext.invokeExternalContextAction(Constants.contextId,e,t).then(function(e){return Xrm.Reporting.reportSuccess(n),e})["catch"](function(e){throw Xrm.Reporting.reportFailure(n,e),e})},t.getExternalContextProperty=function(e){var t=Telemetry.ComponentNames.ExternalContextGetProperty+"."+e;return Telemetry.reportTraceInfo(t,'Getting external context "'+e+'" property'),
Xrm.ExternalContext.getExternalContextProperty(Constants.contextId,e).then(function(n){return Xrm.Reporting.reportSuccess(t),e===Constants.PropertyIds.AttachmentIds&&Telemetry.reportTraceInfo(t,'"'+e+'" value is '+(n&&n.length?n.length:0)),n})["catch"](function(e){throw Xrm.Reporting.reportFailure(t,e),e})},t.makeRequest=function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",Xrm.Page.context.getClientUrl()+"/"+e),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t(r.responseText):n(new Error("Bad response: "+r.statusText)))},r.onerror=function(e){n(new Error("Request failed: "+e.message))};var o=Xrm.Internal.getAuthToken();o&&r.setRequestHeader("Authorization","Bearer "+o),r.send()})},t}();e.Utils=t}(Common||(Common={}));var Commands;!function(e){var t={APPOINTMENT:"APPOINTMENT",EMAIL:"EMAIL",TRACK_FAILED:"TRACK_FAILED"},n=function(){function e(e,t,n){this.itemType=e,this.regardingObject=n?{id:n.id||"",entityType:n.entityType||"",name:n.name||""}:null,Telemetry.reportTraceInfo(t,"Start item tracking")}return e.prototype.track=function(){var e=this;return this.invokeExternalContextAction(Models.TrackingState.InProgress,null,null,!0),this._getTrackParameters().then(function(){return e.trackInternal()}).then(this._trackSuccess.bind(this),this._trackFailed.bind(this))},e.prototype.trackInternal=function(){return this.trackStatus.crmId&&this.trackStatus.crmTrackingState===Models.TrackingState.IsLinked?this.regardingObject.id!==this.trackStatus.crmRegardingObjectId?this._changeRegarding():(Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"The Regarding object was not changed, no changes are made"),Promise.resolve(this.trackStatus)):this.isDelegatedMailbox?this.markToBeProcessed("Immediate Track forbidden. For delegate mailbox we should use SSS"):void 0},e.prototype.isActivityInCrm=function(){if(Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Checking if activity exists in CRM"),!this.trackStatus.crmId)return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"CrmId is empty hence activity is not in CRM"),Promise.resolve(!1);var e="?$filter=activityid eq "+this.trackStatus.crmId+"&$select=activityid";return Xrm.WebApi.online.retrieveMultipleRecords(Common.Utils.getCrmType(this.item),e).then(function(e){var t=e.entities&&e.entities.length>0;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Activity"+(t?"":" not")+" found in CRM"),t})["catch"](function(e){throw Telemetry.reportTraceWarning(Telemetry.ComponentNames.TrackCommand,"Request failed to check whether activity exists in CRM"),e})},e.prototype.markToBeProcessed=function(e,t,n){return Telemetry.reportTraceWarning(Telemetry.ComponentNames.TrackCommand+".SSSQueue",e,t,n),this.invokeExternalContextAction(Models.TrackingState.WillBeLinked)},e.prototype.markAsTrackedImmediately=function(e){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Mark item as Immediately tracked"),this.invokeExternalContextAction(Models.TrackingState.IsLinked,e,!0)},e.prototype.invokeExternalContextAction=function(e,t,n,r){return void 0===n&&(n=!1),void 0===r&&(r=!1),Common.Utils.invokeExternalContextAction(Constants.ActionIds.Track,this._getInvokeExternalContextActionArgs(e,t,n,r))},e.prototype._trackSuccess=function(e){return Common.Utils.performPageRefresh(),e.crmTrackingState!==this.trackStatus.crmTrackingState||this.regardingObject&&this.regardingObject.id!==e.crmRegardingObjectId||this.invokeExternalContextAction(e.crmTrackingState,null,null,!0),e.crmTrackingState===Models.TrackingState.IsLinked&&this.trackStatus.crmTrackingState!==Models.TrackingState.IsLinked?Common.Notifications.showSuccess("TRACK_SUCCEEDED"):void 0},e.prototype._trackFailed=function(e){var n=Resources.ResourceManager.getString(this.itemType===Constants.MailboxItemTypes.Appointment?t.APPOINTMENT:t.EMAIL),r=Resources.ResourceManager.getString(t.TRACK_FAILED);throw this.invokeExternalContextAction(this.trackStatus.crmTrackingState,null,null,!0),Common.Utils.openErrorDialog([r,n],e),e},e.prototype._updateRecord=function(e){var t=this,n=Common.Utils.getCrmType(this.item),r="regardingobjectid_"+this.regardingObject.entityType+"_"+n+"@odata.bind",o="/"+e.EntitySetName+"("+Utility.TrimGuid(this.regardingObject.id)+")",a=(i={},i[r]=o,i);return Xrm.WebApi.updateRecord(n,this.trackStatus.crmId,a).then(function(e){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Regarding object was successfully updated"),t.markAsTrackedImmediately(e.id)})["catch"](function(e){return t.markToBeProcessed("Immediate Track failed. Update Record request failed",e)});var i},e.prototype._changeRegarding=function(){var e=this;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Updating regarding object of "+Common.Utils.getCrmType(this.item)),Xrm.Utility.getEntityMetadata(this.regardingObject.entityType).then(this._updateRecord.bind(this))["catch"](function(t){return e.markToBeProcessed("Immediate Track failed. Unable to get Regarding object metadata "+e.regardingObject.entityType,t)})},e.prototype._getTrackParameters=function(){var e=this;Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Getting tracking parameters from shim");var t=Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAppointmentsReliablePromote)?Constants.PropertyIds.MailboxItemFromServer:Constants.PropertyIds.MailboxItem;return Promise.all([Common.Utils.getExternalContextProperty(t),Common.Utils.getExternalContextProperty(Constants.PropertyIds.TrackStatus),Common.Utils.getExternalContextProperty(Constants.PropertyIds.IsComposeMode),Common.Utils.getExternalContextProperty(Constants.PropertyIds.IsDelegatedMailbox)]).then(function(t){var n=t[0],r=t[1],o=t[2],a=t[3];e.item=n,e.trackStatus=r,e.isComposeMode=o,e.isDelegatedMailbox=a})},e.prototype._getInvokeExternalContextActionArgs=function(e,t,n,r){var o={trackingState:e,isImmediateTrack:n,isTrackingStateUpdate:r,crmId:t||""};return this.regardingObject&&(o.id=this.regardingObject.id,o.entityType=Xrm.Internal.getEntityCode(this.regardingObject.entityType),o.name=this.regardingObject.name),{args:o}},e}();e.TrackCommand=n}(Commands||(Commands={}));var Models;!function(e){}(Models||(Models={}));var Commands;!function(e){var t=function(e){function t(t,n){e.call(this,Constants.MailboxItemTypes.Appointment,t,n)}return __extends(t,e),t.prototype.trackInternal=function(){var t=this,n=e.prototype.trackInternal.call(this);return n?n:this._hasGlobalObjectId()?Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAppointmentsReliablePromote)?this.isActivityInCrm().then(function(e){return e?t.markAsTrackedImmediately(t.trackStatus.crmId):t._validateAndBook()}):this._validateAndBook():this.markToBeProcessed("Immediate Track forbidden. GlobalObjectId is empty")},t.prototype._hasGlobalObjectId=function(){return!!this.item.GlobalObjectId},t.prototype._setIsBookAllowed=function(){var e=this;return this._isBookAllowed=!this.isComposeMode||Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAppointmentsReliablePromote),this._isBookAllowed?this._isCreatedByOtherCrmUser().then(function(t){return e._bookNotAllowedReason="Appointemnt Created by Other User",e._isBookAllowed=!t}):(this._bookNotAllowedReason="Appointment is in Compose mode and FCB.MailAppAppointmentsReliablePromote is disabled",Promise.resolve(this._isBookAllowed))},t.prototype._validateAndBook=function(){var e=this;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Start appointment validation and booking"),Promise.all([this._setIsBookAllowed(),this._getAppointmentRecord()]).then(function(t){var n=t[1];return Common.Utils.WebApiRequest(Common.Utils.createPreValidateAppointmentRequest(n)).then(function(t){var r=t&&t.ValidationResult;return r&&r.ValidationSuccess?e._book(n):e._hasAppointmentConflict(r)?(Telemetry.reportTraceWarning(Telemetry.ComponentNames.TrackCommand,"Appointment has a conflict",null,r),e._showAppointmentConflictDialog(n)):e.markToBeProcessed("Immediate Track failed. Appointment Validation is not success",e._processValidationResultForTelemetry(r))},function(t){return Telemetry.reportTraceWarning(Telemetry.ComponentNames.TrackCommand,"Appointment pre-validation Web Api request failed. Trying to book the appointment.",t),e._book(n)})},function(t){return e.markToBeProcessed("Immediate Track failed. Unable to get appointment details",t)})["catch"](function(t){return e.markToBeProcessed("Immediate Track failed. Unhandled exception",t)})},t.prototype._processValidationResultForTelemetry=function(e){e&&e.TraceInfo&&e.TraceInfo.ErrorInfoList&&e.TraceInfo.ErrorInfoList.length>0&&e.TraceInfo.ErrorInfoList.forEach(function(e){e.ResourceList&&e.ResourceList.length>0&&e.ResourceList.forEach(function(e){e&&e.DisplayName&&delete e.DisplayName})})},t.prototype._book=function(e){var t=this;return this._isBookAllowed?this._createBookRequest(e).then(function(n){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Book request contract successfully retrieved"),Common.Utils.WebApiRequest(n).then(function(n){var r=n&&n.ValidationResult;if(r&&r.ValidationSuccess){var o=r&&r.ActivityId;return Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAppointmentsReliablePromote)?t._createSyncMappingRecord(o):t.markAsTrackedImmediately(o)}return t._hasAppointmentConflict(r)?(Telemetry.reportTraceWarning(Telemetry.ComponentNames.TrackCommand,"Create Book Web Api request responded with conflict",null,r),t._showAppointmentConflictDialog(e)):t.markToBeProcessed("Immediate Track failed. Book request validation failed",t._processValidationResultForTelemetry(r))},function(e){return t.markToBeProcessed("Immediate Track failed. Book request failed",e)})},function(e){return t.markToBeProcessed("Immediate Track failed. Unable to get appointment details",e)}):this.markToBeProcessed("Immediate Track forbidden. "+this._bookNotAllowedReason)},t.prototype._isCreatedByOtherCrmUser=function(){return Common.Utils.isOrganizerResolvedAsUser().then(function(e){return e&&Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Meeting organizer was resolved as CRM user. Falling back to SSS tracking."),e})["catch"](function(e){return Telemetry.reportTraceWarning(Telemetry.ComponentNames.TrackCommand,"Failed to check whether organizer is resolved as user or not, hence falling back to SSS tracking.",e),!0})},t.prototype._hasAppointmentConflict=function(e){return"ErrorCode.ResourceBusy"===e.TraceInfo.ErrorInfoList[0].ErrorCode},t.prototype._createSyncMappingRecord=function(e){var t=this,n=Common.Utils.createSyncIdMapping(e,this.item);return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Creating Exchange Sync Id Mapping Record in CRM"),Xrm.WebApi.online.createRecord(Constants.CrmTypeNames.ExchangeSyncIdMapping,n).then(function(){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Exchange Sync Id Mapping Record created in CRM"),t.markAsTrackedImmediately(e)})["catch"](function(e){throw Telemetry.reportTraceError(Telemetry.ComponentNames.TrackCommand,"Unable create exchange sync id mapping record in the CRM. Item state is inconsistent",e),e}).then(function(){t.isComposeMode&&setTimeout(function(){Common.Utils.invokeExternalContextAction(Constants.ActionIds.RetryTrack)["catch"](void 0)},1e3)})},t.prototype._createAppointment=function(e){var t=this;return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Creating appointment in CRM"),this._canCreateAppointment().then(function(n){if(!n.canCreate)return t.markToBeProcessed('Immediate Track forbidden. Can not create of Appointment: "'+n.reason+'"');var r=Common.Utils.getCrmType(t.item);return Xrm.WebApi.createRecord(r,e).then(function(e){return e&&e.id?Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAppointmentsReliablePromote)?t._createSyncMappingRecord(e.id):t.markAsTrackedImmediately(e.id):t.markToBeProcessed("Immediate Track failed. Response for appointment create request is invalid.",e)})["catch"](function(e){return t.markToBeProcessed("Immediate Track failed. Create of Appointment failed",e)})})},t.prototype._canCreateAppointment=function(){return Common.Utils.getExternalContextProperty(Constants.PropertyIds.AttachmentIds).then(function(e){return e&&e.length>0?{canCreate:!1,reason:"Appointment has attachments"}:{canCreate:!0}})["catch"](function(e){return{canCreate:!1,reason:"Failed to retrieve appointment attachments"}})},t.prototype._showAppointmentConflictDialog=function(e){var t=this;return Xrm.Navigation.openDialog(Constants.DialogNames.AppointmentConflict).then(function(n){var r=n.parameters;return r.is_keep_button?t._isBookAllowed?t._createAppointment(e):t.markToBeProcessed("Immediate track forbidden. "+t._bookNotAllowedReason):t.trackStatus})},t.prototype._createBookRequest=function(e){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Getting Book request"),Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAttachmentsReliablePromote)?Promise.all([Common.Utils.getExternalContextProperty(Constants.PropertyIds.AttachmentIds),Common.Utils.getExternalContextProperty(Constants.PropertyIds.EwsUrl),Common.Utils.getExternalContextProperty(Constants.PropertyIds.EwsToken)]).then(function(t){var n=t[0],r=t[1],o=t[2];if(!n||0===n.length)return Common.Utils.createBookRequest(e);if(!o)throw new Error("EwsToken is empty");if(!r)throw new Error("EwsUrl is empty");return Common.Utils.createBookRequestWithAttachments(e,{attachmentIds:n,ewsUrl:r,ewsToken:o})}):Promise.resolve(Common.Utils.createBookRequest(e))},t.prototype._getAppointmentRecord=function(){var e=this;Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Getting Appointment record");var t=Xrm.Utility.getGlobalContext().organizationSettings,n=t&&t.appointmentRichEditorExperience,r=this.item.CalendarItemType===Constants.CalendarItemTypes.RecurringMaster,o=n&&!r?Constants.PropertyIds.HtmlBody:Constants.PropertyIds.PlainBody,a=[Common.Utils.getExternalContextProperty(Constants.PropertyIds.Subject),Common.Utils.getExternalContextProperty(o),Common.Utils.getExternalContextProperty(Constants.PropertyIds.MeetingAttendees)];return this.regardingObject&&a.push(Xrm.Utility.getEntityMetadata(this.regardingObject.entityType)),Promise.all(a).then(function(t){var n=t[0],r=t[1],o=t[2],a=t[3];return Common.Utils.createAppointmentRecord(e.item,n,r,e.regardingObject,o,a)})},t}(e.TrackCommand);e.TrackAppointment=t}(Commands||(Commands={}));var ODataContract;!function(e){var t=function(){function e(e,t,n){this.MessageId=e,this.Subject=t,this.DirectionCode=n}return e.prototype.getMetadata=function(){var e={boundParameter:null,parameterTypes:{MessageId:{typeName:"Edm.String",structuralProperty:1},Subject:{typeName:"Edm.String",structuralProperty:1},DirectionCode:{typeName:"Edm.Int32",structuralProperty:1}},operationName:"CheckPromoteEmail",operationType:1};return e},e}();e.CheckPromoteEmailRequest=t}(ODataContract||(ODataContract={}));var Models;!function(e){!function(e){e[e.Unknown=-1]="Unknown",e[e.Duplicate=0]="Duplicate",e[e.NoCorrelationMatch=1]="NoCorrelationMatch",e[e.CorrelationMatch=2]="CorrelationMatch",e[e.NoRecipientMatch=3]="NoRecipientMatch",e[e.InternalEmailReject=4]="InternalEmailReject",e[e.SenderMatch=5]="SenderMatch",e[e.AcceptAll=6]="AcceptAll",e[e.InvalidSender=7]="InvalidSender"}(e.PromoteDecision||(e.PromoteDecision={}));e.PromoteDecision}(Models||(Models={}));var Commands;!function(e){var t=function(e){function t(t,n){e.call(this,Constants.MailboxItemTypes.Message,t,n)}return __extends(t,e),t.prototype.trackInternal=function(){var t=this,n=e.prototype.trackInternal.call(this);return n?n:!this.isComposeMode&&this.item.InternetMessageId?this._checkPromote().then(function(e){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Check Deliver Promote call succeeded"),e.shouldPromote?t._deliverPromote():t.markToBeProcessed("Immediate Track failed. Deliver Promote is not allowed Reason: "+e.reason)},function(e){return t.markToBeProcessed("Immediate Track failed. Check Deliver Promote call failed",e)}):this.isComposeMode?this.markToBeProcessed("Immediate Track forbidden. Email is in compose mode"):this.markToBeProcessed("Immediate Track forbidden. InternetMessageId is empty")},t.prototype._checkPromote=function(){Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Invoking CheckDeliverPromote call");var e=new ODataContract.CheckPromoteEmailRequest(this.item.InternetMessageId,null,null);return Common.Utils.WebApiRequest(e).then(function(e){var t=Models.PromoteDecision[e?e.ReasonCode:Models.PromoteDecision.Unknown];return{shouldPromote:e&&e.ShouldPromote,reason:t}})},t.prototype._deliverPromote=function(){var e=this;return this._createDeliverPromoteRequest().then(function(t){return Common.Utils.WebApiRequest(t).then(function(t){return t&&t.activityid?(Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"DeliverPromote call succeeded"),e.markAsTrackedImmediately(t.activityid)):e.markToBeProcessed("Immediate Track failed. Deliver Promote call responded with invalid data",t)},function(t){return e.markToBeProcessed("Immediate Track failed. Deliver promote request failed.",t)})},function(t){return e.markToBeProcessed("Immediate Track failed. Unable to get deliver promote details. "+(t&&t.message?t.message:""),t)})},t.prototype._createDeliverPromoteRequest=function(){return Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Getting Deliver Promote request"),this._getDeliverPromoteRequestDetails().then(function(e){if(e.attachmentIds&&e.attachmentIds.length>0){if(Xrm.Internal.isFeatureEnabled(Constants.FeatureNames.MailAppAttachmentsReliablePromote))return Promise.all([Common.Utils.getExternalContextProperty(Constants.PropertyIds.EwsUrl),Common.Utils.getExternalContextProperty(Constants.PropertyIds.EwsToken)]).then(function(t){var n=t[0],r=t[1];if(!r)throw new Error("EwsToken is empty");if(!n)throw new Error("EwsUrl is empty");var o=e.attachmentIds;return Common.Utils.createDeliverPromoteWithAttachmentsRequest(e,{attachmentIds:o,ewsUrl:n,ewsToken:r})});throw new Error("Immediate track with attachments is not supported")}return Promise.resolve(Common.Utils.createDeliverPromoteRequest(e))})},t.prototype._getDeliverPromoteRequestDetails=function(){var e=this;Telemetry.reportTraceInfo(Telemetry.ComponentNames.TrackCommand,"Getting Deliver Promote request parameters");var t=[Common.Utils.getExternalContextProperty(Constants.PropertyIds.MessageRecipients),Common.Utils.getExternalContextProperty(Constants.PropertyIds.Subject),Common.Utils.getExternalContextProperty(Constants.PropertyIds.HtmlBody),Common.Utils.getExternalContextProperty(Constants.PropertyIds.ReceivedOn),Common.Utils.getExternalContextProperty(Constants.PropertyIds.IsSent),Common.Utils.getExternalContextProperty(Constants.PropertyIds.AttachmentIds)];return this.regardingObject&&t.push(Xrm.Utility.getEntityMetadata(this.regardingObject.entityType)),Promise.all(t).then(function(t){var n=t[0],r=t[1],o=t[2],a=t[3],i=t[4],s=t[5],m=t[6];return{message:e.item,regardingObject:e.regardingObject,recipients:n,subject:r,body:o,receivedOn:a,isSent:i,attachmentIds:s,regardingObjectMetadata:m}})["catch"](function(e){throw Telemetry.reportTraceError(Telemetry.ComponentNames.TrackCommand,"Failed to get Deliver Promote request parameters from Shim",e),e})},t}(e.TrackCommand);e.TrackMessage=t}(Commands||(Commands={}));var Commands;!function(e){function t(t,n){return Common.Utils.getExternalContextProperty(Constants.PropertyIds.ItemType).then(function(r){var o;if(r===Constants.MailboxItemTypes.Appointment)o=new e.TrackAppointment(t,n);else{if(r!==Constants.MailboxItemTypes.Message)return Promise.reject('Unsupported item type "'+r+'"');o=new e.TrackMessage(t,n)}return o.track()})}e.track=t}(Commands||(Commands={}));var Common;!function(e){var t=function(){function e(){}return e.showError=function(e){return this._showToastNotification(e,2)},e.showWarning=function(e){return this._showToastNotification(e,3)},e.showInfo=function(e){return this._showToastNotification(e,4)},e.showSuccess=function(e){return this._showToastNotification(e,1)},e._showToastNotification=function(e,t){return Xrm.UI.addGlobalNotification(1,t,Resources.ResourceManager.getString(e),null,null,null)},e}();e.Notifications=t}(Common||(Common={}));var Common;!function(e){var t=function(){function e(t){if(this.toString=function(){return this.guid},this._guid=e._formatGuidString(t),!this.guid)throw new Error(t+" is not a valid Guid value.");Object.freeze(this)}return Object.defineProperty(e.prototype,"guid",{get:function(){return this._guid},enumerable:!0,configurable:!0}),e._formatGuidString=function(t){if(!t)return null;t=t.toLowerCase();var n=e.braceAndHyphenGuidVerifierPattern.exec(t);if(n)return n[1].length!==n[8].length?null:n[2];var r=e.contiguousGuidVerifierPattern.exec(t);return r?r.filter(function(e,t){return t>0}).join("-"):null},e.newGuid=function(){for(var t="0123456789abcdef",n=36,r="",o=0;n>o;o++)if(14===o)r+="4";else if(8===o||13===o||18===o||23===o)r+="-";else if(19===o){var a=Math.floor(16*Math.random());r+=t.substr(3&a|8,1)}else r+=t.substr(Math.floor(16*Math.random()),1);return new e(r)},e.braceAndHyphenGuidVerifierPattern=/^({?)((\d|[a-f]){8}-(\d|[a-f]){4}-(\d|[a-f]){4}-(\d|[a-f]){4}-(\d|[a-f]){12})(}?)$/,e.contiguousGuidVerifierPattern=/^([a-f\d]{8})([a-f\d]{4})([a-f\d]{4})([a-f\d]{4})([a-f\d]{12})$/,e.EMPTY=new e("00000000-0000-0000-0000-000000000000"),e.toString=function(e){return e?e.guid:null},e.equals=function(t,n){return e.toString(t)===e.toString(n)},e.tryParse=function(t){return e.tryParseOrNull(t)||e.EMPTY},e.tryParseOrNull=function(t){var n=e._formatGuidString(t);return n?new e(n):null},e}();e.Guid=t}(Common||(Common={}));var Dialogs;!function(e){var t;!function(t){function n(){e.Common.SetQueryParameter(t.QUERY_PARAMS.CALENDAR_EDIT_LINK_URL,o())}function r(){e.Common.SetQueryParameter(t.QUERY_PARAMS.IS_KEEP_BUTTON,!0),e.Common.CloseDialog()}function o(){var e=window.location,t=e.port,n=e.hostname,r=e.protocol,o=r+"//"+n;return t&&(o+=":"+t),o+"/workplace/home_calendar.aspx"}t.QUERY_PARAMS={CALENDAR_EDIT_LINK_URL:"calendar_edit_link_url",IS_KEEP_BUTTON:"is_keep_button"},t.onLoad=n,t.onKeepClick=r}(t=e.ShowAppointmentConflict||(e.ShowAppointmentConflict={}))}(Dialogs||(Dialogs={}));var Dialogs;!function(e){var t;!function(t){function n(){e.Common.HideControl(t.CONTROL_IDS.STATUS_MESSAGE),e.Common.HideControl(t.CONTROL_IDS.ANALYZING_EMAIL_BODY_STATUS),e.Common.HideControl(t.CONTROL_IDS.REMOVING_FOLLOW_INFO_STATUS),e.Common.HideControl(t.CONTROL_IDS.FINISHING_UP_STATUS),e.Common.HideControl(t.CONTROL_IDS.UNFOLLOW_BUTTON),e.Common.HideControl(t.CONTROL_IDS.DONE_BUTTON)}function r(n,r){switch(n){case Commands.UnfollowStep.AnalyzingEmailBody:e.Common.SetQueryParameter(t.QUERY_PARAMS.ANALYZING_EMAIL_BODY_STATUS_ICON,Models.FollowStepState[r]),e.Common.ShowControl(t.CONTROL_IDS.ANALYZING_EMAIL_BODY_STATUS);break;case Commands.UnfollowStep.RemovingFollowInfo:e.Common.SetQueryParameter(t.QUERY_PARAMS.REMOVING_FOLLOW_INFO_STATUS_ICON,Models.FollowStepState[r]),e.Common.ShowControl(t.CONTROL_IDS.REMOVING_FOLLOW_INFO_STATUS);break;case Commands.UnfollowStep.FinishingUp:e.Common.SetQueryParameter(t.QUERY_PARAMS.FINISHING_UP_STATUS_ICON,Models.FollowStepState[r]),e.Common.ShowControl(t.CONTROL_IDS.FINISHING_UP_STATUS)}}function o(){return Xrm.Navigation.openConfirmDialog({text:Resources.ResourceManager.getString(t.RESOURCES_IDS.UNFOLLOW_CONFIRMATION),confirmButtonLabel:Resources.ResourceManager.getString(t.RESOURCES_IDS.YES),cancelButtonLabel:Resources.ResourceManager.getString(t.RESOURCES_IDS.NO)}).then(function(e){return e&&e.confirmed})}function a(e){void 0!==l&&r(l,Models.FollowStepState.Success),r(e,Models.FollowStepState.InProgress),l=e}function i(){r(l,Models.FollowStepState.Success),l=void 0,e.Common.HideControl(t.CONTROL_IDS.UNFOLLOW_BUTTON),e.Common.ShowControl(t.CONTROL_IDS.DONE_BUTTON)}function s(n){r(l,Models.FollowStepState.Failure),l=void 0,e.Common.HideControl(t.CONTROL_IDS.STATUS_MESSAGE),e.Common.ShowControl(t.CONTROL_IDS.UNFOLLOW_BUTTON),Xrm.Navigation.openAlertDialog({text:Resources.ResourceManager.getString(t.RESOURCES_IDS.UNFOLLOW_ERROR)})}function m(){n(),e.Common.ShowControl(t.CONTROL_IDS.STATUS_MESSAGE),e.Common.ShowControl(t.CONTROL_IDS.UNFOLLOW_BUTTON)}function c(){var e=this;return o().then(function(t){return t?(n(),new Commands.UnfollowCommand(a).unfollow().then(i.bind(e),s.bind(e))):void 0},s.bind(this))}t.CONTROL_IDS={ANALYZING_EMAIL_BODY_STATUS:"AnalyzingEmailBody_Status",REMOVING_FOLLOW_INFO_STATUS:"RemovingFollowInfo_Status",FINISHING_UP_STATUS:"FinishingUp_Status",STATUS_MESSAGE:"Status_Message",UNFOLLOW_BUTTON:"Unfollow_Button",DONE_BUTTON:"Done_Button"},t.QUERY_PARAMS={ANALYZING_EMAIL_BODY_STATUS_ICON:"analyzing_email_body_status_icon",REMOVING_FOLLOW_INFO_STATUS_ICON:"removing_follow_info_status_icon",FINISHING_UP_STATUS_ICON:"finishing_up_status_icon"},t.RESOURCES_IDS={UNFOLLOW_CONFIRMATION:"UNFOLLOW_CONFIRMATION",UNFOLLOW_ERROR:"UNFOLLOW_ERROR",YES:"YES",NO:"NO"};var l;t.onLoad=m,t.onUnfollowClick=c}(t=e.Unfollow||(e.Unfollow={}))}(Dialogs||(Dialogs={}));var Dialogs;!function(e){var t;!function(t){function n(n){e.Common.SetControlLabel(t.CONTROL_IDS.STATUS_MESSAGE,Resources.ResourceManager.getString(n)),e.Common.ShowControl(t.CONTROL_IDS.STATUS_MESSAGE)}function r(n){e.Common.SetControlLabel(t.CONTROL_IDS.RECOMMEND_MESSAGE,Resources.ResourceManager.getString(n)),e.Common.ShowControl(t.CONTROL_IDS.RECOMMEND_MESSAGE)}function o(n,r){switch(n){case Commands.FollowStep.RetrievingCRMData:e.Common.SetQueryParameter(t.QUERY_PARAMS.RETRIEVING_CRM_DATA_STATUS_ICON,Models.FollowStepState[r]),e.Common.ShowControl(t.CONTROL_IDS.RETRIEVING_CRM_DATA_STATUS);break;case Commands.FollowStep.AddingFollowInfo:e.Common.SetQueryParameter(t.QUERY_PARAMS.ADDING_FOLLOW_INFO_STATUS_ICON,Models.FollowStepState[r]),e.Common.ShowControl(t.CONTROL_IDS.ADDING_FOLLOW_INFO_STATUS);break;case Commands.FollowStep.FinishingUp:e.Common.SetQueryParameter(t.QUERY_PARAMS.FINISHING_UP_STATUS_ICON,Models.FollowStepState[r]),e.Common.ShowControl(t.CONTROL_IDS.FINISHING_UP_STATUS)}}function a(e){void 0!==u&&o(u,Models.FollowStepState.Success),o(e,Models.FollowStepState.InProgress),u=e}function i(){o(u,Models.FollowStepState.Success),u=void 0,e.Common.HideControl(t.CONTROL_IDS.FOLLOW_BUTTON),n(t.RESOURCES_IDS.EMAIL_WILL_BE_FOLLOWED),r(t.RESOURCES_IDS.DONT_EDIT_AFTER_FOLLOW),e.Common.ShowControl(t.CONTROL_IDS.HERE_IS_WHY_LINK),e.Common.ShowControl(t.CONTROL_IDS.DONE_BUTTON)}function s(n){o(u,Models.FollowStepState.Failure),u=void 0,e.Common.HideControl(t.CONTROL_IDS.STATUS_MESSAGE),e.Common.ShowControl(t.CONTROL_IDS.FOLLOW_BUTTON),n instanceof Commands.FollowRestrictedError?(e.Common.SetQueryParameter(t.QUERY_PARAMS.RECIPIENTS_RECORDS,n.FollowRestrictedRecords),e.Common.ShowControl(t.CONTROL_IDS.RECIPIENTS_LIST)):Xrm.Navigation.openAlertDialog({text:Resources.ResourceManager.getString(t.RESOURCES_IDS.FOLLOW_ERROR)})}function m(){e.Common.HideControl(t.CONTROL_IDS.STATUS_MESSAGE),e.Common.HideControl(t.CONTROL_IDS.RECIPIENTS_LIST),e.Common.HideControl(t.CONTROL_IDS.DONE_BUTTON),e.Common.HideControl(t.CONTROL_IDS.RECOMMEND_MESSAGE),e.Common.HideControl(t.CONTROL_IDS.HERE_IS_WHY_LINK),e.Common.HideControl(t.CONTROL_IDS.FOLLOW_BUTTON),e.Common.HideControl(t.CONTROL_IDS.RETRIEVING_CRM_DATA_STATUS),e.Common.HideControl(t.CONTROL_IDS.ADDING_FOLLOW_INFO_STATUS),e.Common.HideControl(t.CONTROL_IDS.FINISHING_UP_STATUS)}function c(){m();var o=Xrm.Page.data.attributes.get(t.QUERY_PARAMS.IS_TRACKED).getValue();o?(n(t.RESOURCES_IDS.EMAIL_IS_NOT_FOLLOWED),r(t.RESOURCES_IDS.FOLLOW_RIGHT_BEFORE_SEND),e.Common.SetQueryParameter(t.QUERY_PARAMS.HELP_LINK_URL,Resources.ResourceManager.getString(t.RESOURCES_IDS.FOLLOW_HELP_LINK_URL_1)),e.Common.ShowControl(t.CONTROL_IDS.FOLLOW_BUTTON)):(n(t.RESOURCES_IDS.EMAIL_CANNOT_BE_FOLLOWED),r(t.RESOURCES_IDS.TRACK_BEFORE_FOLLOWING),e.Common.SetQueryParameter(t.QUERY_PARAMS.HELP_LINK_URL,Resources.ResourceManager.getString(t.RESOURCES_IDS.FOLLOW_HELP_LINK_URL_1))),e.Common.ShowControl(t.CONTROL_IDS.HERE_IS_WHY_LINK)}function l(){return m(),n(t.RESOURCES_IDS.FOLLOW_IN_PROCESS_MESSAGE),new Commands.FollowCommand(a).follow().then(i.bind(this),s.bind(this))}t.CONTROL_IDS={STATUS_MESSAGE:"Status_Message",RECOMMEND_MESSAGE:"Recommend_Message",RECIPIENTS_LIST:"RecipientsList",RETRIEVING_CRM_DATA_STATUS:"RetrievingCRMData_Status",ADDING_FOLLOW_INFO_STATUS:"AddingFollowInfo_Status",FINISHING_UP_STATUS:"FinishingUp_Status",HERE_IS_WHY_LINK:"HereIsWhy_Link",FOLLOW_BUTTON:"Follow_Button",DONE_BUTTON:"Done_Button"},t.QUERY_PARAMS={IS_TRACKED:"is_email_tracked",HELP_LINK_URL:"help_link_url",RETRIEVING_CRM_DATA_STATUS_ICON:"retrieving_crm_data_status_icon",ADDING_FOLLOW_INFO_STATUS_ICON:"adding_follow_info_status_icon",FINISHING_UP_STATUS_ICON:"finishing_up_status_icon",RECIPIENTS_RECORDS:"recipients_records"},t.RESOURCES_IDS={EMAIL_IS_NOT_FOLLOWED:"EMAIL_IS_NOT_FOLLOWED",FOLLOW_RIGHT_BEFORE_SEND:"FOLLOW_RIGHT_BEFORE_SEND",FOLLOW_HELP_LINK_URL_1:"FOLLOW_HELP_LINK_URL_1",EMAIL_CANNOT_BE_FOLLOWED:"EMAIL_CANNOT_BE_FOLLOWED",TRACK_BEFORE_FOLLOWING:"TRACK_BEFORE_FOLLOWING",FOLLOW_IN_PROCESS_MESSAGE:"FOLLOW_IN_PROCESS_MESSAGE",EMAIL_WILL_BE_FOLLOWED:"EMAIL_WILL_BE_FOLLOWED",DONT_EDIT_AFTER_FOLLOW:"DONT_EDIT_AFTER_FOLLOW",FOLLOW_ERROR:"FOLLOW_ERROR"};var u;t.onLoad=c,t.onFollowClick=l}(t=e.Follow||(e.Follow={}))}(Dialogs||(Dialogs={}));var Guid=Common.Guid,Dialogs;!function(e){var t;!function(t){function n(e){d(),u().forEach(function(e,t){T.addOption({text:e.Name,value:t},t)}),l()}function r(e){var t=p();t&&(y.addPreSearch(function(){return y.addCustomFilter(m(t.LogicalName),"template")}),c(),Xrm.Page.ui.moveTo(Xrm.Page.ui.getDefaultNextPageName()))}function o(){Xrm.Page.ui.movePrevious()}function a(){g(),e.Common.CloseDialog()}function i(){l()}function s(){c()}function m(e){return"<filter type='and'>\n\t\t\t\t\t\t<filter type='or'>\n\t\t\t\t\t\t\t<condition attribute='templatetypecode' operator='eq' value='"+h+"'/>\n\t\t\t\t\t\t\t<condition attribute='templatetypecode' operator='eq' value='"+Xrm.Internal.getEntityCode(e)+"'/>\n\t\t\t\t\t\t</filter>\n\t\t\t\t\t</filter>"}function c(){C()?_.setDisabled(!1):_.setDisabled(!0)}function l(){p()?I.setDisabled(!1):I.setDisabled(!0)}function u(){return Xrm.Page.data.attributes.get("email_form_data").getValue()}function d(){T=Xrm.Page.getControl("email_picklist_id"),y=Xrm.Page.getControl("email_template"),I=Xrm.Page.getControl("select_id"),_=Xrm.Page.getControl("addtoemail_id")}function p(){var e=u(),t=T.getAttribute().getValue();return 0>t?null:e[t]}function C(){var e=Xrm.Page.data.attributes.get("email_template").getValue();return e&&0!==e.length?e[0]:null}function g(){var e=p(),t=C();t&&e&&(Xrm.Page.data.attributes.get("template_id").setValue(f(t)),Xrm.Page.data.attributes.get("regarding_object_id").setValue(e.Id),Xrm.Page.data.attributes.get("regarding_object_type").setValue(e.LogicalName))}function f(e){var t=e.id,n=t.slice(1,-1);return new Guid(n)}var T,y,I,_,h=8;t.OnLoad=n,t.OnRegardingSelected=r,t.OpenPreviousPage=o,t.SetOutputsAndClose=a,t.OnTemplateSelectionChanged=i,t.onSelectTemplateChanged=s}(t=e.InsertEmailTemplate||(e.InsertEmailTemplate={}))}(Dialogs||(Dialogs={}));var Dialogs;!function(e){var t;!function(t){function n(e){var t=Xrm.Page.getControl("select_id"),n=Xrm.Page.getControl("kbsearch_id"),r=n.getAttribute().getValue(),o=r&&Array.isArray(r)&&r.length>0;t.setDisabled(!o)}function r(){e.Common.SetQueryParameter(t.QUERY_PARAMS.IS_SELECT_BUTTON,!0),e.Common.CloseDialog()}t.QUERY_PARAMS={IS_SELECT_BUTTON:"is_select_button"},t.SetSelectDisabled=n,t.onSelectClick=r}(t=e.KnowledgeArticle||(e.KnowledgeArticle={}))}(Dialogs||(Dialogs={}));var Dialogs;!function(e){var t;!function(e){function t(e){var t=Xrm.Page.getControl("idSubject"),o=t.getAttribute(),a=o.getValue();
if(a&&Array.isArray(a)&&a.length>0){var i=a[0];Xrm.WebApi.retrieveMultipleRecords("salesliterature","?$filter=subjectid/subjectid eq "+Utility.TrimGuid(i.id)+"&$select="+r.id+","+r.name).then(function(e){var t=Xrm.Page.getControl("idSalesLiterature");t.clearOptions();var o={};e.entities.forEach(function(e,n){o[n]=e[r.id],t.addOption({text:e[r.name],value:n})}),n(),Xrm.Page.data.attributes.get("id_map").setValue(o)})}}function n(e){var t=Xrm.Page.getControl("ok_id"),n=Xrm.Page.getControl("idSalesLiterature"),r=null===n.getAttribute().getValue();t.setDisabled(r)}var r={id:"salesliteratureid",name:"name"};e.HandleSubjectChange=t,e.SetInsertDisabled=n}(t=e.SalesLiterature||(e.SalesLiterature={}))}(Dialogs||(Dialogs={}));var Models;!function(e){!function(e){e[e.InProgress=0]="InProgress",e[e.Success=1]="Success",e[e.Failure=2]="Failure"}(e.FollowStepState||(e.FollowStepState={}));e.FollowStepState}(Models||(Models={}));var Models;!function(e){!function(e){e[e.Sender=1]="Sender",e[e.To=2]="To",e[e.Cc=3]="Cc",e[e.Bcc=4]="Bcc",e[e.Organizer=5]="Organizer",e[e.RequiredAttendee=6]="RequiredAttendee",e[e.OptionalAttendee=7]="OptionalAttendee"}(e.RecipientRole||(e.RecipientRole={}));e.RecipientRole}(Models||(Models={}));var Enums;!function(e){!function(e){e[e.Allowed=1]="Allowed",e[e.ForbiddenOccurence=2]="ForbiddenOccurence",e[e.ForbiddenMeetingInviteRequest=3]="ForbiddenMeetingInviteRequest",e[e.ForbiddenMeetingInviteResponse=4]="ForbiddenMeetingInviteResponse",e[e.ForbiddenForOrganizerResolvedAsUser=5]="ForbiddenForOrganizerResolvedAsUser",e[e.ForbiddenForDelegateAccessMissingWritePermission=6]="ForbiddenForDelegateAccessMissingWritePermission"}(e.TrackAllowedStatus||(e.TrackAllowedStatus={}));e.TrackAllowedStatus}(Enums||(Enums={}));var ODataContract;!function(e){var t=function(){function e(){}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"DeleteOpenInstances",operationType:0,parameterTypes:{SeriesEndDate:{typeName:"Edm.DateTimeOffset",structuralProperty:1},Target:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},StateOfPastInstances:{typeName:"Edm.Int32",structuralProperty:1}}};return e},e}();e.DeleteOpenInstances=t}(ODataContract||(ODataContract={}));var Dialogs;!function(e){var t;!function(e){function t(e){var t="controlId",n=e.getEventArgs();if(n){var r=n[t];if(r){var o=Xrm.Page.getControl(r);o&&o.setFocus()}}}function n(){Xrm.Page.ui.close()}function r(e,t){var n=Xrm.Page.getControl(e);n&&n.setLabel(t)}function o(e){var t=Xrm.Page.getControl(e);t&&!t.getVisible()&&t.setVisible(!0)}function a(e){var t=Xrm.Page.getControl(e);t&&t.getVisible()&&t.setVisible(!1)}function i(e,t){Xrm.Page.data.attributes.get(e).setValue(t)}e.FocusOnLoad=t,e.CloseDialog=n,e.SetControlLabel=r,e.ShowControl=o,e.HideControl=a,e.SetQueryParameter=i}(t=e.Common||(e.Common={}))}(Dialogs||(Dialogs={}));var MailApp;!function(e){function t(e,t){return Commands.track(e,t).then(function(){return Xrm.Reporting.reportSuccess(e)})["catch"](function(t){return Xrm.Reporting.reportFailure(e,t)})}function n(){return t(Telemetry.ComponentNames.TrackCommand+".WithoutRegarding")}function r(){var e={id:Xrm.Page.data.entity.getId(),name:Xrm.Page.data.entity.getPrimaryAttributeValue(),entityType:Xrm.Page.data.entity.getEntityName()};return t(Telemetry.ComponentNames.TrackCommand+".ContextualSetRegarding",e)}function o(){return(new Commands.UntrackCommand).untrack().then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.UntrackCommand)})["catch"](function(e){return Xrm.Reporting.reportFailure(Telemetry.ComponentNames.UntrackCommand,e)})}function a(){return Common.Utils.getExternalContextProperty(Constants.PropertyIds.TrackStatus).then(function(e){return e.crmTrackingState===Models.TrackingState.WillBeLinked}).then(function(e){return Xrm.Navigation.openDialog(Constants.DialogNames.Follow,y,{is_email_tracked:e.toString()})})}function i(){return Xrm.Navigation.openDialog(Constants.DialogNames.Unfollow,y)}function s(e){return Xrm.Navigation.openDialog(Constants.DialogNames.EmailTemplate,y,{email_form_data:e}).then(function(e){var t=e.parameters,n=t.template_id,r=t.regarding_object_id,o=t.regarding_object_type;return n&&m(n,r,o)})}function m(e,t,n){var r=new ODataContract.InstantiateTemplateRequest(e,t,n);return Common.Utils.WebApiRequest(r).then(function(e){if(e&&e.value&&Array.isArray(e.value)&&e.value[0]){var t=e.value[0],n=t.description,r=t.subject;return Common.Utils.invokeExternalContextAction(Constants.ActionIds.InsertBody,{args:{value:n}}).then(function(){return Common.Utils.getExternalContextProperty(Constants.PropertyIds.Subject)}).then(function(e){return e?void 0:Common.Utils.invokeExternalContextAction(Constants.ActionIds.SetSubject,{args:{value:r}})})}}).then(function(){var t="activitymimeattachment",n="_attachmentid_value",r="_objectid_value eq "+e.guid;return T(t,n,r)})}function c(){var e=Xrm.ExternalContext.getExternalContextProperty(Constants.contextId,Constants.PropertyIds.TrackStatus).then(function(e){return e&&(e.crmTrackingState===Models.TrackingState.IsLinked||e.crmTrackingState===Models.TrackingState.WillBeLinked)&&e.crmRegardingObjectId?e:null}),t=Common.Utils.resolveRecipients().then(function(e){return e.filter(function(e){return Common.Utils.isCRMRecord(e)&&e.dataValues&&e.dataValues[Constants.PropertyNames.RecipientRole]!==Models.RecipientRole.Bcc})}).then(function(e){return e.map(function(e){return e.entityReference})});return Promise.all([t,e]).then(function(e){var t=e[0],n=e[1];if(n){var r=t.find(function(e){return e&&e.Id&&e.Id.guid===n.crmRegardingObjectId});r||t.splice(0,0,{Id:Common.Guid.tryParseOrNull(n.crmRegardingObjectId),LogicalName:Xrm.Internal.getEntityName(n.crmRegardingObjectType),Name:n.crmRegardingObjectName})}return t.length?s(t):Xrm.Navigation.openConfirmDialog({text:Resources.ResourceManager.getString("CONFIRM_TEMPLATE_REGARDINGS_RECHECK"),confirmButtonLabel:Resources.ResourceManager.getString("RETRY")}).then(function(e){return e.confirmed?c():void 0})}).then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.AddEmailTemplateCommand)})["catch"](function(e){Xrm.Reporting.reportFailure(Telemetry.ComponentNames.AddEmailTemplateCommand,e),Common.Utils.openErrorDialog("ADD_TEMPLATE_FAILED",e)})}function l(){return Xrm.Navigation.openDialog(Constants.DialogNames.SalesLiterature,y).then(function(e){var t=e.parameters.idSalesLiterature,n=e.parameters.id_map;if(null!=t&&n){var r=n[t];if(r){var o="salesliteratureitem",a="salesliteratureitemid",i="salesliteratureid/salesliteratureid eq "+Utility.TrimGuid(r);return T(o,a,i).then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.AddSalesLiteratureCommand)})["catch"](function(e){Xrm.Reporting.reportFailure(Telemetry.ComponentNames.AddSalesLiteratureCommand,e),Common.Utils.openErrorDialog("ADD_SALES_LITERATURE_FAILED",e)})}}})}function u(){return Xrm.Navigation.openDialog(Constants.DialogNames.KnowledgeArticle,y).then(function(e){if(e&&e.parameters&&e.parameters.kbsearch_id&&e.parameters.is_select_button){var t=e.parameters.kbsearch_id[0],n="title",r="content";return Xrm.WebApi.retrieveRecord(t.entityType,t.id,"?$select="+n+","+r).then(function(e){var t=e[n],o=e[r],a=[];return t&&a.push(Common.Utils.getExternalContextProperty(Constants.PropertyIds.Subject).then(function(e){return e?void 0:Common.Utils.invokeExternalContextAction(Constants.ActionIds.SetSubject,{args:{value:t}})})),o&&a.push(Common.Utils.invokeExternalContextAction(Constants.ActionIds.InsertBody,{args:{value:o}})),Promise.all(a)}).then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.AddKnowledgeArticleCommand)})["catch"](function(e){Xrm.Reporting.reportFailure(Telemetry.ComponentNames.AddKnowledgeArticleCommand,e),Common.Utils.openErrorDialog("ADD_KNOWLEDGE_ARTICLE_FAILED",e)})}})}function d(e){var n=e&&e[0];if(n){var r={id:"{"+n.Id+"}",entityType:n.TypeName,name:n.Name};return t(Telemetry.ComponentNames.TrackCommand+".RegardingSelectedRecord",r)}}function p(e,t){var n=e&&e[0];return n&&t?Promise.all([Common.Utils.getExternalContextProperty(Constants.PropertyIds.Subject),Common.Utils.getExternalContextProperty(Constants.PropertyIds.PlainBody)]).then(function(e){var r={entityName:t,useQuickCreateForm:!0},o={subject:e[0]||"",description:(e[1]||"").trim(),regardingobjectid:n.Id,regardingobjectidtype:n.TypeName,regardingobjectidname:n.Name};return Xrm.Navigation.openForm(r,o).then(function(e){})}).then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.AddActivityCommand)})["catch"](function(e){var n;switch(t){case"task":n="ADD_TASK_FAILED";break;case"appointment":n="ADD_APPOINTMENT_FAILED";break;case"phonecall":n="ADD_PHONE_CALL_FAILED"}Xrm.Reporting.reportFailure(Telemetry.ComponentNames.AddActivityCommand,e),Common.Utils.openErrorDialog(n,e)}):void 0}function C(){return _retrieveActivityDetails().then(function(e){var t=e[0],n=e[1];Xrm.Utility.openEntityForm(n,t)}).then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.ViewActivityCommand)})["catch"](function(e){Xrm.Reporting.reportFailure(Telemetry.ComponentNames.ViewActivityCommand,e,null),Common.Utils.openErrorDialog("VIEW_ACTIVITY_FAILED",e)})}function g(e,t){return Xrm.Utility.getGlobalContext().getCurrentAppProperties().then(function(n){var r=n.appId,o=e&&t?Promise.resolve([e,t]):_retrieveActivityDetails();return o.then(function(e){var t=e[0],n=e[1],o=Xrm.Page.context.getClientUrl(),a=f(r,n,t);window.open(o+"/"+a,"_blank")})}).then(function(){return Xrm.Reporting.reportSuccess(Telemetry.ComponentNames.OpenRecordOnWeb)})["catch"](function(e){Xrm.Reporting.reportFailure(Telemetry.ComponentNames.OpenRecordOnWeb,e,null)})}function f(e,t,n){return"main.aspx?navbar=off&etn="+t+"&pagetype=entityrecord&id="+n+"&appid="+e}function T(e,t,n){var r={salesliteratureitem:"salesliteratureitem",activitymimeattachment:"attachment"},o="filename",a="?$filter="+n+"&$select="+t+","+o;return Xrm.WebApi.retrieveMultipleRecords(e,a).then(function(n){var a=n.entities.map(function(n){var a=Utility.TrimGuid(n[t]),i=r[e],s="Handlers/GenerateAccessUrlHandler.ashx?fileId="+a+"&entityType="+i;return Common.Utils.makeRequest(s).then(function(e){var t=JSON.stringify([{name:n[o],url:e}]);return Common.Utils.invokeExternalContextAction(Constants.ActionIds.AddAttachments,{args:{attachments:t}})})});return Promise.all(a)})}var y={position:2};e.Track=t,e.TrackWithoutRegarding=n,e.ContextualSetRegarding=r,e.Untrack=o,e.Follow=a,e.Unfollow=i,e.AddEmailTemplate=c,e.AddSalesLiterature=l,e.AddKnowledgeArticle=u,e.TrackRegardingSelectedRecord=d,e.AddActivity=p,e.ViewActivity=C,e.OpenRecordOnWeb=g}(MailApp||(MailApp={}));var Common;!function(e){var t=function(){function e(){if(this._isBrowserSupportedIE=!1,this._isBrowserSupportedChrome=!1,this._isBrowserSupportedFirefox=!1,this._isBrowserSafari=!1,this._isBrowserSupportedSafari=!1,e._instance)throw new Error("UserAgent.getInstance() should be used instead of new()");this._rawValue=window.navigator.userAgent,this._isBrowserIE=-1!==this._rawValue.indexOf("MSIE 10")||-1!==this._rawValue.indexOf("MSIE 9.0")||-1!==this._rawValue.indexOf("Trident")||-1!==this._rawValue.indexOf("Edge"),this._isBrowserIE&&(this._isBrowserSupportedIE=-1===this._rawValue.indexOf("MSIE")||-1===this._rawValue.indexOf("MSIE 9.0")&&-1!==this._rawValue.indexOf("MSIE 10")),this._isBrowserChrome=-1!==this._rawValue.indexOf("Chrome")&&!this._isBrowserIE,this._isBrowserChrome&&(this._isBrowserSupportedChrome=this._parseChromeVersion()>=13),this._isBrowserFirefox=-1!==this._rawValue.indexOf("Firefox"),this._isBrowserFirefox&&(this._isBrowserSupportedFirefox=this._parseFirefoxVersion()>=5),-1===this._rawValue.indexOf("Safari")||this._isBrowserIE||(-1!==this._rawValue.indexOf("Chrome")||-1!==this._rawValue.indexOf("Android")?this._isBrowserSafari=!1:this._isBrowserSafari=!0),this._isBrowserSafari&&(this._isBrowserSupportedSafari=this._parseSafariVersion()>5),this._isIPhone=-1!==this._rawValue.indexOf("iPhone"),this._isIPad=-1!==this._rawValue.indexOf("iPad"),this._isIPod=-1!==this._rawValue.indexOf("iPod"),(this._isIPhone||this._isIPad||this._isIPod)&&(this._isIOSSupported=this._parseIOSVersion()>=5),this._isAndroid=-1!==this._rawValue.indexOf("Android"),this._isAndroid&&(this._isAndroidSupported=this._parseAndroidVersion()>=4.4),this._isAndroidPhone=this._isAndroid&&-1!==this._rawValue.indexOf("Mobile"),this._isWebKit=-1!==this._rawValue.indexOf("WebKit")&&!this._isBrowserIE,this._isMac=-1!==window.navigator.appVersion.indexOf("Mac"),this._isWindows=-1!==window.navigator.appVersion.indexOf("Win")||-1!==window.navigator.appVersion.indexOf("NT"),this._isWindows80=-1!==window.navigator.appVersion.indexOf("Windows NT 6.2"),this._isWindowsDesktop=this._isWindows&&-1!==window.navigator.appVersion.indexOf("NT"),this._isWindowsPhone=this._isWindows&&-1!==window.navigator.appVersion.indexOf("Phone"),this._isWindows81=-1!==window.navigator.appVersion.indexOf("Windows NT 6.3")}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype._parseChromeVersion=function(){return this._parseVersionInteger(new RegExp("Chrome/(\\d+)"))},e.prototype._parseFirefoxVersion=function(){return this._parseVersionInteger(new RegExp("Firefox/(\\d+)"))},e.prototype._parseIOSVersion=function(){return this._parseVersionInteger(new RegExp("OS (\\d+)_(\\d+)_?(\\d+)?"))},e.prototype._parseVersionInteger=function(e){var t=this._rawValue.match(e);if(t.length>1){var n=parseInt(t[1],10);return n}return-1},e.prototype._parseSafariVersion=function(){var e="Version";return this._parseVersionFloat(e)},e.prototype._parseAndroidVersion=function(){var e="Android";return this._parseVersionFloat(e)},e.prototype._parseVersionFloat=function(e){var t=this._rawValue.indexOf(e);if(-1!==t){var n=this._rawValue.substring(t+e.length+1,t+e.length+4);return parseFloat(n)}return-1},e.prototype.getIsBrowserIE=function(){return this._isBrowserIE},e.prototype.getIsBrowserChrome=function(){return this._isBrowserChrome},e.prototype.getIsBrowserFirefox=function(){return this._isBrowserFirefox},e.prototype.getIsBrowserSafari=function(){return this._isBrowserSafari},e.prototype.getIsBrowserSupportedIE=function(){return this._isBrowserSupportedIE},e.prototype.getIsBrowserSupportedChrome=function(){return this._isBrowserSupportedChrome},e.prototype.getIsBrowserSupportedFirefox=function(){return this._isBrowserSupportedFirefox},e.prototype.getIsBrowserSupportedSafari=function(){return this._isBrowserSupportedSafari},e.prototype.getIsIPhone=function(){return this._isIPhone},e.prototype.getIsIOSSupported=function(){return this._isIOSSupported},e.prototype.getIsIPad=function(){return this._isIPad},e.prototype.getIsIPod=function(){return this._isIPod},e.prototype.getIsAndroidSupported=function(){return this._isAndroidSupported},e.prototype.getIsMac=function(){return this._isMac},e.prototype.getIsWindows=function(){return this._isWindows},e.prototype.getIsWindows80=function(){return this._isWindows80},e.prototype.getIsWindowsDesktop=function(){return this._isWindowsDesktop},e.prototype.getIsWindowsPhone=function(){return this._isWindowsPhone},e.prototype.getIsWindows81=function(){return this._isWindows81},e.prototype.getIsAndroidPhone=function(){return this._isAndroidPhone},e.prototype.getIsAndroid=function(){return this._isAndroid},e}();e.UserAgent=t}(Common||(Common={}));var getPropertyPromiseCache={},Commands;!function(e){var t="webclient",n="Recipients have Restricted Follow";!function(e){e[e.RetrievingCRMData=0]="RetrievingCRMData",e[e.AddingFollowInfo=1]="AddingFollowInfo",e[e.FinishingUp=2]="FinishingUp"}(e.FollowStep||(e.FollowStep={}));var r=e.FollowStep,o=function(e){function t(t){e.call(this,n),this._followRestrictedRecords=t}return __extends(t,e),Object.defineProperty(t.prototype,"FollowRestrictedRecords",{get:function(){return this._followRestrictedRecords},enumerable:!0,configurable:!0}),t}(Error);e.FollowRestrictedError=o;var a=function(){function a(e){this._statusUpdateCallback=e,this._emailCrmId=Common.Guid.newGuid()}return a.prototype.follow=function(){return this._statusUpdateCallback(r.RetrievingCRMData),this._resolveRecipients().then(this._resolveFollowAllowed.bind(this)).then(this._throwIfRecipientsFollowRestricted.bind(this)).then(this._retrieveEmailLinks.bind(this)).then(this._retrieveTrackingInfo.bind(this)).then(this._setTrackingInfo.bind(this)).then(this._follow.bind(this)).then(this._onSuccess.bind(this),this._onError.bind(this))},a.prototype._onSuccess=function(){Xrm.Reporting.reportSuccess(a.telemetryCommandName)},a.prototype._onError=function(t){if(t instanceof e.FollowRestrictedError){var r=[Telemetry.createParameter(Telemetry.ParameterNames.RecipientsCount,this._emailRecipients.length),Telemetry.createParameter(Telemetry.ParameterNames.RestrictedRecipientsCount,t.FollowRestrictedRecords.length)],o=new Error(n);Xrm.Reporting.reportFailure(a.telemetryCommandName,o,null,r)}else Xrm.Reporting.reportFailure(a.telemetryCommandName,t,null);throw t},a.prototype._resolveRecipients=function(){var e=this;return Common.Utils.resolveRecipients().then(function(t){e._emailRecipients=t})},a.prototype._retrieveFollowAllowed=function(e){if(this._emailRecipients&&this._emailRecipients.length){var t=this._emailRecipients.filter(function(t){return t.entityReference.Id&&t.entityReference.LogicalName===e});if(t&&t.length){var n="";return t.forEach(function(t,r){var o=0!==r?" or ":"";n+=""+o+e+"id eq "+t.entityReference.Id.guid}),Xrm.WebApi.online.retrieveMultipleRecords(e,"?$select="+Constants.PropertyNames.FollowEmail+"&$filter="+n)}}return Promise.resolve(null)},a.prototype._extendFollowAllowed=function(e,t){var n=this;this._emailRecipients&&this._emailRecipients.length&&e&&e.entities&&e.entities.length&&e.entities.forEach(function(e){var r=n._emailRecipients.find(function(n){return n.entityReference.Id&&n.entityReference.Id.guid===e[t+"id"]});r&&(r.dataValues[Constants.PropertyNames.FollowEmail]=e[Constants.PropertyNames.FollowEmail])})},a.prototype._resolveFollowAllowed=function(){var e=this;return Promise.all([this._retrieveFollowAllowed(Constants.CrmTypeNames.Lead),this._retrieveFollowAllowed(Constants.CrmTypeNames.Contact)]).then(function(t){e._extendFollowAllowed(t[0],Constants.CrmTypeNames.Lead),e._extendFollowAllowed(t[1],Constants.CrmTypeNames.Contact)})},a.prototype._throwIfRecipientsFollowRestricted=function(){var e=this._getRecipientsWithFollowRestriction(this._emailRecipients);if(e.length&&e.length>0)throw new o(e)},a.prototype._getRecipientsWithFollowRestriction=function(e){var t=[];return e.forEach(function(e){var n=e.entityReference.LogicalName,r=e.dataValues[Constants.PropertyNames.FollowEmail];n!==Constants.CrmTypeNames.Contact&&n!==Constants.CrmTypeNames.Lead||r||t.push(e.entityReference)}),t},a.prototype._retrieveEmailLinks=function(){this._statusUpdateCallback(r.AddingFollowInfo);var e={args:{crmId:this._emailCrmId.guid}};return Common.Utils.invokeExternalContextAction(Constants.ActionIds.GetEmailLinks,e)},a.prototype._retrieveTrackingInfo=function(e){var n=[Common.Utils.WebApiRequest(new ODataContract.GetEmailTrackingPixelUrlRequest(this._emailCrmId,this._emailCrmId,t))];return e.length&&n.push(Common.Utils.WebApiRequest(new ODataContract.GetEmailLinkTrackingUrlsRequest(this._emailCrmId,this._emailCrmId,t,e))),Promise.all(n).then(function(t){var n=t[0].EmailTrackingPixelUrl,r=[];if(t[1]){var o=t[1].EmailLinkTrackingUrls;r=e.map(function(t,n){return{original:e[n],replacement:o[n]}})}return{emailLinkTrackingUrlPairs:r,emailTrackingPixelUrl:n}})},a.prototype._setTrackingInfo=function(e){var t=e.emailLinkTrackingUrlPairs,n=e.emailTrackingPixelUrl,r={args:{crmId:this._emailCrmId.guid,emailLinkTrackingUrlPairsJSON:JSON.stringify(t),emailTrackingPixelUrl:n}};return Common.Utils.invokeExternalContextAction(Constants.ActionIds.SetTrackingInfo,r)},a.prototype._follow=function(){return this._statusUpdateCallback(r.FinishingUp),Common.Utils.invokeExternalContextAction(Constants.ActionIds.Follow,{args:{crmId:this._emailCrmId.guid}}).then(function(){return Common.Utils.performPageRefresh()})},a.telemetryCommandName="MailApp.Command.Follow",a}();e.FollowCommand=a}(Commands||(Commands={}));var ODataContract;!function(e){var t=function(){function e(e,t,n,r){this.TrackingId=e,this.ConversationTrackingId=t,this.ClientType=n,this.EmailLinkUrls=r}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"GetEmailLinkTrackingUrls",operationType:0,parameterTypes:{TrackingId:{typeName:"Edm.Guid",structuralProperty:1},ConversationTrackingId:{typeName:"Edm.Guid",structuralProperty:1},ClientType:{typeName:"Edm.String",structuralProperty:1},EmailLinkUrls:{typeName:"Edm.String",structuralProperty:4}}};return e},e}();e.GetEmailLinkTrackingUrlsRequest=t}(ODataContract||(ODataContract={}));var ODataContract;!function(e){var t=function(){function e(e,t,n){this.TrackingId=e,this.ConversationTrackingId=t,this.ClientType=n}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"GetEmailTrackingPixelUrl",operationType:1,parameterTypes:{TrackingId:{typeName:"Edm.Guid",structuralProperty:1},ConversationTrackingId:{typeName:"Edm.Guid",structuralProperty:1},ClientType:{typeName:"Edm.String",structuralProperty:1}}};return e},e}();e.GetEmailTrackingPixelUrlRequest=t}(ODataContract||(ODataContract={}));var ODataContract;!function(e){var t=function(){function e(e,t,n){this.TemplateId=e,this.ObjectId=t,this.ObjectType=n}return e.prototype.getMetadata=function(){var e={boundParameter:null,operationName:"InstantiateTemplate",operationType:0,parameterTypes:{TemplateId:{typeName:"Edm.Guid",structuralProperty:1},ObjectType:{typeName:"Edm.String",structuralProperty:1},ObjectId:{typeName:"Edm.Guid",structuralProperty:1}}};return e},e}();e.InstantiateTemplateRequest=t}(ODataContract||(ODataContract={}));
//# sourceMappingURL=D:\a\1\s\target\bin\Release\ts\..\uglify\MailAppSolution.js.map</script><script type="text/javascript">var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},MscrmControls;(function(MscrmControls){var Containers;(function(Containers){"use strict";var MetricObject=function(){function MetricObject(){}return MetricObject}(),MicrosoftFlowsTelemetryReporter=function(){function MicrosoftFlowsTelemetryReporter(){}MicrosoftFlowsTelemetryReporter.prototype.init=function(crmBaseUri,clientType){try{this.crmBaseUri=crmBaseUri;this.metricsReportingServiceUrl=this.crmBaseUri+"/AppWebServices/MetricsReportingService.asmx/Report";this.clientType=clientType}catch(exception){console.error(exception)}};MicrosoftFlowsTelemetryReporter.prototype.getBaseWindowUrl=function(){var protocol=location.protocol,hostName=location.hostname,port=location.port?":"+location.port:"";return protocol+"//"+hostName+port};MicrosoftFlowsTelemetryReporter.prototype.logFlowTelemetryEvent=function(eventName,properties){if(properties===void 0)properties=null;this.sendMetric("MsFlow"+eventName,properties)};MicrosoftFlowsTelemetryReporter.prototype.logFlowAuthenticationEvent=function(tenantId,result,timeTaken,isSilent){var metricProperties={TenantId:tenantId,Result:result,TimeTaken:timeTaken,IsSilent:isSilent};this.sendMetric("MsFlowUserAuthentication",metricProperties)};MicrosoftFlowsTelemetryReporter.prototype.logFlowTriggerEvent=function(tenantId,noOfEntityRecords,noOfProperties,entityLogicalName,flowId,flowRunResult,environmentId,flowTriggerWidgetInitTimeMs,authTokenRetrievalTimeMs,dataRetrievalTimeMs,userRunButtonClickTimeMs){var metricProperties={TenantId:tenantId,NoOfEntityRecords:noOfEntityRecords,NoOfProperties:noOfProperties,EntityLogicalName:entityLogicalName,FlowId:flowId,FlowRunResult:flowRunResult,FlowEnvironmentId:environmentId,FlowTriggerWidgetInitTimeMs:flowTriggerWidgetInitTimeMs,AuthTokenRetrievalTimeMs:authTokenRetrievalTimeMs,DataRetrievalTimeMs:dataRetrievalTimeMs,UserRunButtonClickTimeMs:userRunButtonClickTimeMs};this.sendMetric("MsFlowTriggered",metricProperties)};MicrosoftFlowsTelemetryReporter.prototype.logFlowErrorEvent=function(tenantId,env,errorSource,response,methodName,errMsg){if(methodName==="AttemptToSilentlyAuthenticate")response="";if(response&&response.stack)response=JSON.stringify(response.stack);if(errMsg&&errMsg.message)errMsg=JSON.stringify(errMsg.message);var metricProperties={TenantId:tenantId,FlowEnvironmentId:env,ErrorSource:errorSource,Response:response,MethodName:methodName,IsFailure:true,ErrorMessage:errMsg};this.sendMetric("MsFlowError",metricProperties)};MicrosoftFlowsTelemetryReporter.prototype.logFlowDefinitionsListEvent=function(tenantId,env,numDefinitionsLoaded,timeToLoadDefinitionsMs,timetoLoadDefFromService,entityLogicalName){var metricProperties={TenantId:tenantId,FlowEnvironmentId:env,NumDefinitionsLoaded:numDefinitionsLoaded,TimeToLoadDefinitionsMs:timeToLoadDefinitionsMs,TimetoLoadDefFromService:timetoLoadDefFromService,EntityLogicalName:entityLogicalName};this.sendMetric("MsFlowDefinitionsList",metricProperties)};MicrosoftFlowsTelemetryReporter.prototype.sendMetric=function(name,properties){var _this=this;try{var _window=window;if(_window.Xrm&&_window.Xrm.Internal&&_window.Xrm.Internal.addMetric){_window.Xrm.Internal.addMetric(name,properties);return Promise.resolve()}var outerRequest={request:{MetricsCollections:[{RequestId:this.newGuid(),Metrics:[{n:name,p:properties,t:Date.now()}]}]}};return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("POST",_this.metricsReportingServiceUrl,true);xhr.setRequestHeader("Content-type","application/json");_this.clientType&&xhr.setRequestHeader("ClientAppName",_this.clientType);xhr.onload=function(){var status=xhr.status;if(status===200||status===204)resolve(xhr.response);else reject(status)};xhr.send(JSON.stringify(outerRequest))})}catch(ex){}};MicrosoftFlowsTelemetryReporter.prototype.newGuid=function(){return "xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==="x"?r:r&3|8;return v.toString(16)})};return MicrosoftFlowsTelemetryReporter}();Containers.MicrosoftFlowsTelemetryReporter=MicrosoftFlowsTelemetryReporter})(Containers=MscrmControls.Containers||(MscrmControls.Containers={}))})(MscrmControls||(MscrmControls={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ActivateLibraryLegacy=function(){function ActivateLibraryLegacy(){this.activateRecordsLegacy=function(gridControl,records,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.activate(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.activate(gridControl,records,entityTypeCode)};this.activateRecords=function(gridControl,records,entityName,callback){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.activate(gridControl,records,entityTypeCode,callback):backCompatHeader.Mscrm.GridCommandActions.activate(gridControl,records,entityTypeCode)}}ActivateLibraryLegacy.prototype.activatePrimaryRecord=function(id,entityName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.activate(id,entityName):backCompatHeader.Mscrm.CommandBarActions.activate(id,entityName)};return ActivateLibraryLegacy}();Commands.ActivateLibraryLegacy=ActivateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ActivateLibrary=function(){function ActivateLibrary(){var _this=this;this.activateRecordsLegacy=function(gridControl,records,entityTypeCode){_this.activateRecords(gridControl,records,Xrm.Internal.getEntityName(entityTypeCode))}}ActivateLibrary.prototype.activatePrimaryRecord=function(id,entityName){Commands.Common.changeState(entityName,id,true)};ActivateLibrary.prototype.activateRecords=function(gridControl,records,entityName,callback){if(!records.length){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")});return}if(records.length>1&&(entityName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.KnowledgeSearchModel||entityName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.TopicModel)){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Action_Too_Many_Custom_Messages_Selected_Alert")});return}var dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=records;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.action]=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.activate;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId]=-1;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StatusId]=-1;var dialogCallbackParams={},options=null,client=Xrm.Utility.getGlobalContext().client.getClient();if(client===Xrm.Constants.ClientNames.web||client==Xrm.Constants.ClientNames.outlook||client==Xrm.Constants.ClientNames.unifiedServiceDesk)options={height:250,width:600,position:1};Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.SetStateDialog,options,dialogParams).then(function(successParameter){Commands.Common.closeSetStateDialogFromGridCallback(successParameter.parameters,dialogCallbackParams,gridControl,callback)})};return ActivateLibrary}();Commands.ActivateLibrary=ActivateLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Activate=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.ActivateLibrary:new Commands.ActivateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddLibraryLegacy=function(){function AddLibraryLegacy(){var _this=this;this.AddActivityFromGrid=function(activityTypeName,contentId,entityReference){_this.addActivityFromGrid(activityTypeName,contentId,entityReference)};this.addActivityFromGrid=function(activityTypeName,contentId,entityReference){if(typeof activityTypeName==="number")activityTypeName=Xrm.Internal.getEntityName(activityTypeName);_this.addActivityFromGridLegacy(Xrm.Internal.getEntityCode(activityTypeName),contentId,entityReference)};this.addActivityFromGridLegacy=function(activityTypeCode,contentId,entityReference){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.GridRibbonActions&&Mscrm.GridRibbonActions.addActivityFromGrid)Mscrm.GridRibbonActions.addActivityFromGrid(activityTypeCode,contentId,entityReference);else backCompatHeader.Mscrm.GridRibbonActions.addActivityFromGrid(activityTypeCode,contentId,entityReference)};this.addActivityToFormFromsubgrid=function(activityType,parentId,parentType){var activityCode=Xrm.Internal.getEntityCode(activityType),parentCode=Xrm.Internal.getEntityCode(parentType);_this.addActivityToFormFromsubgridLegacy(activityCode,parentId,parentCode)};this.addActivityToFormFromsubgridLegacy=function(activityType,parentId,parentType){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.AddActivity&&Mscrm.AddActivity.addActivityToFormFromsubgrid)Mscrm.AddActivity.addActivityToFormFromsubgrid(activityType,parentId,parentType);else backCompatHeader.Mscrm.AddActivity.addActivityToFormFromsubgrid(activityType,parentId,parentType)};this.AddActivityOnForm=function(activityTypeName,contentId){_this.addActivityToForm(activityTypeName,contentId)};this.AddActivityToForm=function(activityTypeName,contentId){_this.addActivityToForm(activityTypeName,contentId)};this.addActivityOnForm=function(activityTypeName,contentId){_this.addActivityToForm(activityTypeName,contentId)};this.addActivityToForm=function(activityTypeName,contentId){if(typeof activityTypeName==="number")activityTypeName=Xrm.Internal.getEntityName(activityTypeName);var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.RibbonActions&&Mscrm.RibbonActions.addActivityOnForm)Mscrm.RibbonActions.addActivityOnForm(Xrm.Internal.getEntityCode(activityTypeName),contentId);else backCompatHeader.Mscrm.RibbonActions.addActivityOnForm(Xrm.Internal.getEntityCode(activityTypeName),contentId)};this.AddActivityToFormLegacy=function(activityType,contentId){_this.addActivityToFormLegacy(activityType,contentId)};this.addActivityToFormLegacy=function(activityType,contentId){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.RibbonActions&&Mscrm.RibbonActions.addActivityOnForm)Mscrm.RibbonActions.addActivityOnForm(activityType,contentId);else backCompatHeader.Mscrm.RibbonActions.addActivityOnForm(activityType,contentId)};this.addConnectionFromForm=function(objectId,objectTypeCode,primaryControl,connectToMe,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.RibbonActions&&Mscrm.RibbonActions.addConnectionFromForm)Mscrm.RibbonActions.addConnectionFromForm(objectId,objectTypeCode,primaryControl,connectToMe,gridControl);else backCompatHeader.Mscrm.RibbonActions.addConnectionFromForm(objectId,objectTypeCode,primaryControl,connectToMe,gridControl)}}return AddLibraryLegacy}();Commands.AddLibraryLegacy=AddLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddLibrary=function(){function AddLibrary(){var _this=this;this.AddActivityOnForm=function(activityTypeName,contentId){_this.addActivityToForm(activityTypeName,contentId)};this.AddActivityToForm=function(activityTypeName,contentId){_this.addActivityToForm(activityTypeName,contentId)};this.addActivityOnForm=function(activityTypeName,contentId){_this.addActivityToForm(activityTypeName,contentId)};this.addActivityToForm=function(activityTypeName,contentId){if(typeof activityTypeName==="number")activityTypeName=Xrm.Internal.getEntityName(activityTypeName);var entity=Xrm.Page.data.entity;entity&&entity.getId()&&entity.getEntityName()&&entity.getPrimaryAttributeValue()&&_this._genericAddActivityInternal(activityTypeName,contentId,entity.getId(),entity.getEntityName(),entity.getPrimaryAttributeValue())};this.AddActivityToFormLegacy=function(activityTypeCode,contentId){_this.addActivityToFormLegacy(activityTypeCode,contentId)};this.addActivityToFormLegacy=function(activityTypeCode,contentId){_this.AddActivityToForm(Xrm.Internal.getEntityName(activityTypeCode),contentId)};this.addActivityToFormFromsubgrid=function(activityType,parentId,parentType,gridControl){var parentName=Xrm.Page.data.entity.getPrimaryAttributeValue();_this._genericAddActivityInternal(activityType,null,parentId,parentType,parentName,gridControl)};this.addActivityToFormFromsubgridLegacy=function(activityType,parentId,parentType){var activityTypeName=Xrm.Internal.getEntityName(activityType),parentTypeName=Xrm.Internal.getEntityName(parentType);_this.addActivityToFormFromsubgrid(activityTypeName,parentId,parentTypeName)};this.AddActivityFromGridLegacy=function(activityType,contentId,entityReference){_this.addActivityFromGridLegacy(activityType,contentId,entityReference)};this.addActivityFromGridLegacy=function(activityType,contentId,entityReference){if(typeof activityType!=="number")activityType=parseInt(activityType,10);var activityTypeName=Xrm.Internal.getEntityName(activityType);_this.AddActivityFromGrid(activityTypeName,contentId,entityReference)};this.AddActivityFromGrid=function(activityTypeName,contentId,entityReference){_this.addActivityFromGrid(activityTypeName,contentId,entityReference)};this.addActivityFromGrid=function(activityTypeName,contentId,entityReference){if(typeof activityTypeName==="number")activityTypeName=Xrm.Internal.getEntityName(activityTypeName);_this._addActivityToSelectedObject(activityTypeName,contentId,entityReference[0])};this.addConnectionFromForm=function(objectId,objectTypeCode,primaryControl,connectToMe,gridControl){var data={},parentEntityTypeName=Xrm.Page.data.entity.getEntityName(),parentEntityName=Xrm.Page.data.entity.getPrimaryAttributeValue(),fromEntity={id:objectId,name:parentEntityName,entityType:parentEntityTypeName};if(connectToMe){var formContext=Xrm.Page;data={record2id:{entityType:XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser,id:formContext.context.getUserId(),name:formContext.context.getUserName()},record1id:fromEntity}}else data={record1id:fromEntity};var openOptions={entityName:XrmCore.InternalUtilities.EntityUtilities.EntityNames.Connection};Xrm.Navigation.openForm(openOptions,data)};this._addActivityToSelectedObject=function(activityTypeName,contentId,entityReference){_this._genericAddActivityInternal(activityTypeName,contentId,entityReference.Id,entityReference.TypeName,entityReference.Name)};this._genericAddActivityInternal=function(activityTypeName,contentId,parentId,parentTypeName,parentName,gridControl){var partyId=null,partyType=null,partyName=null,partyLocation="";if(activityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.PhoneCall){var phoneCallCustomerValue=_this._getPhoneCallCustomerForEntity(parentTypeName,parentName,parentId);if(phoneCallCustomerValue&&phoneCallCustomerValue.Id&&phoneCallCustomerValue.Name&&phoneCallCustomerValue.Typename){partyId=phoneCallCustomerValue.Id;partyName=phoneCallCustomerValue.Name;partyType=phoneCallCustomerValue.Typename}if(parentTypeName==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account||parentTypeName==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact||parentTypeName==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Lead){var partyAttribute=Xrm.Page.getAttribute("telephone1");if(partyAttribute&&partyAttribute.getValue()!=null)partyLocation=partyAttribute.getValue().toString()}}else if(activityTypeName!=XrmCore.InternalUtilities.EntityUtilities.EntityNames.Task)switch(parentTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Lead:partyId=parentId;partyType=parentTypeName;partyName=parentName;var partyAttribute=null;switch(activityTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Fax:if(Xrm.Page.data){partyAttribute=Xrm.Page.getAttribute("fax");var partyAttribute1=Xrm.Page.getAttribute("address1_fax");if(partyAttribute&&partyAttribute.getValue()!=null)partyLocation=partyAttribute.getValue().toString();if(partyAttribute1){var partyLocation1=partyAttribute1.getValue();if(partyLocation1)if(partyLocation)partyLocation+=";"+partyLocation1;else partyLocation=partyLocation1}}break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Letter:if(Xrm.Page.data!=null){partyAttribute=Xrm.Page.getAttribute("address1_name");if(partyAttribute)partyLocation=partyAttribute.getValue()}break}break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Incident:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Opportunity:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Quote:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Invoice:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesOrder:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contract:var partyElement=_this._getPartyDetailsForRefreshForm(parentTypeName);if(partyElement){partyId=partyElement.Id;partyType=partyElement.Typename;partyName=partyElement.Name}break;default:if(activityTypeName==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email&&Xrm.Internal.getEntityCode(parentTypeName)>=Xrm.Internal.getEntityCode(XrmCore.InternalUtilities.EntityUtilities.EntityNames.BaseAddEntityObjectTypeCode)){partyId=parentId;partyType=parentTypeName;partyName=parentName}break}_this._addActivityTo(activityTypeName,parentId,parentTypeName,parentName,partyId,partyType,partyName,partyLocation,contentId,gridControl)};this._getPartyDetailsForRefreshForm=function(entityTypeName){var partyElement=null;if(Xrm.Page.data&&Xrm.Page.data.entity){var entityUI=Xrm.Page.data.entity;switch(entityTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Incident:partyElement=_this._getCustomerForIncident();break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Opportunity:partyElement=_this._getCustomerForOppurtunity();break;default:var attributes=entityUI.attributes;if(entityUI.attributes){var customerId=entityUI.attributes.get("customerid");if(customerId)partyElement=_this.getFirstLookupItem(customerId.getValue())}break}}return partyElement};this._getCustomerForOppurtunity=function(){for(var attributeNames=["parentcontactid","parentaccountid","parentaccountid"],_i=0,attributeNames_1=attributeNames;_i<attributeNames_1.length;_i++){var attributeName=attributeNames_1[_i],attribute=Xrm.Page.getAttribute(attributeName);if(attribute)return _this.getFirstLookupItem(attribute.getValue())}return null};this._getCustomerForIncident=function(){var customer=Xrm.Page.getAttribute("customerid"),contact=Xrm.Page.getAttribute("primarycontactid"),customerlookup=null,contactlookup=null;if(customer!=null)customerlookup=_this.getFirstLookupItem(customer.getValue());if(contact!=null)contactlookup=_this.getFirstLookupItem(contact.getValue());if(customerlookup!=null&&contactlookup==null)return customerlookup;else if(customerlookup&&contactlookup&&customerlookup.Typename==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account)return contactlookup;return customerlookup};this._getPhoneCallCustomerForEntity=function(parentTypeName,parentName,parentId){if(!parentName||parentName==="")parentName=Xrm.Page.data.entity.getPrimaryAttributeValue();var phoneCallCustomerValue=null,getEntityTypeCode=Xrm.Internal.getEntityCode;switch(parentTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Incident:var customerIdAttribute=Xrm.Page.getAttribute("customerid");phoneCallCustomerValue=customerIdAttribute?_this.getFirstLookupItem(customerIdAttribute.getValue()):null;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account:var primaryContact=Xrm.Page.getAttribute("primarycontactid");if(primaryContact&&primaryContact.getValue())phoneCallCustomerValue=_this.getFirstLookupItem(primaryContact.getValue());else if(parentId&&parentName){var entityTypeName=XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account;phoneCallCustomerValue={Id:parentId,Name:parentName,Type:getEntityTypeCode(entityTypeName).toString(),Typename:entityTypeName}}break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:if(parentId&&parentName){var entityTypeName=XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact;phoneCallCustomerValue={Id:parentId,Name:parentName,Type:getEntityTypeCode(entityTypeName).toString(),Typename:entityTypeName}}break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Opportunity:var parentContactId=Xrm.Page.getAttribute("parentcontactid");if(parentContactId)phoneCallCustomerValue=_this.getFirstLookupItem(parentContactId.getValue());var parentAccount=Xrm.Page.getAttribute("parentaccountid");if(parentAccount&&!phoneCallCustomerValue)phoneCallCustomerValue=_this.getFirstLookupItem(parentAccount.getValue());break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Lead:var parentContact=Xrm.Page.getAttribute("parentcontactid");if(parentContact&&parentContact.getValue())phoneCallCustomerValue=_this.getFirstLookupItem(parentContact.getValue());else if(parentId&&parentName){var entityTypeName=XrmCore.InternalUtilities.EntityUtilities.EntityNames.Lead;phoneCallCustomerValue=phoneCallCustomerValue={Id:parentId,Name:parentName,Type:getEntityTypeCode(entityTypeName).toString(),Typename:entityTypeName}}break;default:break}return phoneCallCustomerValue};this.getFirstLookupItem=function(parameterCustomerValue){var parameterReturnType=null;if(Array.isArray(parameterCustomerValue)&&parameterCustomerValue.length>0&&parameterCustomerValue[0].id&&parameterCustomerValue[0].name&&parameterCustomerValue[0].entityType)parameterReturnType={Id:parameterCustomerValue[0].id,Name:parameterCustomerValue[0].name,Type:Xrm.Internal.getEntityCode(parameterCustomerValue[0].entityType).toString(),Typename:parameterCustomerValue[0].entityType};return parameterReturnType};this._addActivityTo=function(activityTypeName,id,type,name,partyId,partyType,partyName,location,contentId,gridControl){var parameters={};if(id&&type&&activityTypeName!=XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse){var lookupValue={id:id,name:name,entityType:type};parameters["regardingobjectid"]=JSON.stringify(lookupValue)}if(partyId){var partyLookupList=[{id:partyId,name:partyName,entityType:partyType}],temp=JSON.stringify(partyLookupList);parameters["partyaddressused"]="";parameters["contactInfo"]=location;switch(activityTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email:parameters["to"]=temp;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Appointment:parameters["requiredattendees"]=temp;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PhoneCall:parameters["to"]=temp;break;default:break}}if(contentId)parameters["contentId"]=contentId;var options={};options.entityName=activityTypeName;options.useQuickCreateForm=true;if(gridControl&&gridControl.getRelationship&&gridControl.getRelationship()!=null&&gridControl.getRelationship().relationshipType==0){options.relationship=gridControl.getRelationship();var parentControl=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page;if(parentControl&&parentControl.data&&parentControl.data.entity&&parentControl.data.entity.getEntityReference)options.createFromEntity=parentControl.data.entity.getEntityReference()}Xrm.Navigation.openForm(options,parameters).then(function(){gridControl!=null&&gridControl!=undefined&&gridControl.refresh()})}}return AddLibrary}();Commands.AddLibrary=AddLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Add=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.AddLibrary:new Commands.AddLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Common;(function(Common){var EntitySpecificOverrideBase=function(){function EntitySpecificOverrideBase(entityName){this.overrideMethods={};this.entityName=entityName}EntitySpecificOverrideBase.prototype.call=function(method){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];if(this.overrideMethods&&this.overrideMethods[method]&&this.overrideMethods[method][this.entityName]){var childArgs=[method];childArgs.push.apply(childArgs,args);return this[this.overrideMethods[method][this.entityName]].apply(this,childArgs)}else return this[method].apply(this,args)};return EntitySpecificOverrideBase}();Common.EntitySpecificOverrideBase=EntitySpecificOverrideBase})(Common=XrmCore.Common||(XrmCore.Common={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddExistingFromSubGridBase=function(_super){__extends(AddExistingFromSubGridBase,_super);function AddExistingFromSubGridBase(){_super.apply(this,arguments)}AddExistingFromSubGridBase.prototype.addExistingFromSubGrid=function(gridTypeName,gridControl){var subGridControl=gridControl;if(subGridControl){var gridControlType=subGridControl.getGridType?subGridControl.getGridType():3;if(gridControlType===3||gridControlType===2)return this.call("openLookupRecord",gridTypeName,gridControl)}return false};AddExistingFromSubGridBase.prototype.openLookupRecord=function(gridTypeName,gridControl){var parentForm=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,currentEntity={entityType:parentForm.data.entity.getEntityName(),name:parentForm.data.entity.getPrimaryAttributeValue(),id:parentForm.data.entity.getId().replace("{","").replace("}","")},currentPage=Xrm.Internal.getCurrentPageUrl?Xrm.Internal.getCurrentPageUrl(currentEntity):null;if(currentPage&&-1!==currentPage.indexOf("pagetype=dashboard"))return false;return this.call("lookupRecord",gridTypeName,gridControl)};AddExistingFromSubGridBase.prototype.lookupRecord=function(gridTypeName,gridControl){var subGridControl=gridControl,relationship=subGridControl&&subGridControl.getRelationship?subGridControl.getRelationship():null;if(subGridControl){var entityName=gridControl&&gridControl.getEntityName?gridControl.getEntityName():"",lookup=Xrm.Utility.lookupObjects?Xrm.Utility.lookupObjects({allowMultiSelect:relationship?relationship.relationshipType===1:false,defaultEntityType:entityName,entityTypes:[entityName],lookupType:"Lookup.Simple"}):null;if(lookup){var _this_1=this;lookup.then(function(lookupValues){return _this_1.call("associateRecords",lookupValues,gridTypeName,gridControl)})}return true}return false};AddExistingFromSubGridBase.prototype.associateRecords=function(lookupValues,gridTypeName,gridControl){var _this=this;if(!lookupValues||lookupValues.length===0)return;var subGridControl=gridControl,relationship=subGridControl&&subGridControl.getRelationship?subGridControl.getRelationship():null,relationshipAttributeName=relationship?relationship.attributeName:null,parentForm=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,parentId=parentForm.data.entity.getId().replace("{","").replace("}",""),parentEntity=parentForm.data.entity.getEntityName();if(!XrmCore.InternalUtilities.DialogUtilities.isOffline()){var requests_1=[],requestsPromises=[],_loop_1=function(key){var lookupValue=lookupValues[key],newRequest=Xrm.WebApi.retrieveRecord(lookupValue.entityType,lookupValue.id.toString());newRequest.then(function(childEntity){if(relationship&&relationship.relationshipType===0){var relationshipState=_this.getRelationshipStateOneToMany(lookupValue,childEntity,parentId,relationshipAttributeName,parentEntity);switch(relationshipState){case 0:Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Parent_Record_AlreadyExists")});return;case 2:return}}var request;if(gridControl.getTeamTemplateId&&gridControl.getTeamTemplateId()!==null)request=_this.call("createAddUserToRecordTeamRequest",lookupValue,gridControl);else request=_this.call("createAssociateRequest",lookupValue,gridControl,relationship);request&&requests_1.push(request)});requestsPromises.push(newRequest)};for(var key in lookupValues)_loop_1(key);Promise.all(requestsPromises).then(function(){if(0<requests_1.length)if(requests_1.length==1)Xrm.WebApi.online.execute(requests_1[0]).then(function(success){gridControl&&gridControl.refresh()},function(error){_this.onError(error,gridControl)});else Xrm.WebApi.online.executeMultiple(requests_1).then(function(success){XrmCore.InternalUtilities.DialogUtilities.onGridActionMultipleSuccess(gridControl,success)},function(error){_this.onError(error,gridControl)})},function(error){_this.onError(error,gridControl)})}else{var retrieveOptions="?$select="+relationshipAttributeName;Xrm.WebApi.retrieveRecord(lookupValues[0].entityType,lookupValues[0].id.toString(),retrieveOptions).then(function(childEntity){var relationshipState=_this.getRelationshipStateOneToMany(lookupValues[0],childEntity,parentId,relationshipAttributeName,parentEntity);if(relationshipState===2)return;if(relationshipState===0){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Parent_Record_AlreadyExists")});return}var regardingLookup={logicalname:parentEntity,id:parentId},updateEntityRecord={};updateEntityRecord[relationshipAttributeName]=regardingLookup;Xrm.WebApi.updateRecord(lookupValues[0].entityType,lookupValues[0].id.toString(),updateEntityRecord).then(function(entity){gridControl&&gridControl.refresh()},function(error){_this.onError(error,gridControl)})},function(error){_this.onError(error,gridControl)})}};AddExistingFromSubGridBase.prototype.createAssociateRequest=function(lookupValue,gridControl,relationship){var parentForm=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,parentEntity=parentForm.data.entity.getEntityName(),parentId=parentForm.data.entity.getId().replace("{","").replace("}",""),childEntity=lookupValue.entityType||lookupValue.entityName,childId=lookupValue.id.replace("{","").replace("}",""),shouldSwapParentChild=relationship&&relationship.roleType===2&&relationship.relationshipType===1,request={getMetadata:function(){var ODataMetadata={boundParameter:null,parameterTypes:{},operationName:"Associate",operationType:2};return ODataMetadata},target:{id:shouldSwapParentChild?childId:parentId,entityType:shouldSwapParentChild?childEntity:parentEntity},relatedEntities:[{id:shouldSwapParentChild?parentId:childId,entityType:shouldSwapParentChild?parentEntity:childEntity}],relationship:relationship&&relationship.name};return request};AddExistingFromSubGridBase.prototype.createAddUserToRecordTeamRequest=function(lookupValue,gridControl){if(lookupValue&&lookupValue.id&&lookupValue.entityType){var userType=lookupValue.entityType,userId=lookupValue.id.replace("{","").replace("}",""),parentForm=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page;if(!parentForm||!parentForm.data||!parentForm.data.entity||!parentForm.data.entity.getEntityName||!parentForm.data.entity.getId)return null;var recordType=parentForm.data.entity.getEntityName(),recordId=parentForm.data.entity.getId().replace("{","").replace("}",""),user={id:userId,entityType:userType},record={id:recordId,entityType:recordType},teamTemplate={id:gridControl.getTeamTemplateId(),entityType:"teamtemplate"},request=new XrmCore.SdkContracts.AddUserToRecordTeamRequest(user,record,teamTemplate);return request}return null};AddExistingFromSubGridBase.prototype.onError=function(error,gridControl){gridControl.refresh();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)};AddExistingFromSubGridBase.prototype.getRelationshipStateOneToMany=function(lookupValue,childEntity,parentId,relationshipAttributeName,parentEntity){var isModifiable=parentEntity===XrmCore.InternalUtilities.EntityUtilities.EntityNames.Territory&&lookupValue.entityType===XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser&&relationshipAttributeName==="territoryid",relatedEntityId=childEntity["_"+relationshipAttributeName+"_value"];return relatedEntityId&&!isModifiable?relatedEntityId.toLowerCase()===parentId.toLowerCase()?2:0:1};return AddExistingFromSubGridBase}(XrmCore.Common.EntitySpecificOverrideBase);Commands.AddExistingFromSubGridBase=AddExistingFromSubGridBase})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var GRID_TYPE_INLINE_SUB_GRID=3,GRID_TYPE_ASSOCIATED=2;Commands.ADD_EXISTING_FROM_SUB_GRID_OVERRIDES={addExistingFromSubGrid:{knowledgearticle:"translateArticle",connection:"openCaseResearchFlyout",contact:"checkInParentAndInvoke",account:"checkInParentAndInvoke",lead:"checkInParentAndInvoke",list:"checkInParentAndInvokeFromRelationship",campaign:"checkInParentAndInvokeFromRelationship",campaignactivity:"checkInParentAndInvokeFromRelationship"},openLookupRecord:{activitypointer:"openActivityMenu"},lookupRecord:{opportunityproduct:"openProductLookup",quotedetail:"openProductLookup",salesorderdetail:"openProductLookup",invoicedetail:"openProductLookup"},associateRecords:{list:"associateRecordsList",campaign:"associateRecordsCampaign",product:"associateRecordsProduct",systemuser:"associateRecordsSystemUser"},createAssociateRequest:{contact:"createAssociateRequestContact",list:"createAssociateRequestList",campaignactivity:"createAssociateRequestCampaignActivity",campaign:"createAssociateRequestCampaign",account:"createAssociateRequestAccount",systemuser:"createAssociateRequestSystemUser",lead:"createAssociateRequestLead",queue:"createAssociateRequestQueue",product:"createAssociateRequestProduct"}};var AddExistingFromSubGrid=function(_super){__extends(AddExistingFromSubGrid,_super);function AddExistingFromSubGrid(){_super.apply(this,arguments);this.overrideMethods=Commands.ADD_EXISTING_FROM_SUB_GRID_OVERRIDES}AddExistingFromSubGrid.prototype.translateArticle=function(base,gridTypeName,gridControl){return this[base](gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.openCaseResearchFlyout=function(base,gridTypeName,gridControl){return this[base](gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.checkInParentAndInvoke=function(base,gridTypeName,gridControl){return this[base](gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.checkInParentAndInvokeFromRelationship=function(base,gridTypeName,gridControl){return this[base](gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.openActivityMenu=function(base,gridTypeName,gridControl){return this[base](gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.openProductLookup=function(base,gridTypeName,gridControl){return this[base](gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.associateRecordsList=function(base,lookupValues,gridTypeName,gridControl){this[base](lookupValues,gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.associateRecordsCampaign=function(base,lookupValues,gridTypeName,gridControl){this[base](lookupValues,gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.associateRecordsProduct=function(base,lookupValues,gridTypeName,gridControl){this[base](lookupValues,gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.associateRecordsSystemUser=function(base,lookupValues,gridTypeName,gridControl){this[base](lookupValues,gridTypeName,gridControl)};AddExistingFromSubGrid.prototype.createAssociateRequestContact=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestList=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestAccount=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestCampaign=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestCampaignActivity=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestProduct=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestQueue=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestLead=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};AddExistingFromSubGrid.prototype.createAssociateRequestSystemUser=function(base,lookupValue,gridControl,relationship){return this[base](lookupValue,gridControl,relationship)};return AddExistingFromSubGrid}(Commands.AddExistingFromSubGridBase);Commands.AddExistingFromSubGrid=AddExistingFromSubGrid})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddExistingFromSubGridStandardBase=function(_super){__extends(AddExistingFromSubGridStandardBase,_super);function AddExistingFromSubGridStandardBase(){_super.apply(this,arguments)}AddExistingFromSubGridStandardBase.prototype.addExistingFromSubGridStandard=function(gridTypeName,gridControl){var subGridControl=gridControl;!this.call("addExistingFromSubGrid",gridTypeName,gridControl)&&subGridControl&&this.call("locAssoc",gridTypeName,gridControl)};AddExistingFromSubGridStandardBase.prototype.locAssoc=function(gridTypeName,gridControl){var subGridControl=gridControl;if(subGridControl){var entityName=gridControl&&gridControl.getEntityName?gridControl.getEntityName():"",lookup=Xrm.Utility.lookupObjects?Xrm.Utility.lookupObjects({allowMultiSelect:true,defaultEntityType:entityName,entityTypes:[entityName],lookupType:"Lookup.PartyList"}):null;if(lookup){var _this_2=this;lookup.then(function(lookupValues){return _this_2.call("associateOneToManyRecords",lookupValues,gridControl,false)})}}};AddExistingFromSubGridStandardBase.prototype.associateOneToManyRecords=function(lookupValues,gridControl,overrideParent){if(!lookupValues||lookupValues.length===0)return;var subGridControl=gridControl,relationship=subGridControl&&subGridControl.getRelationship?subGridControl.getRelationship():null;if(relationship){var parentForm=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,parentEntity=parentForm.data.entity.getEntityName(),parentId_1=parentForm.data.entity.getId().replace("{","").replace("}","");Xrm.Utility.getEntityMetadata(parentEntity).then(function(metadata){var recordCount=lookupValues.length,updatedRecords=0,updateRecord=function(lookupValue){var data={"@odata.type":"#Microsoft.Dynamics.CRM."+lookupValue.entityType};data[relationship.navigationPropertyName+"@odata.bind"]="/"+metadata.EntitySetName+"("+parentId_1+")";Xrm.WebApi.updateRecord(lookupValue.entityType,lookupValue.id,data).then(function(response){updatedRecords++;updatedRecords===recordCount&&gridControl&&gridControl.refresh&&gridControl.refresh()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)},_loop_2=function(key){var lookupValue=lookupValues[key];if(overrideParent)updateRecord(lookupValue);else Xrm.WebApi.retrieveRecord(lookupValue.entityType,lookupValue.id).then(function(entity){!entity[relationship.attributeName]&&updateRecord(lookupValue)})};for(var key in lookupValues)_loop_2(key)})}};return AddExistingFromSubGridStandardBase}(Commands.AddExistingFromSubGrid);Commands.AddExistingFromSubGridStandardBase=AddExistingFromSubGridStandardBase})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddExistingFromSubGridStandard=function(_super){__extends(AddExistingFromSubGridStandard,_super);function AddExistingFromSubGridStandard(){_super.apply(this,arguments);this.overrideMethods=AddExistingFromSubGridStandard.AddOverrideMethods(Commands.ADD_EXISTING_FROM_SUB_GRID_OVERRIDES)}AddExistingFromSubGridStandard.AddOverrideMethods=function(overrideMethods){overrideMethods["locAssoc"]={goal:"locAssocObjGoal"};overrideMethods["associateOneToManyRecords"]={territory:"associateOneToManyRecordsOverrideParent",mobileofflineprofile:"associateOneToManyRecordsOverrideParent"};return overrideMethods};AddExistingFromSubGridStandard.prototype.locAssocObjGoal=function(base,gridTypeName,gridControl){this[base](gridTypeName,gridControl)};AddExistingFromSubGridStandard.prototype.associateOneToManyRecordsOverrideParent=function(base,lookupValues,gridControl,overrideParent){this[base](lookupValues,gridControl,true)};return AddExistingFromSubGridStandard}(Commands.AddExistingFromSubGridStandardBase);Commands.AddExistingFromSubGridStandard=AddExistingFromSubGridStandard})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddFromSubGridLibraryLegacy=function(){function AddFromSubGridLibraryLegacy(){}AddFromSubGridLibraryLegacy.prototype.addExistingFromSubGridAssociated=function(gridTypeName,gridControl){var gridTypeCode=Xrm.Internal.getEntityCode(gridTypeName),backCompatHeader=window.parent;Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.addExistingFromSubGridAssociated(gridTypeCode,gridControl):backCompatHeader.Mscrm.GridCommandActions.addExistingFromSubGridAssociated(gridTypeCode,gridControl)};AddFromSubGridLibraryLegacy.prototype.addExistingFromSubGridStandard=function(gridTypeName,gridControl){var gridTypeCode=Xrm.Internal.getEntityCode(gridTypeName),backCompatHeader=window.parent;Mscrm&&Mscrm.GridCommandActions&&Mscrm.GridControl?Mscrm.GridCommandActions.addExistingFromSubGridStandard(gridTypeCode,gridControl):backCompatHeader.Mscrm.GridCommandActions.addExistingFromSubGridStandard(gridTypeCode,gridControl)};return AddFromSubGridLibraryLegacy}();Commands.AddFromSubGridLibraryLegacy=AddFromSubGridLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddFromSubGridLibrary=function(){function AddFromSubGridLibrary(){}AddFromSubGridLibrary.prototype.addExistingFromSubGridAssociated=function(gridTypeName,gridControl){var entityName=gridControl&&gridControl.getEntityName?gridControl.getEntityName():"",addExisting=new Commands.AddExistingFromSubGrid(entityName);addExisting.call("addExistingFromSubGrid",gridTypeName,gridControl)};AddFromSubGridLibrary.prototype.addExistingFromSubGridStandard=function(gridTypeName,gridControl){var entityName=gridControl&&gridControl.getEntityName?gridControl.getEntityName():"",addExisting=new Commands.AddExistingFromSubGridStandard(entityName);addExisting.addExistingFromSubGridStandard(gridTypeName,gridControl)};return AddFromSubGridLibrary}();Commands.AddFromSubGridLibrary=AddFromSubGridLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.AddFromSubGrid=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.AddFromSubGridLibrary:new Commands.AddFromSubGridLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddToQueueLibraryLegacy=function(){function AddToQueueLibraryLegacy(){}AddToQueueLibraryLegacy.prototype.CommandBar=function(entityType){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.CommandBarActions)Mscrm.CommandBarActions.addToQueue(Xrm.Internal.getEntityCode(entityType));else backCompatHeader.Mscrm.CommandBarActions.addToQueue(Xrm.Internal.getEntityCode(entityType))};AddToQueueLibraryLegacy.prototype.CommandBarLegacy=function(objectType){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.CommandBarActions)Mscrm.CommandBarActions.addToQueue(objectType);else backCompatHeader.Mscrm.CommandBarActions.addToQueue(objectType)};AddToQueueLibraryLegacy.prototype.GridCommand=function(gridControl,records,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);if(Mscrm&&Mscrm.CommandBarActions)Mscrm.GridCommandActions.addToQueue(gridControl,records,entityTypeCode);else backCompatHeader.Mscrm.GridCommandActions.addToQueue(gridControl,records,entityTypeCode)};return AddToQueueLibraryLegacy}();Commands.AddToQueueLibraryLegacy=AddToQueueLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AddToQueueLibrary=function(){function AddToQueueLibrary(){}AddToQueueLibrary.prototype.CommandBarLegacy=function(objectType){if(typeof objectType!=="number")objectType=parseInt(objectType,10);this.CommandBar(Xrm.Internal.getEntityName(objectType))};AddToQueueLibrary.prototype.CommandBar=function(entityType){var records=[],entityReference={Id:new Microsoft.Crm.Client.Core.Framework.Guid(Xrm.Page.data.entity.getId()),TypeName:entityType};records=[entityReference];var dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=JSON.stringify(records);dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId;var options={},client=Xrm.Utility.getGlobalContext().client.getClient();if(client===Xrm.Constants.ClientNames.web||client==Xrm.Constants.ClientNames.outlook||client==Xrm.Constants.ClientNames.unifiedServiceDesk){options.height=235;options.width=450}Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.AddToQueueDialog,options,dialogParams).then(this.AddToQueueCommandBarDialogCloseCallback())};AddToQueueLibrary.prototype.GridCommand=function(gridControl,records,entityType){var selectedRecords=[];for(var i in records){var record=records[i],entityName=record.TypeName,entityReference={Id:new Microsoft.Crm.Client.Core.Framework.Guid(record.Id),TypeName:entityName};selectedRecords.push(entityReference)}var dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=JSON.stringify(selectedRecords);dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.GridControl]=JSON.stringify(gridControl);var dialogOptions={},client=Xrm.Utility.getGlobalContext().client.getClient();if(client===Xrm.Constants.ClientNames.web||client==Xrm.Constants.ClientNames.outlook||client==Xrm.Constants.ClientNames.unifiedServiceDesk){dialogOptions.height=235;dialogOptions.width=450}Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.AddToQueueDialog,dialogOptions,dialogParams).then(Commands.Common.gridCommandDialogCloseCallback(gridControl))};AddToQueueLibrary.prototype.AddToQueueCommandBarDialogCloseCallback=function(){return function(callbackParams){var constants=XrmCore.InternalUtilities.DialogUtilities.DialogConstants,client=Xrm.Utility.getGlobalContext().client.getClient();(client===Xrm.Constants.ClientNames.web||callbackParams.parameters[constants.LastButtonClicked]==constants.DialogOkId)&&Xrm.Page.data.refresh(true)}};return AddToQueueLibrary}();Commands.AddToQueueLibrary=AddToQueueLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.AddToQueue=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.AddToQueueLibrary:new Commands.AddToQueueLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AssignLibraryLegacy=function(){function AssignLibraryLegacy(){this.assignObjectLegacy=function(objectType){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.assignObject(objectType):backCompatHeader.Mscrm.CommandBarActions.assignObject(objectType)};this.assignObject=function(entityTypeName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true),objectType=Xrm.Internal.getEntityCode(entityTypeName);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.assignObject(objectType):backCompatHeader.Mscrm.CommandBarActions.assignObject(objectType)};this.assignQueueLegacy=function(entityId,objectType){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.assignQueue(entityId,objectType):backCompatHeader.Mscrm.CommandBarActions.assignQueue(entityId,objectType)};this.assignQueue=function(entityId,entityTypeName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true),objectType=Xrm.Internal.getEntityCode(entityTypeName);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.assignQueue(entityId,objectType):backCompatHeader.Mscrm.CommandBarActions.assignQueue(entityId,objectType)};this.assignSelectedRecordsLegacy=function(gridControl,selectedRecords,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.CommandBarActions?Mscrm.GridCommandActions.assignSelectedRecords(gridControl,selectedRecords,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.assignSelectedRecords(gridControl,selectedRecords,entityTypeCode)};this.assignSelectedRecords=function(gridControl,selectedRecords,entityName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.CommandBarActions?Mscrm.GridCommandActions.assignSelectedRecords(gridControl,selectedRecords,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.assignSelectedRecords(gridControl,selectedRecords,entityTypeCode)};this.assignCloseDialog=function(){Commands.Common.closeDialogLegacy()};this.assignDialogAssignClick=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.assignDialogAssignClick():backCompatHeader.Mscrm.GridCommandActions.assignDialogAssignClick()};this.assignDialogAssignToChange=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.assignDialogAssignToChange():backCompatHeader.Mscrm.GridCommandActions.assignDialogAssignToChange()};this.assignDialogOnLoad=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.assignDialogOnLoad():backCompatHeader.Mscrm.GridCommandActions.assignDialogOnLoad()};this.assignDialogSystemUserChange=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.assignDialogSystemUserChange():backCompatHeader.Mscrm.CommandBarActions.assignDialogSystemUserChange()}}return AssignLibraryLegacy}();Commands.AssignLibraryLegacy=AssignLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var AssignLibrary=function(){function AssignLibrary(){var _this=this;this.assignObjectLegacy=function(objectType){if(typeof objectType!=="number")objectType=parseInt(objectType,10);_this.assignObject(Xrm.Internal.getEntityName(objectType))};this.assignObject=function(entityTypeName){var id=Xrm.Page.data.entity.getId();if(entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.Incident||Xrm.Utility.isActivityType(entityTypeName))_this.assignQueue(id,entityTypeName);else{var entityReference={Id:id,TypeName:entityTypeName,Name:Xrm.Page.data.entity.getEntityReference().name},records=[entityReference],dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityId]=id;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName]=entityTypeName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityTypeCode]=Xrm.Internal.getEntityCode(entityTypeName).toString();dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=XrmCore.InternalUtilities.DialogUtilities.serializeSdkEntityReferences(records);dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.SelectedRecordsCount]=records.length;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType]="";var dialogOptions=null;switch(entityTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SLA:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConvertRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RoutingRule:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Workflow:break;default:break}Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.Assign,dialogOptions,dialogParams).then(_this.assignDialogCloseCallback(dialogParams))}};this.assignQueueLegacy=function(entityId,objectType){if(typeof objectType!=="number")objectType=parseInt(objectType,10);_this.assignQueue(entityId,Xrm.Internal.getEntityName(objectType))};this.assignQueue=function(entityId,entityTypeName){var entityReference={Id:entityId,TypeName:entityTypeName,Name:Xrm.Page.data.entity.getEntityReference().name},dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityId]=entityId;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityTypeCode]=Xrm.Internal.getEntityCode(entityTypeName).toString();dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.SelectedRecordsCount]="1";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName]=entityTypeName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.ShowAssignToMeOption]=true;var dialogWidth,dialogHeight;if(entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.Incident){dialogWidth=456;dialogHeight=250}else if(Xrm.Utility.isActivityType(entityTypeName)){dialogWidth=500;dialogHeight=220}else return;var dialogOptions={height:dialogHeight,width:dialogWidth,position:null};Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.AssignQueue,dialogOptions,dialogParams).then(_this.assignQueueDialogCloseCallback(null,dialogParams,[entityReference]))};this.assignSelectedRecordsLegacy=function(gridControl,selectedRecords,entityTypeCode){_this.assignSelectedRecords(gridControl,selectedRecords,Xrm.Internal.getEntityName(entityTypeCode))};this.assignSelectedRecords=function(gridControl,selectedRecords,entityName){if(Xrm.Internal.isUci()&&entityName==Xrm.Constants.EntityNames.ActivityPointer){var thisObject=_this,promise=Xrm.Utility.getEntitiesMetadata(Commands.Common.GetEntityNamesFromActivityRecords(selectedRecords));selectedRecords.length>0&&promise.then(function(values){!Commands.Common.CheckIfIsReadOnlyInMobileClient(values)&&thisObject.assignSelectedRecordsCallBack(gridControl,selectedRecords,entityName)})}else _this.assignSelectedRecordsCallBack(gridControl,selectedRecords,entityName)};this.assignSelectedRecordsCallBack=function(gridControl,selectedRecords,entityName){if(selectedRecords.length<=0){var alert_1={text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")};Xrm.Navigation.openAlertDialog(alert_1);return}var dialogOptions=null,assignQueue=false,setSelectedSubTypes=false,height=285,width=456;if(Xrm.Utility.isActivityType(entityName))assignQueue=true;switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QueueItem:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PhoneCall:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Appointment:setSelectedSubTypes=true;assignQueue=true;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Fax:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Letter:setSelectedSubTypes=true;assignQueue=true;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Incident:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Task:assignQueue=true;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity:assignQueue=true;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SLA:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConvertRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RoutingRule:break}var dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName]=entityName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId]="";dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType]="";if(assignQueue){if(selectedRecords.length>0){dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.SelectedRecordsCount]=String(selectedRecords.length);dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=XrmCore.InternalUtilities.DialogUtilities.serializeSdkEntityReferences(selectedRecords);dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.ShowAssignToMeOption]=true;Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.AssignQueue,dialogOptions,dialogParams).then(_this.assignQueueDialogCloseCallback(gridControl,dialogParams,selectedRecords))}}else if(selectedRecords.length>0){var callback=_this.gridAssignDialogCloseCallback(gridControl,selectedRecords,dialogParams);dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.SelectedRecordsCount]=selectedRecords.length;Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.Assign,dialogOptions,dialogParams).then(callback)}};this.assignCloseDialog=function(eventContext){XrmCore.InternalUtilities.DialogUtilities.closeDialog(eventContext)};this.assignDialogAssignClick=function(eventContext){var formContext=eventContext.getFormContext();if(!formContext)if(Xrm.Page)formContext=Xrm.Page;else return;var ownerId="",ownerType="",assignTo=formContext.data.attributes.get("rdoMe_id"),assignToLookupControl=formContext.data.attributes.get("systemuserview_id"),disableAssignToLookupControl=assignTo.getValue();if(disableAssignToLookupControl){var selectedUser=assignToLookupControl.getValue();if(!selectedUser||selectedUser.length===0){var errorStrings=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web._grid.cmds.dlg_assignallrecords.aspx_60");Xrm.Navigation.openAlertDialog({text:errorStrings});return}else{ownerId=selectedUser[0].id;ownerType=selectedUser[0].entityType}}else{ownerId=formContext.context.getUserId();ownerType=XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser}formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId).setValue(ownerId);formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType).setValue(ownerType);formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked).setValue(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);formContext.ui.close()};this.assignDialogAssignToChange=function(eventContext){var formContext=eventContext.getFormContext();if(!formContext)if(Xrm.Page)formContext=Xrm.Page;else return;var assignTo=formContext.data.attributes.get("rdoMe_id"),assignToLookupControl=formContext.getControl("systemuserview_id"),disableAssignToLookupControl=assignTo.getValue(),assignButton=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);if(assignToLookupControl&&disableAssignToLookupControl){assignToLookupControl.setDisabled(false);var lookupValue=assignToLookupControl.getAttribute().getValue();assignButton&&(!lookupValue||lookupValue.length===0)&&assignButton.setDisabled(true)}else{assignToLookupControl.setDisabled(true);assignButton&&assignButton.setDisabled(false)}};this.assignDialogOnLoad=function(eventContext){var formContext=eventContext.getFormContext();if(!formContext)if(Xrm.Page)formContext=Xrm.Page;else return;var assignTo=formContext.data.attributes.get("rdoMe_id");assignTo&&assignTo.setValue(false);var entityName="",displayName="",entityDisplaySetName="",entityAttribute=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName);if(entityAttribute){entityName=entityAttribute.getValue();var entityCallback=function(entityMap){var entityInfo=entityMap[entityName];displayName=entityInfo.DisplayName;entityDisplaySetName=entityInfo.DisplayCollectionName;var assignHeader=formContext.getControl("assignheader_id"),headerLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Assign_Title");assignHeader.setLabel(XrmCore.InternalUtilities.GenericUtilities.stringFormat(headerLabel?headerLabel:"Assign",[displayName]));var headerDescription=formContext.getControl("label_headerdescription"),selectedRecordsCount=0,recordsCount=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.SelectedRecordsCount);if(recordsCount&&recordsCount.getValue())selectedRecordsCount=recordsCount.getValue();var titleDescription="";if(selectedRecordsCount===1){var singularDescription=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Assign_DescriptionSingular");titleDescription=XrmCore.InternalUtilities.GenericUtilities.stringFormat(singularDescription?singularDescription:" ",[selectedRecordsCount,displayName])}else if(selectedRecordsCount>1){var pluralDescription=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Assign_DescriptionPlural");titleDescription=XrmCore.InternalUtilities.GenericUtilities.stringFormat(pluralDescription?pluralDescription:" ",[selectedRecordsCount,entityDisplaySetName])}headerDescription.setLabel(titleDescription);_this.assignDialogAssignToChange(eventContext)};XrmCore.InternalUtilities.GenericUtilities.createChainedEntityMetadataMapWithCallback([entityName],0,{},entityCallback)}};this.assignDialogSystemUserChange=function(eventContext){var formContext=eventContext.getFormContext();if(!formContext)if(Xrm.Page)formContext=Xrm.Page;else return;var assignToLookupAttribute=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.SystemUserViewId);if(assignToLookupAttribute){var selectedItems=assignToLookupAttribute.getValue(),assignButton=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);if(!assignButton)return;if(!selectedItems||selectedItems.length===0)assignButton.setDisabled(true);else assignButton.setDisabled(false)}};this.gridAssignDialogCloseCallback=function(gridControl,records,dialogParams){var assignMultiple=_this.assignMultipleRecords;return function(dialogResponse){if(dialogResponse&&dialogResponse.parameters&&dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId){var ownerId=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId].toString(),ownerType=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType].toString();if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}if(ownerId&&ownerType){XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();if(records.length===1){var assignRequest=new XrmCore.SdkContracts.AssignRequest;assignRequest.Target=XrmCore.InternalUtilities.GenericUtilities.ConvertEntityRefToLookUp(records[0]);assignRequest.Assignee={entityType:ownerType,id:ownerId};Xrm.WebApi.online.execute(assignRequest).then(function(response){Xrm.Utility.closeProgressIndicator();gridControl&&gridControl.refresh()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}else assignMultiple(ownerId,ownerType,gridControl,records)}}}};this.assignDialogCloseCallback=function(dialogParams){var shouldSaveBeforeAssigning=_this.shouldSaveBeforeAssigning;return function(dialogResponse){if(dialogResponse&&dialogResponse.parameters&&dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId){var ownerId_1=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId].toString(),ownerType_1=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType].toString(),entityName_1=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName].toString(),entityId_1=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityId].toString();if(Xrm.Utility.getGlobalContext().client.getClientState()===Xrm.Constants.ClientStates.offline){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}if(shouldSaveBeforeAssigning(entityName_1)){var saveOptions={useSchedulingEngine:false,saveMode:47};XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();Xrm.Page.data.save(saveOptions).then(function(success){var assignRequest=new XrmCore.SdkContracts.AssignRequest;assignRequest.Target={entityType:entityName_1,id:entityId_1};assignRequest.Assignee={entityType:ownerType_1,id:ownerId_1};Xrm.WebApi.online.execute(assignRequest).then(function(response){Xrm.Utility.closeProgressIndicator();Xrm.Page.data.refresh()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}else{var assignRequest=new XrmCore.SdkContracts.AssignRequest;assignRequest.Target={entityType:entityName_1,id:entityId_1};assignRequest.Assignee={entityType:ownerType_1,id:ownerId_1};XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();Xrm.WebApi.online.execute(assignRequest).then(function(response){Xrm.Utility.closeProgressIndicator();Xrm.Page.data.refresh()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}}}};this.shouldSaveBeforeAssigning=function(entityName){if(Xrm.Utility.getGlobalContext().client.getClient()!==Xrm.Constants.ClientNames.mobile||Xrm.Page.data.entity.getIsDirty())return true;return entityName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Quote&&entityName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.QuoteDetail&&entityName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesOrder&&entityName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesOrderDetail&&entityName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Invoice&&entityName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.InvoiceDetail}}AssignLibrary.prototype.assignQueueDialogCloseCallback=function(gridControl,dialogParams,records){var assignMultiple=this.assignMultipleRecords;return function(dialogResponse){if(dialogResponse&&dialogResponse.parameters&&dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]&&dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId){var ownerId_2=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerId].toString(),ownerType_2=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OwnerType].toString();if(ownerId_2&&ownerType_2){XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();var updatedGridControl=null;if(dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.GridControl])updatedGridControl=dialogResponse.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.GridControl];else updatedGridControl=gridControl;if(Xrm.Utility.getGlobalContext().client.getClientState()===Xrm.Constants.ClientStates.offline){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}Xrm.Utility.getEntityMetadata(ownerType_2).then(function(metadata){if(records.length===1){var assignRequest=new XrmCore.SdkContracts.AssignRequest;assignRequest.Target=XrmCore.InternalUtilities.GenericUtilities.ConvertEntityRefToLookUp(records[0]);assignRequest.Assignee={entityType:ownerType_2,id:ownerId_2};Xrm.WebApi.online.execute(assignRequest).then(function(response){Xrm.Utility.closeProgressIndicator();gridControl&&gridControl.refresh();Xrm.Page.data&&Xrm.Page.data.refresh()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}else assignMultiple(ownerId_2,ownerType_2,gridControl,records)})}}}};AssignLibrary.prototype.assignMultipleRecords=function(ownerId,ownerType,gridControl,records){var assignBatch=records.map(function(record){var assignRequest=new XrmCore.SdkContracts.AssignRequest;assignRequest.Target=XrmCore.InternalUtilities.GenericUtilities.ConvertEntityRefToLookUp(record);assignRequest.Assignee={entityType:ownerType,id:ownerId};return assignRequest});Xrm.WebApi.online.executeMultiple(assignBatch).then(function(success){Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.onGridActionMultipleSuccess(gridControl,success)},function(error){gridControl.refresh();Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})};return AssignLibrary}();Commands.AssignLibrary=AssignLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Assign=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.AssignLibrary:new Commands.AssignLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var CloseLibraryLegacy=function(){function CloseLibraryLegacy(){this.closeActivityFromGrid=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.GridRibbonActions&&Mscrm.GridRibbonActions.addActivityFromGrid)Mscrm.GridCommandActions.closeActivityFromGrid(gridControl,records);else backCompatHeader.Mscrm.GridCommandActions.closeActivityFromGrid(gridControl,records)};this.closeActivityFromGridLegacy=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);if(Mscrm&&Mscrm.GridRibbonActions&&Mscrm.GridRibbonActions.addActivityFromGrid)Mscrm.GridCommandActions.closeActivityFromGrid(gridControl,records);else backCompatHeader.Mscrm.GridCommandActions.closeActivityFromGrid(gridControl,records)}}return CloseLibraryLegacy}();Commands.CloseLibraryLegacy=CloseLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var CloseLibrary=function(){function CloseLibrary(){this.CloseActivity=function(entityId,entityName){Commands.Common.handleStateChangeAction(entityName,entityId,false)};this.closeActivityFromGrid=function(gridControl,records){for(var _i=0,records_1=records;_i<records_1.length;_i++){var entity=records_1[_i];Commands.Common.handleStateChangeAction(entity.TypeName,entity.Id,false,gridControl)}}}return CloseLibrary}();Commands.CloseLibrary=CloseLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Close=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.CloseLibrary:new Commands.CloseLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ChangeStateLibraryLegacy=function(){function ChangeStateLibraryLegacy(){}ChangeStateLibraryLegacy.prototype.changeState=function(action,objectType,formEventId,objectSubtype){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.FormAction?Mscrm.FormAction.changeState(action,objectType,formEventId,objectSubtype):backCompatHeader.Mscrm.FormAction.changeState(action,objectType,formEventId,objectSubtype)};ChangeStateLibraryLegacy.prototype.deactivateClick=function(){Commands.Common.deactivateClickLegacy()};ChangeStateLibraryLegacy.prototype.onLoadSetState=function(){Commands.Common.onLoadSetStateLegacy()};ChangeStateLibraryLegacy.prototype.onStateChange=function(){Commands.Common.onStateChangeLegacy()};ChangeStateLibraryLegacy.prototype.changeStateCloseDialog=function(){Commands.Common.closeDialogLegacy()};return ChangeStateLibraryLegacy}();Commands.ChangeStateLibraryLegacy=ChangeStateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ChangeStateLibrary=function(){function ChangeStateLibrary(){}ChangeStateLibrary.prototype.changeState=function(action,objectType,formEventId,objectSubtype){var activate;switch(action){case "activate":activate=true;break;case "deactivate":activate=false;break;default:return}var id=Xrm.Page.data.entity.getId(),entityName=Xrm.Page.data.entity.getEntityName();Commands.Common.changeState(entityName,id,activate)};ChangeStateLibrary.prototype.changeStateCloseDialog=function(eventContext){XrmCore.InternalUtilities.DialogUtilities.closeDialog(eventContext)};ChangeStateLibrary.prototype.onLoadSetState=function(eventContext){Commands.Common.onLoadSetState(eventContext)};ChangeStateLibrary.prototype.onStateChange=function(eventContext){Commands.Common.onStateChange(eventContext)};ChangeStateLibrary.prototype.deactivateClick=function(eventContext){Commands.Common.deactivateClick(eventContext)};return ChangeStateLibrary}();Commands.ChangeStateLibrary=ChangeStateLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.ChangeState=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.ChangeStateLibrary:new Commands.ChangeStateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var Common=function(){function Common(){}Common.changeState=function(entityType,id,activate){Common.handleStateChangeAction(entityType,id,activate)};Common.handleStateChangeAction=function(entityName,id,activate,gridControl){var options=null,client=Xrm.Utility.getGlobalContext().client.getClient();if(client===Xrm.Constants.ClientNames.web||client==Xrm.Constants.ClientNames.outlook||client==Xrm.Constants.ClientNames.unifiedServiceDesk)options={height:250,width:600,position:1};var dialogArguments={};dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.action]=activate?XrmCore.InternalUtilities.DialogUtilities.DialogConstants.activate:XrmCore.InternalUtilities.DialogUtilities.DialogConstants.deactivate;dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]="";dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId]=-1;dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StatusId]=-1;var records=[{TypeName:entityName,Id:id}];dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=records;Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.SetStateDialog,options,dialogArguments).then(function(successParameter){if(successParameter&&successParameter.parameters&&successParameter.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId){var state_3=successParameter.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId],status_1=successParameter.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StatusId];XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();if(gridControl)Common.SetEntityState(entityName,id,Number(state_3),Number(status_1)).then(function(successParameter){Xrm.Utility.closeProgressIndicator();gridControl.refresh();gridControl.refreshRibbon()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog);else Xrm.Page.data.save({saveMode:activate?6:5}).then(function(successParameter){Common.SetEntityState(entityName,id,Number(state_3),Number(status_1)).then(function(successParameter){Xrm.Utility.closeProgressIndicator();Common.performPageRefresh(entityName,false)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}})};Common.SetEntityState=function(entityType,id,state,status){var entity={};entity["statecode"]=state;if(status||status===0)entity["statuscode"]=status;else entity["statuscode"]=-1;return Xrm.WebApi.updateRecord(entityType,id,entity)};Common.gridCommandDialogCloseCallback=function(_gridControl){return function(callbackParams){var constants=XrmCore.InternalUtilities.DialogUtilities.DialogConstants,gridControl=callbackParams.parameters[constants.GridControl]?callbackParams.parameters[constants.GridControl]:_gridControl;gridControl&&gridControl.refresh&&callbackParams.parameters[constants.LastButtonClicked]&&callbackParams.parameters[constants.LastButtonClicked]===constants.DialogOkId&&gridControl.refresh()}};Common.closeSetStateDialogFromGridCallback=function(dialogParams,callbackParams,gridControl,callback){if(dialogParams&&dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId){var records=dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records],selectedState_1=dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId],selectedStatus_1=dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StatusId];XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();if(records.length===1){var entityName=records[0].TypeName,entityId=records[0].Id;Common.SetEntityState(entityName,entityId,selectedState_1,selectedStatus_1).then(function(successParameter){Xrm.Utility.closeProgressIndicator();gridControl&&gridControl.refresh();callback&&callback()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}else{var setStateRequests=records.map(function(record){return new XrmCore.SdkContracts.SetStateRequest(record.Id,record.TypeName,selectedState_1,selectedStatus_1)});Xrm.WebApi.online.executeMultiple(setStateRequests).then(function(success){Xrm.Utility.closeProgressIndicator();if(success.every(function(response){return response.ok})){gridControl.refresh();callback&&callback()}else{Common.openAlertDialogForSetStateMultipleError(gridControl);gridControl.refresh()}},function(error){Xrm.Utility.closeProgressIndicator();Common.openAlertDialogForSetStateMultipleError(gridControl);gridControl.refresh()})}}};Common.openAlertDialogForSetStateMultipleError=function(gridControl){var alertDialogStrings={text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_MultipleErrorsFound")};Xrm.Navigation.openAlertDialog(alertDialogStrings).then(function(successParameter){gridControl.refresh()})};Common.setState=function(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen,saveMode){if(Xrm.Page.data.entity.getId()===null||Xrm.Page.data.entity.getId()===undefined||!Xrm.Page.data.isValid())return;if(!statusCode&&statusCode!==0)statusCode=-1;else if(stateCode===-1){Xrm.Utility.getEntityMetadata(entityName,["statuscode"]).then(function(entityMetadata){var statusMetadata=entityMetadata.Attributes.get("statuscode"),stateCode=statusMetadata.getState(statusCode);Common.setStateInternal(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog);return}Common.setStateInternal(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen,saveMode)};Common.setStateInternal=function(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen,saveMode){if(!Common.isBusy){Common.isBusy=true;var saveOptions={useSchedulingEngine:false};if(saveMode)saveOptions.saveMode=saveMode;Xrm.Page.data.save(saveOptions).then(function(successParameter){Common.setStateUpdate(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen)},function(error){Common.isBusy=false;XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})}};Common.setStateUpdate=function(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen){if(!entityId||!entityId.length)entityId=Xrm.Page.data.entity.getId();Common.SetEntityState(entityName,entityId,stateCode,statusCode).then(function(setStateResponse){Common.postSetState(entityId,entityName,closeWindow,entityToOpen,entityIdToOpen)},function(error){Common.isBusy=false;XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})};Common.postSetState=function(entityId,entityName,closeWindow,entityToOpen,entityIdToOpen){if(closeWindow){if(entityToOpen&&entityIdToOpen)Xrm.Utility.openEntityForm(entityToOpen,entityIdToOpen,null);else Xrm.Utility.getEntityMetadata(entityName).then(function(successParameter){var interactionCentric=successParameter.IsInteractionCentricEnabled,oneCount=false;if(!interactionCentric&&oneCount)Xrm.Page.data.refresh(true);else{Common.refreshParentGrid(entityId,entityName);Xrm.Page.ui.close()}},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog);Common.isBusy=false;return}if(entityToOpen&&entityIdToOpen)Xrm.Utility.openEntityForm(entityToOpen,entityIdToOpen,null);else{Xrm.Page.data.refresh(true);Common.refreshParentGrid(entityId,entityName);Common.performPageRefresh(entityName,true)}Common.isBusy=false};Common.refreshParentGrid=function(id,entityName){if(entityName);};Common.performPageRefresh=function(entityName,shouldSaveAndRefresh){Xrm.Utility.getEntityMetadata(entityName).then(function(successParameter){if(successParameter.IsInteractionCentricEnabled)if(shouldSaveAndRefresh)Xrm.Page.data.save().then(function(successParameter){Common.performPageDataAndRibbonRefresh()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog);else Common.performPageDataAndRibbonRefresh();else Xrm.Page.data.refresh(true)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)};Common.performPageDataAndRibbonRefresh=function(){Xrm.Page.data.refresh(true).then(function(successParameter){Xrm.Page.ui.refreshRibbon()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)};Common.deactivateClick=function(eventContext){if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}XrmCore.InternalUtilities.DialogUtilities.setLastButtonClicked(eventContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);var formContext=eventContext.getFormContext();formContext.ui.close()};Common.onLoadSetState=function(eventContext){var formContext=eventContext.getFormContext();if(!formContext)if(Xrm.Page)formContext=Xrm.Page;else throw new Error("No Client API frame can be found");if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();formContext.ui.close();return}var actionName=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.action).getValue(),records=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records).getValue();if(!records||records.length===0)return;var entityName=records[0].TypeName,entityDisplayName="",entityDisplaySetName="",entityCallback=function(entityMap){var entityInfo=entityMap[entityName];entityDisplayName=entityInfo.DisplayName;entityDisplaySetName=entityInfo.DisplayCollectionName;Common.setLabelsForDeactivateDialog(formContext,entityName,entityDisplayName,entityDisplaySetName,records.length,actionName);if(!entityInfo.EnforceStateTransitions){Common.loadStates(formContext,entityName,actionName);return}var _failedCallback=function(recordId,entityName,functionName,errorResponse){throw new Error("Function: onLoadSetState: Retrieve record "+recordId+" from "+entityName+" failed from the Client API "+functionName)};Xrm.WebApi.online.retrieveRecord(entityName,records[0].Id).then(function(recordData){var statusCode=recordData["statuscode"];Xrm.Utility.getAllowedStatusTransitions(entityName,statusCode).then(function(allowedTransitions){if(!allowedTransitions||allowedTransitions.length===0)Common.setNoTransitionsWarning(formContext);else{formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.allowedTransitions).setValue(allowedTransitions);Common.setLabelsForDeactivateDialog(formContext,entityName,entityDisplayName,entityDisplaySetName,records.length,actionName);Common.loadStates(formContext,entityName,actionName)}},function(errorResponse){_failedCallback(records[0].Id,entityName,"Xrm.Utility.getAllowedStatusTransitions",errorResponse)})},function(errorResponse){_failedCallback(records[0].Id,entityName,"Xrm.WebApi.online.retrieveRecord",errorResponse)})};XrmCore.InternalUtilities.GenericUtilities.createChainedEntityMetadataMapWithCallback([entityName],0,{},entityCallback)};Common.setNoTransitionsWarning=function(formContext){var headerControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.HeaderTitleId),descriptionControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DescriptionId),okButtonControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId),cancelButtonControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogCancelId);headerControl!==undefined&&headerControl!==null&&headerControl.setLabel(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web._grid.cmds.dlg_deactivate.aspx_200_Activate_warning_Title"));descriptionControl.setLabel("");okButtonControl.setLabel(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_OK")?"OK":"OK");okButtonControl.setVisible(false);cancelButtonControl.setLabel(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_OK")?XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_OK"):"OK");cancelButtonControl.setVisible(true);var action=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.action).getValue(),messageToDisplay=action===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.activate?"Web._grid.cmds.dlg_deactivate.aspx_200_Activate_warning":"Web._grid.cmds.dlg_deactivate.aspx_200_Deactivate_warning";formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.MessageId).setLabel(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString(messageToDisplay))};Common.onActionMenuClickLegacy=function(action,entityTypeCode,objectSubtype,callbackArgumentRef){return Common.onActionMenuClick(action,Xrm.Internal.getEntityName(entityTypeCode),objectSubtype,callbackArgumentRef)};Common.onActionMenuClick=function(action,entityName,objectSubtype,callbackArgumentRef){if(Xrm.Internal.isUci&&Xrm.Internal.isUci()){var clickContext={};clickContext["action"]=action;clickContext["objectType"]=Xrm.Internal.getEntityCode(entityName);clickContext["objectSubtype"]=objectSubtype;clickContext["callbackArgumentRef"]=callbackArgumentRef;return Common.handleActionMenuClick(clickContext)}else{var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);return Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.onActionMenuClick(action,entityTypeCode,objectSubtype,callbackArgumentRef):backCompatHeader.Mscrm.CommandBarActions.onActionMenuClick(action,entityTypeCode,objectSubtype,callbackArgumentRef)}};Common.handleActionMenuClick=function(clickContext){var action=null,objectType=null,objectTypeName=null,objectSubtype=null,callbackArgumentRef=null,recordId=null;if("action" in clickContext)action=clickContext["action"];if("objectType" in clickContext){objectTypeName=Xrm.Internal.getEntityName(clickContext["objectType"]);objectType=clickContext["objectType"]}if("objectSubtype" in clickContext)objectSubtype=clickContext["objectSubtype"];if("callbackArgumentRef" in clickContext)callbackArgumentRef=clickContext["callbackArgumentRef"];if("recordId" in clickContext)recordId=clickContext["recordId"];if(typeof objectType!=="number")objectType=parseInt(objectType,10);var x=400,y=200,close=false,reload=false,result=null,firstResult=null,callbackRef=null,isDialogInline=false,id=null;if(recordId)id=recordId;else id=Xrm.Page.data.entity.getId();var ids=[id],url=Xrm.Utility.getGlobalContext().prependOrgName("/_grid/cmds/dlg_");url=url.concat(encodeURIComponent(action.toString()),".aspx?dType=1");url=url.concat("&iObjType=",encodeURIComponent(objectType.toString()));url=url.concat("&iTotal=",encodeURIComponent("1"));url=url.concat("&sIds=",encodeURIComponent(id.toString()));if(objectSubtype!=null)url=url.concat("&iObjSubType=",encodeURIComponent(objectSubtype));switch(action){case "share":x=800;y=480;isDialogInline=true;break}if(action!=="delete")if(!callbackRef)firstResult=Common.handleCallbackFunction(result,url,action,objectType,ids,x,y,close,reload,id,callbackArgumentRef,isDialogInline);return firstResult};Common.handleCallbackFunction=function(result,url,action,objectType,ids,width,height,close,reload,id,callbackArgumentRef,isDialogInline){var parameters=null;parameters=[action,objectType,close,reload,id,callbackArgumentRef];var option={position:1,width:width,height:height},callbackFunction=Common.createCallbackFunctionFactory(Common.performActionAfterSwitch,parameters);Common.appendAppIdAndOpenLegacyWebDialog(url.toString(),option,ids,callbackFunction);return result};Common.performActionAfterSwitch=function(result,action,objectType,close,reload,id,callbackArgumentRef){callbackArgumentRef!=null&&Common.executeFunction(callbackArgumentRef,result);return result};Common.executeFunction=function(callbackReference,value){if(callbackReference==null)return null};Common.setLabelsForDeactivateDialog=function(formContext,entityName,entitySingularDisplayName,entityPluralDisplayName,total,action){var entityDisplayName="";if(total===1)entityDisplayName=entitySingularDisplayName;else entityDisplayName=entityPluralDisplayName;var titleControlName=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.TitleId,descriptionLabelName=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DescriptionId,messageLabelName=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.MessageId,dialogOkControlName=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId,deactivateTitle=null,deactivateDescription=null,deactivateMessageLabel=null,deactivateOkLabel=null;if(action===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.deactivate)switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:deactivateTitle=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Grid_Deactivate_Title");deactivateDescription=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Deactivate_Description");deactivateMessageLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web._grid.cmds.dlg_deactivate.aspx_102_Title");deactivateOkLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Deactivate");formContext.getControl(titleControlName).setLabel(deactivateTitle?deactivateTitle:"Deactivate");formContext.getControl(descriptionLabelName).setLabel(deactivateDescription?XrmCore.InternalUtilities.GenericUtilities.stringFormat(deactivateDescription,[total,entityDisplayName]):"Dialog_Deactivate_Description "+total+" "+entityDisplayName+"?");formContext.getControl(messageLabelName).setLabel(messageLabelName?XrmCore.InternalUtilities.GenericUtilities.stringFormat(deactivateMessageLabel,[entityDisplayName]):"Web._grid.cmds.dlg_deactivate.aspx_102_Title");formContext.getControl(dialogOkControlName).setLabel(deactivateOkLabel?XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Deactivate"):"Deactivate");break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ExternalParty:if(total==1);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ExternalPartyItem:if(total==1);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TopicModel:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SyncError:deactivateTitle=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Grid_Deactivate_Title");deactivateDescription=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Deactivate_Description");deactivateMessageLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("SyncError.Dialog.Deactivate.Messsage.Text");deactivateOkLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Deactivate");formContext.getControl(titleControlName).setLabel(deactivateTitle?deactivateTitle:"Deactivate");formContext.getControl(descriptionLabelName).setLabel(deactivateDescription?XrmCore.InternalUtilities.GenericUtilities.stringFormat(deactivateDescription,[total,entityDisplayName]):"Dialog_Deactivate_Description "+total+" "+entityDisplayName+"?");formContext.getControl(messageLabelName).setLabel(messageLabelName?XrmCore.InternalUtilities.GenericUtilities.stringFormat(deactivateMessageLabel,[entityDisplayName]):"SyncError.Dialog.Deactivate.Messsage.Text");formContext.getControl(dialogOkControlName).setLabel(deactivateOkLabel?XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Deactivate"):"Deactivate");break;default:if(Xrm.Utility.isActivityType(entityName)){var closeActivityTitle=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Close_Activity_Title"),[entityDisplayName]),closeActivityDescription=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Close_Activity_Description"),[total,entityDisplayName]),closeActivityMessage=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web._grid.cmds.dlg_deactivate.aspx_85"),[entityDisplayName]),closeButtonText=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Close"),dialogTitle=XrmCore.InternalUtilities.GenericUtilities.stringFormat(closeActivityTitle,[entityDisplayName]);formContext.getControl(titleControlName).setLabel(dialogTitle?dialogTitle:"Dialog_Close_Activity_Title");formContext.getControl(descriptionLabelName).setLabel(closeActivityDescription?closeActivityDescription:"Dialog_Close_Activity_Description");formContext.getControl(messageLabelName).setLabel(closeActivityMessage?closeActivityMessage:"Web._grid.cmds.dlg_deactivate.aspx_85");formContext.getControl(dialogOkControlName).setLabel(closeButtonText?closeButtonText:"Button_Label_Close")}else{deactivateTitle=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Grid_Deactivate_Title");deactivateDescription=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Deactivate_Description"),[total,entityDisplayName]);deactivateMessageLabel=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web._grid.cmds.dlg_deactivate.aspx_55"),[entityDisplayName]);deactivateOkLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Deactivate");formContext.getControl(titleControlName).setLabel(deactivateTitle?deactivateTitle:"Dialog_Grid_Deactivate_Title");formContext.getControl(descriptionLabelName).setLabel(deactivateDescription?deactivateDescription:"");formContext.getControl(messageLabelName).setLabel(deactivateMessageLabel?deactivateMessageLabel:"");formContext.getControl(dialogOkControlName).setLabel(deactivateOkLabel?deactivateOkLabel:"Button_Label_Deactivate")}break}else{var statusString=null,activateTitle=null,activateDescription=null,activateMessage=null,activateButtonText=null;switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ExternalParty:if(total==1);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ExternalPartyItem:if(total==1);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConvertRule:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConvertRuleItem:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecommendationModel:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RoutingRule:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TopicModel:break;default:var statusString_1=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Label_Active"),activateTitle_1=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Activate_Title"),activateDescription_1=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_Activate_Description_Activate"),activateMessage_1=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web._grid.cmds.dlg_activate.aspx_55"),activateButtonText_1=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Activate");formContext.getControl(titleControlName).setLabel(XrmCore.InternalUtilities.GenericUtilities.stringFormat(activateTitle_1,[entityDisplayName]));formContext.getControl(descriptionLabelName).setLabel(XrmCore.InternalUtilities.GenericUtilities.stringFormat(activateDescription_1,[total,entityDisplayName]));formContext.getControl(messageLabelName).setLabel(XrmCore.InternalUtilities.GenericUtilities.stringFormat(activateMessage_1,[entityDisplayName,statusString_1]));formContext.getControl(dialogOkControlName).setLabel(activateButtonText_1?activateButtonText_1:"Button_Label_Activate");break}}formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId).setVisible(true);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogCancelId).setVisible(true)};Common.loadStates=function(formContext,entityName,action){Xrm.Utility.getEntityMetadata(entityName,["statecode"]).then(function(entityMetadata){var stateMetadata=entityMetadata.Attributes.get("statecode"),stateCodeControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId);stateCodeControl.clearOptions();var defaultState;if(Xrm.Utility.isActivityType(entityName)&&action===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.deactivate){var valueList=Object.keys(stateMetadata.OptionSet);valueList.forEach(function(key){var stateCode=stateMetadata.OptionSet[key].value;(stateCode===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Completed||stateCode===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Canceled)&&stateCodeControl.addOption({text:stateMetadata.OptionSet[key].text,value:stateCode})});var defaultCloseState=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.defaultCloseState).getValue();defaultState=defaultCloseState?defaultCloseState:XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Completed;stateCodeControl.setVisible(true);stateCodeControl.getAttribute().setValue(defaultState)}else{stateCodeControl.setVisible(false);defaultState=XrmCore.InternalUtilities.EntityUtilities.isStateCodeReversed(entityName)?action===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.activate?XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Inactive:XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Active:action===XrmCore.InternalUtilities.DialogUtilities.DialogConstants.activate?XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Active:XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Inactive;var valueList=Object.keys(stateMetadata.OptionSet);valueList.forEach(function(key){var stateCode=stateMetadata.OptionSet[key].value;stateCode===defaultState&&stateCodeControl.addOption({text:stateMetadata.OptionSet[key].text,value:stateCode})});stateCodeControl.getAttribute().setValue(defaultState)}var defaultStatus=stateMetadata.getDefaultStatus(defaultState);Common.loadStatusOptions(formContext,entityName,defaultState,defaultStatus)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)};Common.loadStatusOptions=function(formContext,entityName,selectedState,defaultStatusCode){if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}var statusCodeControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StatusId),statusCodeOptionSet=statusCodeControl.getAttribute();statusCodeControl.clearOptions();statusCodeControl.setVisible(false);Xrm.Utility.getEntityMetadata(entityName,["statuscode"]).then(function(entityMetadata){var statusMetadata=entityMetadata.Attributes.get("statuscode"),allowedTransitions=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.allowedTransitions).getValue(),total=0,valueList=Object.keys(statusMetadata.OptionSet);valueList.forEach(function(key){var statusCode=statusMetadata.OptionSet[key].value,rawState=statusMetadata.getState(statusCode);if(rawState===selectedState)if(!allowedTransitions||allowedTransitions.indexOf(statusCode)!==-1){statusCodeControl.addOption({text:statusMetadata.OptionSet[key].text,value:statusCode});total++}});if(allowedTransitions&&total>0&&allowedTransitions.indexOf(defaultStatusCode)===-1){var statusCodeOptions=statusCodeControl.getOptions();if(statusCodeOptions!==undefined&&statusCodeOptions!==null&&statusCodeOptions.length>0)for(var i=0;i<statusCodeOptions.length;i++)if(statusCodeOptions[i].value!==NaN&&statusCodeOptions[i].text!==""){defaultStatusCode=statusCodeOptions[i].value;break}}switch(total){case 0:Common.setNoTransitionsWarning(formContext);break;case 1:statusCodeOptionSet.setValue(defaultStatusCode);break;default:entityName!=="businessunit"&&statusCodeControl.setVisible(true);statusCodeOptionSet.setValue(defaultStatusCode);break}},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)};Common.onStateChange=function(eventContext){var formContext=eventContext.getFormContext();if(!formContext)if(Xrm.Page)formContext=Xrm.Page;else throw new Error("No Client API frame can be found");if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}var recordsAttribute=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records),records=recordsAttribute.getValue(),entityName=records[0].TypeName,stateCodeControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId),selectedState=stateCodeControl.getAttribute().getValue();if(selectedState){formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.selectedState).setValue(selectedState);Xrm.Utility.getEntityMetadata(entityName,["statecode"]).then(function(entityMetadata){var stateMetadata=entityMetadata.Attributes.get("statecode"),defaultStatusCode=stateMetadata.getDefaultStatus(selectedState);Common.loadStatusOptions(formContext,entityName,selectedState,defaultStatusCode)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}};Common.deactivateClickLegacy=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.deactivateClick():backCompatHeader.Mscrm.CommandBarActions.deactivateClick()};Common.closeDialogLegacy=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.InternalUtilities?Mscrm.InternalUtilities.DialogUtility.closeDialog():backCompatHeader.Mscrm.InternalUtilities.DialogUtility.closeDialog()};Common.onLoadSetStateLegacy=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.onLoadSetState():backCompatHeader.Mscrm.CommandBarActions.onLoadSetState()};Common.onStateChangeLegacy=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.onStateChange():backCompatHeader.Mscrm.CommandBarActions.onStateChange()};Common.GetEntityNamesFromActivityRecords=function(records){for(var activityEntityNames={},i=0;i<records.length;i++)if(activityEntityNames[records[i].TypeName]==undefined)activityEntityNames[records[i].TypeName]=[];return activityEntityNames};Common.CheckIfIsReadOnlyInMobileClient=function(values){for(var returnValue=false,index=0;index<values.length;index++){var value=values[index];if(value["IsReadOnlyInMobileClient"]==true){returnValue=true;break}}if(returnValue){var errorStrings={text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("ReadOnlyEntity"),confirmButtonLabel:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_OK")};Xrm.Navigation.openAlertDialog(errorStrings)}return returnValue};Common.constructAndOpenLegacyWebDialog=function(entityName,gridControl,selectedRecords,dialogFileName,dialogWidth,dialogHeight,appendGridItemIdsToUri,dialogCallbackFunction,dialogCallbackParameters){if(!dialogFileName)return;if(!gridControl||!selectedRecords||!selectedRecords.length){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")});return}var entityTypeCode=Xrm.Internal.getEntityCode(entityName),actionUri=Xrm.Utility.getGlobalContext().prependOrgName("/_grid/cmds/");actionUri=actionUri.concat(encodeURIComponent(dialogFileName),"?dType=1");actionUri=actionUri.concat("&iObjType=",encodeURIComponent(entityTypeCode.toString()));actionUri=actionUri.concat("&iTotal=",encodeURIComponent(selectedRecords.length.toString()));if(appendGridItemIdsToUri){var parameterToEncode=(new String).concat("{",selectedRecords[0].Id.toString(),"}");actionUri=actionUri.concat("&sIds=",encodeURIComponent(parameterToEncode));for(var i_1=1;i_1<selectedRecords.length;i_1++){parameterToEncode=(new String).concat(";{",selectedRecords[i_1].Id.toString(),"}");actionUri=actionUri.concat(encodeURIComponent(parameterToEncode))}}for(var options={position:1,width:dialogWidth,height:dialogHeight},callbackRef=Common.createCallbackFunctionFactory(dialogCallbackFunction,dialogCallbackParameters),dialogArguments=new Array(selectedRecords.length),i=0;i<selectedRecords.length;i++)dialogArguments[i]=selectedRecords[i].Id;Common.appendAppIdAndOpenLegacyWebDialog(actionUri,options,dialogArguments,callbackRef)};Common.appendAppIdAndOpenLegacyWebDialog=function(actionUri,options,dialogArguments,callbackRef){if(dialogArguments===void 0)dialogArguments=null;if(callbackRef===void 0)callbackRef=null;if(actionUri.indexOf("appid=")<0){var globalContext=Xrm.Utility.getGlobalContext();globalContext.getCurrentAppProperties().then(function(appProperties){if(appProperties["appId"])actionUri=actionUri.concat("&appid=",encodeURIComponent(appProperties["appId"]));Xrm.Internal.openLegacyWebDialog(actionUri,options,dialogArguments,null,callbackRef)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}else Xrm.Internal.openLegacyWebDialog(actionUri,options,dialogArguments,null,callbackRef)};Common.isBusy=false;Common.createCallbackFunctionFactory=function(func,parameters){return function(retValue){parameters.unshift(retValue);return func.apply(null,parameters)}};return Common}();Commands.Common=Common})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DeactivateLibraryLegacy=function(){function DeactivateLibraryLegacy(){this.deactivateRecordsLegacy=function(gridControl,records,entityTypeCode,defaultCloseState){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.deactivate(gridControl,records,entityTypeCode,defaultCloseState):backCompatHeader.Mscrm.GridCommandActions.deactivate(gridControl,records,entityTypeCode,defaultCloseState)}}DeactivateLibraryLegacy.prototype.deactivatePrimaryRecord=function(id,entityName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.deactivate(id,entityName):backCompatHeader.Mscrm.CommandBarActions.deactivate(id,entityName)};DeactivateLibraryLegacy.prototype.deactivateRecords=function(gridControl,records,entityName,defaultCloseState,callback){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.deactivate(gridControl,records,entityTypeCode,defaultCloseState,callback):backCompatHeader.Mscrm.GridCommandActions.deactivate(gridControl,records,entityTypeCode,defaultCloseState,callback)};return DeactivateLibraryLegacy}();Commands.DeactivateLibraryLegacy=DeactivateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DeactivateLibrary=function(){function DeactivateLibrary(){var _this=this;this.deactivateRecordsLegacy=function(gridControl,records,entityTypeCode,defaultCloseState){if(Xrm.Internal.isUci()&&entityTypeCode==4200){var thisObject=_this,promise=Xrm.Utility.getEntitiesMetadata(Commands.Common.GetEntityNamesFromActivityRecords(records));records.length>0&&promise.then(function(values){!Commands.Common.CheckIfIsReadOnlyInMobileClient(values)&&thisObject.deactivateRecords(gridControl,records,Xrm.Internal.getEntityName(entityTypeCode),defaultCloseState)})}else _this.deactivateRecords(gridControl,records,Xrm.Internal.getEntityName(entityTypeCode),defaultCloseState)}}DeactivateLibrary.prototype.deactivatePrimaryRecord=function(id,entityName){var stateCode=1;switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DuplicateRule:stateCode=0;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConvertRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RoutingRule:Commands.Common.changeState(entityName,id,false);return}Xrm.Utility.getEntityMetadata(entityName,["statecode"]).then(function(entityMetadata){if(entityMetadata.EnforceStateTransitions){Commands.Common.changeState(entityName,id,false);return}var stateMetadata=entityMetadata.Attributes.get("statecode"),statusCodes=stateMetadata.getStatusValuesForState(stateCode);if(statusCodes&&statusCodes.length>0)Commands.Common.changeState(entityName,id,false);else{Xrm.Page.data.save({saveMode:5});Commands.Common.setState(id,entityName,stateCode)}},function(errorParameter){XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(errorParameter)})};DeactivateLibrary.prototype.deactivateRecords=function(gridControl,records,entityName,defaultCloseState,callback){if(!records.length){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")});return}Xrm.Utility.getEntityMetadata(entityName).then(function(entityMetadata){if(entityMetadata.IsInteractionCentricEnabled)for(var logicalName=records[0].TypeName,i=1;i<records.length;i++)if(records[i].TypeName===logicalName)continue;else{Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Apply_Rule_Heterogenous_Activity_Type_Records_Selected")});return}var options={position:1,width:600,height:250};switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BusinessUnit:options.width=650;options.height=280;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DiscountType:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:options.height=200;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse:options.height=250;options.width=400;break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:for(var record=records[0],i=1;i<records.length;i++)if(records[i].TypeName!==record.TypeName){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Apply_Rule_Heterogenous_Activity_Type_Records_Selected")});return}switch(record.TypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SocialActivity:Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Apply_Rule_Social_Activity_Type_Records_Selected_For_Invalid_Action")});return;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email:Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Apply_Rule_Selected_Emails")});return;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity:if(defaultCloseState===1){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Apply_Rule_Selected_Records")});return}break}entityName=record.TypeName;break}DeactivateLibrary.openDialog(gridControl,records,entityName,defaultCloseState,callback,options)},function(errorParameter){XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(errorParameter)})};DeactivateLibrary.openDialog=function(gridControl,records,entityName,defaultCloseState,callback,options){for(var i=0;i<records.length;i++){var resourceString=null;switch(records[i].TypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SocialActivity:resourceString="Grid_Apply_Rule_Social_Activity_Type_Records_Selected_For_Invalid_Action";break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email:resourceString="Grid_Apply_Rule_Selected_Emails";break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity:if(defaultCloseState===1)resourceString="Grid_Apply_Rule_Selected_Records";break}if(resourceString!=null){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString(resourceString)});return}}var dialogArguments={};dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=records;dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.action]=XrmCore.InternalUtilities.DialogUtilities.DialogConstants.deactivate;dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked]="";dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StateId]=-1;dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.StatusId]=-1;if((defaultCloseState||defaultCloseState===0)&&defaultCloseState!==-1)dialogArguments[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.defaultCloseState]=defaultCloseState;var client=Xrm.Utility.getGlobalContext().client.getClient();if(client===Xrm.Constants.ClientNames.web||client==Xrm.Constants.ClientNames.outlook||client==Xrm.Constants.ClientNames.unifiedServiceDesk)options={position:1,width:600,height:250};Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.SetStateDialog,options,dialogArguments).then(function(successParameter){var dialogCallbackParams={};Commands.Common.closeSetStateDialogFromGridCallback(successParameter.parameters,dialogCallbackParams,gridControl,callback)})};return DeactivateLibrary}();Commands.DeactivateLibrary=DeactivateLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Deactivate=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.DeactivateLibrary:new Commands.DeactivateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DeleteLibrary=function(){function DeleteLibrary(){var _this=this;this.deletePrimaryRecord=function(id,entityName){var dialogstrings={title:"",subtitle:"",text:"",confirmButtonLabel:"",cancelButtonLabel:""},url={},dialogOptions=null;Xrm.Utility.getEntityMetadata(entityName).then(function(metadata){switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Appointment:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account:dialogOptions=_this.GetDialogOptions(450,275,1);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TopicModel:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DynamicProperty:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OpportunityProduct:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QuoteDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesOrderDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.InvoiceDetail:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Queue:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SharePointSite:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Workflow:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Product:break;default:break}XrmCore.InternalUtilities.DialogUtilities.tryGetDialogStringsForEnabledMetadataDialogs(XrmCore.InternalUtilities.DialogUtilities.DialogName.DeleteDialog,dialogstrings,entityName,1,url,metadata.DisplayName,metadata.DisplayCollectionName,metadata.IsDocumentManagementEnabled,true);Xrm.Navigation.openConfirmDialog(dialogstrings,dialogOptions).then(function(result){if(result.confirmed){XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();Xrm.WebApi.deleteRecord(entityName,id).then(function(success){Xrm.Utility.closeProgressIndicator();if(success&&success.entityType&&success.id&&success.name)if(Xrm.Page.data.attributes["IsInteractionWallQuickAction"]&&Xrm.Page.data.attributes["IsInteractionWallQuickAction"].fireOnChange)Xrm.Page.data.attributes["IsInteractionWallQuickAction"].fireOnChange;else Xrm.Page.ui.close();else Xrm.Page.ui.close()},function(error){Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})}})})};this.deleteRecordsLegacy=function(gridControl,records,entityTypeCode){_this.deleteRecords(gridControl,records,Xrm.Internal.getEntityName(entityTypeCode))};this.deleteRecords=function(gridControl,records,entityTypeName){var actionUri={};if(records.length<=0){var alert={text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")};Xrm.Navigation.openAlertDialog(alert);return}var dialogstrings={title:"",subtitle:"",text:"",confirmButtonLabel:"",cancelButtonLabel:""};if(XrmCore.InternalUtilities.DialogUtilities.isOffline()&&records&&records.length===1&&entityTypeName===Xrm.Constants.EntityNames.ActivityPointer)entityTypeName=records[0].TypeName;Xrm.Utility.getEntityMetadata(entityTypeName).then(function(metadata){XrmCore.InternalUtilities.DialogUtilities.tryGetDialogStringsForEnabledMetadataDialogs(XrmCore.InternalUtilities.DialogUtilities.DialogName.DeleteDialog,dialogstrings,entityTypeName,records.length,actionUri,metadata.DisplayName,metadata.DisplayCollectionName,metadata.IsDocumentManagementEnabled);var dialogOptions=null;if(Xrm.Utility.isActivityType(entityTypeName));if(entityTypeName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Workflow)switch(entityTypeName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BulkOperation:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Queue:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportMap:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Appointment:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Equipment:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contract:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QueueItem:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Solution:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemForm:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Audit:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SharePointSite:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Calendar:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Account:dialogOptions=_this.GetDialogOptions(450,275,1);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OpportunityProduct:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QuoteDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesOrderDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.InvoiceDetail:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CalendarRule:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Product:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DynamicProperty:break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Connection:var subGridControl=gridControl;if(subGridControl.getGridType&&(subGridControl.getGridType()===3||subGridControl.getGridType()===2)){var gridLabel=void 0;if(subGridControl.getLabel&&subGridControl.getLabel())gridLabel=subGridControl.getLabel();else gridLabel=metadata.DisplayName;if(records.length===1)dialogstrings.text=XrmCore.InternalUtilities.GenericUtilities.stringFormat(dialogstrings.text,[records[0].Name,gridLabel]);else dialogstrings.text=XrmCore.InternalUtilities.GenericUtilities.stringFormat(dialogstrings.text,[gridLabel])}default:break}Xrm.Navigation.openConfirmDialog(dialogstrings,dialogOptions).then(function(result){if(result.confirmed){if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){if(Xrm.Mobile.offline.isOfflineEnabled(entityTypeName)){if(records.length>1){var alert_2={text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Delete_Multiple_Offline")};Xrm.Navigation.openAlertDialog(alert_2);return}XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();Xrm.WebApi.offline.deleteRecord(entityTypeName,records[0].Id).then(function(success){gridControl&&gridControl.refresh();Xrm.Utility.closeProgressIndicator()},function(error){gridControl&&gridControl.refresh();Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})}else XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();if(records.length===1)Xrm.WebApi.online.deleteRecord(records[0].TypeName,records[0].Id).then(function(success){gridControl&&gridControl.refresh();Xrm.Utility.closeProgressIndicator()},function(error){gridControl&&gridControl.refresh();Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)});else{var deleteBatch=records.map(function(record){var entityReference={entityType:record.TypeName,id:record.Id};return new XrmCore.SdkContracts.DeleteRequest(entityReference)});Xrm.WebApi.online.executeMultiple(deleteBatch).then(function(success){Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.onGridActionMultipleSuccess(gridControl,success);var postDeleteActionBatch=_this.postDeleteActions(records,gridControl,entityTypeName);postDeleteActionBatch&&postDeleteActionBatch.length>0&&Xrm.WebApi.online.executeMultiple(postDeleteActionBatch).then(function(success){},function(error){gridControl&&gridControl.refresh();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})},function(error){gridControl&&gridControl.refresh();Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})}}})})};this.postDeleteActions=function(records,gridControl,entityType){var postDeleteActionBatch;switch(entityType){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Connection:var SALES_TEAM_VIEW_ID="FE4BC089-8901-466C-A41B-1C1090F204D4",currentViewId=gridControl&&gridControl.getViewSelector().getCurrentView().id,viewId=currentViewId&&currentViewId.replace("{","").replace("}","").toUpperCase();if(viewId&&viewId==SALES_TEAM_VIEW_ID){var ACCESS_TEAM_TEMPLATE_ID_1="B3228218-B8F6-4A1B-A18D-552C6F980831",parentControl=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,parentEntity_1=parentControl.data.entity;postDeleteActionBatch=records.map(function(record){return _this.removeUserFromRecordTeam(record.Id,parentEntity_1,ACCESS_TEAM_TEMPLATE_ID_1)})}break}return postDeleteActionBatch}}DeleteLibrary.prototype.GetDialogOptions=function(height,width,position){var dialogOptions={height:height,width:width,position:position};return dialogOptions};DeleteLibrary.prototype.removeUserFromRecordTeam=function(userId,parentEntity,teamTemplateId){var removeUserFromTeamRequest=new XrmCore.SdkContracts.RemoveUserFromRecordTeamRequest({id:userId,entityType:XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser},{id:parentEntity.getId(),entityType:parentEntity.getEntityName()},{id:teamTemplateId,entityType:XrmCore.InternalUtilities.EntityUtilities.EntityNames.TeamTemplate});return removeUserFromTeamRequest};return DeleteLibrary}();Commands.DeleteLibrary=DeleteLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DeleteLibraryLegacy=function(){function DeleteLibraryLegacy(){}DeleteLibraryLegacy.prototype.deletePrimaryRecord=function(id,entityName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.deletePrimaryRecord(id,entityName):backCompatHeader.Mscrm.CommandBarActions.deletePrimaryRecord(id,entityName)};DeleteLibraryLegacy.prototype.deleteRecordsLegacy=function(gridControl,records,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.deleteRecords(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.deleteRecords(gridControl,records,entityTypeCode)};DeleteLibraryLegacy.prototype.deleteRecords=function(gridControl,records,entityTypeName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.deleteRecords(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.deleteRecords(gridControl,records,entityTypeCode)};return DeleteLibraryLegacy}();Commands.DeleteLibraryLegacy=DeleteLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var EmailCopyLinkLibraryLegacy=function(){function EmailCopyLinkLibraryLegacy(){this.sendCurrentViewUrl=function(useEmail,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.sendCurrentViewUrl(useEmail,gridControl):backCompatHeader.Mscrm.Utilities.sendSelectedRecordsUrl(useEmail,gridControl)}}EmailCopyLinkLibraryLegacy.prototype.emailCopyLinkPrimaryRecord=function(usingEmail,form){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.sendFormShortcut(usingEmail,form):backCompatHeader.Mscrm.RibbonActions.sendFormShortcut(usingEmail,form)};EmailCopyLinkLibraryLegacy.prototype.emailCopyLinkRecordsLegacy=function(usingEmail,records,entityTypeCode,writeUrlOnly){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.Utilities?Mscrm.Utilities.sendSelectedRecordsUrl(usingEmail,records,entityTypeCode,writeUrlOnly):backCompatHeader.Mscrm.Utilities.sendSelectedRecordsUrl(usingEmail,records,entityTypeCode,writeUrlOnly)};EmailCopyLinkLibraryLegacy.prototype.emailCopyLinkRecords=function(usingEmail,records,entityName,writeUrlOnly){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.Utilities?Mscrm.Utilities.sendSelectedRecordsUrl(usingEmail,records,entityTypeCode,writeUrlOnly):backCompatHeader.Mscrm.Utilities.sendSelectedRecordsUrl(usingEmail,records,entityTypeCode,writeUrlOnly)};return EmailCopyLinkLibraryLegacy}();Commands.EmailCopyLinkLibraryLegacy=EmailCopyLinkLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var EmailCopyLinkLibrary=function(){function EmailCopyLinkLibrary(){this.sendCurrentViewUrl=function(useEmail,gridControl){var clientTypeValue=Xrm.Utility.getGlobalContext().client.getClient(),clientType=clientTypeValue===Xrm.Constants.ClientNames.mobile?1:0,currentWebViewUrl=gridControl.getUrl(),currentBrowserViewUrl=gridControl.getUrl(clientType),webLinkResourceString=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web Link")||"Web Link",title=gridControl.getViewSelector().getCurrentView().name,encodedNewLine=encodeURIComponent("<br>"),formattedBrowserLink=XrmCore.InternalUtilities.GenericUtilities.stringFormat(EmailCopyLinkLibrary.generalEmailBodyFormat,[currentBrowserViewUrl,title]),body=encodeURIComponent(formattedBrowserLink);if(clientType===1){var formattedWebLink=EmailCopyLinkLibrary.isAndroid()?XrmCore.InternalUtilities.GenericUtilities.stringFormat(EmailCopyLinkLibrary.generalEmailLinkForAndroidIntoBrackets,[webLinkResourceString,currentWebViewUrl]):XrmCore.InternalUtilities.GenericUtilities.stringFormat(EmailCopyLinkLibrary.generalEmailLinkIntoBrackets,[currentWebViewUrl,webLinkResourceString]);body+=encodeURIComponent(formattedWebLink)+encodedNewLine}useEmail&&EmailCopyLinkLibrary.openEmailForm("",title,body,null)}}EmailCopyLinkLibrary.prototype.emailCopyLinkPrimaryRecord=function(usingEmail,form){var entity=Xrm.Page.data.entity,entityTitle=entity.getPrimaryAttributeValue(),recordId=entity.getId(),entityLogicalName=entity.getEntityName(),ccFieldValue="",records=[];records.push({Id:recordId,Name:entityTitle,TypeName:entityLogicalName});EmailCopyLinkLibrary.emailCopyLinks(usingEmail,records,entityLogicalName,false,ccFieldValue)};EmailCopyLinkLibrary.prototype.emailCopyLinkRecordsLegacy=function(usingEmail,records,entityTypeCode,writeUrlOnly){EmailCopyLinkLibrary.emailCopyLinks(usingEmail,records,Xrm.Internal.getEntityName(entityTypeCode),writeUrlOnly)};EmailCopyLinkLibrary.prototype.emailCopyLinkRecords=function(usingEmail,records,entityName,writeUrlOnly){EmailCopyLinkLibrary.emailCopyLinks(usingEmail,records,entityName,writeUrlOnly)};EmailCopyLinkLibrary.emailCopyLinks=function(usingEmail,records,entityName,writeUrlOnly,ccFieldValue){if(!records||!records.length){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")});return}if(records.length>10){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Max_Shortcut_Record_Reached")});return}if(!writeUrlOnly)writeUrlOnly=!usingEmail&&records.length===1;for(var subject=" ",body="",clientTypeValue=Xrm.Utility.getGlobalContext().client.getClient(),clientType=clientTypeValue===Xrm.Constants.ClientNames.mobile?1:0,i=0;i<records.length;i++){var record=records[i],value={entityType:record.TypeName,id:record.Id,name:record.Name},pageUrl=Xrm.Internal.getCurrentPageUrl(value,clientType),browserUrl=Xrm.Internal.getEmailLink(value),entityTitle=record.Name,url=clientType==1||record.TypeName==="report"?browserUrl:pageUrl,encodedNewLine=encodeURIComponent("<br>"),linkBracket=EmailCopyLinkLibrary.isAndroid()?EmailCopyLinkLibrary.newLineReplaceWithBreak(EmailCopyLinkLibrary.generalEmailLinkForIntoBrackets)+"<br>":EmailCopyLinkLibrary.generalEmailLinkForIntoBrackets,formattedWebLink=XrmCore.InternalUtilities.GenericUtilities.stringFormat(linkBracket,[writeUrlOnly?url:entityTitle,url]);if(clientType===1&&EmailCopyLinkLibrary.isiOSdevice()){body+=encodeURIComponent(entityTitle);var webLinkResourceString=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("EmailLink_WebLinkText")||"Web Link",formattediOSLink=XrmCore.InternalUtilities.GenericUtilities.stringFormat(EmailCopyLinkLibrary.generalEmailLinkIntoBrackets,[browserUrl,webLinkResourceString]);body+=encodeURIComponent(formattediOSLink)+encodedNewLine}else body+=encodeURIComponent(formattedWebLink);if(i===0&&records.length===1)subject=entityTitle}EmailCopyLinkLibrary.openEmailForm("",subject,body,ccFieldValue)};EmailCopyLinkLibrary.openEmailForm=function(to,subject,body,cc){var mailtoLink="mailto:";if(to){var index=to.lastIndexOf("@");if(index>=0&&index<to.length)mailtoLink+=encodeURIComponent(to.substr(0,index))+"@"+encodeURIComponent(to.substr(index+1));else mailtoLink+=encodeURIComponent(to)}var seporator="?";if(cc){mailtoLink+=seporator+"cc="+encodeURIComponent(cc);seporator="&"}if(subject){mailtoLink+=seporator+"subject="+encodeURIComponent(subject);seporator="&"}if(body)mailtoLink+=seporator+"body="+body;var maxAllowableLength=2020;if(mailtoLink.length>maxAllowableLength){var errorDialogOptions={message:"",errorCode:-2147204303};Xrm.Navigation.openErrorDialog(errorDialogOptions)}else Xrm.Navigation.openUrl(mailtoLink,{isExternal:true})};EmailCopyLinkLibrary.isAndroid=function(){return navigator.platform&&/Android|Linux/g.test(navigator.platform)};EmailCopyLinkLibrary.isiOSdevice=function(){return navigator.platform=="iPad"||navigator.platform=="iPhone"};EmailCopyLinkLibrary.newLineReplaceWithBreak=function(str){return str.replace("\n","<br/>")};EmailCopyLinkLibrary.generalEmailBodyFormat='<a href="{0}">{1}</a>';EmailCopyLinkLibrary.generalEmailLinkForAndroidIntoBrackets=" ({0}: {1})";EmailCopyLinkLibrary.generalEmailLinkForIntoBrackets="{0}\n({1})\n";EmailCopyLinkLibrary.generalEmailLinkIntoBrackets=" ("+EmailCopyLinkLibrary.generalEmailBodyFormat+")";return EmailCopyLinkLibrary}();Commands.EmailCopyLinkLibrary=EmailCopyLinkLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.EmailCopyLink=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.EmailCopyLinkLibrary:new Commands.EmailCopyLinkLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var EntityImageUpload=function(){function EntityImageUpload(){}EntityImageUpload.DialogLoad=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=formContext.data.attributes,entityImageUrl=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImageUrlParameter).getValue(),entityPrimaryAttribute=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityPrimaryAttributeParameter).getValue(),entityImageData=JSON.stringify({mode:entityImageUrl?0:1,entityPrimaryField:entityPrimaryAttribute,imageSrc:entityImageUrl,dialogModeLabel:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_CurrentEntityImage")});dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImagePreviewId).setValue(entityImageData);if(entityImageUrl===null)formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.UseDefaultId).setVisible(false);else formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.UseDefaultId).setVisible(true);var isNotMobile=Xrm.Utility.getGlobalContext().client.getClient()!=Xrm.Constants.ClientNames.mobile;if(isNotMobile)formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.TakePhotoId).setVisible(false);else formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.TakePhotoId).setVisible(true);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.UploadImageId).setVisible(true);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId).setVisible(false);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogCancelId).setVisible(false)};EntityImageUpload.TakePhoto=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=eventContext.getFormContext().data.attributes,options={height:144,width:144,quality:50,allowEdit:true,preferFrontCamera:false};Xrm.Device.captureImage(options).then(function(file){EntityImageUpload._switchDialogMode(eventContext,true);EntityImageUpload._setEntityImagePreivewData(file,dialogAttributes)},function(error){var alert={text:error.message};Xrm.Navigation.openAlertDialog(alert)})};EntityImageUpload.UploadPhoto=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=eventContext.getFormContext().data.attributes,options={allowMultipleFiles:false,accept:"image/*"},imageFormats=/(\.jpg|\.png|\.JPG|\.PNG|\.gif|\.GIF|\.jpeg|\.JPEG|\.tif|\.TIF|.\tiff|.\TIFF|.\bmp|.\BMP)$/;Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.mobile&&XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();Xrm.Device.pickFile(options).then(function(files){if(files[0].fileName.match(imageFormats)){EntityImageUpload._switchDialogMode(eventContext,true);EntityImageUpload._setEntityImagePreivewData(files[0],dialogAttributes)}else{var alert_3={text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_UploadImage_ErrorMsg")};Xrm.Navigation.openAlertDialog(alert_3)}Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.mobile&&Xrm.Utility.closeProgressIndicator()},function(error){if(error.errorCode!=0){var alert_4={text:error.message};Xrm.Navigation.openAlertDialog(alert_4)}Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.mobile&&Xrm.Utility.closeProgressIndicator()})};EntityImageUpload.UseDefault=function(eventContext){EntityImageUpload._switchDialogMode(eventContext,true);var dialogAttributes=eventContext.getFormContext().data.attributes,entityPrimaryAttribute=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityPrimaryAttributeParameter).getValue(),entityImageData=JSON.stringify({mode:1,entityPrimaryField:entityPrimaryAttribute,imageSrc:"",dialogModeLabel:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_NewEntityImage")});dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImagePreviewId).setValue(entityImageData);dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImageDataParameter).setValue("")};EntityImageUpload.Update=function(eventContext){var dialogAttributes=eventContext.getFormContext().data.attributes,imageData=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImageDataParameter).getValue(),entityImageData={entityimage:imageData},entityLogicalName=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityLogicalNameParameter).getValue(),entityId=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityIdParameter).getValue();XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();Xrm.WebApi.updateRecord(entityLogicalName,entityId,entityImageData).then(function(){Xrm.Page.ui.close();Xrm.Utility.closeProgressIndicator()},function(error){var alert={text:error.message};Xrm.Navigation.openAlertDialog(alert);Xrm.Utility.closeProgressIndicator()})};EntityImageUpload.Cancel=function(eventContext){EntityImageUpload._switchDialogMode(eventContext,false);var dialogAttributes=eventContext.getFormContext().data.attributes,entityImageUrl=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImageUrlParameter).getValue(),entityPrimaryAttribute=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityPrimaryAttributeParameter).getValue(),entityImageData=JSON.stringify({mode:entityImageUrl?0:1,entityPrimaryField:entityPrimaryAttribute,imageSrc:entityImageUrl,dialogModeLabel:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_CurrentEntityImage")});dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImagePreviewId).setValue(entityImageData)};EntityImageUpload._switchDialogMode=function(eventContext,isConfirmation){var formContext=eventContext.getFormContext(),dialogAttributes=formContext.data.attributes,editModeLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_ChangeImage"),confirmationModeLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_UpdateImage"),entityImageUrl=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImageUrlParameter).getValue(),editModeDescriptionLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_ChangeImage_Description"),confirmationModeDescriptionLabel=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_UpdateImage_Description");formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.TitleId).setLabel(isConfirmation?confirmationModeLabel:editModeLabel);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DescriptionId).setLabel(isConfirmation?confirmationModeDescriptionLabel:editModeDescriptionLabel);var isMobile=Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.mobile;isMobile&&formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.TakePhotoId).setVisible(!isConfirmation);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.UploadImageId).setVisible(!isConfirmation);entityImageUrl!==null&&formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.UseDefaultId).setVisible(!isConfirmation);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId).setVisible(isConfirmation);formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogCancelId).setVisible(isConfirmation);if(isConfirmation)formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId).setFocus();else if(isMobile)formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.TakePhotoId).setFocus();else formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.UploadImageId).setFocus()};EntityImageUpload._setEntityImagePreivewData=function(file,dialogAttributes){var base64FileContent=file.fileContent,entityPrimaryAttribute=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityPrimaryAttributeParameter).getValue(),entityImageData=JSON.stringify({mode:0,entityPrimaryField:entityPrimaryAttribute,imageSrc:"data:image;base64,"+base64FileContent,dialogModeLabel:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_EntityImage_NewEntityImage")});dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImagePreviewId).setValue(entityImageData);dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityImageDataParameter).setValue(base64FileContent)};return EntityImageUpload}();Commands.EntityImageUpload=EntityImageUpload})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DeviceSettings=function(){function DeviceSettings(){}DeviceSettings.onLoadDeviceSettings=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=formContext.data.attributes;dialogAttributes.get("is_saved").setValue(false);var deviceSettings=dialogAttributes.get("device_settings").getValue(),isOfflineControlHidden=dialogAttributes.get("is_offline_control_hidden").getValue(),isOfflineSyncEnabled=dialogAttributes.get("is_offlinesync_enabled").getValue(),isOfflineInitializing=dialogAttributes.get("is_offline_initializing").getValue();DeviceSettings.setOfflineSync(formContext,isOfflineControlHidden,isOfflineSyncEnabled,isOfflineInitializing);DeviceSettings.setUserContentAndLocation(dialogAttributes,deviceSettings);DeviceSettings.setCamera(dialogAttributes,deviceSettings);DeviceSettings.isLoaded=true};DeviceSettings.saveButtonClick=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=formContext.data.attributes,deviceSettings=dialogAttributes.get("device_settings").getValue(),isOfflineSyncEnabled=dialogAttributes.get("is_offlinesync_enabled").getValue(),oldDeviceSettings=JSON.stringify(deviceSettings);DeviceSettings.saveGeneralParameters(dialogAttributes,deviceSettings);DeviceSettings.saveCamera(dialogAttributes,deviceSettings);DeviceSettings.saveVideo(dialogAttributes,deviceSettings);if(JSON.stringify(deviceSettings)===oldDeviceSettings&&isOfflineSyncEnabled===dialogAttributes.get("offlineSync").getValue())dialogAttributes.get("is_saved").setValue(false);else{dialogAttributes.get("device_settings").setValue(deviceSettings);dialogAttributes.get("is_offlinesync_enabled").setValue(dialogAttributes.get("offlineSync").getValue());dialogAttributes.get("is_saved").setValue(true)}Xrm.Page.ui.close()};DeviceSettings.closeButtonClick=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=formContext.data.attributes;dialogAttributes.get("is_saved").setValue(false);Xrm.Page.ui.close()};DeviceSettings.onUserContentAndLocationChanged=function(eventContext){var formContext=eventContext.getFormContext(),dialogAttributes=formContext.data.attributes,userContentAndLocation=dialogAttributes.get("userContentAndLocation");if(DeviceSettings.isLoaded&&userContentAndLocation.getValue()){userContentAndLocation.setValueInternal(false);Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.DeviceSettingsConsentDialog,null,null).then(function(response){response.parameters["is_confirmed"]&&userContentAndLocation.setValueInternal(true)})}};DeviceSettings.setOfflineSync=function(formContext,isOfflineControlHidden,isOfflineSyncEnabled,isOfflineInitializing){var dialogAttributes=formContext.data.attributes,offlineSync=dialogAttributes.get("offlineSync"),offlineSyncControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OfflineSync);if(isOfflineControlHidden){offlineSyncControl.setVisible(false);offlineSync.setValueInternal(false)}else if(isOfflineSyncEnabled){offlineSync.setValueInternal(isOfflineSyncEnabled);isOfflineInitializing&&offlineSyncControl.setDisabled(true)}else offlineSync.setValueInternal(false)};DeviceSettings.setUserContentAndLocation=function(dialogAttributes,deviceSettings){var userContentAndLocation=dialogAttributes.get("userContentAndLocation");userContentAndLocation.setValueInternal(deviceSettings["microphone"].isEnabled&&deviceSettings["geolocation"].isEnabled)};DeviceSettings.setCamera=function(dialogAttributes,deviceSettings){var cameraEnabled=dialogAttributes.get("cameraEnabled");cameraEnabled.setValueInternal(deviceSettings["camera"].isEnabled);var savePhotoToLibrary=dialogAttributes.get("savePhotoToLibrary");savePhotoToLibrary.setValueInternal(deviceSettings["camera"].savePhoto);dialogAttributes.get("photoResolution").setValue(deviceSettings["camera"].imageRes)};DeviceSettings.saveGeneralParameters=function(dialogAttributes,deviceSettings){var parameters=["geolocation","microphone"],attributeName;parameters.forEach(function(item){attributeName="userContentAndLocation";if(deviceSettings[item])deviceSettings[item].isEnabled=dialogAttributes.get(attributeName).getValue();else{var feature=(_a={},_a[item]={featureName:item,isEnabled:dialogAttributes.get(attributeName).getValue()},_a);Object.assign(deviceSettings,feature)}var _a})};DeviceSettings.saveCamera=function(dialogAttributes,deviceSettings){var attribute=dialogAttributes.get("photoResolution");if(deviceSettings["camera"]){deviceSettings["camera"].isEnabled=dialogAttributes.get("cameraEnabled").getValue();deviceSettings["camera"].savePhoto=dialogAttributes.get("savePhotoToLibrary").getValue();deviceSettings["camera"].imageRes=attribute.getSelectedOption().value}else{var camera={camera:{featureName:"camera",isEnabled:dialogAttributes.get("cameraEnabled").getValue(),savePhoto:dialogAttributes.get("savePhotoToLibrary").getValue(),imageRes:attribute.getSelectedOption().value}};Object.assign(deviceSettings,camera)}};DeviceSettings.saveVideo=function(dialogAttributes,deviceSettings){var videoValue=dialogAttributes.get("cameraEnabled").getValue()&&dialogAttributes.get("userContentAndLocation").getValue();if(deviceSettings["video"])deviceSettings["video"].isEnabled=videoValue;else{var video={video:{featureName:"video",isEnabled:videoValue}};Object.assign(deviceSettings,video)}};DeviceSettings.isLoaded=false;return DeviceSettings}();Commands.DeviceSettings=DeviceSettings})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ExportLibraryLegacy=function(){function ExportLibraryLegacy(){this.exportToExcelLegacy=function(gridControl,entityTypeCode,exportType){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.exportToXlsx(gridControl,entityTypeCode,exportType):backCompatHeader.Mscrm.GridRibbonActions.exportToXlsx(gridControl,entityTypeCode,exportType)};this.exportToExcel=function(gridControl,entityTypeName,exportType){var entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName),backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.exportToXlsx(gridControl,entityTypeCode,exportType):backCompatHeader.Mscrm.GridRibbonActions.exportToXlsx(gridControl,entityTypeCode,exportType)};this.generateWordTemplateFlyout=function(commandProperties,entityTypeName,isForm,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.generateWordTemplateFlyout(commandProperties,entityTypeName,isForm,gridControl):backCompatHeader.Mscrm.CommandBarActions.generateWordTemplateFlyout(commandProperties,entityTypeName,isForm,gridControl)};this.generateExcelTemplateFlyout=function(commandProperties,entityTypeName,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.generateDocumentTemplateFlyout(commandProperties,entityTypeName,gridControl):backCompatHeader.Mscrm.CommandBarActions.generateDocumentTemplateFlyout(commandProperties,entityTypeName,gridControl)};this.runExcelTemplate=function(commandProperties,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.runDocumentTemplate(commandProperties,gridControl):backCompatHeader.Mscrm.GridRibbonActions.runDocumentTemplate(commandProperties,gridControl)};this.runWordTemplate=function(commandProperties,entityTypeName,gridControl,selectedRecords){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.runWordTemplate(commandProperties,entityTypeName,gridControl,selectedRecords):backCompatHeader.Mscrm.GridRibbonActions.runWordTemplate(commandProperties,entityTypeName,gridControl,selectedRecords)}}return ExportLibraryLegacy}();Commands.ExportLibraryLegacy=ExportLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ExportToExcelType;(function(ExportToExcelType){ExportToExcelType[ExportToExcelType["DynamicXlsx"]=2]="DynamicXlsx";ExportToExcelType[ExportToExcelType["PivotXlsx"]=3]="PivotXlsx";ExportToExcelType[ExportToExcelType["StaticXlsx"]=4]="StaticXlsx";ExportToExcelType[ExportToExcelType["AllStaticXlsx"]=5]="AllStaticXlsx";ExportToExcelType[ExportToExcelType["OnlineExcel"]=6]="OnlineExcel"})(ExportToExcelType||(ExportToExcelType={}));var ExportLibrary=function(){function ExportLibrary(){var _this=this;this.getExportTypeName=function(exportType){var exportTypeName="";switch(exportType){case ExportToExcelType.AllStaticXlsx:exportTypeName="AllStaticXlsx";break;case ExportToExcelType.StaticXlsx:exportTypeName="StaticXlsx";break;case ExportToExcelType.DynamicXlsx:exportTypeName="DynamicXlsx";break;case ExportToExcelType.PivotXlsx:exportTypeName="PivotXlsx";break;case ExportToExcelType.OnlineExcel:exportTypeName="OnlineExcel";break}return exportTypeName};this.exportToExcelLegacy=function(gridControl,entityTypeCode,exportType){var entityTypeName=Xrm.Internal.getEntityName(entityTypeCode);_this.exportToExcel(gridControl,entityTypeName,exportType,null)};this.exportToExcel=function(gridControl,entityTypeName,exportType,selectedRecords){var exportTypeName=_this.getExportTypeName(exportType);Commands.ExportTelemetryHelper.logExportInitTelemetry("ExportToExcel.Init",entityTypeName,exportTypeName);if(exportType==ExportToExcelType.OnlineExcel)_this.exportToExcelOnline(gridControl,entityTypeName,exportType);else if(exportType==ExportToExcelType.DynamicXlsx||exportType==ExportToExcelType.PivotXlsx)_this.exportToDynamicExcel(gridControl,entityTypeName,exportType);else _this.exportToStandardExcel(gridControl.getViewSelector().getCurrentView(),gridControl.getFetchXml(),entityTypeName,exportType,selectedRecords)};this.exportToStandardExcel=function(currentView,fetchXml,entityTypeName,exportType,selectedRecords){var exportTypeName=_this.getExportTypeName(exportType),documentType=1,openMode={openMode:2},dom_Fetch=XrmCore.InternalUtilities.ExportUtilities.getXmlDOMFromString(fetchXml);if(exportType==ExportToExcelType.AllStaticXlsx){dom_Fetch.getElementsByTagName("fetch")[0].removeAttribute("page");dom_Fetch.getElementsByTagName("fetch")[0].removeAttribute("count")}fetchXml=XrmCore.InternalUtilities.ExportUtilities.getXmlAsString(dom_Fetch);var keys=selectedRecords!=null?["selectedRecords"]:[],values=selectedRecords!=null?[{Type:"System.String",Value:selectedRecords.toString()}]:[],arg=new XrmCore.SdkContracts.InputArgument(selectedRecords!=null?1:0,true,keys,values),argCol=new XrmCore.SdkContracts.InputArgumentCollection(arg),r=new XrmCore.SdkContracts.ExportToExcelRequest(currentView,fetchXml,"","",argCol);Commands.ExportTelemetryHelper.logExportDetailsTelemetry("ExportToExcel.Details",entityTypeName,exportTypeName,currentView.name,currentView.entityType,currentView.id);Xrm.Utility.showProgressIndicator(Xrm.Utility.getResourceString("Main_system_library","ExportToXlsx_ProgressDialog_Header"));var deferred=Xrm.WebApi.online.execute(r).then(function(res){return res.json()}).then(function(odataResponse){var file={fileContent:odataResponse.ExcelFile,fileName:XrmCore.InternalUtilities.ExportUtilities.generateExportFileName(currentView.name,documentType),mimeType:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};return Xrm.Navigation.openFile(file,openMode)}).then(function(res){console.log(res);Commands.ExportTelemetryHelper.logExportSuccessTelemetry("ExportToExcel.Completed",entityTypeName,exportTypeName);Xrm.Utility.closeProgressIndicator()}).then(undefined,function(err){console.error(err);Commands.ExportTelemetryHelper.logFailureTelemetry("ExportToExcel.Failure",err,entityTypeName,exportTypeName);var errorMessage="";if(err.innerror&&err.innerror.message){if(err.innerror.message!="")errorMessage=err.innerror.message}else errorMessage=err.message;var errorDialogOptions={message:errorMessage,errorCode:err.errorCode};Xrm.Navigation.openErrorDialog(errorDialogOptions);Xrm.Utility.closeProgressIndicator()})};this.exportToDynamicExcel=function(gridControl,entityTypeName,exportType){var documentType=1,openMode={openMode:2},currentView=gridControl.getViewSelector().getCurrentView(),fetchXml=gridControl.getFetchXml(),entityTypeCode=Xrm.Internal.getEntityCode(gridControl.getEntityName()),dialogOption={height:600,width:800,position:1},dialogParams={};dialogParams["entity_typeName"]=gridControl.getEntityName();dialogParams["entity_typeCode"]=entityTypeCode;dialogParams["entity_fetchXml"]=fetchXml;dialogParams["entity_effectiveFetchXml"]=fetchXml;dialogParams["entity_exportType"]=exportType;dialogParams["entity_viewId"]=gridControl.getViewSelector().getCurrentView().id;dialogParams["entity_viewName"]=gridControl.getViewSelector().getCurrentView().name;dialogParams["entity_viewType"]=gridControl.getViewSelector().getCurrentView().entityType;dialogParams["entity_totalRecordCount"]=gridControl.getGrid().getTotalRecordCount();var entityName=currentView.entityType,columns=["layoutxml"],exportTypeName=_this.getExportTypeName(exportType);Commands.ExportTelemetryHelper.logExportDetailsTelemetry("ExportToExcel.Details",entityTypeName,exportTypeName,gridControl.getViewSelector().getCurrentView().name,gridControl.getViewSelector().getCurrentView().entityType,gridControl.getViewSelector().getCurrentView().id);Xrm.WebApi.online.retrieveRecord(entityName,currentView.id,"?$select="+columns).then(function(oppResponse){if(oppResponse.layoutxml){dialogParams["entity_layoutXml"]=oppResponse.layoutxml;dialogParams["entity_effectiveLayoutXml"]=oppResponse.layoutxml;Commands.ExportTelemetryHelper.logExportSuccessTelemetry("ExportToExcel.DialogOpened",entityTypeName,exportTypeName);Xrm.Navigation.openDialog("ExportToExcel",dialogOption,dialogParams)}},function(err){Commands.ExportTelemetryHelper.logFailureTelemetry("ExportToExcel.Failure",err,entityTypeName,exportTypeName);Xrm.Navigation.openAlertDialog({text:"No LayoutXml found for this View",confirmButtonLabel:"Error Dialog"})});return};this.exportToExcelOnline=function(gridControl,entityTypeName,exportType){var params={},currentView=gridControl.getViewSelector().getCurrentView(),fetchXml=gridControl.getFetchXml(),dom_Fetch=XrmCore.InternalUtilities.ExportUtilities.getXmlDOMFromString(fetchXml);dom_Fetch.getElementsByTagName("fetch")[0].removeAttribute("page");dom_Fetch.getElementsByTagName("fetch")[0].removeAttribute("count");fetchXml=XrmCore.InternalUtilities.ExportUtilities.getXmlAsString(dom_Fetch);var screenDimensions=_this.getScreenDimensions(),exportTypeName=_this.getExportTypeName(exportType);Xrm.Utility.getEntityMetadata(entityTypeName).then(function(entityMetadata){params["current_view"]=currentView.entityType+"/"+currentView.id;params["fetch_xml"]=fetchXml;params["entityType_name"]=entityTypeName;params["layout_xml"]=" ";params["entity_is_importable"]=entityMetadata.IsImportable;Commands.ExportTelemetryHelper.logExportDetailsTelemetry("ExportToExcel.Details",entityTypeName,exportTypeName,gridControl.getViewSelector().getCurrentView().name,gridControl.getViewSelector().getCurrentView().entityType,gridControl.getViewSelector().getCurrentView().id);Xrm.Navigation.openDialog("ExportToExcelOnlineDialog",{width:screenDimensions.width,height:screenDimensions.height,position:1},params)},function(err){Commands.ExportTelemetryHelper.logFailureTelemetry("ExportToExcel.Failure",err,entityTypeName,exportTypeName);var errorDialogOptions={message:Xrm.Utility.getResourceString("Main_system_library","ExportToXlsx_Error_Entity_Metadata_Not_Found"),errorCode:err.errorCode};Xrm.Navigation.openErrorDialog(errorDialogOptions)})};this.getScreenDimensions=function(){var screenWidth=window.screen.width,screenHeight=window.screen.height,screenDimensions={width:screenWidth,height:screenHeight};return screenDimensions};this.generateWordTemplateFlyout=function(commandProperties,entityTypeName,isForm,gridControl){var documentType=2,ribbonRelationshipType=-1,contextType=0;if(isForm)contextType=1;else if(typeof gridControl.getRelationship==="function"){contextType=2;var relationship=gridControl.getRelationship();if(relationship!==null&&relationship.relationshipType===0)ribbonRelationshipType=0;else if(relationship!==null&&relationship.relationshipType===1)ribbonRelationshipType=1}var deferred1=XrmCore.InternalUtilities.ExportUtilities.retrieveSystemDocumentTemplates(entityTypeName,documentType),deferred2=XrmCore.InternalUtilities.ExportUtilities.retrievePersonalDocumentTemplates(entityTypeName,documentType),menu=Promise.all([deferred1,deferred2]).then(function(_a){var systemTemplates=_a[0],personalTemplates=_a[1];ExportLibrary._systemTemplates=systemTemplates;ExportLibrary._personalTemplates=personalTemplates;return _this.buildMenu(systemTemplates,personalTemplates,entityTypeName,isForm,contextType,ribbonRelationshipType,documentType)});commandProperties["PopulationXML"]=menu;return};this.generateExcelTemplateFlyout=function(commandProperties,entityTypeName,gridControl){var isForm=false,documentType=1,contextType=0,ribbonRelationshipType=-1;if(typeof gridControl.getRelationship==="function"){contextType=2;var relationship=gridControl.getRelationship();if(relationship!==null&&relationship.relationshipType===0)ribbonRelationshipType=0;else if(relationship!==null&&relationship.relationshipType===1)ribbonRelationshipType=1}var deferred1=XrmCore.InternalUtilities.ExportUtilities.retrieveSystemDocumentTemplates(entityTypeName,documentType),deferred2=XrmCore.InternalUtilities.ExportUtilities.retrievePersonalDocumentTemplates(entityTypeName,documentType),menu=Promise.all([deferred1,deferred2]).then(function(_a){var systemTemplates=_a[0],personalTemplates=_a[1];ExportLibrary._systemTemplates=systemTemplates;ExportLibrary._personalTemplates=personalTemplates;return _this.buildMenu(systemTemplates,personalTemplates,entityTypeName,isForm,contextType,ribbonRelationshipType,documentType)});commandProperties["PopulationXML"]=menu;return};this.runExcelTemplate=function(commandProperties,gridControl){var documentType=1,openMode={openMode:2},contextType=0;if(typeof gridControl.getRelationship==="function")contextType=2;var personalTemplateKeyword="DocumentTemplates.Menu.PersonalExcelTemplates.",sourceControlId=commandProperties["SourceControlId"];if(sourceControlId=="ViewAllMyTemplatesId"){_this.navigateToPersonalDocumentTemplates("recordlist","personaldocumenttemplate");return}var templateEntityName="documenttemplate",templateId=sourceControlId.split(/[. ]+/).pop();if(sourceControlId.indexOf(personalTemplateKeyword)!==-1)templateEntityName="personaldocumenttemplate";if(templateId==="UploadTemplate"||templateId==="DownloadTemplate"){_this.openDocTemplateDialog(templateId,documentType,gridControl);return}var onlineTemplateKeyword="DocumentOnlineTemplates.Menu.",personalTemplateOnlineValidatorKeyword="PersonalExcelTemplates.Controls.",onlineExcelValidatorKeyword="Controls.OpenExcelOnline.";if(sourceControlId.indexOf(onlineTemplateKeyword)!==-1){if(sourceControlId.indexOf(personalTemplateOnlineValidatorKeyword)!==-1)templateEntityName="personaldocumenttemplate";if(sourceControlId.indexOf(onlineExcelValidatorKeyword)!==-1){var params={},screenDimensions=_this.getScreenDimensions(),fetchXml=gridControl.getFetchXml();params["current_view"]=templateEntityName+"/"+templateId;params["fetch_xml"]=fetchXml;params["entityType_name"]=gridControl.getEntityName();params["layout_xml"]="";Xrm.Navigation.openDialog("ExportToExcelOnlineDialog",{width:screenDimensions.width,height:screenDimensions.height,position:1},params);return}}var templateRef={id:"{"+templateId+"}",entityType:templateEntityName},r=null;if(contextType===0){var currentViewId=gridControl.getViewSelector().getCurrentView().id,currentView={id:currentViewId,entityType:"savedquery"};r=new XrmCore.SdkContracts.RenderTemplateFromViewRequest(templateRef,currentView)}else if(contextType===2){var fetchXml=gridControl.getFetchXml(),dom_Fetch=XrmCore.InternalUtilities.ExportUtilities.getXmlDOMFromString(fetchXml);dom_Fetch.getElementsByTagName("fetch")[0].removeAttribute("page");dom_Fetch.getElementsByTagName("fetch")[0].removeAttribute("count");fetchXml=XrmCore.InternalUtilities.ExportUtilities.getXmlAsString(dom_Fetch);var keys=[],values=[],arg=new XrmCore.SdkContracts.InputArgument(0,true,keys,values),argCol=new XrmCore.SdkContracts.InputArgumentCollection(arg);r=new XrmCore.SdkContracts.RenderTemplateRequest(templateRef,fetchXml,"",argCol)}Xrm.Utility.showProgressIndicator(Xrm.Utility.getResourceString("Main_system_library","ExportToXlsx_ProgressDialog_Header"));var deferred=Xrm.WebApi.online.execute(r).then(function(res){return res.json()}).then(function(odataResponse){var template=undefined;if(templateEntityName==="documenttemplate")template=ExportLibrary._systemTemplates.filter(function(obj){return obj.Id===templateId})[0];else template=ExportLibrary._personalTemplates.filter(function(obj){return obj.Id===templateId})[0];var file={fileContent:odataResponse.ExcelFile,fileName:XrmCore.InternalUtilities.ExportUtilities.generateExportFileName(template.Name,documentType),mimeType:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"};Xrm.UI.addGlobalNotification(1,1,Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_SucessfullyDownloaded"),null,null);return Xrm.Navigation.openFile(file,openMode)},function(errorResponse){Xrm.Utility.closeProgressIndicator();console.log(errorResponse);var errorMessage="";if(errorResponse.innerror&&errorResponse.innerror.message){if(errorResponse.innerror.message!="")errorMessage=errorResponse.innerror.message}else errorMessage=errorResponse.message;var errorDialogOptions={message:errorMessage,errorCode:errorResponse.errorCode};Xrm.Navigation.openErrorDialog(errorDialogOptions)}).then(function(res){console.log(res);Xrm.Utility.closeProgressIndicator()});return};this.openDocTemplateDialog=function(dialogName,documentType,gridControl,isForm){var width=512,height=300,docDialog="DocumentTemplateUpload";if(documentType==2&&dialogName==="DownloadTemplate"){width=850;height=650}if(dialogName==="DownloadTemplate")docDialog="DocumentTemplateDownload";var params={};if(isForm)params["Entity_Name"]=gridControl.entityReference.entityType;else{var viewId=gridControl.getViewSelector().getCurrentView().id.replace("{","").replace("}",""),currentView=gridControl.getViewSelector().getCurrentView().name,fetchXmlData=gridControl.getFetchXml();params["Entity_Name"]=gridControl.getEntityName();params["View_Id"]=viewId;params["current_view"]=currentView;params["fetch_xmldata"]=fetchXmlData}params["DocTemplateFile_Type"]=documentType;params["DocTemplate_Type"]=9941;Xrm.Navigation.openDialog(docDialog,{width:width,height:height,position:1},params).then(function(result){if(result.parameters&&result.parameters["Is_DocumentTemplate_Uploaded"]!=undefined&&result.parameters["DocumentTemplate_index"]!=undefined)if(result.parameters["Is_DocumentTemplate_Uploaded"]==1){var entityFormOptions={};entityFormOptions["entityName"]="personaldocumenttemplate";entityFormOptions["entityId"]=result.parameters["DocumentTemplate_index"];var actionDescriptor={actionLabel:Xrm.Utility.getResourceString("Main_system_library","View_Personal_Document_Template"),eventHandler:function(){Xrm.Navigation.openForm(entityFormOptions)}};Xrm.UI.addGlobalNotification(1,1,Xrm.Utility.getResourceString("Main_system_library","DocTemplate_Successfully_Uploaded"),null,actionDescriptor)}});return};this.runWordTemplate=function(commandProperties,entityTypeCode,gridControl,selectedRecords){var isForm=false;if(typeof selectedRecords==="string"){selectedRecords=[selectedRecords];isForm=true}var documentType=2,openMode={openMode:2},personalTemplateKeyword="WordTemplates.Menu.PersonalWordTemplates.",sourceControlId=commandProperties["SourceControlId"];if(sourceControlId=="ViewAllMyTemplatesId"){_this.navigateToPersonalDocumentTemplates("recordlist","personaldocumenttemplate");return}var templateEntityName="documenttemplate";if(sourceControlId.indexOf(personalTemplateKeyword)!==-1)templateEntityName="personaldocumenttemplate";var templateId=sourceControlId.split(/[. ]+/).pop();if(templateId==="UploadTemplate"||templateId==="DownloadTemplate"){_this.openDocTemplateDialog(templateId,documentType,gridControl,isForm);return}var templateRef={id:"{"+templateId+"}",entityType:templateEntityName},recordsString=JSON.stringify(selectedRecords),r=new XrmCore.SdkContracts.ExportWordDocumentRequest(entityTypeCode,templateRef,recordsString);Xrm.Utility.showProgressIndicator(Xrm.Utility.getResourceString("Main_system_library","ExportToDocx_ProgressDialog_Header"));var deferred=Xrm.WebApi.online.execute(r).then(function(res){return res.json()}).then(function(odataResponse){var template=undefined;if(templateEntityName==="documenttemplate")template=ExportLibrary._systemTemplates.filter(function(obj){return obj.Id===templateId})[0];else template=ExportLibrary._personalTemplates.filter(function(obj){return obj.Id===templateId})[0];var file={fileContent:odataResponse.WordFile,fileName:XrmCore.InternalUtilities.ExportUtilities.generateExportFileName(template.Name,documentType),mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"};Xrm.UI.addGlobalNotification(1,1,Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_Word_SucessfullyDownloaded"),null,null);return Xrm.Navigation.openFile(file,openMode)},function(errorResponse){Xrm.Utility.closeProgressIndicator();console.log(errorResponse);var errorMessage="";if(errorResponse.innerror&&errorResponse.innerror.message){if(errorResponse.innerror.message!="")errorMessage=errorResponse.innerror.message}else errorMessage=errorResponse.message;var errorDialogOptions={message:errorMessage,errorCode:errorResponse.errorCode};Xrm.Navigation.openErrorDialog(errorDialogOptions)}).then(function(res){console.log(res);Xrm.Utility.closeProgressIndicator()});return};this.navigateToPersonalDocumentTemplates=function(pageType,entityName){var personalDocTemplatePageInput={pageType:pageType,entityName:entityName};Xrm.Navigation.navigateTo(personalDocTemplatePageInput)};this.buildMenu=function(systemTemplates,personalTemplates,entityTypeName,isForm,contextType,ribbonRelationshipType,documentType){var menuId=XrmCore.InternalUtilities.ExportUtilities.determineRibbonMenuId(entityTypeName,isForm,contextType,ribbonRelationshipType,documentType,false),onlineMenuId=XrmCore.InternalUtilities.ExportUtilities.determineRibbonMenuId(entityTypeName,isForm,contextType,ribbonRelationshipType,documentType,true),commandId=XrmCore.InternalUtilities.ExportUtilities.determinRibbonCommandId(entityTypeName,isForm,contextType,ribbonRelationshipType,documentType,false),systemButtonsControl=XrmCore.InternalUtilities.ExportUtilities.buildControlsFromTemplates(menuId,onlineMenuId,commandId,systemTemplates,true,documentType),personalButtonsControl=XrmCore.InternalUtilities.ExportUtilities.buildControlsFromTemplates(menuId,onlineMenuId,commandId,personalTemplates,false,documentType),createcommandId=XrmCore.InternalUtilities.ExportUtilities.determinCreateRibbonCommandId(entityTypeName,isForm,contextType,documentType,true),createTemplates=XrmCore.InternalUtilities.ExportUtilities.retrieveCreateTemplates(),createuploadDownloadButtonsControl=XrmCore.InternalUtilities.ExportUtilities.buildControlsForCreate(menuId,createcommandId,createTemplates,false,documentType),menuSection1=XrmCore.InternalUtilities.ExportUtilities.buildMenuSection(menuId,false,documentType,true,10,createuploadDownloadButtonsControl),menuSection2=XrmCore.InternalUtilities.ExportUtilities.buildMenuSection(menuId,true,documentType,false,20,systemButtonsControl),menuSection3=XrmCore.InternalUtilities.ExportUtilities.buildMenuSection(menuId,false,documentType,false,30,personalButtonsControl),menuSections=[];menuSections.push(menuSection1);menuSections.push(menuSection2);menuSections.push(menuSection3);var menu=XrmCore.InternalUtilities.ExportUtilities.buildMenu(menuId,menuSections);return menu}}ExportLibrary._systemTemplates=[];ExportLibrary._personalTemplates=[];return ExportLibrary}();Commands.ExportLibrary=ExportLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Export=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.ExportLibrary:new Commands.ExportLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ExportTelemetryHelper=function(){function ExportTelemetryHelper(){}ExportTelemetryHelper.getEventParams=function(entityTypeName,exportTypeName){var eventParams=[],entityTypeParam={name:"entityTypeName",value:entityTypeName},exportTypeParam={name:"exportTypeName",value:exportTypeName};eventParams.push(entityTypeParam);eventParams.push(exportTypeParam);return eventParams};ExportTelemetryHelper.logExportInitTelemetry=function(componentName,entityTypeName,exportTypeName){var eventParams=ExportTelemetryHelper.getEventParams(entityTypeName,exportTypeName);Xrm!=null&&Xrm.Reporting!=null&&Xrm.Reporting.reportSuccess(componentName,eventParams)};ExportTelemetryHelper.logExportDetailsTelemetry=function(componentName,entityTypeName,exportTypeName,viewName,viewEntityType,viewId){var viewNameParam={name:"viewName",value:viewName},viewEntityTypeParam={name:"viewEntityType",value:viewEntityType},viewIdParam={name:"viewId",value:viewId},eventParams=ExportTelemetryHelper.getEventParams(entityTypeName,exportTypeName);eventParams.push(viewEntityTypeParam);eventParams.push(viewIdParam);eventParams.push(viewNameParam);Xrm!=null&&Xrm.Reporting!=null&&Xrm.Reporting.reportSuccess(componentName,eventParams)};ExportTelemetryHelper.logExportSuccessTelemetry=function(componentName,entityTypeName,exportTypeName){var eventParams=ExportTelemetryHelper.getEventParams(entityTypeName,exportTypeName);Xrm!=null&&Xrm.Reporting!=null&&Xrm.Reporting.reportSuccess(componentName,eventParams)};ExportTelemetryHelper.logFailureTelemetry=function(componentName,err,entityTypeName,exportTypeName){var errorMessage;if(err.message&&err.message!=null&&err.message!="")errorMessage=err.message;else if(err.innerror&&err.innerror.message&&err.innerror.message!=null&&err.innerror.message!="")errorMessage=err.innerror.message;else errorMessage="Export to Excel Failed with unknown error";if(Xrm!=null&&Xrm.Reporting!=null){var errorParam={name:"ErrorResponse",message:errorMessage},eventParams=ExportTelemetryHelper.getEventParams(entityTypeName,exportTypeName);Xrm.Reporting.reportFailure(componentName,errorParam,"",eventParams)}};return ExportTelemetryHelper}();Commands.ExportTelemetryHelper=ExportTelemetryHelper})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var FlowsConstants=function(){function FlowsConstants(){}FlowsConstants.FlowFpiResponseIdsProcessed="FlowFpiResponseIdsProcessed";FlowsConstants.Flow_SessionStorage_CreateURL="flowCreateUrl";FlowsConstants.Flow_SessionStorage_ManageURL="flowManageUrl";FlowsConstants.Flow_SessionStorage_DefinitionList="flowDefinitionList";FlowsConstants.Flow_SessionStorage_UserLoginRequired="flowUserLoginRequired";FlowsConstants.Flow_SessionStorage_EntityLogicalName="dynamics365EntityLogicalName";FlowsConstants.Flow_SessionStorage_Dynamics365AccessToken="dynamics365AccessToken";FlowsConstants.Flow_LocalStorage_EnvironmentId="flowEnvironmentId";FlowsConstants.Flow_GlobalVar_EntityCollectionName="EntityLogicalCollectionName";FlowsConstants.Flow_GlobalVar_EntityLogicalName="EntityLogicalName";FlowsConstants.Flow_GlobalVar_IntegratedEnvironment="MICROSOFT_FLOW_INTEGRATED_ENVIRONMENT";FlowsConstants.Flow_GlobalVar_DestinationURL="MICROSOFT_FLOW_DESTINATIONURL";FlowsConstants.Flow_GlobalVar_FirstPartyURL="MICROSOFT_FLOW_FIRSTPARTYINTEGRATION_SITE_URL";FlowsConstants.Flow_GlobalVar_CrmOrgUniqueName="ORG_UNIQUE_NAME";FlowsConstants.Flow_GlobalVar_CrmOrgId="ORG_ID";FlowsConstants.Flow_Localization_CreateFlow="Flows_CreateFlow";FlowsConstants.Flow_Localization_ManageFlow="Flows_ManageFlows";FlowsConstants.Flow_Localization_LoginFlow="Flows_LoginFlow";FlowsConstants.Flow_Localization_RunWorkflow="Menu_Label_Run_Workflow";FlowsConstants.Flow_Localization_ManageFlowMenuSection="Flows_ManageFlowMenuSection";FlowsConstants.Flow_Localization_RunFlowMenuSection="Flows_RunFlowMenuSection";FlowsConstants.Flow_Localization_Authentication="SystemCustomization.SystemSettingsDialog.PreviewTab.IsMicrosoftFlowEnabled.AuthenticateButton.Text";FlowsConstants.Flow_Control_CreateFlow="Mscrm.Flows.TriggerFlow.CreateFlow";FlowsConstants.Flow_Control_ManageFlow="Mscrm.Flows.TriggerFlow.ManageFlows";FlowsConstants.Flow_Control_LoginFlow="Mscrm.Flows.TriggerFlow.LoginFlow";FlowsConstants.Flow_Settings_FlowSettings="ENABLE_MICROSOFT_FLOW_INTEGRATION";FlowsConstants.Flow_UciFpiUrl_ComponentId="FlowIntegrationUci";FlowsConstants.Flow_UciFpiUrl_ClientType="moca";FlowsConstants.Flow_UciFpiResources_FlowService="https://service.flow.microsoft.com/";FlowsConstants.Flow_UciFpiResources_GraphApi="https://graph.microsoft.com";return FlowsConstants}();Commands.FlowsConstants=FlowsConstants})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var FlowsDynamicMenuBuilder=function(){function FlowsDynamicMenuBuilder(){}FlowsDynamicMenuBuilder.buildMenuUCI=function(flowsLibrary,selectedEntityTypeName,isForm){var mainPromise=new Promise(function(resolve,reject){var menuXml=FlowsDynamicMenuBuilder.generateMenuXml(flowsLibrary,selectedEntityTypeName,isForm,true);resolve(menuXml)});return mainPromise};FlowsDynamicMenuBuilder.buildMenuWebClient=function(flowsLibrary,selectedEntityTypeName,isForm){var menuXml=FlowsDynamicMenuBuilder.generateMenuXml(flowsLibrary,selectedEntityTypeName,isForm,false);return menuXml};FlowsDynamicMenuBuilder.generateMenuXml=function(flowsLibrary,entityName,isForm,isUCI){menuSectionCount=1;var menuSection1Title=flowsLibrary.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_ManageFlowMenuSection),menuSection1='<MenuSection Id="Mscrm.DynamicMenu.Flows.MenuSection'+menuSectionCount+'" Title="'+menuSection1Title+'" Sequence="'+menuSectionCount*10+'"><Controls Id="Mscrm.DynamicMenu.Flows.Controls'+menuSectionCount+'">',controls="";menuSectionCount++;menuSequence=10;var label=flowsLibrary.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_CreateFlow);controls+=FlowsDynamicMenuBuilder.generateControlXml(label,menuSequence,Commands.FlowsConstants.Flow_Control_CreateFlow,entityName,isForm,isUCI);menuSequence+=10;label=flowsLibrary.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_ManageFlow);controls+=FlowsDynamicMenuBuilder.generateControlXml(label,menuSequence,Commands.FlowsConstants.Flow_Control_ManageFlow,entityName,isForm,isUCI);menuSequence+=10;var flowLoginRequired=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_UserLoginRequired);if(flowLoginRequired==null||flowLoginRequired=="true"){label=flowsLibrary.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_LoginFlow);controls+=FlowsDynamicMenuBuilder.generateControlXml(label,menuSequence,Commands.FlowsConstants.Flow_Control_LoginFlow,entityName,isForm,isUCI);menuSequence+=10}menuSection1+=controls+"</Controls></MenuSection>";var menuSection2Title=flowsLibrary.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_RunFlowMenuSection),menuSection2='<MenuSection Id="Mscrm.DynamicMenu.Flows.MenuSection'+menuSectionCount+'" Title="'+menuSection2Title+'" Sequence="'+menuSectionCount*10+'"><Controls Id="Mscrm.DynamicMenu.Flows.Controls'+menuSectionCount+'">',flowDefinitions=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_DefinitionList+"_"+entityName);menuSequence=10;controls="";if(flowDefinitions!=null&&flowLoginRequired=="false"){var flowDefinitionList=[];flowDefinitionList=JSON.parse(flowDefinitions);if(flowDefinitionList.length>0){flowDefinitionList.forEach(function(flow){controls+=FlowsDynamicMenuBuilder.generateControlXml(flow.displayName,menuSequence,flow.name,entityName,isForm,isUCI);menuSequence+=10});menuSection2+=controls+"</Controls></MenuSection>";menuSectionCount++}else menuSection2=""}else menuSection2="";var flowMenuSection=menuSection1+menuSection2;return flowMenuSection};FlowsDynamicMenuBuilder.generateControlXml=function(label,sequence,buttonId,entityName,isForm,isUCI){var page="HomePageGrid";if(isForm)page="Form";var commandId=entityName+"|NoRelationship|"+page+"|Mscrm.Flows.TriggerFlow";if(!isUCI)commandId="Mscrm.Flows.TriggerFlow";var button='<Button Id="'+buttonId+'" Command="'+commandId+'" Sequence="'+sequence+'" LabelText="'+label+'" Alt="'+label+'" Image16by16="/_imgs/Ribbon/OpenFlows_16.png" Image32by32="/_imgs/Ribbon/OpenFlows_32.png" ModernImage="Flows" />';return button};return FlowsDynamicMenuBuilder}();Commands.FlowsDynamicMenuBuilder=FlowsDynamicMenuBuilder;var WorkflowDynamicMenuBuilder=function(){function WorkflowDynamicMenuBuilder(){}WorkflowDynamicMenuBuilder.buildMenuUCI=function(flowsLibrary,entityCollection,selectedEntityTypeName,isForm){var menuXml=WorkflowDynamicMenuBuilder.generateMenuXml(flowsLibrary,entityCollection,selectedEntityTypeName,false,true);return menuXml};WorkflowDynamicMenuBuilder.generateMenuXml=function(flowsLibrary,entityCollection,entityName,isForm,isUCI){var workflowMenuSection="",menuSectionTitle=flowsLibrary.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_RunWorkflow),menuSection='<MenuSection Id="Mscrm.DynamicMenu.Flows.MenuSection'+menuSectionCount+'" Title="'+menuSectionTitle+'" Sequence="'+menuSectionCount*10+'"><Controls Id="Mscrm.DynamicMenu.Flows.Controls'+menuSectionCount+'">';menuSequence=10;var controls="";if(entityCollection.length>0){entityCollection.forEach(function(workflow){var label=workflow.name,buttonId=workflow.workflowid;controls+=WorkflowDynamicMenuBuilder.generateControlXml(label,menuSequence,buttonId,entityName,isForm,isUCI);menuSequence+=10});menuSection+=controls+"</Controls></MenuSection>"}else menuSection="";return workflowMenuSection=menuSection};WorkflowDynamicMenuBuilder.generateControlXml=function(label,sequence,buttonId,entityName,isForm,isUCI){var button="",page="HomePageGrid";if(isForm)page="Form";var commandId=entityName+"|NoRelationship|"+page+"|Mscrm.Flows.TriggerWorkflow";if(!isUCI)commandId="Mscrm.Flows.TriggerWorkflow";var button='<Button Id="'+buttonId+'" Command="'+commandId+'" Sequence="'+sequence+'" LabelText="'+label+'" Alt="'+label+'" Image16by16="/_imgs/Ribbon/OpenFlows_16.png" Image32by32="/_imgs/Ribbon/OpenFlows_32.png" ModernImage="Flows" />';return button};return WorkflowDynamicMenuBuilder}();Commands.WorkflowDynamicMenuBuilder=WorkflowDynamicMenuBuilder})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var MicrosoftFlowsTelemetryReporter=MscrmControls.Containers.MicrosoftFlowsTelemetryReporter,ExecuteOnDemandWorkflowRequest=function(){function ExecuteOnDemandWorkflowRequest(){}ExecuteOnDemandWorkflowRequest.prototype.getMetadata=function(){var metadata={boundParameter:"entity",parameterTypes:{entity:{typeName:"Microsoft.Dynamics.CRM.workflow",structuralProperty:5},EntityId:{typeName:"Edm.Guid",structuralProperty:1},InputArguments:{typeName:"Microsoft.Dynamics.CRM.InputArgumentCollection",structuralProperty:2}},operationName:"ExecuteWorkflow",operationType:0};return metadata};return ExecuteOnDemandWorkflowRequest}();Commands.ExecuteOnDemandWorkflowRequest=ExecuteOnDemandWorkflowRequest;var FlowsLibrary=function(){function FlowsLibrary(){var _this=this;this.populateMenu=function(commandProperties,entityLogicalName,isForm){var context=Xrm.Utility.getGlobalContext();if(context&&context.client&&context.client.getClient()==Xrm.Constants.ClientNames.outlook){commandProperties["PopulationXML"]="";return}_this.populateFlowMenu(commandProperties,entityLogicalName,isForm)};this.populateFlowMenu=function(commandProperties,entityLogicalName,isForm){try{if(!entityLogicalName&&isForm&&Xrm.Page.data&&Xrm.Page.data.entity)entityLogicalName=Xrm.Page.data.entity.getEntityName();var flowEnvironmentID=_this.microsoftFlowEnvironmentId(),getFlowDefinitionListPromise_1=function(){return _this.getFlowDefinitionList(flowEnvironmentID,entityLogicalName,_this)};if(Xrm.Internal.isUci()){var buildMenuPromise=function(){return Commands.FlowsDynamicMenuBuilder.buildMenuUCI(_this,entityLogicalName,isForm)},menuXmlPromise=function(){return getFlowDefinitionListPromise_1().then(function(){return buildMenuPromise()},function(error){return buildMenuPromise()})},ovarallPromise=menuXmlPromise;if(_this.isInUciShim()){var fpiDomain=_this.getFirstPartyIntegrationDomain(),initTokensPromise=Xrm.Utility.beginSecureSessionForResource(Commands.FlowsConstants.Flow_UciFpiResources_FlowService,Commands.FlowsConstants.Flow_UciFpiUrl_ComponentId,fpiDomain);ovarallPromise=function(){return initTokensPromise.then(function(expDate){return menuXmlPromise()},function(errorCode){console.error("Shim failed to init the Flow Token with error code: %d",errorCode);return buildMenuPromise()})}}if(_this.isMicrosoftFlowEnabled()&&Xrm.Internal.isFeatureEnabled("OnDemandWorkflowUCI"))commandProperties["PopulationXML"]=ovarallPromise().then(function(flowMenuSectionPromise){var flowMenuPromise=(new Promise(function(resolve){resolve(_this.populateWorkflowMenu(commandProperties,entityLogicalName,isForm))})).then(function(workflowMenuSectionPromise){var flowMenu='<Menu Id="Mscrm.DynamicMenu.Flows">'+flowMenuSectionPromise+workflowMenuSectionPromise+"</Menu>";return flowMenu});return flowMenuPromise});else commandProperties["PopulationXML"]=ovarallPromise()}else{getFlowDefinitionListPromise_1();var webMenuSection=Commands.FlowsDynamicMenuBuilder.buildMenuWebClient(_this,entityLogicalName,isForm);commandProperties["PopulationXML"]='<Menu Id="Mscrm.DynamicMenu.Flows">'+webMenuSection+"</Menu>"}}catch(exception){console.error(exception);_this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(_this.tenantId,null,"FlowsLibrary",exception,"PopulateMenu",exception);commandProperties["PopulationXML"]="";var errorResponse={errorCode:2147811937,message:exception};XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse)}};this.populateWorkflowMenu=function(commandProperties,entityLogicalName,isForm){try{if(!entityLogicalName&&isForm&&Xrm.Page.data&&Xrm.Page.data.entity)entityLogicalName=Xrm.Page.data.entity.getEntityName();var entityTypeCode=Xrm.Internal.getEntityCode(entityLogicalName),queryFetchXml="<fetch mapping='logical' distinct='true'><entity name='workflow'><attribute name='workflowid'/><attribute name='name'/>",queryConditionEntityCodeXml="<condition attribute='primaryentity' operator='eq' value='"+entityTypeCode+"' />",queryConditionOnDemandXml="<condition attribute='ondemand' operator='eq' value='1' />",queryConditionCategoryXml="<condition attribute='category' operator='eq' value='0' />",queryConditionTypeXml="<condition attribute='type' operator='eq' value='1' />",queryConditionStateXml="<condition attribute='statecode' operator='eq' value='1' />",queryConditionStatusXml="<condition attribute='statuscode' operator='eq' value='2' />",queryXml=queryFetchXml+"<filter type='and'>"+queryConditionEntityCodeXml+queryConditionOnDemandXml+queryConditionCategoryXml+queryConditionTypeXml+queryConditionStateXml+queryConditionStatusXml+"</filter></entity></fetch>",workflowMenuPromise=new Promise(function(resolve,reject){Xrm.WebApi.online.retrieveMultipleRecords("workflow","?fetchXml= "+queryXml).then(function(collection){var entityCollection=collection.entities;if(entityCollection.length>0)Xrm.Internal.isUci()&&resolve(Commands.WorkflowDynamicMenuBuilder.buildMenuUCI(_this,entityCollection,entityLogicalName,isForm));else resolve("")},function(errorResponse){console.error(errorResponse.message);_this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(_this.tenantId,null,"FlowsLibrary",null,"PopulateWorkflowMenu",errorResponse.message);XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse);resolve("")})});return workflowMenuPromise}catch(exception){console.error(exception);_this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(_this.tenantId,null,"FlowsLibrary",exception,"PopulateWorkflowMenu",exception);var errorResponse={errorCode:2147811937,message:exception};XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse);return ""}};this.getLocalizedLabel=function(lcid){if(Xrm.Internal.isUci())return Xrm.Utility.getResourceString("Main_system_library",lcid);else return Xrm.Internal.getResourceString(lcid)};this.getUrlVars=function(str){for(var vars=[],hash,hashes=str.slice(str.indexOf("?")+1).split("&"),i=0;i<hashes.length;i++){hash=hashes[i].split("=");vars.push(hash[0]);vars[hash[0]]=hash[1]}return vars};this.microsoftFlowDestinationUrl=function(){if(Xrm.Internal.isUci())return Xrm.Utility.getGlobalContext().getAdvancedConfigSetting("MicrosoftFlowDestinationUrl");else return window.parent[Commands.FlowsConstants.Flow_GlobalVar_DestinationURL]};this.getMicrosoftFlowFirstPartyIntegrationSiteUrl=function(){if(Xrm.Internal.isUci()){var url=Xrm.Utility.getGlobalContext().getAdvancedConfigSetting("MicrosoftFlowFirstPartyIntegrationSiteUrl");if(_this.isInUciShim()){url+="&componentId="+Commands.FlowsConstants.Flow_UciFpiUrl_ComponentId;url+="&client="+Commands.FlowsConstants.Flow_UciFpiUrl_ClientType}return url}else return window.parent[Commands.FlowsConstants.Flow_GlobalVar_FirstPartyURL]};this.triggerFlow=function(commandProperties,selectedRecords,entityLogicalName){var controlId=commandProperties["SourceControlId"];if(!entityLogicalName&&Xrm.Page.data&&Xrm.Page.data.entity)entityLogicalName=Xrm.Page.data.entity.getEntityName();switch(controlId){case Commands.FlowsConstants.Flow_Control_CreateFlow:_this.createFlow(entityLogicalName);break;case Commands.FlowsConstants.Flow_Control_ManageFlow:_this.manageFlows();break;default:var orgUniqueName=FlowsLibrary.orgUniqueName();_this.getEntityCollectionNamePromise(entityLogicalName).then(function(entityLogicalCollectionName){_this.triggerFlowForDynamicDefinition(controlId,selectedRecords,orgUniqueName,entityLogicalName,entityLogicalCollectionName)});break}};this.triggerWorkflow=function(commandProperties,selectedRecords,entityLogicalName){var controlId=commandProperties["SourceControlId"];if(!entityLogicalName&&Xrm.Page.data&&Xrm.Page.data.entity)entityLogicalName=Xrm.Page.data.entity.getEntityName();var entityIds=[];if(selectedRecords!=null){var records=selectedRecords.length;if(records===0)try{Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName()&&entityIds.push(_this.removeCurlyBracesFromEntityRecordId(Xrm.Page.data.entity.getId()))}catch(exception){var errorResponse={errorCode:2147811938,message:""};XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse);return}else for(var i=0;i<records;i++)entityIds.push(_this.removeCurlyBracesFromEntityRecordId(selectedRecords[i].Id))}var confirmSubtitle,confirmText,entityDisplayName,entityCollectionDisplayName;_this.getEntityDisplayNamePromiseUCI(entityLogicalName,true).then(function(collectionDisplayName){entityCollectionDisplayName=collectionDisplayName==null||collectionDisplayName.length==0?entityLogicalName:collectionDisplayName;_this.getEntityDisplayNamePromiseUCI(entityLogicalName,false).then(function(displayName){entityDisplayName=displayName==null||displayName.length==0?entityLogicalName:displayName;try{confirmSubtitle=Xrm.Utility.getResourceString("Main_system_library","Dialog_RunWorkflow_Description");confirmSubtitle=XrmCore.InternalUtilities.GenericUtilities.stringFormat(confirmSubtitle,[entityIds.length,entityIds.length>1?entityCollectionDisplayName:entityDisplayName]);confirmText=Xrm.Utility.getResourceString("Main_system_library","Dialog_RunWorkflow_Body")+" "+Xrm.Utility.getResourceString("Main_system_library","Dialog_RunWorkflow_Body_Confirm");confirmText=XrmCore.InternalUtilities.GenericUtilities.stringFormat(confirmText,[entityDisplayName]);var confirmOptions={title:_this.getLocalizedLabel("Dialog_Runworkflow_Title"),subtitle:confirmSubtitle,text:confirmText}}catch(exception){console.error(exception);_this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(_this.tenantId,null,"FlowsLibrary",exception,"TriggerWorkflow",exception);var errorResponse={errorCode:2147811937,message:exception};XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse);return}Xrm.Navigation.openConfirmDialog(confirmOptions).then(function(dialogResponse){if(dialogResponse.confirmed)entityIds.length>0&&entityIds.forEach(function(entityId){var request=new ExecuteOnDemandWorkflowRequest;request.InputArguments=null;request.entity={id:controlId,entityType:"workflow"};request.EntityId={guid:entityId};Xrm.WebApi.online.execute(request).then(function(sucessResponse){var successProperties={TenantId:_this.tenantId,FlowRunResult:"Success",NoOfEntityRecords:1,EntityLogicalName:entityLogicalName,FlowId:controlId,FlowEnvironmentId:null};_this.microsoftFlowsTelemetryReporter.logFlowTelemetryEvent("Triggered",successProperties)},function(errorResponse){console.error(errorResponse.message);_this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(_this.tenantId,null,"FlowsLibrary",null,"TriggerWorkflow",errorResponse.message);XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse)})})})})})};this.createFlow=function(entityLogicalName){var flowCreateUrl=sessionStorage[Commands.FlowsConstants.Flow_SessionStorage_CreateURL+"_"+entityLogicalName];if(flowCreateUrl!=null)if(_this.isInUciShim())Xrm.Navigation.openUrl(flowCreateUrl);else window.parent.open(flowCreateUrl,"_blank")};this.manageFlows=function(){var flowManageUrl=sessionStorage[Commands.FlowsConstants.Flow_SessionStorage_ManageURL];if(flowManageUrl!=null)if(_this.isInUciShim())Xrm.Navigation.openUrl(flowManageUrl);else window.parent.open(flowManageUrl,"_blank")};this.triggerFlowForDynamicDefinition=function(definitionId,selectedRecords,orgUniqueName,entityLogicalName,entityLogicalCollectionName){var entityIds=[];if(selectedRecords!=null){var records=selectedRecords.length;if(records===0)try{Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntityName()&&entityIds.push(_this.removeCurlyBracesFromEntityRecordId(Xrm.Page.data.entity.getId()))}catch(exception){}else for(var i=0;i<records;i++)entityIds.push(_this.removeCurlyBracesFromEntityRecordId(selectedRecords[i].Id))}var flowLoginRequired=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_UserLoginRequired);if(entityIds.length===0&&flowLoginRequired&&flowLoginRequired==="false"){if(definitionId!==Commands.FlowsConstants.Flow_Control_LoginFlow){var errorResponse={errorCode:2147811938,message:""};XrmCore.InternalUtilities.GenericUtilities.HandleErrorMessage(errorResponse)}return}var entityIdCollection=JSON.stringify(entityIds),dynamics365AccessToken=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_Dynamics365AccessToken);if(_this.isInUciShim()){var authenticationManager=Microsoft.Crm.Client.Core.Framework.AuthenticationManager;if(authenticationManager){var authManagerInstance=authenticationManager.get_defaultInstance();if(authManagerInstance){if(authManagerInstance.get_authToken())dynamics365AccessToken=authManagerInstance.get_authToken();!dynamics365AccessToken&&console.error("Failed to get the token from the Shim")}}}var dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityIdCollection]=entityIdCollection;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.FlowId]=definitionId;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.FlowsEnvironmentId]=_this.microsoftFlowEnvironmentId();dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.OrgUniqueName]=orgUniqueName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityLogicalCollectionName]=entityLogicalCollectionName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityLogicalName]=entityLogicalName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Dynamics365AccessToken]=dynamics365AccessToken;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.FlowsDestinationURL]=_this.microsoftFlowDestinationUrl();dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.FlowsFPISiteURL]=_this.getMicrosoftFlowFirstPartyIntegrationSiteUrl();dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.FlowsAuthenticationString]=_this.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_Authentication);var dialogOptions={};dialogOptions.height=600;dialogOptions.width=600;Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.MicrosoftFlowsDialog,dialogOptions,dialogParams)};this.onFlowsDialogLoad=function(eventContext){var label="",flowLoginRequired=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_UserLoginRequired);if(flowLoginRequired==null||flowLoginRequired=="true")label=_this.getLocalizedLabel(Commands.FlowsConstants.Flow_Localization_LoginFlow);else if(eventContext!=null){var formContext=eventContext.getFormContext();if(formContext!=null&&formContext.data!=null&&formContext.data.attributes!=null){var dialogAttributes=formContext.data.attributes,definitionId=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.FlowId).getValue(),entityLogicalName=dialogAttributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityLogicalName).getValue();label=_this.getFlowDisplayName(eventContext,entityLogicalName,definitionId)}}if(!label)return;else Xrm.Page.ui.controls.get("lbl_flows").setLabel(label)};this.flowsDialogCloseCallback=function(eventContext){if(Xrm.Internal.isUci)XrmCore.InternalUtilities.DialogUtilities.closeDialog(eventContext);else Commands.Common.closeDialogLegacy();var flowEnvironmentId=_this.microsoftFlowEnvironmentId();_this.getFlowDefinitionList(flowEnvironmentId,window[Commands.FlowsConstants.Flow_GlobalVar_EntityLogicalName],_this)};this.getFlowDisplayName=function(eventContext,entityLogicalName,definitionId){var label="",flowDefinitions=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_DefinitionList+"_"+entityLogicalName);if(flowDefinitions!=null){var flowDefinitionList=[];flowDefinitionList=JSON.parse(flowDefinitions);flowDefinitionList!=null&&flowDefinitionList.length>0&&flowDefinitionList.forEach(function(flow){if(flow.name===definitionId)label=flow.displayName})}return label};this.removeCurlyBracesFromEntityRecordId=function(recordId){recordId=recordId.replace("{","");recordId=recordId.replace("}","");return recordId};this.isMicrosoftFlowEnabled=function(){try{var isFlowsEnabled=true;if(Xrm.Internal.isUci())isFlowsEnabled=!XrmCore.InternalUtilities.DialogUtilities.isOffline()&&Xrm.Utility.getGlobalContext().getAdvancedConfigSetting("IsMicrosoftFlowEnabled")&&Xrm.Internal.isFeatureEnabled("FlowIntegration");else isFlowsEnabled=window.top[Commands.FlowsConstants.Flow_Settings_FlowSettings];return isFlowsEnabled}catch(ex){console.error(ex)}return false}}FlowsLibrary.prototype.microsoftFlowEnvironmentId=function(){return localStorage.getItem(Commands.FlowsConstants.Flow_LocalStorage_EnvironmentId)};FlowsLibrary.prototype.updateEnvironmentIdCache=function(environmentId){environmentId&&localStorage.setItem(Commands.FlowsConstants.Flow_LocalStorage_EnvironmentId,environmentId)};FlowsLibrary.prototype.clearEnvironmentIdCache=function(){localStorage.removeItem(Commands.FlowsConstants.Flow_LocalStorage_EnvironmentId)};FlowsLibrary.prototype.getFirstPartyIntegrationDomain=function(){var a=document.createElement("a");a.href=this.microsoftFlowDestinationUrl();return a.hostname};FlowsLibrary.prototype.isInUciShim=function(){if(Xrm.Internal.isUci()){var context=Xrm.Utility.getGlobalContext();if(context&&context.client)return context.client.getClient()==Xrm.Constants.ClientNames.mobile}return false};FlowsLibrary.prototype.getOrganizationId=function(){var orgSettings=Xrm.Utility.getGlobalContext().organizationSettings;if(orgSettings)return orgSettings.organizationId;else{var crmOrganizationId=window[Commands.FlowsConstants.Flow_GlobalVar_CrmOrgId];if(!crmOrganizationId&&window.parent)crmOrganizationId=window.parent[Commands.FlowsConstants.Flow_GlobalVar_CrmOrgId];return crmOrganizationId}};FlowsLibrary.prototype.getEntityCollectionNamePromise=function(entityName){var entityCollectionNamePromise;if(Xrm.Internal.isUci()){var entityMetadataPromise=Xrm.Utility.getEntityMetadata(entityName);entityCollectionNamePromise=entityMetadataPromise.then(function(entityMetadata){return entityMetadata.EntitySetName},function(){console.error("Failed to get EntityCollectionName for '%s' entity",entityName)})}else{var entityColllectionName=window[Commands.FlowsConstants.Flow_GlobalVar_EntityCollectionName];if(!entityColllectionName)if(Xrm.Page.data&&Xrm.Page.data.entity&&Xrm.Page.data.entity.getEntitySetName)entityColllectionName=Xrm.Page.data.entity.getEntitySetName();else if(Xrm.Internal&&Xrm.Internal.getEntitySetName)entityColllectionName=Xrm.Internal.getEntitySetName(entityName);entityCollectionNamePromise=Promise.resolve(entityColllectionName)}return entityCollectionNamePromise};FlowsLibrary.prototype.getEntityDisplayNamePromiseUCI=function(entityName,getCollectionName){var _this=this,entityDisplayNamePromise,entityMetadataPromise=Xrm.Utility.getEntityMetadata(entityName);entityDisplayNamePromise=entityMetadataPromise.then(function(entityMetadata){return getCollectionName?entityMetadata.DisplayCollectionName:entityMetadata.DisplayName},function(errorResponse){console.error(errorResponse.message);_this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(_this.tenantId,null,"FlowsLibrary",null,"GetEntityDisplayNamePromiseUCI",errorResponse.message);return entityName});return entityDisplayNamePromise};FlowsLibrary.prototype.getFlowDefinitionList=function(environmentId,entityLogicalName,obj){var _this=this;try{this.microsoftFlowsTelemetryReporter=new MicrosoftFlowsTelemetryReporter;if(Xrm&&Xrm.Utility&&Xrm.Utility.getGlobalContext()){var clientType="";if(Xrm.Internal&&Xrm.Internal.isUci())clientType="UCI";this.microsoftFlowsTelemetryReporter.init(Xrm.Utility.getGlobalContext().getClientUrl(),clientType)}this.microsoftFlowFirstPartyIntegrationSiteUrl=this.getMicrosoftFlowFirstPartyIntegrationSiteUrl();if(this.microsoftFlowFirstPartyIntegrationSiteUrl)this.tenantId=this.getUrlVars(this.microsoftFlowFirstPartyIntegrationSiteUrl)["tenantId"]}catch(exception){console.error(exception)}var entityCollectionNamePromise=this.getEntityCollectionNamePromise(entityLogicalName);return entityCollectionNamePromise.then(function(dynamics365EntityLogicalCollectionName){return _this.getFlowDefinitionListPromise(environmentId,entityLogicalName,dynamics365EntityLogicalCollectionName)})};FlowsLibrary.prototype.getFlowDefinitionListPromise=function(environmentId,entityLogicalName,dynamics365EntityLogicalCollectionName){var _this=this,mainPromise=new Promise(function(resolve,reject){var performanceTrackers={};performanceTrackers.startFlowDefinitionsLoadTime=performance.now();performanceTrackers.startAttemptToSilentlyAuthenticateTime=null;var destinationOrigin=_this.microsoftFlowDestinationUrl(),dynamics365OrganizationUniqueName=FlowsLibrary.orgUniqueName(),targetURL=_this.microsoftFlowFirstPartyIntegrationSiteUrl,organizationId=_this.getOrganizationId(),iframeWindow,cachedDefinitionsListStr=sessionStorage.getItem(Commands.FlowsConstants.Flow_SessionStorage_DefinitionList+"_"+entityLogicalName);if(cachedDefinitionsListStr){var cachedDefinitionsList=JSON.parse(cachedDefinitionsListStr);cachedDefinitionsList&&resolve(cachedDefinitionsList)}if(document.getElementById("flowIframe"))iframeWindow=document.getElementById("flowIframe");else{iframeWindow=document.createElement("iframe");iframeWindow.style.display="none";iframeWindow.className="flowClassIframe";iframeWindow.name="flowIframe";iframeWindow.id="flowIframe";document.body.appendChild(iframeWindow)}iframeWindow.src=targetURL;window[Commands.FlowsConstants.FlowFpiResponseIdsProcessed]={};_this.activeMessageEventListener&&window.removeEventListener("message",_this.activeMessageEventListener);_this.activeMessageEventListener=function(e){_this.fpiMessageHandler(e,iframeWindow,targetURL,dynamics365OrganizationUniqueName,entityLogicalName,dynamics365EntityLogicalCollectionName,environmentId,destinationOrigin,organizationId,performanceTrackers,resolve,reject)};window.addEventListener&&window.addEventListener("message",_this.activeMessageEventListener,false)});return mainPromise};FlowsLibrary.prototype.fpiMessageHandler=function(e,iframeWindow,targetURL,dynamics365OrganizationUniqueName,dynamics365EntityLogicalName,dynamics365EntityLogicalCollectionName,environmentId,destinationOrigin,organizationId,performanceTrackers,resolveCallback,rejectCallback){if(!e||!e.data||!e.data.isResponse||!e.data.requestId||!e.data.method)return;if(e.data.requestId){if(window[Commands.FlowsConstants.FlowFpiResponseIdsProcessed][e.data.requestId])return;window[Commands.FlowsConstants.FlowFpiResponseIdsProcessed][e.data.requestId]=true}var iFrameContentWindow=iframeWindow.contentWindow;if(e.data.method==="MicrosoftFlowAppLoaded"){iFrameContentWindow.postMessage({method:"GetFlowWebsiteUrls",params:{environment:environmentId,dynamics365OrganizationUniqueName:dynamics365OrganizationUniqueName,dynamics365EntityLogicalCollectionName:dynamics365EntityLogicalCollectionName,dynamics365EntityLogicalName:dynamics365EntityLogicalName,dynamics365OrganizationId:organizationId}},destinationOrigin);performanceTrackers.startAttemptToSilentlyAuthenticateTime=performance.now();iFrameContentWindow.postMessage({method:"AttemptToSilentlyAuthenticate"},destinationOrigin)}else if(e.data.method==="UserLoginCompleted"){var userAuthTime=performance.now()-performanceTrackers.startAttemptToSilentlyAuthenticateTime;userAuthTime>0&&this.microsoftFlowsTelemetryReporter.logFlowAuthenticationEvent(this.tenantId,"Success",userAuthTime,false);iframeWindow.src=targetURL}else if(e.data.method==="AttemptToSilentlyAuthenticate")if(e.data.response&&e.data.response.success){performanceTrackers.startFlowDefinitionsLoadTime=performance.now();sessionStorage.setItem(Commands.FlowsConstants.Flow_SessionStorage_UserLoginRequired,"false");var authTime=performance.now()-performanceTrackers.startAttemptToSilentlyAuthenticateTime;authTime>0&&this.microsoftFlowsTelemetryReporter.logFlowAuthenticationEvent(this.tenantId,"Success",authTime,true);iFrameContentWindow.postMessage({method:"GetDefinitionsList",params:{environment:environmentId,dynamics365OrganizationUniqueName:dynamics365OrganizationUniqueName,dynamics365EntityLogicalCollectionName:dynamics365EntityLogicalCollectionName,dynamics365EntityLogicalName:dynamics365EntityLogicalName,dynamics365OrganizationId:organizationId}},destinationOrigin)}else{sessionStorage.setItem(Commands.FlowsConstants.Flow_SessionStorage_UserLoginRequired,"true");rejectCallback(null)}else if(e.data.method==="GetDefinitionsList")if(!e.data.isFailure){var flowDefinitions=[],endFlowDefinitionsLoadTime=performance.now(),returnedEnvironmentId=e.data.response.environmentId;if(returnedEnvironmentId){this.updateEnvironmentIdCache(returnedEnvironmentId);environmentId=returnedEnvironmentId}for(var flows=e.data.response.flows,flowCount=0,n=0;n<flows.length;++n){flowDefinitions[n]={name:flows[n].name,displayName:flows[n].displayName};flowCount=flowCount+1}sessionStorage.setItem(Commands.FlowsConstants.Flow_SessionStorage_DefinitionList+"_"+dynamics365EntityLogicalName,JSON.stringify(flowDefinitions));window.removeEventListener("message",this.activeMessageEventListener);var oLoadDefFromService=e.data.performanceInfo,timetoLoadDefFromService=0;if(oLoadDefFromService!=undefined)timetoLoadDefFromService=oLoadDefFromService.getDefinitionsListTimeMs;var timeTaken=Math.floor(endFlowDefinitionsLoadTime-performanceTrackers.startFlowDefinitionsLoadTime);this.microsoftFlowsTelemetryReporter.logFlowDefinitionsListEvent(this.tenantId,environmentId,flowCount,timeTaken,timetoLoadDefFromService,dynamics365EntityLogicalName);resolveCallback(flowDefinitions)}else{e.data.response&&e.data.response.status==403&&this.clearEnvironmentIdCache();rejectCallback(e.data.errorMessage)}else if(e.data.method==="GetFlowWebsiteUrls")if(e.data.response&&e.data.response.success){var returnedEnvironmentId=e.data.response.environmentId;if(returnedEnvironmentId){this.updateEnvironmentIdCache(returnedEnvironmentId);environmentId=returnedEnvironmentId}else console.warn("GetFlowWebsiteUrls did not get the environment Id in real time. Flow URLs are not going to be environment specific.");sessionStorage.setItem("flowCreateUrl_"+dynamics365EntityLogicalName,e.data.response.createFlowUrl);sessionStorage.setItem("flowManageUrl",e.data.response.manageFlowsUrl)}if(e.data.isFailure){var errMsg=e.data.errorMessage.replace(/'/g,"\\'"),methodName=e.data.method,errorSource=e.data.errorSource,response="";if(e.data.response)response=JSON.stringify(e.data.response);this.microsoftFlowsTelemetryReporter.logFlowErrorEvent(this.tenantId,environmentId,errorSource,response,methodName,errMsg)}};FlowsLibrary.orgUniqueName=function(){if(Xrm.Internal.isUci())return Xrm.Utility.getGlobalContext().getOrgUniqueName();else{var crmOrgUniqueName=window[Commands.FlowsConstants.Flow_GlobalVar_CrmOrgUniqueName];if(!crmOrgUniqueName&&window.parent)crmOrgUniqueName=window.parent[Commands.FlowsConstants.Flow_GlobalVar_CrmOrgUniqueName];return crmOrgUniqueName}};return FlowsLibrary}();Commands.FlowsLibrary=FlowsLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Flows=new Commands.FlowsLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Delete=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.DeleteLibrary:new Commands.DeleteLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var HierarchyLibraryLegacy=function(){function HierarchyLibraryLegacy(){}HierarchyLibraryLegacy.prototype.ViewHierarchy=function(entityTypeCode,form){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.viewHierarchy(entityTypeCode):backCompatHeader.Mscrm.CommandBarActions.viewHierarchy(entityTypeCode)};HierarchyLibraryLegacy.prototype.ViewHierarchyFromGrid=function(selectedRecords,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.viewHierarchyFromGrid(selectedRecords,entityTypeCode):backCompatHeader.Mscrm.CommandBarActions.viewHierarchyFromGrid(selectedRecords,entityTypeCode)};return HierarchyLibraryLegacy}();Commands.HierarchyLibraryLegacy=HierarchyLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var HierarchyControlName="MscrmControls.HierarchyControl.HierarchyControl",CustomControlPageType="control",HierarchyLibrary=function(){function HierarchyLibrary(){}HierarchyLibrary.prototype.ViewHierarchy=function(entityTypeCode,form){var dataInput={};dataInput.etn=form.data.entity.getEntityName();dataInput.id=form.data.entity.getId().replace("{","").replace("}","");var controlInput={};controlInput.pageType=CustomControlPageType;controlInput.controlName=HierarchyControlName;controlInput.data=dataInput;Xrm.Navigation.navigateTo(controlInput)};HierarchyLibrary.prototype.ViewHierarchyFromGrid=function(selectedRecords,entityTypeCode){var dataInput={};dataInput.etn=selectedRecords[0].TypeName;dataInput.id=selectedRecords[0].Id;var controlInput={};controlInput.pageType=CustomControlPageType;controlInput.controlName=HierarchyControlName;controlInput.data=dataInput;Xrm.Navigation.navigateTo(controlInput)};return HierarchyLibrary}();Commands.HierarchyLibrary=HierarchyLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Hierarchy=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.HierarchyLibrary:new Commands.HierarchyLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ImportLibrary=function(){function ImportLibrary(){this.importFromExcel=function(gridControl,entityTypeName){var params={};params["id_ImportFileType"]=3;params["id_EntityLogicalName"]=entityTypeName;Xrm.Navigation.openDialog("ImportWizard",{width:512,height:600,position:2},params);Xrm.Reporting.reportSuccess("Import.SMBImportLaunchRequest",[{name:"Dialogname",value:"ImportWizard"},{name:"Source",value:"EntityGrid"},{name:"EntityLogicalName",value:entityTypeName},{name:"ImportFileType",value:3}])};this.importFromCSV=function(gridControl,entityTypeName){var params={};params["id_ImportFileType"]=0;params["id_EntityLogicalName"]=entityTypeName;Xrm.Navigation.openDialog("ImportWizard",{width:512,height:600,position:2},params);Xrm.Reporting.reportSuccess("Import.SMBImportLaunchRequest",[{name:"Dialogname",value:"ImportWizard"},{name:"Source",value:"EntityGrid"},{name:"EntityLogicalName",value:entityTypeName},{name:"ImportFileType",value:0}])};this.importFromExchange=function(gridControl,entityTypeName){var params={};Xrm.Navigation.openDialog("ImportExchange",{width:400,height:600,position:2},params);Xrm.Reporting.reportSuccess("Import.SMBImportLaunchRequest",[{name:"Dialogname",value:"ImportExchange"},{name:"Source",value:"EntityGrid"},{name:"EntityLogicalName",value:entityTypeName},{name:"ImportFileType",value:2}])}}return ImportLibrary}();Commands.ImportLibrary=ImportLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Import=new Commands.ImportLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var BulkEditLibraryLegacy=function(){function BulkEditLibraryLegacy(){}BulkEditLibraryLegacy.prototype.bulkEditRecordsLegacy=function(gridControl,records,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.bulkEdit(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridRibbonActions.bulkEdit(gridControl,records,entityTypeCode)};BulkEditLibraryLegacy.prototype.bulkEditRecords=function(gridControl,records,entityName,defaultCloseState,callback){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.bulkEdit(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridRibbonActions.bulkEdit(gridControl,records,entityTypeCode)};BulkEditLibraryLegacy.prototype.isBulkEditEnabledForEntityLegacy=function(entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isBulkEditEnabledForEntity(entityTypeCode):backCompatHeader.Mscrm.RibbonActions.isBulkEditEnabledForEntity(entityTypeCode)};BulkEditLibraryLegacy.prototype.isBulkEditEnabledForEntity=function(entityName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isBulkEditEnabledForEntity(entityTypeCode):backCompatHeader.Mscrm.RibbonActions.isBulkEditEnabledForEntity(entityTypeCode)};return BulkEditLibraryLegacy}();Commands.BulkEditLibraryLegacy=BulkEditLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var BulkEditLibrary=function(){function BulkEditLibrary(){var _this=this;this.bulkEditRecordsLegacy=function(gridControl,records,entityTypeCode){var entityName=Xrm.Internal.getEntityName(entityTypeCode);_this.bulkEditRecords(gridControl,records,entityName)};this.bulkEditRecords=function(gridControl,records,entityName){if(!gridControl||!records||records.length===0){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_NoItemSelected")});return}var entityTypeCode=Xrm.Internal.getEntityCode(entityName);if(records.length===1){var openOptions={entityName:records[0].TypeName,entityId:records[0].Id};Xrm.Navigation.openForm(openOptions);return}var actualEntityName=entityName,actionUri;if(entityName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer){for(var record=records[0],i=1;i<records.length;i++)if(records[i].TypeName!==record.TypeName){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Apply_Rule_Heterogenous_Activity_Type_Records_Selected")});return}actualEntityName=record.TypeName}var forceRefresh=false,parameters=[forceRefresh,gridControl,"bulkedit",entityTypeCode,records];Commands.Common.constructAndOpenLegacyWebDialog(actualEntityName,gridControl,records,"dlg_bulkedit.aspx",1e3,700,false,_this._refreshGridAfterBulkEdit,parameters)};this._refreshGridAfterBulkEdit=function(result,forceRefresh,gridControl,requestType,entityName,records){(result||forceRefresh)&&gridControl.refresh()};this.isBulkEditEnabledForEntityLegacy=function(entityTypeCode){return _this.isBulkEditEnabledForEntity(Xrm.Internal.getEntityName(entityTypeCode))};this.isBulkEditEnabledForEntity=function(entityName){switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:if(!XrmCore.InternalUtilities.ActivityUtilities.isActivityTypeCode(entityName)||entityName==XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster)return false;return true;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AccountAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityMimeAttachment:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityParty:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityScheduling:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AdvancedSimilarityRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Annotation:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AnnualFiscalCalendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ApplicationFile:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AppLicense:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AppOfflineFilter:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Appointment:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AppSalesPerson:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AppWorkflowInstance:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AsyncOperation:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Attribute:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AttributeMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.AttributePicklistValue:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Audit:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BulkDeleteFailure:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BulkDeleteOperation:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BulkDeleteWizardDialog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BulkOperation:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BulkOperationLog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BusinessUnit:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BusinessUnitMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.BusinessUnitNewsArticle:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Calendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CalendarRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ClientUpdate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ColumnMapping:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CompetitorAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Connection:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConnectionRole:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ConstraintBasedGroup:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ContactAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contract:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ContractDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ContractTemplate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CustomerAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CustomerOpportunityRole:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CustomerRelationship:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Discount:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DiscountType:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DisplayString:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DisplayStringMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DocumentIndex:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DocumentTemplate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DuplicateDetectionDialog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DuplicateRecord:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DuplicateRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.DuplicateRuleCondition:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.EmailHash:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Entity:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.EntityMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.EntityRelationship:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.EntityRelationshipRole:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Equipment:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Fax:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.FieldPermission:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.FieldSecurityProfile:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.FilterTemplate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.FixedMonthlyFiscalCalendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.GoalRollupQuery:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.HolidayCalendarRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportData:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportEntity:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportFile:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportJob:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportLog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ImportWizardDialog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.IncidentResolution:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.IntegrationStatus:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.InternalAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.InterProcessLock:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Invoice:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.InvoiceDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.IsvConfig:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.KbArticle:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.KbArticleComment:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.KbArticleTemplate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.KnowledgeSearchModel:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.LeadAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Letter:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.License:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ListMember:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.LocalizedLabel:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.LookUpMapping:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.MailMergeTemplate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Metric:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.MonthlyFiscalCalendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.MobileOfflineProfileItemAssociation:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.NewKbArticle:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.None:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Notification:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.NotWorkingWorkShift:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OccurrenceCalendarRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OccurringWorkShift:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OpportunityClose:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OpportunityProduct:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OptionSet:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OrderClose:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Organization:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OrganizationStatistic:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OrganizationUI:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.OwnerMapping:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PhoneCall:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PickListMapping:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PluginAssembly:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PluginType:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PluginTypeStatistic:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Privilege:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.PrivilegeObjectTypeCodes:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ProcessSession:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ProductPriceLevel:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Publisher:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QuarterlyFiscalCalendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Queue:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QueueItem:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QuoteClose:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.QuoteDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurrenceCalendarRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringWorkShift:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Relationship:9803;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RelationshipRole:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RelationshipRoleMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Report:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ReportPropertyDialog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ResourceGroupExpansion:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ResourceSpec:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RibbonCommand:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RibbonContextGroup:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RibbonCustomization:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RibbonDiff:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RibbonRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RibbonTabToCommandMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Role:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RolePrivileges:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RoleTemplate:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RoleTemplatePrivileges:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RollupField:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesLiterature:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesLiteratureItem:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SalesOrderDetail:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SavedQuery:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SavedQueryVisualization:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ScriptErrorDetailsDialog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ScriptErrorDialog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessage:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageFilter:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessagePair:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageProcessingStep:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageProcessingStepImage:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageProcessingStepSecureConfig:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageRequest:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageRequestField:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageResponse:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SdkMessageResponseField:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SemiAnnualFiscalCalendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Service:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ServiceAppointment:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ServiceEndpoint:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ServiceRestrictionCalendarRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SharePointDocumentLocation:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SharePointSite:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Site:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SiteMap:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Solution:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SolutionComponent:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SolutionExportWizard:9207;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SolutionImportWizard:9208;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Subject:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Subscription:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SubscriptionClients:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SubscriptionManuallyTrackedObject:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SubscriptionSyncInfo:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemForm:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUserPrincipals:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Task:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Team:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Template:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Territory:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TimeOffCalendarRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TimeZoneDefinition:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TimeZoneLocalizedName:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TimeZoneRule:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TopicModel:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TransactionCurrency:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TransformationMapping:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.TransformationParameterMapping:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UnresolvedAddress:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UnresolvedEmailParty:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UoM:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UserFiscalCalendar:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UserForm:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UserQuery:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UserQueryVisualization:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.UserSettings:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ViewAttribute:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WebResource:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WebWizard:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WizardAccessPrivilege:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WizardPage:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Workflow:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WorkflowDependency:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WorkflowLog:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.WorkflowWaitSubscription:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.MailboxStatistics:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.EntityDashboard:return false;default:return true}}}return BulkEditLibrary}();Commands.BulkEditLibrary=BulkEditLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.BulkEdit=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.BulkEditLibrary:new Commands.BulkEditLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var MergeLibraryLegacy=function(){function MergeLibraryLegacy(){}MergeLibraryLegacy.prototype.mergeRecordsLegacy=function(gridControl,records,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.mergeRecords(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.mergeRecords(gridControl,records,entityTypeCode)};MergeLibraryLegacy.prototype.mergeRecords=function(gridControl,records,entityName,defaultCloseState,callback){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.mergeRecords(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.mergeRecords(gridControl,records,entityTypeCode)};return MergeLibraryLegacy}();Commands.MergeLibraryLegacy=MergeLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var MergeLibrary=function(){function MergeLibrary(){var _this=this;this.mergeRecordsLegacy=function(gridControl,records,entityTypeCode){var entityName=Xrm.Internal.getEntityName(entityTypeCode);_this.mergeRecords(gridControl,records,entityName)};this.mergeRecords=function(gridControl,records,entityName){var maxLimit=2;if(records&&records.length>maxLimit){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("LOCID_MERGE_TOOMANY_RECORDS")});return}var forceRefresh=false,parameters=[forceRefresh,gridControl,"merge",Xrm.Internal.getEntityCode(entityName),records];Commands.Common.constructAndOpenLegacyWebDialog(entityName,gridControl,records,"dlg_merge.aspx",800,570,true,_this.showMessageAfterMergeAssocAndRefreshGrid,parameters)};this.showMessageAfterMergeAssocAndRefreshGrid=function(result,forceRefresh,gridControl,requestType,entityName,records){(result||forceRefresh)&&gridControl.refresh()}}return MergeLibrary}();Commands.MergeLibrary=MergeLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Merge=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.MergeLibrary:new Commands.MergeLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var NavigateToGridLibrary=function(){function NavigateToGridLibrary(){}NavigateToGridLibrary.prototype.navigateToHomepageGrid=function(gridControl,entityTypeName){if(entityTypeName&&gridControl&&gridControl.getViewSelector()&&gridControl.getViewSelector().getCurrentView()){var currentViewId=gridControl.getViewSelector().getCurrentView().id,viewId=currentViewId&&currentViewId.replace("{","").replace("}","").toUpperCase();Xrm.Navigation.navigateTo({pageType:"entitylist",entityName:entityTypeName,viewId:viewId})}};return NavigateToGridLibrary}();Commands.NavigateToGridLibrary=NavigateToGridLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.NavigateToGrid=new Commands.NavigateToGridLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var NewRecordForBPFEntityLibraryLegacy=function(){function NewRecordForBPFEntityLibraryLegacy(){this.openNewRecord=function(entityLogicalName,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.openNewBpfEntityRecord(entityLogicalName,gridControl):backCompatHeader.Mscrm.CommandBarActions.openNewBpfEntityRecord(entityLogicalName,gridControl)}}return NewRecordForBPFEntityLibraryLegacy}();Commands.NewRecordForBPFEntityLibraryLegacy=NewRecordForBPFEntityLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var NewRecordForBPFEntityLibrary=function(){function NewRecordForBPFEntityLibrary(){this.openNewRecord=function(entityLogicalName,gridControl){NewRecordForBPFEntityLibrary.getProcessInfo(entityLogicalName).then(function(response){if(response.entities&&response.entities.length>0){var process=response.entities[0],primaryEntityLogicalName=process["primaryentity"],processId=process["workflowid"],openOptions={entityName:primaryEntityLogicalName,processId:processId};Xrm.Navigation.openForm(openOptions)}},function(e){console.error(e)})}}NewRecordForBPFEntityLibrary.getProcessInfo=function(entityLogicalName){var fetchXml="<fetch version='1.0' mapping='logical'><entity name='workflow'><attribute name='primaryentity' /><attribute name='workflowid' /><filter type='and'><condition attribute='uniquename' operator='eq' value='"+entityLogicalName+"' /></filter></entity></fetch>";return Xrm.WebApi.online.retrieveMultipleRecords("workflow","?fetchXml="+fetchXml)};return NewRecordForBPFEntityLibrary}();Commands.NewRecordForBPFEntityLibrary=NewRecordForBPFEntityLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.NewRecordForBPFEntity=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.NewRecordForBPFEntityLibrary:new Commands.NewRecordForBPFEntityLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var OpenObjLibraryLegacy=function(){function OpenObjLibraryLegacy(){var _this=this;this.NewCustomActivity=function(entityTypeName,id,parameters,urlPrefix,mode,extraParams){_this.NewCustomActivityLegacy(Xrm.Internal.getEntityCode(entityTypeName),id,parameters,urlPrefix,mode,extraParams)};this.NewCustomActivityLegacy=function(entityTypeCode,id,parameters,urlPrefix,mode,extraParams){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);openObj?openObj(entityTypeCode,id,parameters,urlPrefix,mode,extraParams):backCompatHeader.openObj(entityTypeCode,id,parameters,urlPrefix,mode,extraParams)}}return OpenObjLibraryLegacy}();Commands.OpenObjLibraryLegacy=OpenObjLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var OpenObjLibrary=function(){function OpenObjLibrary(){var _this=this;this.NewCustomActivity=function(entityTypeName,id,parameters,urlPrefix,mode,extraParams){var openOptions={entityName:entityTypeName};Xrm.Navigation.openForm(openOptions)};this.NewCustomActivityLegacy=function(entityTypeCode,id,parameters,urlPrefix,mode,extraParams){var entityName=Xrm.Internal.getEntityName(entityTypeCode);_this.NewCustomActivity(entityName,id,parameters,urlPrefix,mode,extraParams)}}return OpenObjLibrary}();Commands.OpenObjLibrary=OpenObjLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.OpenObj=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.OpenObjLibrary:new Commands.OpenObjLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var OpenLibraryLegacy=function(){function OpenLibraryLegacy(){this.openNewRecord=function(entityLogicalName,gridControl){if(typeof entityLogicalName==="number")entityLogicalName=Xrm.Internal.getEntityName(entityLogicalName);var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.openNewRecord(entityLogicalName,gridControl):backCompatHeader.Mscrm.CommandBarActions.openNewRecord(entityLogicalName,gridControl)};this.addNewFromSubGridStandard=function(gridTypeName,parentEntityTypeName,parentEntityId,primaryControl,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true),parentEntityTypeCode=Xrm.Internal.getEntityCode(parentEntityTypeName),gridTypeCode=Xrm.Internal.getEntityCode(gridTypeName);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.addNewFromSubGridStandard(gridTypeCode,parentEntityTypeCode,parentEntityId,primaryControl,gridControl):backCompatHeader.Mscrm.GridCommandActions.addNewFromSubGridStandard(gridTypeCode,parentEntityTypeCode,parentEntityId,primaryControl,gridControl)};this.addNewFromSubGridStandardLegacy=function(gridTypeCode,parentEntityTypeCode,parentEntityId,primaryControl,gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.addNewFromSubGridStandard(gridTypeCode,parentEntityTypeCode,parentEntityId,primaryControl,gridControl):backCompatHeader.Mscrm.GridCommandActions.addNewFromSubGridStandard(gridTypeCode,parentEntityTypeCode,parentEntityId,primaryControl,gridControl)}}return OpenLibraryLegacy}();Commands.OpenLibraryLegacy=OpenLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var OpenLibrary=function(){function OpenLibrary(){var _this=this;this.openNewRecord=function(entityLogicalName,gridControl){if(typeof entityLogicalName==="number")entityLogicalName=Xrm.Internal.getEntityName(entityLogicalName);if(!entityLogicalName)return;var parameters={};switch(entityLogicalName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Report:var runReportLib=void 0;runReportLib=new XrmCore.Commands.RunReportLibrary;runReportLib.NewReport(entityLogicalName,gridControl);break;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.Connection:var SALES_TEAM_VIEW_ID="FE4BC089-8901-466C-A41B-1C1090F204D4",STAKEHOLDER_VIEW_ID="4E3600FA-B9C8-49F4-B69A-51EBA06D9BDF",STAKEHOLDER_ROLE_ID="518D7AAA-3B4C-4041-AD33-A6FD40DF6C81",SALES_PROFESSIONAL_ROLE_ID_1="20079806-EB84-4093-99AD-BB46435DB028",currentViewId=gridControl&&gridControl.getViewSelector().getCurrentView().id,viewId=currentViewId&&currentViewId.replace("{","").replace("}","").toUpperCase(),isStakeholderOrSalesTeamGrid=viewId&&(viewId==STAKEHOLDER_VIEW_ID||viewId==SALES_TEAM_VIEW_ID);if(isStakeholderOrSalesTeamGrid){var targetEntityName=viewId==STAKEHOLDER_VIEW_ID?XrmCore.InternalUtilities.EntityUtilities.EntityNames.Contact:XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser,roleId_1=viewId==STAKEHOLDER_VIEW_ID?STAKEHOLDER_ROLE_ID:SALES_PROFESSIONAL_ROLE_ID_1,lookup=Xrm.Utility.lookupObjects?Xrm.Utility.lookupObjects({allowMultiSelect:false,defaultEntityType:targetEntityName,entityTypes:[targetEntityName],lookupType:"Lookup.Simple"}):null;lookup&&lookup.then(function(lookupValues){return _this.createConnection(lookupValues,roleId_1,gridControl,roleId_1==SALES_PROFESSIONAL_ROLE_ID_1)});break}else if(gridControl){var fetchXml=gridControl.getFetchXml(),domFetch=fetchXml&&XrmCore.InternalUtilities.ExportUtilities.getXmlDOMFromString(fetchXml),linkEntities=domFetch&&domFetch.getElementsByTagName("link-entity");if(linkEntities)for(var linkEntity=void 0,linkEntity=0;linkEntity<linkEntities.length;linkEntity++)if(linkEntities[linkEntity].getAttribute("name")=="connectionrole"){var filters=linkEntities[linkEntity].getElementsByTagName("filter");if(filters&&filters[0])for(var conditions=filters[0].getElementsByTagName("condition"),condition=void 0,condition=0;condition<conditions.length;condition++)if(conditions[condition].getAttribute("attribute")=="category")parameters["roleCategoryId"]=conditions[condition].getAttribute("value")}}default:var openOptions={entityName:entityLogicalName};if(gridControl){var subGridControl=gridControl;if(subGridControl.getGridType&&(subGridControl.getGridType()===3||subGridControl.getGridType()===2)){openOptions.useQuickCreateForm=true;if(subGridControl.getRelationship&&subGridControl.getRelationship()){var parentControl=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page;if(parentControl&&parentControl.data&&parentControl.data.entity){var lookupValue=parentControl.data.entity.getEntityReference();openOptions.createFromEntity=lookupValue}}}}Xrm.Navigation.openForm(openOptions,parameters)}};this.addNewFromSubGridStandard=function(gridEntityName,parentEntityName,parentEntityId,primaryControl,gridControl){if(typeof gridEntityName=="number")gridEntityName=Xrm.Internal.getEntityName(gridEntityName);var entityRelationship=gridControl.getRelationship(),parentControl=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,fromEntity=parentControl.data.entity.getEntityReference(),openOptions={entityName:gridEntityName,createFromEntity:fromEntity,useQuickCreateForm:true,relationship:entityRelationship};Xrm.Navigation.openForm(openOptions)};this.addNewFromSubGridStandardLegacy=function(gridTypeCode,parentEntityTypeCode,parentEntityId,primaryControl,gridControl){_this.addNewFromSubGridStandard(Xrm.Internal.getEntityName(gridTypeCode),Xrm.Internal.getEntityName(parentEntityTypeCode),parentEntityId,primaryControl,gridControl)};this.createConnection=function(lookupValues,targetRoleId,gridControl,assignRecordToDefaultSalesTemplate){if(assignRecordToDefaultSalesTemplate===void 0)assignRecordToDefaultSalesTemplate=false;if(!lookupValues||lookupValues.length===0)return;var connectionFromEntitySetName,connectionToEntitySetName,parentControl=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page;Xrm.Utility.getEntityMetadata(parentControl.data.entity.getEntityName()).then(function(connectionFromMetadata){connectionFromEntitySetName=connectionFromMetadata["EntitySetName"];var fromEntityId=parentControl.data.entity.getId().replace("{","").replace("}",""),toEntityType=lookupValues[0].entityType,toEntityId=lookupValues[0].id.replace("{","").replace("}","");Xrm.Utility.getEntityMetadata(toEntityType).then(function(connectionToMetadata){connectionToEntitySetName=connectionToMetadata["EntitySetName"];var DummyConnectionRoleIdIfRecord2RoleIdDoesNotExist="26591187-1160-4D25-8723-2D9C92617D3A",connection={};connection["record1id_"+parentControl.data.entity.getEntityName()+"@odata.bind"]="/"+connectionFromEntitySetName+"("+fromEntityId+")";connection["record2id_"+toEntityType+"@odata.bind"]="/"+connectionToEntitySetName+"("+toEntityId+")";connection["record2roleid@odata.bind"]="/connectionroles("+targetRoleId+")";connection["record1roleid@odata.bind"]="/connectionroles("+DummyConnectionRoleIdIfRecord2RoleIdDoesNotExist+")";Xrm.WebApi.createRecord(XrmCore.InternalUtilities.EntityUtilities.EntityNames.Connection,connection).then(function(success){if(assignRecordToDefaultSalesTemplate){var ACCESS_TEAM_TEMPLATE_ID="B3228218-B8F6-4A1B-A18D-552C6F980831";_this.addUserToRecordTeam(lookupValues[0].id,ACCESS_TEAM_TEMPLATE_ID)}gridControl&&gridControl.refresh()},function(error){gridControl&&gridControl.refresh();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})})})};this.addUserToRecordTeam=function(userId,templateId){var parentEntity=Xrm.Page.data.entity,addUserToTeamRequest=new XrmCore.SdkContracts.AddUserToRecordTeamRequest({id:userId,entityType:XrmCore.InternalUtilities.EntityUtilities.EntityNames.SystemUser},{id:parentEntity.getId(),entityType:parentEntity.getEntityName()},{id:templateId,entityType:XrmCore.InternalUtilities.EntityUtilities.EntityNames.TeamTemplate});Xrm.WebApi.online.execute(addUserToTeamRequest).then(null,function(error){XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})}}return OpenLibrary}();Commands.OpenLibrary=OpenLibrary;var LookupValueImplementation=function(){function LookupValueImplementation(id,name,entityType){this.name=name;this.id=id;this.entityType=entityType}return LookupValueImplementation}()})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Open=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.OpenLibrary:new Commands.OpenLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var OpenActiveStageLibraryLegacy=function(){function OpenActiveStageLibraryLegacy(){}OpenActiveStageLibraryLegacy.prototype.openActiveStageFromGrid=function(records){var record=records[0],bpfEntityReference={LogicalName:record.TypeName,Id:record.Id,Name:record.Name},backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.openActiveStage(bpfEntityReference):backCompatHeader.Mscrm.GridRibbonActions.openActiveStage(bpfEntityReference)};OpenActiveStageLibraryLegacy.prototype.openActiveStageFromForm=function(id,entityName){var bpfEntityReference={LogicalName:entityName,Id:id,Name:""},backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.openActiveStage(bpfEntityReference):backCompatHeader.Mscrm.GridRibbonActions.openActiveStage(bpfEntityReference)};return OpenActiveStageLibraryLegacy}();Commands.OpenActiveStageLibraryLegacy=OpenActiveStageLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var OpenActiveStageLibrary=function(){function OpenActiveStageLibrary(){}OpenActiveStageLibrary.prototype.openActiveStageFromGrid=function(records){if(records.length==1){var record_1=records[0],bpfEntityReference={entityType:record_1.TypeName,id:record_1.Id,name:record_1.Name},request=new XrmCore.SdkContracts.RetrieveActiveStageRecordRequest(bpfEntityReference),deferred=Xrm.WebApi.online.execute(request).then(function(response){return response.json()}).then(function(odataResponse){var entityName=odataResponse["@odata.type"].replace("#Microsoft.Dynamics.CRM.","");Xrm.Utility.getEntityMetadata(entityName).then(function(entityMetadata){var openOptions={entityName:entityName,entityId:odataResponse[entityMetadata.PrimaryIdAttribute],processId:odataResponse["processid"],processInstanceId:record_1.Id};Xrm.Navigation.openForm(openOptions,null)})},function(error){console.error(error)});return}};OpenActiveStageLibrary.prototype.openActiveStageFromForm=function(id,entityName){var bpfEntityReference={entityType:entityName,id:id},request=new XrmCore.SdkContracts.RetrieveActiveStageRecordRequest(bpfEntityReference),deferred=Xrm.WebApi.online.execute(request).then(function(response){return response.json()}).then(function(odataResponse){var entityName=odataResponse["@odata.type"].replace("#Microsoft.Dynamics.CRM.","");Xrm.Utility.getEntityMetadata(entityName).then(function(entityMetadata){var openOptions={entityName:entityName,entityId:odataResponse[entityMetadata.PrimaryIdAttribute],processId:odataResponse["processid"],processInstanceId:id};Xrm.Navigation.openForm(openOptions,null)})},function(error){console.error(error)})};return OpenActiveStageLibrary}();Commands.OpenActiveStageLibrary=OpenActiveStageLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.OpenActiveStage=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.OpenActiveStageLibrary:new Commands.OpenActiveStageLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var Refresh=function(){function Refresh(){}Refresh.refreshCommand=function(control){if(control.refresh)control.refresh();else Xrm.Page.ui&&Xrm.Page.ui.refresh&&Xrm.Page.ui.refresh()};return Refresh}();Commands.Refresh=Refresh})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DisassociateLibraryLegacy=function(){function DisassociateLibraryLegacy(){}DisassociateLibraryLegacy.prototype.gridDisassociate=function(typeName,gridControl,firstSelectedItemId){var typeCode=Xrm.Internal.getEntityCode(typeName),backCompatHeader=window.top.frames[0];Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.gridDisassociate(typeCode,gridControl,firstSelectedItemId):backCompatHeader.Mscrm.GridRibbonActions.gridDisassociate(typeCode,gridControl,firstSelectedItemId)};return DisassociateLibraryLegacy}();Commands.DisassociateLibraryLegacy=DisassociateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var GridDisassociateBase=function(_super){__extends(GridDisassociateBase,_super);function GridDisassociateBase(){_super.apply(this,arguments)}GridDisassociateBase.prototype.disassociate=function(gridControl,selectedRecords){var _this=this,parentControl=gridControl&&gridControl.getParentForm?gridControl.getParentForm():Xrm.Page,parentId=parentControl.data.entity.getId().replace("{","").replace("}",""),parentEntity=parentControl.data.entity.getEntityName(),subGridControl=gridControl,relationship=subGridControl&&subGridControl.getRelationship&&subGridControl.getRelationship(),relationshipName=relationship&&relationship.name,childEntity=gridControl&&gridControl.getEntityName?gridControl.getEntityName():"",shouldSwapParentChild=relationship&&relationship.roleType===2&&relationship.relationshipType===1;if(selectedRecords&&0<selectedRecords.getLength())Xrm.WebApi.online&&Xrm.Utility.getEntityMetadata(parentEntity).then(function(metadata){var batch=[];selectedRecords.forEach(function(selectedRecord){var childId=selectedRecord.getId().replace("{","").replace("}","");if(shouldSwapParentChild)batch.push(_this.createDisassociateODataContract(childId,childEntity,parentId,relationship));else batch.push(_this.createDisassociateODataContract(parentId,parentEntity,childId,relationship))});batch&&batch.length>0&&_this.performExecuteMultiple(gridControl,batch)});else{var rows_1=gridControl&&gridControl.getGrid&&gridControl.getGrid()&&gridControl.getGrid().getSelectedRows&&gridControl.getGrid().getSelectedRows();if(rows_1&&0<rows_1.getLength())Xrm.WebApi.online&&Xrm.Utility.getEntityMetadata(parentEntity).then(function(metadata){var batch=[];rows_1.forEach(function(row){var childId=row&&row.data&&row.data.entity&&row.data.entity.getId?row.data.entity.getId().replace("{","").replace("}",""):null;if(shouldSwapParentChild)batch.push(_this.createDisassociateODataContract(childId,childEntity,parentId,relationship));else batch.push(_this.createDisassociateODataContract(parentId,parentEntity,childId,relationship))});batch&&batch.length>0&&_this.performExecuteMultiple(gridControl,batch)})}};GridDisassociateBase.prototype.createDisassociateODataContract=function(entityId,entityType,relatedEntityId,relationship){var request={getMetadata:function(){var ODataMetadata={boundParameter:null,parameterTypes:{},operationName:"Disassociate",operationType:2};return ODataMetadata},target:{id:entityId,entityType:entityType},relatedEntityId:relatedEntityId,relationship:relationship&&relationship.name};return request};GridDisassociateBase.prototype.performExecuteMultiple=function(gridControl,batch){Xrm.WebApi.online.executeMultiple(batch).then(function(success){XrmCore.InternalUtilities.DialogUtilities.onGridActionMultipleSuccess(gridControl,success)},function(error){gridControl.refresh();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error)})};return GridDisassociateBase}(XrmCore.Common.EntitySpecificOverrideBase);Commands.GridDisassociateBase=GridDisassociateBase})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var GridDisassociate=function(_super){__extends(GridDisassociate,_super);function GridDisassociate(){_super.apply(this,arguments);this.overrideMethods={disassociate:{category:"gridDisassociateForKnowledgeArticleCategory"}}}GridDisassociate.prototype.gridDisassociateForKnowledgeArticleCategory=function(base,gridControl,selectedRecords){this[base](gridControl,selectedRecords)};return GridDisassociate}(Commands.GridDisassociateBase);Commands.GridDisassociate=GridDisassociate})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var DisassociateLibrary=function(){function DisassociateLibrary(){}DisassociateLibrary.prototype.gridDisassociate=function(typeName,gridControl,firstSelectedItemId){var gridDisassociate=new Commands.GridDisassociate(typeName);gridDisassociate.call("disassociate",gridControl)};return DisassociateLibrary}();Commands.DisassociateLibrary=DisassociateLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Disassociate=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.DisassociateLibrary:new Commands.DisassociateLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var SaveLibraryLegacy=function(){function SaveLibraryLegacy(){this.saveForm=function(form){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.saveForm(form):backCompatHeader.Mscrm.RibbonActions.saveForm(form)};this.saveAndCloseForm=function(form){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.saveAndCloseForm(form):backCompatHeader.Mscrm.RibbonActions.saveAndCloseForm(form)};this.saveAsCompleted=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.saveAsCompleted():backCompatHeader.Mscrm.CommandBarActions.saveAsCompleted()}}return SaveLibraryLegacy}();Commands.SaveLibraryLegacy=SaveLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var SaveLibrary=function(){function SaveLibrary(){var _this=this;this.saveForm=function(form){var saveOptions={useSchedulingEngine:false,saveMode:1},successCallback=function(successParameter){};form.data.save(saveOptions).then(successCallback,_this._failedCallback)};this.saveAndCloseForm=function(form){var saveOptions={useSchedulingEngine:false,saveMode:2},successCallback=function(successParameter){form.ui.close()};form.data.save(saveOptions).then(successCallback,_this._failedCallback)};this._failedCallback=function(errorResponse){};this.saveAsCompleted=function(){var entityId=Xrm.Page.data.entity.getId(),entityName=Xrm.Page.data.entity.getEntityName(),stateCode=1,statusCode=-1,closePage=true;XrmCore.Commands.Common.setState(entityId,entityName,stateCode,statusCode,closePage,null,null,58)}}return SaveLibrary}();Commands.SaveLibrary=SaveLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Save=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.SaveLibrary:new Commands.SaveLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var SetRegardingLibraryLegacy=function(){function SetRegardingLibraryLegacy(){}SetRegardingLibraryLegacy.prototype.setRegarding=function(gridControl,records,entityTypeName){var entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName),backCompatHeader=window.top.frames[0];Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.setRegarding(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.GridCommandActions.addExistingFromSubGridAssociated(gridControl,records,entityTypeCode)};SetRegardingLibraryLegacy.prototype.setRegardingOnLoad=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.setRegardingOnLoad():backCompatHeader.Mscrm.GridCommandActions.setRegardingOnLoad()};SetRegardingLibraryLegacy.prototype.setRegardingDialogRegardingChange=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.setRegardingDialogRegardingChange():backCompatHeader.Mscrm.GridCommandActions.setRegardingDialogRegardingChange()};SetRegardingLibraryLegacy.prototype.setRegardingDialogSetClick=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.setRegardingDialogSetClick():backCompatHeader.Mscrm.GridCommandActions.setRegardingDialogSetClick()};SetRegardingLibraryLegacy.prototype.setRegardingCloseDialog=function(){Commands.Common.closeDialogLegacy()};return SetRegardingLibraryLegacy}();Commands.SetRegardingLibraryLegacy=SetRegardingLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var SetRegardingLibrary=function(){function SetRegardingLibrary(){}SetRegardingLibrary.prototype.setRegarding=function(gridControl,records,entityTypeName){if(Xrm.Internal.isUci()&&entityTypeName==Xrm.Constants.EntityNames.ActivityPointer){var promise=Xrm.Utility.getEntitiesMetadata(Commands.Common.GetEntityNamesFromActivityRecords(records));records.length>0&&promise.then(function(values){!Commands.Common.CheckIfIsReadOnlyInMobileClient(values)&&SetRegardingLibrary.setRegardingCallback(gridControl,records,entityTypeName)})}else SetRegardingLibrary.setRegardingCallback(gridControl,records,entityTypeName)};SetRegardingLibrary.setRegardingCallback=function(gridControl,records,entityTypeName){var windowWidth=500,windowHeight=260,dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName]=entityTypeName;dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records]=records;var options={width:windowWidth,height:windowHeight};Xrm.Navigation.openDialog(XrmCore.InternalUtilities.DialogUtilities.DialogName.SetRegarding,options,dialogParams).then(Commands.Common.gridCommandDialogCloseCallback(gridControl))};SetRegardingLibrary.prototype.setRegardingOnLoad=function(eventContext){var formContext=eventContext.getFormContext(),setButton=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);setButton.setDisabled(true);var headerDescriptionControl=formContext.getControl("label_DialogDescription"),selectedRecordsCount=0,records=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records).getValue();selectedRecordsCount=records.length;Xrm.Utility.getEntityMetadata(Xrm.Constants.EntityNames.ActivityPointer).then(function(entityInfo){var titleDescription="";if(selectedRecordsCount===1)titleDescription=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_SetRegarding_Description"),[selectedRecordsCount,entityInfo.DisplayName]);else titleDescription=XrmCore.InternalUtilities.GenericUtilities.stringFormat(XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Dialog_SetRegarding_Description"),[selectedRecordsCount,entityInfo.DisplayCollectionName]);headerDescriptionControl.setLabel(titleDescription)})};SetRegardingLibrary.prototype.setRegardingDialogRegardingChange=function(eventContext){var formContext=eventContext.getFormContext(),setButton=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId),setRegardingLookupControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.regardingControlName),regardingValue=setRegardingLookupControl.getAttribute().getValue();if(!regardingValue||regardingValue.length===0)setButton.setDisabled(true);else setButton.setDisabled(false)};SetRegardingLibrary.prototype.setRegardingDialogSetClick=function(eventContext){var formContext=eventContext.getFormContext();if(XrmCore.InternalUtilities.DialogUtilities.isOffline()){XrmCore.InternalUtilities.DialogUtilities.showOfflineError();return}var records=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.Records).getValue(),regardingLookupControl=formContext.getControl(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.regardingControlName),selectedRegardingEntities=regardingLookupControl.getAttribute().getValue(),regardingObjectId=selectedRegardingEntities[0].id,regardingObjectTypeName=selectedRegardingEntities[0].entityType;XrmCore.InternalUtilities.GenericUtilities.showGenericProgressIndicator();var uniqueRecordTypes=records.reduce(function(accumulator,record){accumulator.indexOf(record.TypeName)<0&&accumulator.push(record.TypeName);return accumulator},[]);XrmCore.InternalUtilities.GenericUtilities.createChainedEntityMetadataMapWithCallback(uniqueRecordTypes,0,{},function(entityInfo){if(records.length===1)SetRegardingLibrary.saveRegardingObject(eventContext,records[0].Id,records[0].TypeName,entityInfo[records[0].TypeName].EntitySetName,regardingObjectId,regardingObjectTypeName);else SetRegardingLibrary.saveRegardingMultiple(eventContext,records,entityInfo,regardingObjectId,regardingObjectTypeName)})};SetRegardingLibrary.prototype.setRegardingCloseDialog=function(eventContext){XrmCore.InternalUtilities.DialogUtilities.closeDialog(eventContext)};SetRegardingLibrary.saveRegardingObject=function(eventContext,id,entityName,entitySetName,regardingObjectId,regardingObjectEntityName){var formContext=eventContext.getFormContext(),payloadKey="regardingobjectid_"+regardingObjectEntityName+"_"+entityName+"@odata.bind",payload=(_a={},_a[payloadKey]="/"+entitySetName+"("+regardingObjectId.replace("{","").replace("}","")+")",_a);Xrm.WebApi.online.updateRecord(entityName,id,payload).then(function(){XrmCore.InternalUtilities.DialogUtilities.setLastButtonClicked(eventContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);Xrm.Utility.closeProgressIndicator();formContext.ui.close()},function(reason){XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(reason);formContext.ui.close()});var _a};SetRegardingLibrary.saveRegardingMultiple=function(eventContext,records,entityInfo,regardingObjectId,regardingObjectTypeName){var formContext=eventContext.getFormContext(),setRegardingBatch=records.map(function(record){var setRegardingRequest=new XrmCore.SdkContracts.SetRegardingRequest(record,regardingObjectTypeName,regardingObjectId,entityInfo[record.TypeName].EntitySetName);return setRegardingRequest});Xrm.WebApi.online.executeMultiple(setRegardingBatch).then(function(success){if(success.every(function(response){return response.ok})){XrmCore.InternalUtilities.DialogUtilities.setLastButtonClicked(eventContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);Xrm.Utility.closeProgressIndicator();formContext.ui.close()}else SetRegardingLibrary.openAlertDialogForSetRegardingMultipleError(eventContext)},function(error){Xrm.Utility.closeProgressIndicator();XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog(error);formContext.ui.close()})};SetRegardingLibrary.openAlertDialogForSetRegardingMultipleError=function(eventContext){var formContext=eventContext.getFormContext(),dialogText=XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_MultipleErrorsFound");Xrm.Navigation.openAlertDialog({text:dialogText});XrmCore.InternalUtilities.DialogUtilities.setLastButtonClicked(eventContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);Xrm.Utility.closeProgressIndicator();formContext.ui.close()};return SetRegardingLibrary}();Commands.SetRegardingLibrary=SetRegardingLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.SetRegarding=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.SetRegardingLibrary:new Commands.SetRegardingLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var ShareLibraryLegacy=function(){function ShareLibraryLegacy(){}ShareLibraryLegacy.prototype.shareSelectedRecordsLegacy=function(gridControl,selectedRecords,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.shareSelectedRecords(gridControl,selectedRecords,entityTypeCode):backCompatHeader.Mscrm.GridRibbonActions.shareSelectedRecords(gridControl,selectedRecords,entityTypeCode)};ShareLibraryLegacy.prototype.shareSelectedRecords=function(gridControl,selectedRecords,entityName,defaultCloseState,callback){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),entityTypeCode=Xrm.Internal.getEntityCode(entityName);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.shareSelectedRecords(gridControl,selectedRecords,entityTypeCode):backCompatHeader.Mscrm.GridRibbonActions.shareSelectedRecords(gridControl,selectedRecords,entityTypeCode)};ShareLibraryLegacy.prototype.isShareValidLegacy=function(selectedEntityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isShareValid(selectedEntityTypeCode):backCompatHeader.Mscrm.RibbonActions.isShareValid(selectedEntityTypeCode)};ShareLibraryLegacy.prototype.isShareValid=function(selectedEntityTypeName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false),selectedEntityTypeCode=Xrm.Internal.getEntityCode(selectedEntityTypeName);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isShareValid(selectedEntityTypeCode):backCompatHeader.Mscrm.RibbonActions.isShareValid(selectedEntityTypeCode)};return ShareLibraryLegacy}();Commands.ShareLibraryLegacy=ShareLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var SHARE_COMPONENT_NAME="Share",ShareLibrary=function(){function ShareLibrary(){var _this=this;this.isShareValidLegacy=function(selectedEntityTypeCode){return _this.isShareValid(Xrm.Internal.getEntityName(selectedEntityTypeCode))};this.isShareValid=function(selectedEntityName){switch(selectedEntityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:return false;default:return true}};this.shareSelectedRecordsLegacy=function(gridControl,selectedRecords,entityTypeCode){var entityName=Xrm.Internal.getEntityName(entityTypeCode);_this.shareSelectedRecords(gridControl,selectedRecords,entityName)};this.shareSelectedRecords=function(gridControl,selectedRecords,entityName){var forceRefresh=false,callback=null,parameters=[forceRefresh,gridControl,callback];Commands.Common.constructAndOpenLegacyWebDialog(entityName,gridControl,selectedRecords,"dlg_share.aspx",885,500,true,_this.refreshGrid,parameters)};this.refreshGrid=function(result,forceRefresh,gridControl,requestType,entityName,records){(result||forceRefresh)&&gridControl.refresh()}}return ShareLibrary}();Commands.ShareLibrary=ShareLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.Share=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.ShareLibrary:new Commands.ShareLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var AutoSaveLibraryLegacy=function(){function AutoSaveLibraryLegacy(){this.isAutoSaveEnabled=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isAutoSaveEnabled():backCompatHeader.Mscrm.RibbonActions.isAutoSaveEnabled()}}return AutoSaveLibraryLegacy}();Rules.AutoSaveLibraryLegacy=AutoSaveLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var AutoSaveLibrary=function(){function AutoSaveLibrary(){this.isAutoSaveEnabled=function(){return Xrm.Utility.getGlobalContext().organizationSettings.isAutoSaveEnabled}}return AutoSaveLibrary}();Rules.AutoSaveLibrary=AutoSaveLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.AutoSave=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.AutoSaveLibrary:new Rules.AutoSaveLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var ChartsLibraryLegacy=function(){function ChartsLibraryLegacy(){this.disableButtonsWhenChartMaximized=function(gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.disableButtonsWhenChartMaximized(gridControl):backCompatHeader.Mscrm.GridCommandActions.disableButtonsWhenChartMaximized(gridControl)}}return ChartsLibraryLegacy}();Rules.ChartsLibraryLegacy=ChartsLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var ChartsLibrary=function(){function ChartsLibrary(){this.disableButtonsWhenChartMaximized=function(gridControl){return true}}return ChartsLibrary}();Rules.ChartsLibrary=ChartsLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.Charts=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.ChartsLibrary:new Rules.ChartsLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var DashboardLibrary=function(){function DashboardLibrary(){this.isDashboardPage=function(){return Xrm.Utility.getGlobalContext().getQueryStringParameters().pageType==="dashboard"}}return DashboardLibrary}();Rules.DashboardLibrary=DashboardLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.Dashboard=new Rules.DashboardLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var Enabled=function(){function Enabled(){this.enableImportFromExchange=function(entityTypeName){if(entityTypeName=="contact")return true;else return false}}Enabled.alwaysEnabled=function(){return true};Enabled.neverEnabled=function(){return false};Enabled.enableImportForWeb=function(){if(Xrm.Internal.isUci&&Xrm.Internal.isUci()&&Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.web)return true;else return false};Enabled.enableActivityForWeb=function(){if(Xrm.Internal.isUci&&Xrm.Internal.isUci())if(Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.web)return true;else return false;else return true};Enabled.enableExportToExcelOnlineForModern=function(){if(Xrm.Internal.isUci&&Xrm.Internal.isUci())return !Xrm.Utility.getGlobalContext().isOnPremises();else return true};return Enabled}();Rules.Enabled=Enabled})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var ExportLibraryLegacy=function(){function ExportLibraryLegacy(){}ExportLibraryLegacy.prototype.EnableExportToExcel=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.enableExportToExcel():backCompatHeader.Mscrm.RibbonActions.enableExportToExcel()};ExportLibraryLegacy.prototype.EnabledForXlsxExport=function(gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.enabledForXlsxExport(gridControl):backCompatHeader.Mscrm.GridRibbonActions.enabledForXlsxExport(gridControl)};ExportLibraryLegacy.prototype.EnableOnlyInBrowsersForModern=function(){return true};return ExportLibraryLegacy}();Rules.ExportLibraryLegacy=ExportLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var ExportLibrary=function(){function ExportLibrary(){}ExportLibrary.prototype.EnableExportToExcel=function(){return true};ExportLibrary.prototype.EnabledForXlsxExport=function(gridControl){return true};ExportLibrary.prototype.EnableOnlyInBrowsersForModern=function(){if(Xrm.Internal.isUci&&Xrm.Internal.isUci())if(Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.web)return true;else return false;else return true};return ExportLibrary}();Rules.ExportLibrary=ExportLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.Export=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.ExportLibrary:new Rules.ExportLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var HierarchyView=function(){function HierarchyView(){}HierarchyView.isValidForHierarchyView=function(){return true};HierarchyView.isValidForHierarchyPageInUC=function(){return true};return HierarchyView}();Rules.HierarchyView=HierarchyView})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var HierarchyLibraryLegacy=function(){function HierarchyLibraryLegacy(){this.IsRecordHierarchyEnabled=function(selectedControl,selectedControlSelectedItemReferences){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isRecordHierarchyEnabled(selectedControl,selectedControlSelectedItemReferences):backCompatHeader.Mscrm.RibbonActions.isRecordHierarchyEnabled(selectedControl,selectedControlSelectedItemReferences)}}HierarchyLibraryLegacy.prototype.IsFormHierarchyEnabled=function(form){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isFormHierarchyEnabled():backCompatHeader.Mscrm.RibbonActions.isFormHierarchyEnabled()};HierarchyLibraryLegacy.prototype.IsNotHierarchyView=function(selectedControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isNotHierarchyView():backCompatHeader.Mscrm.RibbonActions.isNotHierarchyView()};return HierarchyLibraryLegacy}();Rules.HierarchyLibraryLegacy=HierarchyLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var HierarchyLibrary=function(){function HierarchyLibrary(){}HierarchyLibrary.setHierarchyLibrary=function(success,entityId){HierarchyLibrary.currentEntityId=entityId;HierarchyLibrary.isHierarchial=success};HierarchyLibrary.prototype.IsFormHierarchyEnabled=function(form){return this.isHierarchyEnabled(form.data.entity.getEntityName(),form.data.entity.getId())};HierarchyLibrary.prototype.IsNotHierarchyView=function(selectedControl){if(selectedControl&&selectedControl._controlName)return selectedControl._controlName.indexOf("MscrmControls.HierarchyControl.HierarchyControl")<0;return false};HierarchyLibrary.prototype.IsRecordHierarchyEnabled=function(selectedControl,selectedItemReferences){return this.isHierarchyEnabled(selectedItemReferences[0].TypeName,selectedItemReferences[0].Id)};HierarchyLibrary.prototype.isHierarchyEnabled=function(entity,entityId){if(entityId===HierarchyLibrary.promiseEntityId&&HierarchyLibrary.metadataRequestPromise)return HierarchyLibrary.metadataRequestPromise;try{if(entityId==HierarchyLibrary.currentEntityId)return Promise.resolve(HierarchyLibrary.isHierarchial);else{HierarchyLibrary.promiseEntityId=entityId;return HierarchyLibrary.metadataRequestPromise=Xrm.Utility.getEntityMetadata(entity).then(function(metadata){var entitySetName=metadata.EntitySetName,hierarchicalRelationships=metadata.OneToManyRelationships.get(function(relationship){return relationship.IsHierarchical&&relationship.ReferencedEntity===entity});if(hierarchicalRelationships&&hierarchicalRelationships.length>0)return XrmCore.InternalUtilities.HierarchyUtilities.checkifRecordHierarchyEnabled(entity,entityId,entitySetName,hierarchicalRelationships[0]).then(function(success){HierarchyLibrary.setHierarchyLibrary(success,entityId);HierarchyLibrary.promiseEntityId=null;HierarchyLibrary.metadataRequestPromise=null;return HierarchyLibrary.isHierarchial});else return false})}}catch(ex){return Promise.resolve(false)}};HierarchyLibrary.isHierarchial=false;HierarchyLibrary.currentEntityId="";return HierarchyLibrary}();Rules.HierarchyLibrary=HierarchyLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.Hierarchy=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.HierarchyLibrary:new Rules.HierarchyLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var OnlineLibraryLegacy=function(){function OnlineLibraryLegacy(){this.IsEntityAvailableForUserInMocaOffline=function(selectedEntityTypeName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.IsEntityAvailableForUserInMocaOffline(selectedEntityTypeName):backCompatHeader.Mscrm.CommandBarActions.IsEntityAvailableForUserInMocaOffline(selectedEntityTypeName)};this.IsCommandAvailableInMocaOffline=function(boolParam,selectedEntityTypeName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.IsCommandAvailableInMocaOffline(boolParam,selectedEntityTypeName):backCompatHeader.Mscrm.CommandBarActions.IsCommandAvailableInMocaOffline(boolParam,selectedEntityTypeName)}}return OnlineLibraryLegacy}();Rules.OnlineLibraryLegacy=OnlineLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var OnlineLibrary=function(){function OnlineLibrary(){this.IsCommandAvailableInMocaOffline=function(boolParam,selectedEntityTypeName){return true}}OnlineLibrary.prototype.IsEntityAvailableForUserInMocaOffline=function(selectedEntityTypeName){if(Xrm.Utility.getGlobalContext().client.getClientState()===Xrm.Constants.ClientStates.offline)return Xrm.Mobile.offline.isOfflineEnabled(selectedEntityTypeName);return true};OnlineLibrary.prototype.IsCustomActivityAvailableForUserInMocaOffline=function(commandProperties){if(Xrm.Utility.getGlobalContext().client.getClientState()===Xrm.Constants.ClientStates.offline){if(commandProperties!=null&&commandProperties["SourceControlId"]!=null){var buttonId=commandProperties["SourceControlId"];if(buttonId.toLowerCase().indexOf("mscrm.dynamicmenu.grid.newcustomactivity")>=0||buttonId.toLowerCase().indexOf("mscrm.dynamicmenu.form.addactivity")>=0||buttonId.toLowerCase().indexOf("mscrm.dynamicmenu.subgrid.newactivitymenu")>=0){var idParts=buttonId.split(".");return Xrm.Mobile.offline.isOfflineEnabled(idParts[idParts.length-1])}}return false}return true};OnlineLibrary.prototype.IsRelationshipEnabledInMocaOffline=function(gridControl){var subGridControl=gridControl;if(Xrm.Utility.getGlobalContext().client.getClientState()===Xrm.Constants.ClientStates.offline){var relationship=subGridControl&&subGridControl.getRelationship?subGridControl.getRelationship():null;if(relationship)return relationship.relationshipType===1?false:true}return true};return OnlineLibrary}();Rules.OnlineLibrary=OnlineLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.Online=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.OnlineLibrary:new Rules.OnlineLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var RefreshFormLibraryLegacy=function(){function RefreshFormLibraryLegacy(){this.isRefreshForm=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isRefreshForm():backCompatHeader.Mscrm.RibbonActions.isRefreshForm()}}return RefreshFormLibraryLegacy}();Rules.RefreshFormLibraryLegacy=RefreshFormLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var RefreshFormLibrary=function(){function RefreshFormLibrary(){this.isRefreshForm=function(){return true}}return RefreshFormLibrary}();Rules.RefreshFormLibrary=RefreshFormLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.RefreshForm=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.RefreshFormLibrary:new Rules.RefreshFormLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var RunReportLibraryLegacy=function(){function RunReportLibraryLegacy(){}RunReportLibraryLegacy.prototype.generateReportMenuXml=function(commandProperties,entityLogicalName,isForm,ribbonSelectionControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.generateReportMenuXml(commandProperties,entityLogicalName,isForm,ribbonSelectionControl):backCompatHeader.Mscrm.CommandBarActions.generateReportMenuXml(commandProperties,entityLogicalName,isForm,ribbonSelectionControl)};RunReportLibraryLegacy.prototype.runReport=function(commandProperties,gridControl,recordIds){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.runReport(commandProperties,gridControl,recordIds):backCompatHeader.Mscrm.GridRibbonActions.runReport(commandProperties,gridControl,recordIds)};RunReportLibraryLegacy.prototype.runReportFromFormRibbon=function(commandProperties,formControl,entityLogicalName){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.runReportFromFormRibbon(commandProperties,formControl):backCompatHeader.Mscrm.RibbonActions.runReportFromFormRibbon(commandProperties,formControl)};RunReportLibraryLegacy.prototype.viewReport=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.ReportActions?Mscrm.ReportActions.viewReport(gridControl,records):backCompatHeader.Mscrm.ReportActions.viewReport(gridControl,records)};RunReportLibraryLegacy.prototype.editReportFilter=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.ReportActions?Mscrm.ReportActions.editReportFilter(gridControl,records):backCompatHeader.Mscrm.ReportActions.editReportFilter(gridControl,records)};RunReportLibraryLegacy.prototype.editReport=function(gridControl,records,entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(true);Mscrm&&Mscrm.ReportActions?Mscrm.ReportActions.editReport(gridControl,records,entityTypeCode):backCompatHeader.Mscrm.ReportActions.editReport(gridControl,records,entityTypeCode)};return RunReportLibraryLegacy}();Commands.RunReportLibraryLegacy=RunReportLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){var RunReportLibrary=function(){function RunReportLibrary(){var _this=this;this.generateReportMenuXml=function(commandProperties,entityLogicalName,isForm,ribbonSelectionControl){var contextType=0,ribbonRelationshipType=-1,reportVisibilityCode=3;if(isForm){contextType=1;reportVisibilityCode=2}else if(ribbonSelectionControl.getGridType()===3){contextType=2;reportVisibilityCode=3;var relationship=ribbonSelectionControl.getRelationship();if(relationship!==null&&relationship.relationshipType===0)ribbonRelationshipType=0;else if(relationship!==null&&relationship.relationshipType===1)ribbonRelationshipType=1}var deferred=XrmCore.InternalUtilities.ReportsUtilites.retrieveReportsForEntity(entityLogicalName,reportVisibilityCode),menu=Promise.all([deferred]).then(function(_a){var reports=_a[0];Commands.logRetrieveReportsSuccess(entityLogicalName,reportVisibilityCode,ribbonRelationshipType);RunReportLibrary._reports=reports;return _this._buildMenu(commandProperties,reports,entityLogicalName,isForm,contextType,ribbonRelationshipType)},function(error){Commands.logRetrieveReportsFailure(error,entityLogicalName,null,reportVisibilityCode,ribbonRelationshipType)});commandProperties["PopulationXML"]=menu};this._buildMenu=function(commandProperties,reports,entityLogicalName,isForm,ribbonContextType,ribbonRelationshipType){var sourceControlId=commandProperties["SourceControlId"],menuId=sourceControlId+".Menu",menuSections=[],reportsCommandId=XrmCore.InternalUtilities.ReportsUtilites.determineReportsCommandId(entityLogicalName,isForm,ribbonContextType,ribbonRelationshipType),sectionIndex=0;if(reports&&reports.length>0){var reportsSections=XrmCore.InternalUtilities.ReportsUtilites.divideReportsIntoFilterableAndNon(reports);if(reportsSections["filterableReports"].length>0){var filterableReportsSection=XrmCore.InternalUtilities.ReportsUtilites.createMenuSection(menuId,reportsSections["filterableReports"],reportsCommandId,sectionIndex,true);menuSections.push(filterableReportsSection);sectionIndex=sectionIndex+1}if(reportsSections["nonFilterableReports"].length>0){var nonFilterableReportsSection=XrmCore.InternalUtilities.ReportsUtilites.createMenuSection(menuId,reportsSections["nonFilterableReports"],reportsCommandId,sectionIndex,false);menuSections.push(nonFilterableReportsSection)}}else{var noReportsSection=XrmCore.InternalUtilities.ReportsUtilites.createMenuSection(menuId,null,reportsCommandId,sectionIndex,false);menuSections.push(noReportsSection)}var menu=XrmCore.InternalUtilities.ReportsUtilites.buildMenu(menuId,menuSections);return menu};this.NewReport=function(entityTypeName,gridControl){var page="/crmreports/reportproperty.aspx",actionUri=Xrm.Utility.getGlobalContext().prependOrgName(page);Commands.logReportEvent(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DefaultGuidString,Xrm.Internal.getEntityCode(entityTypeName),null,"newreport");_this.openLegacyReportPropertyPage(actionUri,gridControl,"_blank")}}RunReportLibrary.prototype.runReportFromFormRibbon=function(commandProperties,formControl,entityCode){var reportId=XrmCore.InternalUtilities.ReportsUtilites.getReportIdFromSourceControlId(commandProperties["SourceControlId"]),reportEntity=RunReportLibrary._getReport(reportId);this.runFormsReport(reportEntity.Isfilterable,reportId,reportEntity.ReportTypeCode,reportEntity.Name,reportEntity.Filename,formControl.entityReference,entityCode)};RunReportLibrary.prototype.runFormsReport=function(filterable,reportId,reportType,reportName,reportFilename,entityReference,entityTypeCode){Commands.logReportEvent(reportId,entityTypeCode,reportType,"run_reportonentityform");if(filterable){var uri=XrmCore.InternalUtilities.ReportsUtilites.getCrmUri(XrmCore.InternalUtilities.ReportsUtilites.reportViewerBaseUri)+"?id="+reportId+"&action=run&context=records&recordstype="+entityTypeCode+"&records="+entityReference.id+"&helpID="+reportFilename;window.parent.open(uri,"_blank")}else this._openReportBasedOnType(reportId,"run",reportName,reportFilename,reportType,null)};RunReportLibrary.prototype.viewReport=function(gridControl,records){this._openReport(gridControl,records,"run")};RunReportLibrary.prototype.editReportFilter=function(gridControl,records){XrmCore.InternalUtilities.DialogUtilities.isAllowLegacyDialogsEmbedding()&&this._openReport(gridControl,records,"editfilter")};RunReportLibrary.prototype.openRecordItem=function(gridControl,records){XrmCore.InternalUtilities.DialogUtilities.isAllowLegacyDialogsEmbedding()&&this._openReport(gridControl,records,"filter")};RunReportLibrary.prototype._openReport=function(gridControl,records,reportWindowType){var _this=this,record;if(records.length===1){var reportRecord_1=records[0],gridEntity=gridControl.getGrid().getRows().get(reportRecord_1.Id).data.entity,reportEntity=gridEntity,reportName=reportEntity.attributes.get("name"),reportFileName=reportEntity.attributes.get("filename"),reportTypecode=reportEntity.attributes.get("reporttypecode");if(reportName&&reportTypecode&&reportFileName){var reportTypecodeValue=reportTypecode.getValue(),reportFileNameValue=reportFileName.getValue(),reportNameValue=reportName.getValue();Commands.logReportEvent(reportRecord_1.Id,Xrm.Internal.getEntityCode(reportRecord_1.TypeName),reportTypecodeValue,reportWindowType+"_onreportgrid");this._openReportBasedOnType(reportRecord_1.Id,reportWindowType,reportNameValue,reportFileNameValue,reportTypecodeValue,reportEntity)}else Xrm.WebApi.retrieveRecord("report",reportRecord_1.Id,"?$select=name,filename,reporttypecode,bodyurl,bodybinary,filesize,mimetype").then(function(reportEntityRecord){if(reportEntityRecord!=null){var reportNameValue=reportEntityRecord["name"]!=null?reportEntityRecord["name"].toString():null,reportFileNameValue=reportEntityRecord["filename"]!=null?reportEntityRecord["filename"].toString():null,reportTypecodeValue=reportEntityRecord["reporttypecode"]!=null?reportEntityRecord["reporttypecode"]:null;Commands.logReportEvent(reportRecord_1.Id,Xrm.Internal.getEntityCode(reportRecord_1.TypeName),reportTypecodeValue,reportWindowType+"_onreportgrid");_this._openReportBasedOnType(reportRecord_1.Id,reportWindowType,reportNameValue,reportFileNameValue,reportTypecodeValue,reportEntityRecord)}},function(error){Commands.logRetrieveReportsFailure(error,"report",reportRecord_1.Id,null,null)})}};RunReportLibrary.prototype._openReportBasedOnType=function(reportRecordId,reportWindowType,reportNameValue,reportFileNameValue,reportTypecodeValue,reportEntityRecord){var _this=this,reportURL=XrmCore.InternalUtilities.ReportsUtilites.getCrmUri("/crmreports/viewer/viewer.aspx?action="+reportWindowType+"&helpID="+reportFileNameValue+"&id=%7b"+reportRecordId+"%7d");switch(reportTypecodeValue){case 1:var globalContext=Xrm.Utility.getGlobalContext();globalContext.getCurrentAppProperties().then(function(appProperties){reportURL=reportURL.concat("&appid=",encodeURIComponent(appProperties["appId"]));window.parent.open(reportURL,"_blank");var recent={entityTypeName:"report",objectId:reportRecordId,pinStatus:false,recordType:"Entity",title:reportNameValue};Xrm.Internal.addRecentItem(recent)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog);break;case 2:if(reportWindowType==="editfilter")Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web.Reports.NonSRSReportFilterSchedule")});else if(reportEntityRecord)this._DownloadReport(reportEntityRecord);else Xrm.WebApi.retrieveRecord("report",reportRecordId,"?$select=filename,reporttypecode,bodyurl,bodybinary,filesize,mimetype").then(function(reportEntityRecord){reportEntityRecord!=null&&_this._DownloadReport(reportEntityRecord)},function(error){Commands.logRetrieveReportsFailure(error,"report",reportRecordId,null,null)});break;case 3:if(reportWindowType==="editfilter")Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web.Reports.NonSRSReportFilterSchedule")});else window.parent.open(reportURL,"_blank");break;case 4:Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Web.Reports.UnsupportedReportType")});break;default:break}};RunReportLibrary.prototype._DownloadReport=function(reportEntityRecord){if(reportEntityRecord){var file={fileContent:reportEntityRecord["bodybinary"]!=null?reportEntityRecord["bodybinary"].toString():null,fileName:reportEntityRecord["filename"]!=null?reportEntityRecord["filename"].toString():null,fileSize:reportEntityRecord["filesize"]!=null?reportEntityRecord["filesize"]:null,mimeType:reportEntityRecord["mimetype"]!=null?reportEntityRecord["mimetype"].toString():null},openMode={openMode:2};Xrm.Navigation.openFile(file,openMode)}};RunReportLibrary.prototype.runReport=function(commandProperties,gridControl,recordIds,entityCode){if(recordIds==null)recordIds=[];var reportId=XrmCore.InternalUtilities.ReportsUtilites.getReportIdFromSourceControlId(commandProperties["SourceControlId"]),reportEntity=RunReportLibrary._getReport(reportId),parameters={GridControl:gridControl,ReportEntity:reportEntity,RecordIds:recordIds,EntityTypeCode:entityCode};if(reportEntity.Isfilterable){Commands.logReportEvent(reportId,entityCode,parameters.ReportEntity.ReportTypeCode,"RunReportCommandButtonOnEntityGridInitiated");var numRecordsSelected=recordIds.length,enableView=XrmCore.InternalUtilities.ReportsUtilites.isEffectiveFetchXmlFinal(gridControl),dialogUrl=XrmCore.InternalUtilities.ReportsUtilites.getRunReportDialogUrl(reportId,numRecordsSelected,enableView),options={position:1,width:450,height:400},dialogArguments={uciCallback:this.performActionAfterRunReport,callbackParameters:parameters};Commands.Common.appendAppIdAndOpenLegacyWebDialog(dialogUrl,options,dialogArguments,null)}else this.performActionAfterRunReport(2,parameters)};RunReportLibrary.prototype.performActionAfterRunReport=function(runMode,parameters){var uri=XrmCore.InternalUtilities.ReportsUtilites.getCrmUri(XrmCore.InternalUtilities.ReportsUtilites.reportViewerBaseUri),fetchXml=parameters.GridControl.getFetchXml(),form;if(parameters.ReportEntity.Isfilterable){if(runMode==null)runMode=-1;Commands.logRunReportOnEntityGrid(parameters,runMode);if(runMode==-1)return;switch(runMode){case 0:var sb=[],recordIds=parameters.RecordIds;if(recordIds)for(var i=0;i<recordIds.length;i++){i>0&&sb.push(";");sb.push(recordIds[i])}form=XrmCore.InternalUtilities.ReportsUtilites.CreateViewReportForm(uri,parameters.ReportEntity.ReportId,parameters.ReportEntity.Filename,"records","recordstype="+parameters.EntityTypeCode);XrmCore.InternalUtilities.ReportsUtilites.addFormParameter(form,"records",sb.join(""));Commands.logReportEvent(parameters.ReportEntity.ReportId,parameters.EntityTypeCode,null,"run_filterablereport_onentitygrid_forselectedrecords: "+sb.join(","));break;case 1:form=XrmCore.InternalUtilities.ReportsUtilites.CreateViewReportForm(uri,parameters.ReportEntity.ReportId,parameters.ReportEntity.Filename,"fetch");XrmCore.InternalUtilities.ReportsUtilites.addFormParameter(form,"fetchxml",fetchXml);Commands.logReportEvent(parameters.ReportEntity.ReportId,parameters.EntityTypeCode,null,"run_filterablereport_onentitygrid_forfetchxml: "+fetchXml);break;case 2:default:var reportURL_1=XrmCore.InternalUtilities.ReportsUtilites.getCrmUri("/crmreports/viewer/viewer.aspx?action=run&helpID="+parameters.ReportEntity.Filename+"&id=%7b"+parameters.ReportEntity.ReportId+"%7d");Commands.logReportEvent(parameters.ReportEntity.ReportId,parameters.EntityTypeCode,null,"run_filterablereport_onentitygrid_forallrecords_BeforeOpen");var globalContext=Xrm.Utility.getGlobalContext();globalContext.getCurrentAppProperties().then(function(appProperties){reportURL_1=reportURL_1.concat("&appid=",encodeURIComponent(appProperties["appId"]));window.parent.open(reportURL_1,"_blank");Commands.logReportEvent(parameters.ReportEntity.ReportId,parameters.EntityTypeCode,null,"run_filterablereport_onentitygrid_forallrecords_AfterOpen");var recent={entityTypeName:"report",objectId:parameters.ReportEntity.ReportId,pinStatus:false,recordType:"Entity",title:parameters.ReportEntity.Name};Xrm.Internal.addRecentItem(recent)},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog);break}}else{var reportViewType=parameters.ReportEntity.ReportTypeCode;Commands.logReportEvent(parameters.ReportEntity.ReportId,parameters.EntityTypeCode,reportViewType,"run_nonfilterablereport_onentitygrid");this._openReportBasedOnType(parameters.ReportEntity.ReportId,"run",parameters.ReportEntity.Name,parameters.ReportEntity.Filename,reportViewType,null)}if(form){var globalContext=Xrm.Utility.getGlobalContext();globalContext.getCurrentAppProperties().then(function(appProperties){var reportURL=form["action"];reportURL=reportURL.concat("&appid=",encodeURIComponent(appProperties["appId"]));form.setAttribute("action",reportURL);form.setAttribute("target","_blank");form.submit()},XrmCore.InternalUtilities.DialogUtilities.createActionFailedErrorDialog)}};RunReportLibrary._getReport=function(reportID){for(var i=0;i<RunReportLibrary._reports.length;i++)if(RunReportLibrary._reports[i].ReportId===reportID)return RunReportLibrary._reports[i]};RunReportLibrary.prototype.editReport=function(gridControl,records,entityTypeCode){var record;if(records.length===1){var reportRecord=records[0],page="/crmreports/reportproperty.aspx",actionUri=Xrm.Utility.getGlobalContext().prependOrgName(page),parameterToEncode=(new String).concat("{",reportRecord.Id.toString(),"}");actionUri=actionUri.concat("?id=",encodeURIComponent(parameterToEncode));Commands.logReportEvent(reportRecord.Id.toString(),entityTypeCode,null,"editreport");this.openLegacyReportPropertyPage(actionUri,gridControl,reportRecord.Id.toString())}};RunReportLibrary.prototype.openLegacyReportPropertyPage=function(actionUri,gridControl,name){var options={position:1,width:window.parent.innerHeight,height:window.parent.innerWidth},reportwindow=window.open(actionUri,name,"width="+options.width+", height="+options.height+", resizable=1, align-item=center, justify-content=center");window.onmessage=function(e){gridControl.refresh()}};RunReportLibrary._reports=[];return RunReportLibrary}();Commands.RunReportLibrary=RunReportLibrary})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){Commands.RunReport=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Commands.RunReportLibrary:new Commands.RunReportLibraryLegacy})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var ReportsUtilites=function(){function ReportsUtilites(){}ReportsUtilites.buildControlsForRunReports=function(menuId,reports,commandId){var buttons=[],controlsPrefix=menuId+".Filtered.Controls",image="Report";if(reports&&reports.length>0)for(var i=0;i<reports.length;i++){var button={ControlType:"Button",Id:controlsPrefix+".{"+reports[i].ReportId+"}",Command:commandId,Sequence:String(i*10+10),ToolTipDescription:reports[i].Name,Alt:reports[i].Name,LabelText:reports[i].Name,ModernImage:image};buttons.push(button)}var controls={Id:controlsPrefix,Items:buttons};return controls};ReportsUtilites.GridViewReportId="gridViewReport";ReportsUtilites.reportViewerBaseUri="/crmreports/viewer/viewer.aspx";ReportsUtilites.retrieveReportsForEntity=function(entityTypeName,reportVisibilityCode){var entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName),fetchXml='<fetch mapping="logical">\n\t\t\t<entity name="report">\n\t\t\t<attribute name="name" /><attribute name="reporttypecode" /><attribute name="reportid" /><attribute name="filename" />\n\t\t\t<attribute name="bodyurl" />\n\t\t\t<order attribute="name" descending="false" />\n\t\t\t<filter type="and"><condition attribute="languagecode" operator="eq-userlanguage" /></filter>\n\t\t\t<link-entity alias="reportreportidreportentityreportid" name="reportentity" from="reportid" to="reportid">\n\t\t\t<attribute name="isfilterable" />\n\t\t\t<filter type="and"><condition attribute="objecttypecode" operator="eq" value="'+entityTypeCode+'"/></filter>\n\t\t\t</link-entity>\n\t\t\t<link-entity alias="reportreportidreportvisibilityreportid" name="reportvisibility" from="reportid" to="reportid">\n\t\t\t<filter type="and"><condition attribute="visibilitycode" operator="eq" value="'+reportVisibilityCode+'"/>\n\t\t\t</filter>\n\t\t\t</link-entity>\n\t\t\t</entity>\n\t\t\t</fetch>',deferred=Xrm.WebApi.online.retrieveMultipleRecords(InternalUtilities.EntityUtilities.EntityNames.Report,"?fetchXml="+fetchXml).then(function(response){for(var reports=[],templates=response.entities,i=0;i<templates.length;i++){var curT={ReportId:templates[i].reportid,Name:templates[i].name,Filename:templates[i].filename,Bodyurl:templates[i].bodyurl,ReportTypeCode:templates[i].reporttypecode,Isfilterable:templates[i]["reportreportidreportentityreportid.isfilterable"]};reports.push(curT)}return reports},function(e){console.error(e)});return deferred};ReportsUtilites.createMenuSection=function(menuId,reports,reportsCommandId,sectionIndex,filterableSection){var filterableReportsControl=ReportsUtilites.buildControlsForRunReports(menuId,reports,reportsCommandId);return InternalUtilities.ReportsUtilites.buildMenuSection(menuId,filterableSection,sectionIndex*10+10,filterableReportsControl)};ReportsUtilites.buildMenuSection=function(menuId,filterable,sequenceNum,controls){var runOnCurrentRecordLabel=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_ParameterizedReportsForm"),sectionStr="",titleStr="";if(controls&&controls.Items&&controls.Items.length>0)if(filterable){titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_ParameterizedReports");sectionStr="filterable"}else{titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_GlobalReports");sectionStr="nonFilterable"}else{titleStr=Xrm.Utility.getResourceString("Main_system_library","Ribbon.ReportMenu.NoReportsAvailable");sectionStr="noReports"}var section={Id:menuId+"."+sectionStr,Sequence:String(sequenceNum),DisplayMode:6,Title:titleStr,Item:controls};return section};ReportsUtilites.buildMenu=function(menuId,menuSections){var menu={Id:menuId,MenuSection:menuSections};return menu};ReportsUtilites.determineReportsCommandId=function(entityLogicalName,isForm,ribbonContextType,ribbonRelationshipType){var relType="NoRelationship";if(ribbonRelationshipType===0)relType="OneToMany";else if(ribbonRelationshipType===1)relType="ManyToMany";var ribbonContext="SubGridAssociated";if(isForm)ribbonContext="Form";else if(ribbonContextType==0)ribbonContext="HomePageGrid";var docStr="ReportsMenu",opStr="RunReport",contextStr=isForm?"Form":"Grid",cmdStr=entityLogicalName+"|"+relType+"|"+ribbonContext+"|Mscrm."+docStr+"."+opStr+"."+contextStr;return cmdStr};ReportsUtilites.getReportIdFromSourceControlId=function(sourceControlId){return sourceControlId.substring(sourceControlId.length-37).slice(0,-1)};ReportsUtilites.getCrmUri=function(path){if(Xrm.Utility.getGlobalContext().isOnPremises&&Xrm.Utility.getGlobalContext().getOrgUniqueName)return Xrm.Utility.getGlobalContext().prependOrgName(path)};ReportsUtilites.CreateViewReportForm=function(uri,reportId,fileName,context,contextQuery){var form=document.getElementsByName(ReportsUtilites.GridViewReportId)[0];if(form)form=ReportsUtilites._clearFormParameters(form);else{form=document.createElement("form");form.setAttribute("name",ReportsUtilites.GridViewReportId);form.setAttribute("method","post");form.setAttribute("style","display: none");form=document.body.appendChild(form)}uri=uri+("?action=run&id="+reportId+"&helpID="+fileName);if(context!=null)uri=uri+("&context="+context);if(contextQuery!=null)uri=uri+("&"+contextQuery);form.setAttribute("action",uri);return form};ReportsUtilites.addFormParameter=function(form,paramName,paramValue){var inputElement=document.createElement("input");inputElement.value=paramValue;inputElement.name=paramName;form.appendChild(inputElement);return form};ReportsUtilites.isEffectiveFetchXmlFinal=function(gridControl){return true};ReportsUtilites.getRunReportDialogUrl=function(reportId,numRecordsSelected,enableView){var view=enableView?1:0;return ReportsUtilites.getCrmUri("/_grid/cmds/dlg_runreport.aspx?id="+reportId+"&numselected="+numRecordsSelected+"&enableview="+view)};ReportsUtilites.divideReportsIntoFilterableAndNon=function(reports){for(var filterableReports=[],nonFilterableReports=[],i=0;i<reports.length;i++)if(reports[i].Isfilterable)filterableReports.push(reports[i]);else nonFilterableReports.push(reports[i]);return {filterableReports:filterableReports,nonFilterableReports:nonFilterableReports}};ReportsUtilites._clearFormParameters=function(form){if(form&&form.children)for(var i=form.children.length-1;i>=0;i--)form.removeChild(form.children[i]);return form};return ReportsUtilites}();InternalUtilities.ReportsUtilites=ReportsUtilites})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Commands;(function(Commands){function _getEventParam(eventName,eventValue){var eventParam={name:eventName,value:eventValue};return eventParam}function _reportingAvailable(){if(Xrm!=null&&Xrm.Reporting!=null)return true;return false}function logRetrieveReportsSuccess(entityLogicalName,reportVisibilityCode,ribbonRelationshipType){if(_reportingAvailable()){var eventParams=[];eventParams.push(_getEventParam("entityLogicalName",entityLogicalName));eventParams.push(_getEventParam("reportVisibilityCode",reportVisibilityCode.toString()));eventParams.push(_getEventParam("ribbonRelationshipType",ribbonRelationshipType.toString()));Xrm.Reporting.reportSuccess("RetrieveReports",eventParams)}}Commands.logRetrieveReportsSuccess=logRetrieveReportsSuccess;function logRetrieveReportsFailure(error,entityLogicalName,reportId,reportVisibilityCode,ribbonRelationshipType){var errorMessage;if(error.message&&error.message!=null&&error.message!="")errorMessage=error.message;else if(error.innerror&&error.innerror.message&&error.innerror.message!=null&&error.innerror.message!="")errorMessage=error.innerror.message;else errorMessage="Retrieve Reports Failed with unknown error";if(_reportingAvailable()){var errorParam={name:"ErrorResponse",message:errorMessage},eventParams=[];entityLogicalName?eventParams.push(_getEventParam("entityLogicalName",entityLogicalName)):null;reportVisibilityCode?eventParams.push(_getEventParam("reportVisibilityCode",reportVisibilityCode.toString())):null;ribbonRelationshipType?eventParams.push(_getEventParam("ribbonRelationshipType",ribbonRelationshipType.toString())):null;reportId?eventParams.push(_getEventParam("reportId",reportId)):null;Xrm.Reporting.reportFailure("RetrieveReports",errorParam,"",eventParams)}}Commands.logRetrieveReportsFailure=logRetrieveReportsFailure;function logRunReportOnEntityGrid(parameters,runMode){parameters&&parameters.ReportEntity&&_logReportEvent(parameters.ReportEntity.ReportId,parameters.EntityTypeCode,null,runMode,"run_reportonentitygrid")}Commands.logRunReportOnEntityGrid=logRunReportOnEntityGrid;function logReportEvent(reportId,entityTypeCode,reportTypecodeValue,eventDetail){_logReportEvent(reportId,entityTypeCode,reportTypecodeValue,null,eventDetail)}Commands.logReportEvent=logReportEvent;function _logReportEvent(reportId,entityTypeCode,reportTypecodeValue,runMode,eventDetail){if(_reportingAvailable()){var eventParams=[];entityTypeCode?eventParams.push(_getEventParam("EntityTypeCode",entityTypeCode.toString())):null;reportTypecodeValue?eventParams.push(_getEventParam("ReportTypecodeValue",reportTypecodeValue.toString())):null;runMode?eventParams.push(_getEventParam("RunMode",runMode.toString())):null;eventDetail?eventParams.push(_getEventParam("EventDetail",eventDetail)):null;var applicationEvent={eventName:"ucissrsreports",eventParameters:eventParams};if(reportId){eventParams.push(_getEventParam("ReportId",reportId));Xrm.Reporting.reportEvent(applicationEvent)}else{var errorParam={name:"ErrorResponse",message:"ReportId is null"};Xrm.Reporting.reportFailure("RetrieveReports",errorParam,"",eventParams)}}}})(Commands=XrmCore.Commands||(XrmCore.Commands={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var SaveAsLibraryLegacy=function(){function SaveAsLibraryLegacy(){var _this=this;this.isBulkSaveAsCancelledValid=function(entityTypeName){return _this.isBulkSaveAsCancelledValidLegacy(Xrm.Internal.getEntityCode(entityTypeName))};this.isBulkSaveAsCompletedValid=function(entityTypeName){return _this.isBulkSaveAsCompletedValidLegacy(Xrm.Internal.getEntityCode(entityTypeName))};this.canMarkComplete=function(records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.canMarkComplete(records):backCompatHeader.Mscrm.GridRibbonActions.canMarkComplete(records)};this.isBulkSaveAsCancelledValidLegacy=function(entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.isBulkSaveAsCancelledValid(entityTypeCode):backCompatHeader.Mscrm.GridRibbonActions.isBulkSaveAsCancelledValid(entityTypeCode)};this.isBulkSaveAsCompletedValidLegacy=function(entityTypeCode){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.isBulkSaveAsCompletedValid(entityTypeCode):backCompatHeader.Mscrm.GridRibbonActions.isBulkSaveAsCompletedValid(entityTypeCode)}}return SaveAsLibraryLegacy}();Rules.SaveAsLibraryLegacy=SaveAsLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var SaveAsLibrary=function(){function SaveAsLibrary(){var _this=this;this.isBulkSaveAsCancelledValid=function(entityTypeName){if(XrmCore.InternalUtilities.DialogUtilities.isMobileCompanionApp())return true;if(Xrm.Utility.isActivityType(entityTypeName)||entityTypeName===Xrm.Constants.EntityNames.ActivityPointer)return !(entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster||entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email);else return false};this.isBulkSaveAsCompletedValid=function(entityTypeName){if(XrmCore.InternalUtilities.DialogUtilities.isMobileCompanionApp())return true;if(Xrm.Utility.isActivityType(entityTypeName)||entityTypeName===Xrm.Constants.EntityNames.ActivityPointer)return !(entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster||entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity||entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse||entityTypeName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email);else return false};this.canMarkComplete=function(records){for(var i=0;i<records.length;i++){var typeName=records[i].TypeName;if(typeName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.Email&&typeName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity&&typeName!==XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignResponse)return true}return false};this.isBulkSaveAsCancelledValidLegacy=function(entityTypeCode){var entityName=Xrm.Internal.getEntityName(entityTypeCode);return _this.isBulkSaveAsCancelledValid(entityName)};this.isBulkSaveAsCompletedValidLegacy=function(entityTypeCode){var entityName=Xrm.Internal.getEntityName(entityTypeCode);return _this.isBulkSaveAsCompletedValid(entityName)}}return SaveAsLibrary}();Rules.SaveAsLibrary=SaveAsLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.SaveAs=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.SaveAsLibrary:new Rules.SaveAsLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var SetRegardingLibraryLegacy=function(){function SetRegardingLibraryLegacy(){}SetRegardingLibraryLegacy.prototype.isBulkSetRegardingValid=function(entityTypeName,records){var entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName),backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.GridCommandActions?Mscrm.GridCommandActions.isBulkSetRegardingValid(entityTypeCode,records):backCompatHeader.Mscrm.GridCommandActions.isBulkSetRegardingValid(entityTypeCode,records)};SetRegardingLibraryLegacy.prototype.disableForSocialActivityView=function(gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.GridRibbonActions?Mscrm.GridRibbonActions.disableForSocialActivityView(gridControl):backCompatHeader.Mscrm.GridRibbonActions.disableForSocialActivityView(gridControl)};return SetRegardingLibraryLegacy}();Rules.SetRegardingLibraryLegacy=SetRegardingLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var SetRegardingLibrary=function(){function SetRegardingLibrary(){}SetRegardingLibrary.prototype.isBulkSetRegardingValid=function(entityName,records){if(Xrm.Utility.isActivityType(entityName)||entityName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer)switch(entityName){case XrmCore.InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:for(var key in records){var record=records[key];if(record.logicalName===XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity)return false}return true;case XrmCore.InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster:case XrmCore.InternalUtilities.EntityUtilities.EntityNames.CampaignActivity:return false;default:return true}return false};SetRegardingLibrary.prototype.disableForSocialActivityView=function(gridControl){if(gridControl&&gridControl.getViewSelector&&gridControl.getViewSelector()&&gridControl.getViewSelector().getCurrentView&&gridControl.getViewSelector().getCurrentView())return ["{E3CA8AD6-C682-4383-B54E-82641EF83206}","{DB576E56-6591-402D-848B-D6F9D626DAA3}","{AE2B791C-8210-49D3-BA16-3110AF6864A4}","{3354F296-99AF-45EF-8223-88ED59A7F478}","{C26EF3A5-0D49-42D3-ABD9-0D75E5F849E3}","{9E28442C-413E-4E5B-B3ED-1DCFFE9F43A9}","{CE7337DF-90B4-4940-8751-0C7BF8CD50EB}","{436918CB-693E-43F1-AE90-48AE3FA21C61}","{DF8137B5-B580-4806-8A26-385B83CFB5BF}"].indexOf(gridControl.getViewSelector().getCurrentView().id)!==-1;return false};return SetRegardingLibrary}();Rules.SetRegardingLibrary=SetRegardingLibrary})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.SetRegarding=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.SetRegardingLibrary:new Rules.SetRegardingLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.SharePointFCBLegacy="FCB.SharePointS2S";var SharePointDocumentLibraryLegacy=function(){function SharePointDocumentLibraryLegacy(){}SharePointDocumentLibraryLegacy.prototype.areSelectedLocationsSame=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.areSelectedLocationsSame(gridControl,records):backCompatHeader.Mscrm.GridCommandActions.areSelectedLocationsSame(gridControl,records)};SharePointDocumentLibraryLegacy.prototype.isDocumentNotFromSharedLocation=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isDocumentNotFromSharedLocation(gridControl,records):backCompatHeader.Mscrm.GridCommandActions.isDocumentNotFromSharedLocation(gridControl,records)};SharePointDocumentLibraryLegacy.prototype.isSharePointSiteConfigured=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isSharePointSiteConfigured():backCompatHeader.Mscrm.GridCommandActions.isSharePointSiteConfigured()};SharePointDocumentLibraryLegacy.prototype.isRecordHasActiveSharePointDocLocation=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isRecordHasActiveSharePointDocLocation():backCompatHeader.Mscrm.GridCommandActions.disableButtonsWhenChartMaximized()};SharePointDocumentLibraryLegacy.prototype.isRecordHasActiveOrRenamedSharePointDocLocation=function(){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isRecordHasActiveOrRenamedSharePointDocLocation():backCompatHeader.Mscrm.GridCommandActions.isRecordHasActiveOrRenamedSharePointDocLocation()};SharePointDocumentLibraryLegacy.prototype.isDocumentRecommendationsEnabledForEntity=function(gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.CommandBarActions?Mscrm.CommandBarActions.isDocumentRecommendationsEnabledForEntity(gridControl):backCompatHeader.Mscrm.CommandBarActions.isDocumentRecommendationsEnabledForEntity(gridControl)};SharePointDocumentLibraryLegacy.prototype.isFolderNotSelected=function(gridControl,records){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.CommandBarActions?Mscrm.RibbonActions.isFolderNotSelected(gridControl,records):backCompatHeader.Mscrm.CommandBarActions.isFolderNotSelected(gridControl,records)};SharePointDocumentLibraryLegacy.prototype.isDocumentAssociatedGridViewSelected=function(gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.CommandBarActions?Mscrm.RibbonActions.isDocumentAssociatedGridViewSelected(gridControl):backCompatHeader.Mscrm.CommandBarActions.isDocumentAssociatedGridViewSelected(gridControl)};SharePointDocumentLibraryLegacy.prototype.isSharePointDocLocationNotSharedOrAllFiles=function(gridControl){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.RibbonActions?Mscrm.RibbonActions.isSharePointDocLocationNotSharedOrAllFiles():backCompatHeader.Mscrm.GridCommandActions.isSharePointDocLocationNotSharedOrAllFiles()};SharePointDocumentLibraryLegacy.prototype.hideCommand=function(){return false};SharePointDocumentLibraryLegacy.prototype.isSharePointEnabled=function(){return Xrm.Internal.isFeatureEnabled(Rules.SharePointFCBLegacy)};return SharePointDocumentLibraryLegacy}();Rules.SharePointDocumentLibraryLegacy=SharePointDocumentLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.LOCATION_ID="locationid";Rules.SHARED_LOCATION_GUID="17DE0DBB-153C-4C1A-B98A-223B3EA10125";Rules.SharePointFCB="SharePointS2S";var SharePointDocumentLibrary=function(){function SharePointDocumentLibrary(){}SharePointDocumentLibrary.prototype.areSelectedLocationsSame=function(gridControl,records){return true};SharePointDocumentLibrary.prototype.isDocumentNotFromSharedLocation=function(gridControl,records){var isDocNotFromSharedLoc=false,getLocationIdFromGridCtrl=GridControlUtil.GetParameterFromGridControl(gridControl,Rules.LOCATION_ID).toUpperCase();if(getLocationIdFromGridCtrl!=Rules.SHARED_LOCATION_GUID)return isDocNotFromSharedLoc=true;return isDocNotFromSharedLoc};SharePointDocumentLibrary.prototype.isSharePointSiteConfigured=function(){return true};SharePointDocumentLibrary.prototype.isRecordHasActiveSharePointDocLocation=function(){return true};SharePointDocumentLibrary.prototype.isRecordHasActiveOrRenamedSharePointDocLocation=function(){return true};SharePointDocumentLibrary.prototype.isDocumentRecommendationsEnabledForEntity=function(gridControl){return false};SharePointDocumentLibrary.prototype.isFolderNotSelected=function(gridControl,records){var returnValue=false;if(gridControl&&records){returnValue=true;var selectedRecords=gridControl.getGrid().getSelectedRows();selectedRecords&&selectedRecords.forEach(function(row){if(row&&row.data&&row.data.entity){var fileType=row.data.entity.attributes.get("filetype").getValue();if(fileType=="folder"||fileType=="onetoc2")returnValue=false}})}return returnValue};SharePointDocumentLibrary.prototype.isDocumentAssociatedGridViewSelected=function(gridControl){var isViewSelected=false,viewId="{0016f9f3-41cc-4276-9d11-04308d15858d}";if(gridControl){var viewSelector=gridControl.getViewSelector(),currentView=viewSelector.getCurrentView();isViewSelected=currentView!=null&&currentView.id!=null&&currentView.id.toString().toUpperCase()==viewId.toUpperCase()?true:false}return isViewSelected};SharePointDocumentLibrary.prototype.isSharePointDocLocationNotSharedOrAllFiles=function(gridControl){var isDocNotFromSharedLoc=false,getLocationIdFromGridCtrl=GridControlUtil.GetParameterFromGridControl(gridControl,Rules.LOCATION_ID).toUpperCase();if(getLocationIdFromGridCtrl!=Rules.SHARED_LOCATION_GUID)return isDocNotFromSharedLoc=true;return isDocNotFromSharedLoc};SharePointDocumentLibrary.prototype.hideCommand=function(){return false};SharePointDocumentLibrary.prototype.isSharePointEnabled=function(){return Xrm.Internal.isFeatureEnabled(Rules.SharePointFCB)};return SharePointDocumentLibrary}();Rules.SharePointDocumentLibrary=SharePointDocumentLibrary;var GridControlUtil=function(){function GridControlUtil(){}GridControlUtil.GetParameterFromGridControl=function(gridControl,id){var customFilterXml=gridControl.getFilterXml();return customFilterXml?GridControlUtil.GetParameterFromFetchXml(customFilterXml,id.toLowerCase()):""};GridControlUtil.GetParameterFromFetchXml=function(fetchXml,parameterName){var domParser=new DOMParser,fetchXmlDocument=domParser.parseFromString(fetchXml,"text/xml");if(fetchXmlDocument){var filterElements=fetchXmlDocument.getElementsByTagName("filter");if(filterElements&&filterElements.length>0)for(var index=0;index<filterElements.length;index++)for(var filterElement=filterElements[index],filterElementIndex=0;filterElementIndex<filterElement.childNodes.length;filterElementIndex++){var currentElement=filterElement.childNodes.item(filterElementIndex);if(currentElement.nodeName==="condition"){var attributeName=GridControlUtil.getNodeAttributeValueFromName(currentElement,"attribute");if(attributeName===parameterName)return GridControlUtil.getNodeAttributeValueFromName(currentElement,"value")}}}return ""};GridControlUtil.getNodeAttributeValueFromName=function(inputNode,attribuetName){if(!inputNode)return null;var nodeAttributeMap=inputNode.attributes.getNamedItem(attribuetName);return nodeAttributeMap?nodeAttributeMap.value:null};return GridControlUtil}();Rules.GridControlUtil=GridControlUtil})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.SharePointDocument=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.SharePointDocumentLibrary:new Rules.SharePointDocumentLibraryLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var SystemUserRules=function(){function SystemUserRules(){}SystemUserRules.prototype.isCurrentUser=function(userId){var globalContext=Xrm.Utility.getGlobalContext(),currentUserId=globalContext?globalContext.userSettings.userId.toLowerCase().replace("{","").replace("}",""):null;if(userId!==null&&userId!==undefined&&currentUserId){userId=userId.toLowerCase().replace("{","").replace("}","");return userId===currentUserId}return false};return SystemUserRules}();Rules.SystemUserRules=SystemUserRules})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){var SystemUserRulesLegacy=function(){function SystemUserRulesLegacy(){}SystemUserRulesLegacy.prototype.isCurrentUser=function(userId){var backCompatHeader=XrmCore.InternalUtilities.LegacyUtilities.getIFrameForWebClient(false);return Mscrm&&Mscrm.SystemUserActions?Mscrm.SystemUserActions.isCurrentUser(userId):backCompatHeader.Mscrm.SystemUserActions.isCurrentUser(userId)};return SystemUserRulesLegacy}();Rules.SystemUserRulesLegacy=SystemUserRulesLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var Rules;(function(Rules){Rules.SystemUser=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Rules.SystemUserRules:new Rules.SystemUserRulesLegacy})(Rules=XrmCore.Rules||(XrmCore.Rules={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var AssignRequest=function(){function AssignRequest(){}AssignRequest.prototype.getMetadata=function(){var metadata={boundParameter:null,operationName:"Assign",operationType:0,parameterTypes:{Target:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},Assignee:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5}}};return metadata};return AssignRequest}();SdkContracts.AssignRequest=AssignRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var DeleteRequest=function(){function DeleteRequest(entityReference){this.entityReference=entityReference}DeleteRequest.prototype.getMetadata=function(){var metadata={boundParameter:undefined,parameterTypes:{entityReference:{typeName:"mscrm.crmbaseentity",structuralProperty:5}},operationName:"Delete",operationType:2};return metadata};return DeleteRequest}();SdkContracts.DeleteRequest=DeleteRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var Object=function(){function Object(){}Object.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{},operationName:null,operationType:null};return metadata};return Object}();SdkContracts.Object=Object})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var InputArgumentCollection=function(){function InputArgumentCollection(args){this.Arguments=args}InputArgumentCollection.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{Arguments:{typeName:"Microsoft.Dynamics.CRM.InputArgument",structuralProperty:2}},operationName:null,operationType:null};return metadata};return InputArgumentCollection}();SdkContracts.InputArgumentCollection=InputArgumentCollection})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var InputArgument=function(){function InputArgument(count,isReadOnly,keys,values){this.Count=count;this.IsReadOnly=isReadOnly;this.Keys=keys;this.Values=values}InputArgument.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{Count:{typeName:"Edm.Int32",structuralProperty:1},IsReadOnly:{typeName:"Edm.Boolean",structuralProperty:1},Keys:{typeName:"Edm.String",structuralProperty:4},Values:{typeName:"mscrm.Object",structuralProperty:4}},operationName:null,operationType:null};return metadata};return InputArgument}();SdkContracts.InputArgument=InputArgument})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var ExportToExcelRequest=function(){function ExportToExcelRequest(view,fetchXml,layoutXml,queryApi,queryParameters){this.View=view;this.FetchXml=fetchXml;this.LayoutXml=layoutXml;this.QueryApi=queryApi;this.QueryParameters=queryParameters}ExportToExcelRequest.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{View:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},FetchXml:{typeName:"Edm.String",structuralProperty:1},LayoutXml:{typeName:"Edm.String",structuralProperty:1},QueryApi:{typeName:"Edm.String",structuralProperty:1},QueryParameters:{typeName:"Microsoft.Dynamics.CRM.InputArgumentCollection",structuralProperty:2}},operationName:"ExportToExcel",operationType:0};return metadata};return ExportToExcelRequest}();SdkContracts.ExportToExcelRequest=ExportToExcelRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var ExportWordDocumentRequest=function(){function ExportWordDocumentRequest(entityTypeCode,selectedTemplate,selectedRecords){this.EntityTypeCode=entityTypeCode;this.SelectedTemplate=selectedTemplate;this.SelectedRecords=selectedRecords}ExportWordDocumentRequest.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{EntityTypeCode:{typeName:"Edm.Int32",structuralProperty:1},SelectedTemplate:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},SelectedRecords:{typeName:"Edm.String",structuralProperty:1}},operationName:"ExportWordDocument",operationType:0};return metadata};return ExportWordDocumentRequest}();SdkContracts.ExportWordDocumentRequest=ExportWordDocumentRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var RenderTemplateRequest=function(){function RenderTemplateRequest(template,fetchXml,queryApi,queryParameters){this.Template=template;this.FetchXml=fetchXml;this.QueryApi=queryApi;this.QueryParameters=queryParameters}RenderTemplateRequest.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{Template:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},FetchXml:{typeName:"Edm.String",structuralProperty:1},QueryApi:{typeName:"Edm.String",structuralProperty:1},QueryParameters:{typeName:"Microsoft.Dynamics.CRM.InputArgumentCollection",structuralProperty:2}},operationName:"RenderTemplate",operationType:0};return metadata};return RenderTemplateRequest}();SdkContracts.RenderTemplateRequest=RenderTemplateRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var RenderTemplateFromViewRequest=function(){function RenderTemplateFromViewRequest(template,view){this.Template=template;this.View=view}RenderTemplateFromViewRequest.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{Template:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},View:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5}},operationName:"RenderTemplateFromView",operationType:0};return metadata};return RenderTemplateFromViewRequest}();SdkContracts.RenderTemplateFromViewRequest=RenderTemplateFromViewRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var RetrieveActiveStageRecordRequest=function(){function RetrieveActiveStageRecordRequest(bpfEntityReference){this.BpfEntityReference=bpfEntityReference}RetrieveActiveStageRecordRequest.prototype.getMetadata=function(){var metadata={boundParameter:null,parameterTypes:{BpfEntityReference:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5}},operationName:"RetrieveActiveStageRecord",operationType:1};return metadata};return RetrieveActiveStageRecordRequest}();SdkContracts.RetrieveActiveStageRecordRequest=RetrieveActiveStageRecordRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var SetRegardingRequest=function(){function SetRegardingRequest(record,regardingObjectTypeName,regardingObjectId,entitySetName){this.id=record.Id.replace("{","").replace("}","");this.etn=record.TypeName;var payloadKey="regardingobjectid_"+regardingObjectTypeName+"_"+record.TypeName+"@odata.bind";this.payload={};this.payload[payloadKey]="/"+entitySetName+"("+regardingObjectId.replace("{","").replace("}","")+")"}SetRegardingRequest.prototype.getMetadata=function(){var metadata={boundParameter:undefined,parameterTypes:{},operationName:"Update",operationType:2};return metadata};return SetRegardingRequest}();SdkContracts.SetRegardingRequest=SetRegardingRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var SetStateRequest=function(){function SetStateRequest(id,etn,statecode,statuscode){this.id=id.replace("{","").replace("}","");this.etn=etn;this.payload={statecode:statecode,statuscode:statuscode}}SetStateRequest.prototype.getMetadata=function(){var metadata={boundParameter:undefined,parameterTypes:{},operationName:"Update",operationType:2};return metadata};return SetStateRequest}();SdkContracts.SetStateRequest=SetStateRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var RemoveUserFromRecordTeamRequest=function(){function RemoveUserFromRecordTeamRequest(entity,record,teamTemplate){this.entity=entity;this.Record=record;this.TeamTemplate=teamTemplate}RemoveUserFromRecordTeamRequest.prototype.getMetadata=function(){var metadata={boundParameter:"entity",parameterTypes:{entity:{typeName:"Microsoft.Dynamics.CRM.systemuser",structuralProperty:5},Record:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},TeamTemplate:{typeName:"Microsoft.Dynamics.CRM.teamtemplate",structuralProperty:5}},operationName:"RemoveUserFromRecordTeam",operationType:0};return metadata};return RemoveUserFromRecordTeamRequest}();SdkContracts.RemoveUserFromRecordTeamRequest=RemoveUserFromRecordTeamRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var AddUserToRecordTeamRequest=function(){function AddUserToRecordTeamRequest(entity,record,teamTemplate){this.entity=entity;this.Record=record;this.TeamTemplate=teamTemplate}AddUserToRecordTeamRequest.prototype.getMetadata=function(){var metadata={boundParameter:"entity",parameterTypes:{entity:{typeName:"Microsoft.Dynamics.CRM.systemuser",structuralProperty:5},Record:{typeName:"Microsoft.Dynamics.CRM.crmbaseentity",structuralProperty:5},TeamTemplate:{typeName:"Microsoft.Dynamics.CRM.teamtemplate",structuralProperty:5}},operationName:"AddUserToRecordTeam",operationType:0};return metadata};return AddUserToRecordTeamRequest}();SdkContracts.AddUserToRecordTeamRequest=AddUserToRecordTeamRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var ActivityUtilities=function(){function ActivityUtilities(){}ActivityUtilities.isActivityTypeCode=function(entityName){switch(entityName){case InternalUtilities.EntityUtilities.EntityNames.Task:case InternalUtilities.EntityUtilities.EntityNames.Letter:case InternalUtilities.EntityUtilities.EntityNames.PhoneCall:case InternalUtilities.EntityUtilities.EntityNames.ServiceAppointment:case InternalUtilities.EntityUtilities.EntityNames.UntrackedEmail:case InternalUtilities.EntityUtilities.EntityNames.Fax:case InternalUtilities.EntityUtilities.EntityNames.QuoteClose:case InternalUtilities.EntityUtilities.EntityNames.OrderClose:case InternalUtilities.EntityUtilities.EntityNames.IncidentResolution:case InternalUtilities.EntityUtilities.EntityNames.OpportunityClose:case InternalUtilities.EntityUtilities.EntityNames.SocialActivity:case InternalUtilities.EntityUtilities.EntityNames.CampaignActivity:case InternalUtilities.EntityUtilities.EntityNames.Appointment:case InternalUtilities.EntityUtilities.EntityNames.BulkOperation:case InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster:case InternalUtilities.EntityUtilities.EntityNames.CampaignResponse:case InternalUtilities.EntityUtilities.EntityNames.Email:case InternalUtilities.EntityUtilities.EntityNames.ActivityPointer:return true;default:return false}};return ActivityUtilities}();InternalUtilities.ActivityUtilities=ActivityUtilities})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var DialogUtilities=function(){function DialogUtilities(){}DialogUtilities.closeDialog=function(eventContext){var formContext=eventContext.getFormContext();this.setLastButtonClicked(eventContext,DialogUtilities.DialogConstants.DialogCancelId);formContext.ui.close()};DialogUtilities.setLastButtonClicked=function(eventContext,buttonId){var formContext=eventContext.getFormContext(),lastButtonClicked=formContext.data.attributes.get("last_button_clicked");lastButtonClicked&&lastButtonClicked.setValue(buttonId)};DialogUtilities.isMobileCompanionApp=function(){return Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.mobile};DialogUtilities.isOutlook=function(){return Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.outlook};DialogUtilities.isMailApp=function(){var contexts=Xrm&&Xrm.ExternalContext?Xrm.ExternalContext.getAvailableExternalContexts():null;if(contexts&&contexts.get("MAIL_CONTEXT"))return true;return false};DialogUtilities.isOffline=function(){return DialogUtilities.isMobileCompanionApp()&&Xrm.Utility.getGlobalContext().client.getClientState()===Xrm.Constants.ClientStates.offline};DialogUtilities.showOfflineError=function(){var alert={text:InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Generic_Mobile_Client_Offline")};Xrm.Navigation.openAlertDialog(alert)};DialogUtilities.getSdkEntityReference=function(records){var referenceList=[];records.forEach(function(record){referenceList.push(record)});return referenceList};DialogUtilities.serializeSdkEntityReferences=function(records){return JSON.stringify(records)};DialogUtilities.deserializeSdkEntityReferences=function(stringifiedRecords){if(!stringifiedRecords)return [];return DialogUtilities.getSdkEntityReference(JSON.parse(stringifiedRecords))};DialogUtilities.createActionFailedErrorDialog=function(errorResponse){Xrm.Utility.closeProgressIndicator();var errorDialogOptions={message:errorResponse.message,errorCode:errorResponse.errorCode};Xrm.Navigation.openErrorDialog(errorDialogOptions)};DialogUtilities.onGridActionMultipleSuccess=function(gridControl,successResponses){if(successResponses.every(function(response){return response.ok}))gridControl&&gridControl.refresh();else InternalUtilities.DialogUtilities.openAlertDialogForMultipleErrors(gridControl)};DialogUtilities.isAllowLegacyDialogsEmbedding=function(){if(Xrm&&Xrm.Internal&&Xrm.Internal.getAllowLegacyDialogsEmbedding)return !DialogUtilities.isMobileCompanionApp()&&!DialogUtilities.isOutlook()&&!DialogUtilities.isMailApp()&&Xrm.Internal.getAllowLegacyDialogsEmbedding();return false};DialogUtilities.tryGetDialogStringsForEnabledMetadataDialogs=function(dialogName,confirmDialogStrings,entityName,recordsToDelete,actionUri,entityDisplayName,entitySetName,isDocumentManagementEnabled,isPrimary){if(isPrimary===void 0)isPrimary=false;if(recordsToDelete===null||recordsToDelete===undefined)recordsToDelete=1;var displayName=entityDisplayName;if(recordsToDelete>1)displayName=entitySetName;var DialogStrings={},DialogKeys=null;switch(dialogName){case DialogUtilities.DialogName.DeleteDialog:switch(entityName){case InternalUtilities.EntityUtilities.EntityNames.Contact:DialogKeys=["Web._grid.cmds.dlg_delete_contact.aspx_54","Delete_Customer_Dialog_Account_Instruction","Delete_Customer_Dialog_Delete_Instruction","Button_Label_Delete","Button_Label_Cancel","Dialog_DeleteContactConfirm_Title","Dialog_DeleteContactConfirm_Description"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Web._grid.cmds.dlg_delete_contact.aspx_54"].toString(),[displayName]);confirmDialogStrings.text+="\n";confirmDialogStrings.text+=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Delete_Customer_Dialog_Account_Instruction"].toString(),[displayName]);confirmDialogStrings.text+="\n";confirmDialogStrings.text+=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Delete_Customer_Dialog_Delete_Instruction"].toString(),[displayName]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteContactConfirm_Title"].toString(),[displayName]);confirmDialogStrings.subtitle=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteContactConfirm_Description"].toString(),[recordsToDelete,displayName]);break;case InternalUtilities.EntityUtilities.EntityNames.Account:DialogKeys=["Web._grid.cmds.dlg_delete_account.aspx_54","Button_Label_Delete","Button_Label_Cancel","Dialog_DeleteAccountConfirm_Title","Dialog_DeleteAccountConfirm_Description"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Web._grid.cmds.dlg_delete_account.aspx_54"].toString(),[displayName]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteAccountConfirm_Title"].toString(),[displayName]);confirmDialogStrings.subtitle=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteAccountConfirm_Description"].toString(),[recordsToDelete,displayName]);if(isDocumentManagementEnabled){DialogKeys=["Delete_Account_Dialog_RelatedDocumentsWarning","Delete_Customer_Dialog_Account_Instruction","Delete_Customer_Dialog_Delete_Instruction"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text+="\n";confirmDialogStrings.text+=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Delete_Account_Dialog_RelatedDocumentsWarning"].toString(),[]);confirmDialogStrings.text+="\n";confirmDialogStrings.text+=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Delete_Customer_Dialog_Account_Instruction"].toString(),[displayName]);confirmDialogStrings.text+="\n";confirmDialogStrings.text+=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Delete_Customer_Dialog_Delete_Instruction"].toString(),[displayName])}break;case InternalUtilities.EntityUtilities.EntityNames.KnowledgeArticle:DialogKeys=["Delete_KnowledgeArticle_Dialog_RelatedInformationWarning","Button_Label_Delete","Button_Label_Cancel","Dialog_DeleteKnowledgeArticleConfirm_Title","Dialog_DeleteKnowledgeArticleConfirm_Description"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=DialogStrings["Delete_KnowledgeArticle_Dialog_RelatedInformationWarning"].toString();confirmDialogStrings.confirmButtonLabel=DialogStrings["Button_Label_Delete"].toString();confirmDialogStrings.cancelButtonLabel=DialogStrings["Button_Label_Cancel"].toString();confirmDialogStrings.title=DialogStrings["Dialog_DeleteKnowledgeArticleConfirm_Title"].toString();confirmDialogStrings.subtitle=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteKnowledgeArticleConfirm_Description"].toString(),[recordsToDelete]);break;case InternalUtilities.EntityUtilities.EntityNames.OpportunityProduct:case InternalUtilities.EntityUtilities.EntityNames.InvoiceDetail:DialogKeys=["Dialog_Delete_DeleteAll","Button_Label_Delete","Button_Label_Cancel","Web._grid.cmds.dlg_delete.aspx_26"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_DeleteAll"].toString(),[]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Web._grid.cmds.dlg_delete.aspx_26"].toString(),[]);confirmDialogStrings.subtitle="";break;case InternalUtilities.EntityUtilities.EntityNames.Lead:case InternalUtilities.EntityUtilities.EntityNames.Competitor:case InternalUtilities.EntityUtilities.EntityNames.Opportunity:case InternalUtilities.EntityUtilities.EntityNames.DynamicProperty:case InternalUtilities.EntityUtilities.EntityNames.Email:case InternalUtilities.EntityUtilities.EntityNames.Incident:case InternalUtilities.EntityUtilities.EntityNames.SyncError:DialogKeys=["Dialog_Delete_Description","Button_Label_Delete","Button_Label_Cancel","Web._grid.cmds.dlg_delete.aspx_26"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Description"].toString(),[displayName]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Web._grid.cmds.dlg_delete.aspx_26"].toString(),[]);confirmDialogStrings.subtitle="";break;case InternalUtilities.EntityUtilities.EntityNames.Queue:DialogKeys=["Dialog_DeleteQueue_Description","Button_Label_Delete","Button_Label_Cancel","Dialog_DeleteQueueEmpty_Title"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteQueue_Description"].toString(),[recordsToDelete,displayName]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_DeleteQueueEmpty_Title"].toString(),[displayName]);confirmDialogStrings.subtitle="";break;case InternalUtilities.EntityUtilities.EntityNames.TopicModel:DialogKeys=["Dialog_Delete_Topicmodel_Description","Button_Label_Delete","Button_Label_Cancel","Dialog_Delete_Topicmodel_Title"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Topicmodel_Description"].toString(),[]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Topicmodel_Title"].toString(),[]);confirmDialogStrings.subtitle="";break;case InternalUtilities.EntityUtilities.EntityNames.AzureServiceConnection:DialogKeys=["Dialog_Delete_AzureServiceConnection_Description","Button_Label_Delete","Button_Label_Cancel","Dialog_Delete_AzureServiceConnection_Title"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_AzureServiceConnection_Description"].toString(),[]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_AzureServiceConnection_Title"].toString(),[]);confirmDialogStrings.subtitle="";break;case InternalUtilities.EntityUtilities.EntityNames.Contract:case InternalUtilities.EntityUtilities.EntityNames.RecurringAppointmentMaster:case InternalUtilities.EntityUtilities.EntityNames.ServiceAppointment:case InternalUtilities.EntityUtilities.EntityNames.Role:case InternalUtilities.EntityUtilities.EntityNames.TeamTemplate:case InternalUtilities.EntityUtilities.EntityNames.CalendarRule:return false;case InternalUtilities.EntityUtilities.EntityNames.Product:DialogUtilities.GetDefaultStringsForDeleteDialog(confirmDialogStrings,displayName);break;case InternalUtilities.EntityUtilities.EntityNames.Connection:if(isPrimary)DialogUtilities.GetDefaultStringsForDeleteDialog(confirmDialogStrings,displayName);else{DialogKeys=["Dialog_Delete_Connection_Description","Dialog_Delete_Bulk_Connection_Description","Button_Label_Yes","Button_Label_No","Dialog_Delete_Connection_Title"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=Xrm.Utility.getResourceString("Main_system_library",key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Connection_Description"].toString(),[]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Yes"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_No"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Connection_Title"].toString(),[]);if(recordsToDelete>1)confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Bulk_Connection_Description"].toString(),[]);confirmDialogStrings.subtitle=""}break;case InternalUtilities.EntityUtilities.EntityNames.Category:DialogKeys=["Dialog_Delete_Description_Category","Button_Label_Yes","Button_Label_No","Web._grid.cmds.dlg_delete.aspx_26"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Description_Category"].toString(),[displayName]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Yes"].toString(),[]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_No"].toString(),[]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Web._grid.cmds.dlg_delete.aspx_26"].toString(),[]);confirmDialogStrings.subtitle="";break;default:DialogUtilities.GetDefaultStringsForDeleteDialog(confirmDialogStrings,displayName);break}break;case InternalUtilities.DialogUtilities.DialogName.SaveAndRouteCase:confirmDialogStrings.text=InternalUtilities.GenericUtilities.getLocalResourceString("Dlg_RouteCase_AddRequiredConfirmForSingleCase_Body");confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Route");confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Cancel");confirmDialogStrings.title=InternalUtilities.GenericUtilities.getLocalResourceString("Dlg_RouteCase_AddRequiredConfirm_Title");break;case InternalUtilities.DialogUtilities.DialogName.RouteCase:DialogKeys=["Dlg_RouteCase_AddRequiredConfirmForSingleCase_Body","Button_Label_Route","Button_Label_Cancel","Dlg_RouteCase_AddRequiredConfirm_Title"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=DialogStrings["Dlg_RouteCase_AddRequiredConfirmForSingleCase_Body"].toString();confirmDialogStrings.confirmButtonLabel=DialogStrings["Button_Label_Route"].toString();confirmDialogStrings.cancelButtonLabel=DialogStrings["Button_Label_Cancel"].toString();confirmDialogStrings.title=DialogStrings["Dlg_RouteCase_AddRequiredConfirm_Title"].toString();break;case InternalUtilities.DialogUtilities.DialogName.ReactivateCase:DialogKeys=["Case_Reactivate_Dlg_Title","Web.CS.cases.dlg_reactivate.aspx_50","Button_Label_Reactivate","Button_Label_Cancel"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.title=DialogStrings["Case_Reactivate_Dlg_Title"].toString();confirmDialogStrings.text=DialogStrings["Web.CS.cases.dlg_reactivate.aspx_50"].toString();confirmDialogStrings.confirmButtonLabel=DialogStrings["Button_Label_Reactivate"].toString();confirmDialogStrings.cancelButtonLabel=DialogStrings["Button_Label_Cancel"].toString();break;case InternalUtilities.DialogUtilities.DialogName.ResolveCase:DialogKeys=["Web._cs.Cases.dlg_ConfirmResolve.aspx_1","Web._cs.Cases.dlg_ConfirmResolve.aspx_3","Button_Label_Confirm","Button_Label_Cancel"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.title=DialogStrings["Web._cs.Cases.dlg_ConfirmResolve.aspx_1"].toString();confirmDialogStrings.text=DialogStrings["Web._cs.Cases.dlg_ConfirmResolve.aspx_3"].toString();confirmDialogStrings.confirmButtonLabel=DialogStrings["Button_Label_Confirm"].toString();confirmDialogStrings.cancelButtonLabel=DialogStrings["Button_Label_Cancel"].toString();break;case InternalUtilities.DialogUtilities.DialogConstants.resolveCaseNoValidStatusReasonTransition:DialogKeys=["Web.Record.NoValidStatusReasonTransition.Window_Title01","Web.Record.NoValidStatusReasonTransition01","Button_Label_OK","Button_Label_Cancel"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.title=DialogStrings["Web.Record.NoValidStatusReasonTransition.Window_Title01"].toString();confirmDialogStrings.text=DialogStrings["Web.Record.NoValidStatusReasonTransition01"].toString();confirmDialogStrings.confirmButtonLabel=DialogStrings["Button_Label_OK"].toString();confirmDialogStrings.cancelButtonLabel=DialogStrings["Button_Label_Cancel"].toString();break;case InternalUtilities.DialogUtilities.DialogName.CancelCaseDialog:DialogKeys=["Web._cs.Cases.dlg_ConfirmResolve.aspx_4","Button_Label_Confirm","Button_Label_Cancel","Web._cs.Cases.dlg_ConfirmCancel.aspx_2"];DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=DialogStrings["Web._cs.Cases.dlg_ConfirmResolve.aspx_4"].toString();confirmDialogStrings.confirmButtonLabel=DialogStrings["Button_Label_Confirm"].toString();confirmDialogStrings.cancelButtonLabel=DialogStrings["Button_Label_Cancel"].toString();confirmDialogStrings.title=DialogStrings["Web._cs.Cases.dlg_ConfirmCancel.aspx_2"].toString();break;case InternalUtilities.DialogUtilities.DialogName.ApplyEmailTemplate:confirmDialogStrings.text=InternalUtilities.GenericUtilities.getLocalResourceString("Web._cs.ApplyEmailTemplate.dlg_ConfirmResolveText");confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_OK");confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Cancel");confirmDialogStrings.title=InternalUtilities.GenericUtilities.getLocalResourceString("Web._cs.ApplyEmailTemplate.dlg_ConfirmResolveTitle");break;case InternalUtilities.DialogUtilities.DialogName.UpdateAttachment:confirmDialogStrings.text=InternalUtilities.GenericUtilities.getLocalResourceString("AddTemplateWithoutAttachment");confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_OK");confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.getLocalResourceString("Button_Label_Cancel");confirmDialogStrings.title=InternalUtilities.GenericUtilities.getLocalResourceString("Web._cs.ApplyEmailTemplate.dlg_ConfirmResolveTitle");break;default:return false}return true};DialogUtilities.GetDefaultStringsForDeleteDialog=function(confirmDialogStrings,displayName){var DialogKeys=["Dialog_Delete_Description","Button_Label_Delete","Button_Label_Cancel","Web._grid.cmds.dlg_delete.aspx_26"],DialogStrings={};DialogKeys.forEach(function(key){DialogStrings[key]=InternalUtilities.GenericUtilities.getLocalResourceString(key)||key});confirmDialogStrings.text=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Dialog_Delete_Description"].toString(),[displayName]);confirmDialogStrings.confirmButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Delete"].toString(),[displayName]);confirmDialogStrings.cancelButtonLabel=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Button_Label_Cancel"].toString(),[displayName]);confirmDialogStrings.title=InternalUtilities.GenericUtilities.stringFormat(DialogStrings["Web._grid.cmds.dlg_delete.aspx_26"].toString(),[]);confirmDialogStrings.subtitle=""};DialogUtilities.openAlertDialogForMultipleErrors=function(gridControl){var alertDialogStrings={text:InternalUtilities.GenericUtilities.getLocalResourceString("Error_Message_Action_MultipleErrorsFound")};Xrm.Navigation.openAlertDialog(alertDialogStrings,null).then(function(success){gridControl&&gridControl.refresh()})};return DialogUtilities}();InternalUtilities.DialogUtilities=DialogUtilities;var DialogUtilities;(function(DialogUtilities){var DialogName=function(){function DialogName(){}DialogName.RouteCase="routecase";DialogName.SaveAndRouteCase="saveandroutecase";DialogName.DeleteDialog="delete";DialogName.AddToQueueDialog="AddToQueue";DialogName.ReactivateCase="ReactivateCase";DialogName.ResolveCase="ResolveCase";DialogName.QueueItemPickDialog="QueueItemPick";DialogName.RouteQueuedItemDialog="RouteQueuedItem";DialogName.Assign="Assign";DialogName.AssignQueue="AssignQueue";DialogName.CancelCaseDialog="CancelCase";DialogName.SetRegarding="SetRegarding";DialogName.ConvertActivityDialog="ConvertActivity";DialogName.ConvertToCaseDialog="ConvertToCase";DialogName.ConvertToKnowledgeArticleDialog="ConvertToKnowledgeArticle";DialogName.CloseOpportunity="CloseOpportunity";DialogName.CloseOrder="CloseOrder";DialogName.CloseInvoice="InvoiceClose";DialogName.CloseQuote="CloseQuote";DialogName.CreateOrder="CreateOrder";DialogName.SetStateDialog="SetStateDialog";DialogName.RecommendationModelDialog="RecommendationModelDialog";DialogName.SeriesActionDialog="SeriesActionDialog";DialogName.DupWarningDialog="DupWarning";DialogName.ApplyEmailTemplate="ApplyEmailTemplate";DialogName.SelectTemplateRecipient="SelectTemplateRecipient";DialogName.UpdateAttachment="UpdateAttachment";DialogName.Lookup="Lookup";DialogName.CreateSlaDialog="CreateSlaDialog";DialogName.AssociateCase="AssociateCase";DialogName.MergeCase="MergeCase";DialogName.RecommendedDocument="RecommendedDocument";DialogName.DocumentSuggestions="DocumentSuggestions";DialogName.OtherDocumentSuggestions="OtherDocumentSuggestions";DialogName.EntityImageUpload="EntityImageUpload";DialogName.DeviceSettings="DeviceSettings";DialogName.DeviceSettingsConsentDialog="DeviceSettingsConsentDialog";DialogName.MicrosoftFlowsDialog="MicrosoftFlowsDialog";return DialogName}();DialogUtilities.DialogName=DialogName;var DialogConstants=function(){function DialogConstants(){}DialogConstants.DialogOkId="ok_id";DialogConstants.DialogCancelId="cancel_id";DialogConstants.DialogMerge="Merge";DialogConstants.DialogSet="Set";DialogConstants.EntityId="entity_id";DialogConstants.EntityName="entity_name";DialogConstants.ActionCardId="actionCardId";DialogConstants.CardType="cardType";DialogConstants.LastButtonClicked="last_button_clicked";DialogConstants.ProgressValue=40;DialogConstants.ProgressMinValue=0;DialogConstants.ProgressMaxValue=100;DialogConstants.GridControl="gridControl";DialogConstants.Records="entity_records";DialogConstants.resolveCaseNoValidStatusReasonTransition="ResolveCaseNOvalidStatusReasonTransition";DialogConstants.EntityTypeCode="entityTypeCode";DialogConstants.DefaultStatus=-1;DialogConstants.BusinessQueuesLookupId="businessqueues_id";DialogConstants.incidentActiveState="Active";DialogConstants.statusReasonId="setcasestatus_id";DialogConstants.statusReasonLabelId="lbl_setcasestatus";DialogConstants.noValidStatusTransitionAlertTextResourceString="Web.Record.NoValidStatusReasonTransition03";DialogConstants.timeSpent="timeSpent";DialogConstants.isTimeAllotment="bIsTimeAllotment";DialogConstants.allotmentsRemaining="iAllotmentsRemaining";DialogConstants.resolutionType="resolutionType_id";DialogConstants.resolution="resolution_id";DialogConstants.totalTime="totaltime_id";DialogConstants.billableTime="billabletime_id";DialogConstants.remarks="remarks_id";DialogConstants.closeCaseConfirmAllotments="Case_Resolve_Dlg_Confirm_Allotments";DialogConstants.closeCaseString="Web.CS.cases.dlg_closecase.aspx_27";DialogConstants.closeCaseStringForNullSubject="Web.CS.cases.dlg_closecase.aspx_50";DialogConstants.closeCaseConfirmParent="Case_Resolve_Dlg_Confirm_Parent";DialogConstants.closeCaseConfirmContractDetailState="Case_Resolve_Dlg_Confirm_ContractDetailState";DialogConstants.resolvedState="Resolved";DialogConstants.RemoveQueueItemPickId="checkboxpick_id";DialogConstants.QueueItemPickHeaderText="lbl_headerdescription";DialogConstants.QueueItemRouteToId="routeto_id";DialogConstants.QueueItemUserLookupId="crmUserLookupControl_id";DialogConstants.QueueItemQueueLookupId="crmQueueLookupControl_id";DialogConstants.QueueItemRemoveId="chkBoxRemoveItem_id";DialogConstants.QueueItemAssignedToUserText="lbl_assignedtouser";DialogConstants.QueueItemAssignedToQueueText="lbl_addtoqueue";DialogConstants.QueueItemRouteHeaderText="lbl_headerdescription";DialogConstants.AssignQueueDialogLabel="label_DialogDescription";DialogConstants.AssignTomeOption="rdoMe_id";DialogConstants.SelectedRecordsCount="selected_records_count";DialogConstants.SystemUserViewId="systemuserview_id";DialogConstants.statusCodeId="statusCode_id";DialogConstants.CancelStatus="Canceled";DialogConstants.Id="Id";DialogConstants.regardingObjectColumnName="regardingobjectid";DialogConstants.regardingObjectTypeColumnName="regardingobjecttypecode";DialogConstants.regardingControlName="regarding_id";DialogConstants.activity="Activity";DialogConstants.activityLogicalName="activitypointer";DialogConstants.OpenNewId="cbOpenNew_id";DialogConstants.OpenNewRecord="openNewRecord";DialogConstants.SaveActivityId="cbSaveActivity_id";DialogConstants.SaveActivity="saveActivity";DialogConstants.LogResponseId="cbLogResponse_id";DialogConstants.Subject="subject";DialogConstants.LeadLookup="leadLookup";DialogConstants.CustomerLookup="customerLookup";DialogConstants.CurrencyLookup="currencyLookup";DialogConstants.CampaignLookup="campaignassociatedview_id";DialogConstants.SubjectLookup="subject_id";DialogConstants.LeadId="leadId";DialogConstants.OwnerId="owner_id";DialogConstants.OwnerType="owner_type";DialogConstants.OwnerName="owner_name";DialogConstants.OpportunityId="opportunityId";DialogConstants.CaseId="incidentId";DialogConstants.TransactionCurrencyId="transactioncurrencyid";DialogConstants.StateCode="statecode";DialogConstants.Caller="caller";DialogConstants.CallerParameters="callerparameters";DialogConstants.EstimatedValue="estimatedvalue";DialogConstants.ActualRevenueId="actualrevenue_id";DialogConstants.OpportunityStatusReasonId="statusreason_id";DialogConstants.CompetitorId="competitor_id";DialogConstants.CloseDateId="closedate_id";DialogConstants.DescriptionId="description_id";DialogConstants.Won="won";DialogConstants.WonString="Won";DialogConstants.LostString="Lost";DialogConstants.LabelSubtitle="lbl_closedescription";DialogConstants.DescriptionMaxLength=200;DialogConstants.HeaderTitleId="header_title_id";DialogConstants.TitleId="title_id";DialogConstants.MessageId="message_id";DialogConstants.StateId="state_id";DialogConstants.StatusId="status_id";DialogConstants.selectedState="selected_state";DialogConstants.allowedTransitions="allowed_transitions";DialogConstants.action="action_name";DialogConstants.activate="activate";DialogConstants.deactivate="deactivate";DialogConstants.defaultCloseState="default_close_state";DialogConstants.Completed=1;DialogConstants.Canceled=2;DialogConstants.Inactive=1;DialogConstants.Active=0;DialogConstants.DeleteOccurrence="deleteoccurrence_id";DialogConstants.DeleteSeriesKeepCompleted="deleteserieskeepcompleted_id";DialogConstants.DeleteSeriesAllInstances="deleteseriesallinstances_id";DialogConstants.DeleteDescriptionId="deletedescription_id";DialogConstants.SeriesId="seriesId";DialogConstants.AttachementSubGridControl="attachmentsGrid";DialogConstants.ControlNullError=" control cannot be null";DialogConstants.CursorInfoData="cursorInfo";DialogConstants.DefaultGuidString="00000000-0000-0000-0000-000000000000";DialogConstants.DefaultFormattedGuidString="{00000000-0000-0000-0000-000000000000}";DialogConstants.DefaultLookupName="default";DialogConstants.DescriptionAttribute="description";DialogConstants.EmailTemplateControlName="emailtemplates_id";DialogConstants.EmailSubject="emailsubject";DialogConstants.EmailDescription="emaildescription";DialogConstants.EmailEntityName="email";DialogConstants.EmailEntityId="id";DialogConstants.EmailEntityType="entityType";DialogConstants.EmailFormData="emailFormData";DialogConstants.EmailToField="to";DialogConstants.EmailCcField="cc";DialogConstants.EntityType="type";DialogConstants.EntityTypeInfo="entityTypeInfo";DialogConstants.FieldControlName="fieldname_id";DialogConstants.KeyPresent="KeyPresent";DialogConstants.LanguageId="language_id";DialogConstants.RecordControlName="record_id";DialogConstants.RegardingObject="regardingobjectid";DialogConstants.RecipientNames="name";DialogConstants.SelectControlName="select_id";DialogConstants.SubjectAttribute="subject";DialogConstants.TemplateEntityName="template";DialogConstants.TemplateId="templateId";DialogConstants.ParentAccountLookupId="parentAccountLookup_id";DialogConstants.ParentContactLookupId="parentContactLookup_id";DialogConstants.QualifyStatus="qualifyStatus";DialogConstants.ParentAccountId="parentAccountId";DialogConstants.ParentAccountName="parentAccountName";DialogConstants.ParentContactId="parentContactId";DialogConstants.ParentContactName="parentContactName";DialogConstants.qualifyLeadCommandName="QualifyLead";DialogConstants.convertActivityCommandName="ConvertActivity";DialogConstants.loseOpportunityCommandName="LoseOpportunity";DialogConstants.winOpportunityCommandName="WinOpportunity";DialogConstants.resolveCaseCommandName="CloseIncident";DialogConstants.setState="SetState";DialogConstants.closeActivityCommandName="CloseActivity";DialogConstants.commaSeperator=",";DialogConstants.defaultIndex=0;DialogConstants.firstIndex=1;DialogConstants.logicalName="LogicalName";DialogConstants.StatusCode="statuscode";DialogConstants.IncidentTitle="incident_title";DialogConstants.IncidentDescription="incident_description";DialogConstants.IncidentResolution="incident_resolution";DialogConstants.IncidentResolutionDescription="incidentresolution_description";DialogConstants.ConvertToKnowledgeArticleTitle="title_id";DialogConstants.ConvertToKnowledgeArticleContent="content_id";DialogConstants.ConvertToKnowledgeArticleId="knowledgeArticleId";DialogConstants.ConvertToKnowledgeArticleOwnerId="owner_id";DialogConstants.ConvertToKnowledgeArticleSubjectId="subject_id";DialogConstants.SubjectId="subjectId";DialogConstants.SubjectName="subjectName";DialogConstants.ConvertToKnowledgeArticleSubjectName="subjectName";DialogConstants.ConvertToKnowledgeArticleOwnerType="ownerType";DialogConstants.slaName="name_id";DialogConstants.SLASelectedEnity="applicableEntity_id";DialogConstants.PriceLevelId="pricelevelid";DialogConstants.SuggestionsSource="SuggestionsSource";DialogConstants.IsCustomLineItemEntity="isCustomLineItemEntity";DialogConstants.LineItemMetaData="lineItemMetaData";DialogConstants.PanoramaItemDialog="PanoramaItemDialog";DialogConstants.EntityLogicalNameParameter="entitylogicalname_id";DialogConstants.EntityPrimaryAttributeParameter="entityprimaryattribute_id";DialogConstants.EntityIdParameter="entity_id";DialogConstants.EntityImageUrlParameter="entityimageurl_id";DialogConstants.CameraEnabledParameter="cameraenabled_id";DialogConstants.EntityImageDataParameter="entityimagedata_id";DialogConstants.EntityImagePreviewId="entityimagepreview_id";DialogConstants.TakePhotoId="takephoto_id";DialogConstants.UploadImageId="uploadimage_id";DialogConstants.UseDefaultId="usedefault_id";DialogConstants.DeviceSettings="device_settings";DialogConstants.FlowId="flow_id";DialogConstants.EntityIdCollection="entity_ids";DialogConstants.FlowsEnvironmentId="environment_id";DialogConstants.OrgUniqueName="org_unique_name";DialogConstants.EntityLogicalCollectionName="entity_logical_collection_name";DialogConstants.EntityLogicalName="entity_logical_name";DialogConstants.Dynamics365AccessToken="dynamics365_access_token";DialogConstants.FlowsDestinationURL="flows_destination_url";DialogConstants.FlowsFPISiteURL="flows_fpi_site_url";DialogConstants.FlowsAuthenticationString="flows_authentication_string";DialogConstants.OfflineSync="offlineSync";DialogConstants.ShowAssignToMeOption="show_assign_to_me_option";return DialogConstants}();DialogUtilities.DialogConstants=DialogConstants})(DialogUtilities=InternalUtilities.DialogUtilities||(InternalUtilities.DialogUtilities={}))})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var EntityUtilities=function(){function EntityUtilities(){}EntityUtilities.isStateCodeReversed=function(entityName){switch(entityName){case InternalUtilities.EntityUtilities.EntityNames.Entitlement:case InternalUtilities.EntityUtilities.EntityNames.RoutingRule:case InternalUtilities.EntityUtilities.EntityNames.ConvertRule:return true;default:return false}};return EntityUtilities}();InternalUtilities.EntityUtilities=EntityUtilities;var EntityUtilities;(function(EntityUtilities){var ProductStructureType=function(){function ProductStructureType(){}ProductStructureType.Product=1;ProductStructureType.ProductFamily=2;ProductStructureType.ProductBundle=3;return ProductStructureType}();EntityUtilities.ProductStructureType=ProductStructureType;var EntityNames=function(){function EntityNames(){}EntityNames.None="none";EntityNames.Account="account";EntityNames.ActionCard="actioncard";EntityNames.SyncError="syncerror";EntityNames.AccountLeads="accountleads";EntityNames.ActivityMimeAttachment="activitymimeattachment";EntityNames.ActivityParty="activityparty";EntityNames.ActivityPointer="activitypointer";EntityNames.AdvancedSimilarityRule="advancedsimilarityrule";EntityNames.Annotation="annotation";EntityNames.AnnualFiscalCalendar="annualfiscalcalendar";EntityNames.ApplicationFile="applicationfile";EntityNames.Appointment="appointment";EntityNames.AsyncOperation="asyncoperation";EntityNames.Attachment="attachment";EntityNames.AttributeMap="attributemap";EntityNames.Audit="audit";EntityNames.AzureServiceConnection="azureserviceconnection";EntityNames.BaseAddEntityObjectTypeCode="baseaddentityobjecttypecode";EntityNames.BulkDeleteFailure="bulkdeletefailure";EntityNames.BulkDeleteOperation="bulkdeleteoperation";EntityNames.BulkOperation="bulkoperation";EntityNames.BulkOperationLog="bulkoperationlog";EntityNames.BusinessDataLocalizedLabel="businessdatalocalizedlabel";EntityNames.BusinessUnit="businessunit";EntityNames.BusinessUnitMap="businessunitmap";EntityNames.BusinessUnitNewsArticle="businessunitnewsarticle";EntityNames.Calendar="calendar";EntityNames.CalendarRule="calendarrule";EntityNames.Campaign="campaign";EntityNames.CampaignActivity="campaignactivity";EntityNames.CampaignActivityItem="campaignactivityitem";EntityNames.CampaignItem="campaignitem";EntityNames.CampaignResponse="campaignresponse";EntityNames.ChannelProperty="channelproperty";EntityNames.ChannelPropertyGroup="channelpropertygroup";EntityNames.ClientUpdate="clientupdate";EntityNames.ColumnMapping="columnmapping";EntityNames.Commitment="commitment";EntityNames.Competitor="competitor";EntityNames.CompetitorAddress="competitoraddress";EntityNames.CompetitorProduct="competitorproduct";EntityNames.CompetitorSalesLiterature="competitorsalesliterature";EntityNames.ComplexControl="complexcontrol";EntityNames.Connection="connection";EntityNames.ConnectionRole="connectionrole";EntityNames.ConnectionRoleAssociation="connectionroleassociation";EntityNames.ConnectionRoleObjectTypeCode="connectionroleobjecttypecode";EntityNames.ConvertRule="convertrule";EntityNames.ConvertRuleItem="convertruleitem";EntityNames.ConstraintBasedGroup="constraintbasedgroup";EntityNames.Contact="contact";EntityNames.ContactInvoices="contactinvoices";EntityNames.ContactLeads="contactleads";EntityNames.ContactOrders="contactorders";EntityNames.ContactQuotes="contactquotes";EntityNames.Contract="contract";EntityNames.ContractDetail="contractdetail";EntityNames.ContractTemplate="contracttemplate";EntityNames.CustomerAddress="customeraddress";EntityNames.CustomerOpportunityRole="customeropportunityrole";EntityNames.CustomerRelationship="customerrelationship";EntityNames.Dependency="dependency";EntityNames.DependencyNode="dependencynode";EntityNames.Discount="discount";EntityNames.DiscountType="discounttype";EntityNames.DisplayString="displaystring";EntityNames.DisplayStringMap="displaystringmap";EntityNames.DocumentIndex="documentindex";EntityNames.DocumentTemplate="documenttemplate";EntityNames.DuplicateRecord="duplicaterecord";EntityNames.DuplicateRule="duplicaterule";EntityNames.DuplicateRuleCondition="duplicaterulecondition";EntityNames.DynamicProperty="dynamicproperty";EntityNames.DelveActionHub="delveactionhub";EntityNames.DynamicPropertyOptionSetItem="dynamicpropertyoptionsetitem";EntityNames.Email="email";EntityNames.EmailHash="emailhash";EntityNames.EmailSearch="emailsearch";EntityNames.EmailServerProfile="emailserverprofile";EntityNames.EmailSignature="emailsignature";EntityNames.Entitlement="entitlement";EntityNames.EntityMap="entitymap";EntityNames.Equipment="equipment";EntityNames.EntitlementChannel="entitlementchannel";EntityNames.EntitlementTemplateChannel="entitlementtemplatechannel";EntityNames.Fax="fax";EntityNames.FieldPermission="fieldpermission";EntityNames.FieldSecurityProfile="fieldsecurityprofile";EntityNames.FilterTemplate="filtertemplate";EntityNames.FixedMonthlyFiscalCalendar="fixedmonthlyfiscalcalendar";EntityNames.Goal="goal";EntityNames.GoalRollupQuery="goalrollupquery";EntityNames.Import="import";EntityNames.ImportData="importdata";EntityNames.ImportEntityMapping="importentitymapping";EntityNames.ImportFile="importfile";EntityNames.ImportJob="importjob";EntityNames.ImportLog="importlog";EntityNames.ImportMap="importmap";EntityNames.Incident="incident";EntityNames.IncidentResolution="incidentresolution";EntityNames.IntegrationStatus="integrationstatus";EntityNames.InternalAddress="internaladdress";EntityNames.InterProcessLock="interprocesslock";EntityNames.InvalidDependency="invaliddependency";EntityNames.Invoice="invoice";EntityNames.InvoiceDetail="invoicedetail";EntityNames.IsvConfig="isvconfig";EntityNames.KbArticle="kbarticle";EntityNames.KbArticleComment="kbarticlecomment";EntityNames.KbArticleTemplate="kbarticletemplate";EntityNames.NewKbArticle="newkbarticle";EntityNames.KnowledgeArticle="knowledgearticle";EntityNames.KnowledgeArticlesCategories="knowledgearticlescategories";EntityNames.KnowledgeArticleIncident="knowledgearticleincident";EntityNames.KnowledgeArticleViews="knowledgearticleviews";EntityNames.KnowledgeSearchModel="knowledgesearchmodel";EntityNames.LanguageLocale="languagelocale";EntityNames.Lead="lead";EntityNames.LeadAddress="leadaddress";EntityNames.LeadCompetitors="leadcompetitors";EntityNames.LeadProduct="leadproduct";EntityNames.Letter="letter";EntityNames.License="license";EntityNames.List="list";EntityNames.ListMember="listmember";EntityNames.LookUpMapping="lookupmapping";EntityNames.Mailbox="mailbox";EntityNames.MailMergeTemplate="mailmergetemplate";EntityNames.Metric="metric";EntityNames.MobileOfflineProfile="mobileofflineprofile";EntityNames.MobileOfflineProfileItem="mobileofflineprofileitem";EntityNames.MonthlyFiscalCalendar="monthlyfiscalcalendar";EntityNames.Notification="notification";EntityNames.Notes="annotation";EntityNames.OfficeDocument="officedocument";EntityNames.Opportunity="opportunity";EntityNames.OpportunityClose="opportunityclose";EntityNames.OpportunityCompetitors="opportunitycompetitors";EntityNames.OpportunityProduct="opportunityproduct";EntityNames.OrderClose="orderclose";EntityNames.Organization="organization";EntityNames.OrganizationStatistic="organizationstatistic";EntityNames.OrganizationUI="organizationui";EntityNames.Owner="owner";EntityNames.OwnerMapping="ownermapping";EntityNames.PersonalDocumentTemplate="personaldocumenttemplate";EntityNames.PhoneCall="phonecall";EntityNames.PickListMapping="picklistmapping";EntityNames.PluginAssembly="pluginassembly";EntityNames.PluginType="plugintype";EntityNames.PluginTypeStatistic="plugintypestatistic";EntityNames.PluginTraceLog="plugintracelog";EntityNames.Post="post";EntityNames.PostComment="postcomment";EntityNames.PostFollow="postfollow";EntityNames.PostLike="postlike";EntityNames.PostRegarding="postregarding";EntityNames.PostRole="postrole";EntityNames.PriceLevel="pricelevel";EntityNames.PrincipalAttributeAccessMap="principalattributeaccessmap";EntityNames.PrincipalEntityMap="principalentitymap";EntityNames.PrincipalObjectAccess="principalobjectaccess";EntityNames.PrincipalObjectAccessReadSnapshot="principalobjectaccessreadsnapshot";EntityNames.PrincipalObjectAttributeAccess="principalobjectattributeaccess";EntityNames.Privilege="privilege";EntityNames.PrivilegeObjectTypeCodes="privilegeobjecttypecodes";EntityNames.ChannelAccessProfileEntityAccessLevel="channelaccessprofileentityaccesslevel";EntityNames.ProcessSession="processsession";EntityNames.Product="product";EntityNames.ProductAssociation="productassociation";EntityNames.ProductPriceLevel="productpricelevel";EntityNames.ProductSalesLiterature="productsalesliterature";EntityNames.ProductSubstitute="productsubstitute";EntityNames.Publisher="publisher";EntityNames.PublisherAddress="publisheraddress";EntityNames.QuarterlyFiscalCalendar="quarterlyfiscalcalendar";EntityNames.Queue="queue";EntityNames.QueueItem="queueitem";EntityNames.Quote="quote";EntityNames.QuoteClose="quoteclose";EntityNames.QuoteDetail="quotedetail";EntityNames.RecommendationModel="recommendationmodel";EntityNames.RecommendationModelVersion="recommendationmodelversion";EntityNames.RecordCountSnapshot="recordcountsnapshot";EntityNames.RecurrenceRule="recurrencerule";EntityNames.RecurringAppointmentMaster="recurringappointmentmaster";EntityNames.RelationshipRole="relationshiprole";EntityNames.RelationshipRoleMap="relationshiprolemap";EntityNames.ReplicationBacklog="replicationbacklog";EntityNames.Report="report";EntityNames.ReportCategory="reportcategory";EntityNames.ReportEntity="reportentity";EntityNames.ReportLink="reportlink";EntityNames.ReportVisibility="reportvisibility";EntityNames.Resource="resource";EntityNames.ResourceGroup="resourcegroup";EntityNames.ResourceGroupExpansion="resourcegroupexpansion";EntityNames.ResourceSpec="resourcespec";EntityNames.RibbonCommand="ribboncommand";EntityNames.RibbonContextGroup="ribboncontextgroup";EntityNames.RibbonCustomization="ribboncustomization";EntityNames.RibbonDiff="ribbondiff";EntityNames.RibbonRule="ribbonrule";EntityNames.RibbonTabToCommandMap="ribbontabtocommandmap";EntityNames.Role="role";EntityNames.RolePrivileges="roleprivileges";EntityNames.RoleTemplate="roletemplate";EntityNames.RoleTemplatePrivileges="roletemplateprivileges";EntityNames.RollupField="rollupfield";EntityNames.SalesLiterature="salesliterature";EntityNames.SalesLiteratureItem="salesliteratureitem";EntityNames.SalesOrder="salesorder";EntityNames.SalesOrderDetail="salesorderdetail";EntityNames.SalesProcessInstance="salesprocessinstance";EntityNames.SavedQuery="savedquery";EntityNames.SavedQueryVisualization="savedqueryvisualization";EntityNames.SdkMessage="sdkmessage";EntityNames.SdkMessageFilter="sdkmessagefilter";EntityNames.SdkMessagePair="sdkmessagepair";EntityNames.SdkMessageProcessingStep="sdkmessageprocessingstep";EntityNames.SdkMessageProcessingStepImage="sdkmessageprocessingstepimage";EntityNames.SdkMessageProcessingStepSecureConfig="sdkmessageprocessingstepsecureconfig";EntityNames.SdkMessageRequest="sdkmessagerequest";EntityNames.SdkMessageRequestField="sdkmessagerequestfield";EntityNames.SdkMessageResponse="sdkmessageresponse";EntityNames.SdkMessageResponseField="sdkmessageresponsefield";EntityNames.SemiAnnualFiscalCalendar="semiannualfiscalcalendar";EntityNames.Service="service";EntityNames.ServiceAppointment="serviceappointment";EntityNames.ServiceContractContacts="servicecontractcontacts";EntityNames.ServiceEndpoint="serviceendpoint";EntityNames.SharePointDocumentLocation="sharepointdocumentlocation";EntityNames.SharePointData="sharepointdata";EntityNames.SharePointDocument="sharepointdocument";EntityNames.SharePointSite="sharepointsite";EntityNames.Site="site";EntityNames.SiteMap="sitemap";EntityNames.Solution="solution";EntityNames.SocialActivity="socialactivity";EntityNames.SocialProfile="socialprofile";EntityNames.SolutionComponent="solutioncomponent";EntityNames.StatusMap="statusmap";EntityNames.StringMap="stringmap";EntityNames.Subject="subject";EntityNames.Subscription="subscription";EntityNames.SubscriptionClients="subscriptionclients";EntityNames.SubscriptionManuallyTrackedObject="subscriptionmanuallytrackedobject";EntityNames.SubscriptionSyncInfo="subscriptionsyncinfo";EntityNames.SubscriptionTrackingDeletedObject="subscriptiontrackingdeletedobject";EntityNames.SystemForm="systemform";EntityNames.SystemUser="systemuser";EntityNames.Position="position";EntityNames.SystemUserBusinessUnitEntityMap="systemuserbusinessunitentitymap";EntityNames.SystemUserLicenses="systemuserlicenses";EntityNames.SystemUserPrincipals="systemuserprincipals";EntityNames.SystemUserProfiles="systemuserprofiles";EntityNames.SystemUserRoles="systemuserroles";EntityNames.Task="task";EntityNames.Team="team";EntityNames.TeamMembership="teammembership";EntityNames.TeamProfiles="teamprofiles";EntityNames.TeamRoles="teamroles";EntityNames.TeamTemplate="teamtemplate";EntityNames.Template="template";EntityNames.Territory="territory";EntityNames.Theme="theme";EntityNames.TimeZoneDefinition="timezonedefinition";EntityNames.TimeZoneLocalizedName="timezonelocalizedname";EntityNames.TimeZoneRule="timezonerule";EntityNames.TopicModel="topicmodel";EntityNames.TransactionCurrency="transactioncurrency";EntityNames.TransformationMapping="transformationmapping";EntityNames.TransformationParameterMapping="transformationparametermapping";EntityNames.UnresolvedAddress="unresolvedaddress";EntityNames.UoM="uom";EntityNames.UoMSchedule="uomschedule";EntityNames.UserEntityInstanceData="userentityinstancedata";EntityNames.UserEntityUISettings="userentityuisettings";EntityNames.UserFiscalCalendar="userfiscalcalendar";EntityNames.UserForm="userform";EntityNames.UserQuery="userquery";EntityNames.UserQueryVisualization="userqueryvisualization";EntityNames.UserSettings="usersettings";EntityNames.WebResource="webresource";EntityNames.WebWizard="webwizard";EntityNames.WizardAccessPrivilege="wizardaccessprivilege";EntityNames.WizardPage="wizardpage";EntityNames.Workflow="workflow";EntityNames.WorkflowDependency="workflowdependency";EntityNames.WorkflowLog="workflowlog";EntityNames.WorkflowWaitSubscription="workflowwaitsubscription";EntityNames.RoutingRule="routingrule";EntityNames.RoutingRuleItem="routingruleitem";EntityNames.HierarchyRule="hierarchyrule";EntityNames.SLA="sla";EntityNames.SLAItem="slaitem";EntityNames.SLAKPIInstance="slakpiinstance";EntityNames.DataPerformance="dataperformance";EntityNames.ChannelAccessProfileRule="channelaccessprofilerule";EntityNames.ChannelAccessProfileRuleItem="channelaccessprofileruleitem";EntityNames.ExternalParty="externalparty";EntityNames.ExternalPartyItem="externalpartyitem";EntityNames.Category="category";EntityNames.AccountAddress="accountaddress";EntityNames.ActivityScheduling="activityscheduling";EntityNames.AppLicense="applicense";EntityNames.AppOfflineFilter="appofflinefilter";EntityNames.AppSalesPerson="appsalesperson";EntityNames.AppWorkflowInstance="appworkflowinstance";EntityNames.Attribute="attribute";EntityNames.AttributePicklistValue="attributepicklistvalue";EntityNames.BulkDeleteWizardDialog="bulkdeletewizarddialog";EntityNames.ContactAddress="contactaddress";EntityNames.DuplicateDetectionDialog="duplicatedetectiondialog";EntityNames.Entity="entity";EntityNames.EntityRelationship="entityrelationship";EntityNames.EntityRelationshipRole="entityrelationshiprole";EntityNames.HolidayCalendarRule="HolidayCalendarRule";EntityNames.ImportEntity="importentity";EntityNames.ImportWizardDialog="importwizarddialog";EntityNames.LocalizedLabel="localizedlabel";EntityNames.MobileOfflineProfileItemAssociation="mobileofflineprofileitemassociation";EntityNames.NotWorkingWorkShift="notworkingworkshift";EntityNames.OccurrenceCalendarRule="OccurrenceCalendarRule";EntityNames.OccurringWorkShift="occurringworkshift";EntityNames.OptionSet="optionset";EntityNames.RecurrenceCalendarRule="recurrencecalendarrule";EntityNames.RecurringWorkShift="recurringworkShift";EntityNames.Relationship="relationship";EntityNames.ScriptErrorDetailsDialog="scripterrordetailsdialog";EntityNames.ScriptErrorDialog="scripterrordialog";EntityNames.ServiceRestrictionCalendarRule="servicerestrictioncalendarrule";EntityNames.SolutionExportWizard="solutionexportwizard";EntityNames.SolutionImportWizard="solutionimportwizard";EntityNames.TimeOffCalendarRule="timeoffcalendarrule";EntityNames.UnresolvedEmailParty="unresolvedemailparty";EntityNames.ViewAttribute="viewattribute";EntityNames.MailboxStatistics="mailboxstatistics";EntityNames.EntityDashboard="entitydashboard";EntityNames.ReportPropertyDialog="reportpropertydialog";EntityNames.UntrackedEmail="untrackedemail";return EntityNames}();EntityUtilities.EntityNames=EntityNames})(EntityUtilities=InternalUtilities.EntityUtilities||(InternalUtilities.EntityUtilities={}))})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var GenericUtilities=function(){function GenericUtilities(){}GenericUtilities.getLocalResourceString=function(locLabel){return Xrm.Utility.getResourceString("Main_system_library",locLabel)};GenericUtilities.showGenericProgressIndicator=function(){Xrm.Utility.showProgressIndicator(GenericUtilities.getLocalResourceString("Msg_Progress_MOCA_Dialog"))};GenericUtilities.createChainedEntityMetadataMapWithCallback=function(uniqueEntityTypes,currentIndex,entityNameToMetadataMap,callback){if(currentIndex<uniqueEntityTypes.length)Xrm.Utility.getEntityMetadata(uniqueEntityTypes[currentIndex]).then(function(metadata){entityNameToMetadataMap[uniqueEntityTypes[currentIndex]]=metadata;GenericUtilities.createChainedEntityMetadataMapWithCallback(uniqueEntityTypes,currentIndex+1,entityNameToMetadataMap,callback)},function(error){GenericUtilities.createChainedEntityMetadataMapWithCallback(uniqueEntityTypes,currentIndex+1,entityNameToMetadataMap,callback)});else callback(entityNameToMetadataMap)};GenericUtilities.HandleErrorMessage=function(errorResponse){var errorDialogOptions={message:errorResponse.message,errorCode:errorResponse.errorCode};Xrm.Navigation.openErrorDialog(errorDialogOptions)};GenericUtilities.stringFormat=function(stringToFormat,args){if(!args||stringToFormat===undefined||stringToFormat===null)return stringToFormat||"";return stringToFormat.replace(/{(\d+)}/g,function(match,number){return args[number]!=null&&args[number]!=undefined?args[number]:match})};GenericUtilities.Format=function(format){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];for(var returnValue=format,i=1;i<arguments.length;i++){var actualValue=typeof arguments[i]=="undefined"||arguments[i]==null?"":arguments[i].toString();returnValue=returnValue.replace(new RegExp("\\{"+(i-1)+"\\}","g"),actualValue)}return returnValue};GenericUtilities.isNullOrEmpty=function(s){return s==null||s.length===0};GenericUtilities.isNullOrWhitespace=function(s){return s==null||s.trim().length===0};GenericUtilities.isNullUndefinedOrWhitespace=function(s){return s==null||s==undefined||s.trim().length===0};GenericUtilities.EqualsIgnoreCase=function(string1,string2){var isString1Null=string1==null,isString2Null=string2==null,isString1Undefined=string1==undefined,isString2Undefined=string2==undefined;if(isString1Null&&isString2Null||isString1Undefined&&isString2Undefined)return true;if(isString1Null!=isString2Null||isString1Undefined!=isString2Undefined)return false;return string1.toUpperCase()===string2.toUpperCase()};GenericUtilities.ReplaceLineBreaksWithBrTags=function(text){return text.replace(/(?:\r\n|&#13;&#10;|\r|&#13;|\n|&#10;)/g,"<br />")};GenericUtilities.ConvertEntityRefToLookUp=function(entityRef){return {entityType:entityRef.TypeName,id:entityRef.Id,name:entityRef.Name}};GenericUtilities.Empty="";return GenericUtilities}();InternalUtilities.GenericUtilities=GenericUtilities})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var SdkContracts;(function(SdkContracts){var RetrieveDocumentTemplatesRequest=function(){function RetrieveDocumentTemplatesRequest(entityTypeCode,documentType,entityset){this.EntityTypeCode=entityTypeCode;this.DocumentType=documentType;this.entityset=entityset}RetrieveDocumentTemplatesRequest.prototype.getMetadata=function(){var metadata={boundParameter:"entityset",parameterTypes:{entityset:{typeName:"mscrm.documenttemplate",structuralProperty:4},EntityTypeCode:{typeName:"Edm.Int32",structuralProperty:1},DocumentType:{typeName:"Edm.Int32",structuralProperty:1}},operationName:"RetrieveDocumentTemplates",operationType:1};return metadata};return RetrieveDocumentTemplatesRequest}();SdkContracts.RetrieveDocumentTemplatesRequest=RetrieveDocumentTemplatesRequest})(SdkContracts=XrmCore.SdkContracts||(XrmCore.SdkContracts={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var ExportUtilities=function(){function ExportUtilities(){}ExportUtilities.retrievePersonalDocumentTemplates=function(entityTypeName,documentType){var entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName),fetchXml="<fetch mapping='logical'> <entity name='personaldocumenttemplate'> <attribute name='personaldocumenttemplateid' /> <attribute name='name' /> <order attribute='createdon' descending='true' /><filter type = 'and'> <condition attribute='associatedentitytypecode' operator='eq' value='"+entityTypeCode+"' /> <condition attribute='documenttype' operator='eq' value='"+documentType+"' /> <condition attribute='status' operator= 'eq' value= '0' /> </filter> </entity> </fetch>",deferred=Xrm.WebApi.online.retrieveMultipleRecords("personaldocumenttemplate","?fetchXml="+fetchXml).then(function(response){for(var personalTemplates=[],templates=response.entities,i=0;i<templates.length;i++){var curT={Id:templates[i].personaldocumenttemplateid,Name:templates[i].name};personalTemplates.push(curT)}return personalTemplates},function(e){console.error(e)});return deferred};ExportUtilities.retrieveSystemDocumentTemplates=function(entityTypeName,documentType){var entityTypeCode=Xrm.Internal.getEntityCode(entityTypeName),r=new XrmCore.SdkContracts.RetrieveDocumentTemplatesRequest(entityTypeCode,documentType,"documenttemplate"),deferred=Xrm.WebApi.online.execute(r).then(function(res){return res.json()}).then(function(odataResponse){for(var templates=odataResponse.value,systemTemplates=[],i=0;i<templates.length;i++){var curT={Id:templates[i].documenttemplateid,Name:templates[i].name};systemTemplates.push(curT)}return systemTemplates},function(e){console.error(e)});return deferred};ExportUtilities.retrieveCreateTemplates=function(){var createTemplate=[{Id:"UploadTemplate",Name:Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_UploadTemplate")},{Id:"DownloadTemplate",Name:Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_DownloadTemplate")}];return createTemplate};ExportUtilities.retrieveOnlineButton=function(){var createTemplate=[{Id:"OpenExcelOnline",Name:Xrm.Utility.getResourceString("Main_system_library","Menu_Label_OpenExcelOnline")},{Id:"Download",Name:Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Download")}];return createTemplate};ExportUtilities.determineRibbonMenuId=function(entityLogicalName,isForm,ribbonContextType,ribbonRelationshipType,documentType,isOnline){var relType="NoRelationship";if(ribbonRelationshipType===0)relType="OneToMany";else if(ribbonRelationshipType===1)relType="ManyToMany";var contextWithId="SubGrid",ribbonContext="SubGridAssociated";if(isForm){contextWithId="Form";ribbonContext="Form"}else if(ribbonContextType==0){contextWithId="HomepageGrid";ribbonContext="HomePageGrid"}var template="";if(isOnline)template=documentType===2?"WordOnlineTemplates":"DocumentOnlineTemplates";else template=documentType===2?"WordTemplates":"DocumentTemplates";var menuButtonId=entityLogicalName+"|"+relType+"|"+ribbonContext+"|Mscrm."+contextWithId+"."+entityLogicalName+"."+template+".Menu";return menuButtonId};ExportUtilities.determinCreateRibbonCommandId=function(entityLogicalName,isForm,ribbonContextType,documentType,isUpload){var relType="NoRelationship",ribbonContext="SubGridAssociated";if(isForm)ribbonContext="Form";else if(ribbonContextType==0)ribbonContext="HomePageGrid";var docStr=documentType===2?"Word":"Document",opStr="TemplatesMenu",cmdStr=entityLogicalName+"|"+relType+"|"+ribbonContext+"|Mscrm."+docStr+"Template."+opStr;if(documentType===2){var contextStr=isForm?"Form":"Grid";cmdStr=cmdStr+"."+contextStr}return cmdStr};ExportUtilities.determinRibbonCommandId=function(entityLogicalName,isForm,ribbonContextType,ribbonRelationshipType,documentType,isCreate){var relType="NoRelationship";if(ribbonRelationshipType===0)relType="OneToMany";else if(ribbonRelationshipType===1)relType="ManyToMany";var ribbonContext="SubGridAssociated";if(isForm)ribbonContext="Form";else if(ribbonContextType==0)ribbonContext="HomePageGrid";var docStr=documentType===2?"Word":"Document",opStr=isCreate?"Create"+docStr+"Template":"TemplatesMenu",cmdStr=entityLogicalName+"|"+relType+"|"+ribbonContext+"|Mscrm."+docStr+"Template."+opStr;if(documentType===2){var contextStr=isForm?"Form":"Grid";cmdStr=cmdStr+"."+contextStr}return cmdStr};ExportUtilities.buildControlsForCreate=function(menuId,commandId,templates,isUpload,documentType){for(var buttons=[],tempStr=isUpload?"Upload":"Download",docStr=documentType===1?"Excel":"Word",controlsPrefix=menuId+"."+docStr+"Templates.Controls",image="",i=0;i<templates.length;i++){if(image==="")image="SharePointUploadDocument";else image="Download";var button={ControlType:"Button",Id:controlsPrefix+"."+templates[i].Id,Command:commandId,Sequence:String(i*10+10),ToolTipDescription:templates[i].Name,Alt:templates[i].Name,LabelText:templates[i].Name,ModernImage:image};buttons.push(button)}var controls={Id:controlsPrefix,Items:buttons};return controls};ExportUtilities.buildControlsFromTemplates=function(menuId,onlineMenuId,commandId,templates,isSystemTemplate,documentType){var buttons=[],flyoutButtons=[],tempStr=isSystemTemplate?"":"Personal",docStr=documentType===1?"Excel":"Word",image=isSystemTemplate?"SystemDocumentTemplates":"MyDocumentTemplates",onlinecontrolsPrefix=menuId+"."+tempStr+docStr+"Templates.Controls",isOnPrem=Xrm.Utility.getGlobalContext().isOnPremises(),templateButtonForOnline=ExportUtilities.retrieveOnlineButton(),button={ControlType:"Button",Id:"ViewAllMyTemplatesId",Command:commandId,Sequence:String(i*10+10),ToolTipDescription:Xrm.Utility.getResourceString("Main_system_library","View_All_My_Templates"),Alt:Xrm.Utility.getResourceString("Main_system_library","View_All_My_Templates"),LabelText:Xrm.Utility.getResourceString("Main_system_library","View_All_My_Templates"),ModernImage:"ViewAllMyDocumentTemplates"};if(!isOnPrem&&documentType===1&&Xrm.Utility.getGlobalContext().client.getClient()===Xrm.Constants.ClientNames.web){!isSystemTemplate&&flyoutButtons.push(button);for(var i=0;i<templates.length;i++){onlineMenuId=""+onlineMenuId;var flyoutButtonsButtonsControl=InternalUtilities.ExportUtilities.buildOnlineControlsFromTemplates(onlineMenuId,commandId,templateButtonForOnline,templates[i],isSystemTemplate,true,documentType),menuSectionOnline=InternalUtilities.ExportUtilities.buildOnlineMenuSection(onlineMenuId,templates[i],isSystemTemplate,documentType,false,i*10+10,flyoutButtonsButtonsControl),menuSectionsOnline=[];menuSectionsOnline.push(menuSectionOnline);var menuOnline=InternalUtilities.ExportUtilities.buildMenu(onlineMenuId,menuSectionsOnline),flyoutButton={ControlType:"FlyoutAnchor",Id:onlinecontrolsPrefix+"."+templates[i].Id,Command:commandId,Sequence:String(i*10+10),ToolTipDescription:templates[i].Name,Alt:templates[i].Name,LabelText:templates[i].Name,ModernImage:image,Menu:menuOnline};flyoutButtons.push(flyoutButton)}var controls={Id:onlinecontrolsPrefix,Items:flyoutButtons};return controls}else{var controlsPrefix=menuId+"."+tempStr+docStr+"Templates.Controls";!isSystemTemplate&&buttons.push(button);for(var i=0;i<templates.length;i++){var button_1={ControlType:"Button",Id:controlsPrefix+"."+templates[i].Id,Command:commandId,Sequence:String(i*10+10),ToolTipDescription:templates[i].Name,Alt:templates[i].Name,LabelText:templates[i].Name,ModernImage:image};buttons.push(button_1)}var controls={Id:controlsPrefix,Items:buttons};return controls}};ExportUtilities.buildOnlineControlsFromTemplates=function(menuId,commandId,Onlinetemplates,template,isSystemTemplate,isOnline,documentType){for(var buttons=[],tempStr=isSystemTemplate?"":"Personal",docStr=documentType===1?"Excel":"Word",controlsPrefix=menuId+"."+tempStr+docStr+"Templates.Controls",i=0;i<Onlinetemplates.length;i++){var image=Onlinetemplates[i].Id==="OpenExcelOnline"?"ExportToExcel":"DocumentTemplates",button={ControlType:"Button",Id:controlsPrefix+"."+Onlinetemplates[i].Id+"."+template.Id,Command:commandId,Sequence:String(i*10+10),ToolTipDescription:Onlinetemplates[i].Name+" "+template.Name,Alt:Onlinetemplates[i].Name,LabelText:Onlinetemplates[i].Name+" "+template.Name,ModernImage:image};buttons.push(button)}var controls={Id:controlsPrefix+"."+template.Id,Items:buttons};return controls};ExportUtilities.buildMenuSection=function(menuId,isSystemTemplate,documentType,isCreate,sequenceNum,controls){var tempStr=isSystemTemplate?"":"Personal",docStr=documentType===2?"Word":"Excel",sectionStr=isCreate?"CreateTemplates":""+tempStr+docStr+"Templates",titleStr="";if(isCreate)if(documentType==1)titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_CreateExcelTemplate");else titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_CreateWordTemplate");else if(documentType==1)if(isSystemTemplate)titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_ExcelTemplates");else titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_PersonalExcelTemplates");else if(isSystemTemplate)titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_WordTemplates");else titleStr=Xrm.Utility.getResourceString("Main_system_library","Menu_Label_Group_PersonalWordTemplates");var section={Id:menuId+"."+sectionStr,Sequence:String(sequenceNum),DisplayMode:6,Title:titleStr,Item:controls};return section};ExportUtilities.buildOnlineMenuSection=function(menuId,template,isSystemTemplate,documentType,isCreate,sequenceNum,controls){var tempStr=isSystemTemplate?"":"Personal",docStr=documentType===2?"Word":"Excel",sectionStr=""+tempStr+docStr+"Templates."+template.Id,titleStr="",section={Id:menuId+"."+sectionStr,Sequence:String(sequenceNum),DisplayMode:6,Title:titleStr,Item:controls};return section};ExportUtilities.buildMenu=function(menuId,menuSections){var menu={Id:menuId,MenuSection:menuSections};return menu};ExportUtilities.generateExportFileName=function(prefix,documentType){var ext=documentType===2?".docx":".xlsx";if(typeof Xrm.Utility.getGlobalContext()!="undefined"&&Xrm.Utility.getGlobalContext()!=null&&typeof Xrm.Utility.getGlobalContext().userSettings!="undefined"&&Xrm.Utility.getGlobalContext().userSettings!=null&&prefix&&prefix.length!=0){var now=new Date,datePattern=Xrm.Utility.getGlobalContext().userSettings.dateFormattingInfo.ShortDatePattern,timePattern=Xrm.Utility.getGlobalContext().userSettings.dateFormattingInfo.LongTimePattern,dateSeparator=Xrm.Utility.getGlobalContext().userSettings.dateFormattingInfo.DateSeparator,timeSeparator=Xrm.Utility.getGlobalContext().userSettings.dateFormattingInfo.TimeSeparator,fileName=prefix+" "+now.format(datePattern)+" "+now.format(timePattern);fileName=fileName.split(dateSeparator).join("-").split(timeSeparator).join("-");return ""+fileName+ext}if(prefix&&prefix.length!=0)return ""+prefix+ext;return "Export"+ext};ExportUtilities.getXmlDOMFromString=function(xmlStr){if(window.ActiveXObject&&window.GetObject){var dom=new ActiveXObject("Microsoft.XMLDOM");dom.loadXML(xmlStr);return dom}if(window.DOMParser)return (new DOMParser).parseFromString(xmlStr,"text/xml");throw new Error("No XML parser available")};ExportUtilities.getXmlAsString=function(xmlDom){return typeof XMLSerializer!=="undefined"?(new window.XMLSerializer).serializeToString(xmlDom):xmlDom.xml};return ExportUtilities}();InternalUtilities.ExportUtilities=ExportUtilities})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var oDataVersion="v9.0/",oDataPath="/api/data/"+oDataVersion,formApiPath="/systemforms",headers=[["Prefer",'odata.include-annotations="*"']],fetchXml='<fetch mapping="logical" count="1"><entity name="{0}"><attribute name="{3}" /><filter type="or"><condition attribute="{3}" operator= "eq" value= "{1}" /><filter type="and" ><condition attribute="{2}" operator= "eq" value= "{1}" /><condition attribute="{3}" operator= "not-null" /></filter></filter></entity></fetch>',HierarchyUtilities=function(){function HierarchyUtilities(){}HierarchyUtilities.getEntityRecordUrl=function(entity,name,recordId){var currentEntity={entityType:entity,name:name,id:recordId},currentUrl=Xrm.Internal.getCurrentPageUrl(currentEntity);return currentUrl.replace("pagetype=entityrecord","pagetype=control&controlName=MscrmControls.HierarchyControl.HierarchyControl")};HierarchyUtilities.sendXHR=function(url){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);for(var i in headers)xhr.setRequestHeader(headers[i][0],headers[i][1]);xhr.onload=function(){var status=xhr.status;if(status==200)resolve(xhr.response);else reject(xhr.response)};xhr.onerror=function(){reject(xhr.response)};xhr.send()})};HierarchyUtilities.retrieveRelationshipForEntityMetadata=function(entitySetName,encodedFetchXml){var url=this.generateoDataUrlForDataFetch(entitySetName,encodedFetchXml);return this.sendXHR(url)};HierarchyUtilities.generateoDataUrlForDataFetch=function(entitySetName,encodedFetchXml){var hostUrl=Xrm.Utility.getGlobalContext().getClientUrl(),oDataUrl=hostUrl+oDataPath+entitySetName+"?fetchXml="+encodedFetchXml;return oDataUrl};HierarchyUtilities.checkifRecordHierarchyEnabled=function(entityLogicalName,Id,entitySetName,relationship){var result=false;try{return this.retrieveRelationshipForEntityMetadata(entitySetName,InternalUtilities.GenericUtilities.stringFormat(fetchXml,[entityLogicalName,Id,relationship.ReferencedAttribute,relationship.ReferencingAttribute])).then(function(relResponse){var parsedChildResponse=JSON.parse(relResponse);if(parsedChildResponse.value.length>0)result=true;return result})}catch(ex){return Promise.reject(result)}};return HierarchyUtilities}();InternalUtilities.HierarchyUtilities=HierarchyUtilities})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var XrmCore;(function(XrmCore){var InternalUtilities;(function(InternalUtilities){var LegacyUtilities=function(){function LegacyUtilities(){}LegacyUtilities.getIFrameForWebClient=function(isForm){var origin=document.origin;try{var currentWindow=window,parent_1=window.parent;while(currentWindow.document.origin===origin){try{if((isForm&&currentWindow.self._IsRefreshForm||!isForm&&!currentWindow.self._IsRefreshForm)&&currentWindow.Mscrm&&currentWindow.Mscrm.RibbonActions)return currentWindow}catch(e){}if(currentWindow===currentWindow.parent)break;currentWindow=currentWindow.parent}currentWindow=window;parent_1=window.parent;while(currentWindow!==parent_1&&parent_1.document.origin===origin){for(var ind=0;ind<parent_1.frames.length;ind++)try{var currentIframe=parent_1.frames[ind];if((isForm&&currentIframe.self._IsRefreshForm||!isForm&&!currentIframe.self._IsRefreshForm)&&currentIframe.Mscrm&&currentIframe.Mscrm.RibbonActions)return currentIframe}catch(e){}currentWindow=parent_1;parent_1=parent_1.parent}return window}catch(e){return window}};return LegacyUtilities}();InternalUtilities.LegacyUtilities=LegacyUtilities})(InternalUtilities=XrmCore.InternalUtilities||(XrmCore.InternalUtilities={}))})(XrmCore||(XrmCore={}));var Mscrm;(function(Mscrm){var ManageProcessActionDialogActions=function(){function ManageProcessActionDialogActions(){}ManageProcessActionDialogActions.onClickOk=function(eventContext){var formContext=eventContext.getFormContext();ManageProcessActionDialogActions.setLastButtonClicked(formContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);if(Xrm.Page.data.isValid())formContext.ui.close();else ManageProcessActionDialogActions.setLastButtonClicked(formContext,null)};ManageProcessActionDialogActions.onClickCancel=function(eventContext){var formContext=eventContext.getFormContext();ManageProcessActionDialogActions.setLastButtonClicked(formContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogCancelId);formContext.ui.close()};ManageProcessActionDialogActions.setLastButtonClicked=function(formContext,buttonId){var lastButtonClicked=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked);lastButtonClicked&&lastButtonClicked.setValue(buttonId)};return ManageProcessActionDialogActions}();Mscrm.ManageProcessActionDialogActions=ManageProcessActionDialogActions})(Mscrm||(Mscrm={}));var Mscrm;(function(Mscrm){var WorkflowWebResource=function(){function WorkflowWebResource(){}WorkflowWebResource.ShowAbandon=function(){if(Xrm.Page.data.process){var businessProcessFlowInstanceStatus=Xrm.Page.data.process.getStatus();if(businessProcessFlowInstanceStatus)return businessProcessFlowInstanceStatus==WorkflowWebResource.ActiveBusinessProcessFlowInstanceStatus}return false};WorkflowWebResource.ShowFinish=function(){if(Xrm.Page.data.process){var businessProcessFlowInstanceStatus=Xrm.Page.data.process.getStatus(),isBusinessProcessStatusActive=businessProcessFlowInstanceStatus&&businessProcessFlowInstanceStatus==WorkflowWebResource.ActiveBusinessProcessFlowInstanceStatus;if(isBusinessProcessStatusActive==true){var activePath=Xrm.Page.data.process.getActivePath(),activeStage=Xrm.Page.data.process.getActiveStage();if(activePath&&activeStage){var lastStageInPath=activePath.get(activePath.getLength()-1);return activeStage.getId()===lastStageInPath.getId()}}}return false};WorkflowWebResource.ShowReactivate=function(){if(Xrm.Page.data.process){var businessProcessFlowInstanceStatus=Xrm.Page.data.process.getStatus();if(businessProcessFlowInstanceStatus)return businessProcessFlowInstanceStatus!=WorkflowWebResource.ActiveBusinessProcessFlowInstanceStatus}return false};WorkflowWebResource.CanSwitchProcess=function(){return true};WorkflowWebResource.CanEditProcess=function(){return WorkflowWebResource.IsBusinessProcessPresent()};WorkflowWebResource.IsBusinessProcessPresent=function(){if(Xrm.Page.ui.process)return true;else return false};WorkflowWebResource.SwitchProcess=function(){if(Xrm.Internal.isUci()){var dialogParams={};dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityIdParameter]=Xrm.Page.data.entity.getId();dialogParams[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.EntityName]=Xrm.Page.data.entity.getEntityName();dialogParams["process_instance_name"]=Xrm.Page.data.process.getInstanceName();var dialogOptions={height:Math.min(500,.9*window.outerHeight),width:Math.min(600,.9*window.outerWidth),position:1};Xrm.Navigation.openDialog("SwitchProcess",dialogOptions,dialogParams).then(function(successParameter){if(successParameter&&successParameter.parameters)if(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId===successParameter.parameters[XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked])if(successParameter.parameters["process_instance_id"])Xrm.Page.data.process.setActiveProcessInstance(successParameter.parameters["process_instance_id"],function(){WorkflowWebResource.SwitchProcessCallBack(successParameter)});else successParameter.parameters["process_id"]&&Xrm.Page.data.process.setActiveProcess(successParameter.parameters["process_id"],function(){WorkflowWebResource.SwitchProcessCallBack(successParameter)})},null)}else Xrm.Page.data.process.switchProcess()};WorkflowWebResource.SwitchProcessCallBack=function(dialogParams){};WorkflowWebResource.AbandonProcess=function(){Xrm.Page.data.process.abandonProcess()};WorkflowWebResource.ReactivateProcess=function(){Xrm.Page.data.process.reactivateProcess()};WorkflowWebResource.SetActiveStage=function(){var selectedStage=Xrm.Page.data.process.getSelectedStage();selectedStage&&Xrm.Page.data.process.setActiveStage(selectedStage.getId())};WorkflowWebResource.FinishProcess=function(){Xrm.Page.data.process.completeProcess()};WorkflowWebResource.ActiveBusinessProcessFlowInstanceStatus="active";return WorkflowWebResource}();Mscrm.WorkflowWebResource=WorkflowWebResource})(Mscrm||(Mscrm={}));var Mscrm;(function(Mscrm){var ManageSwitchProcessDialogActions=function(){function ManageSwitchProcessDialogActions(){}ManageSwitchProcessDialogActions.onClickCancel=function(eventContext){var formContext=eventContext.getFormContext();ManageSwitchProcessDialogActions.setLastButtonClicked(formContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogCancelId);formContext.ui.close()};ManageSwitchProcessDialogActions.onClickOk=function(eventContext){var formContext=eventContext.getFormContext(),processInstanceIdAttribute=formContext.data.attributes.get("process_instance_id");if(processInstanceIdAttribute&&processInstanceIdAttribute.getValue()==="invalid"){Xrm.Navigation.openAlertDialog({text:XrmCore.InternalUtilities.GenericUtilities.getLocalResourceString("Grid_Action_Too_Many_Custom_Messages_Selected_Alert")});return}ManageSwitchProcessDialogActions.setLastButtonClicked(formContext,XrmCore.InternalUtilities.DialogUtilities.DialogConstants.DialogOkId);formContext.ui.close()};ManageSwitchProcessDialogActions.setLastButtonClicked=function(formContext,buttonId){var lastButtonClicked=formContext.data.attributes.get(XrmCore.InternalUtilities.DialogUtilities.DialogConstants.LastButtonClicked);lastButtonClicked&&lastButtonClicked.setValue(buttonId)};return ManageSwitchProcessDialogActions}();Mscrm.ManageSwitchProcessDialogActions=ManageSwitchProcessDialogActions})(Mscrm||(Mscrm={}))</script><script type="text/javascript">var Yammer;
(function (Yammer) {
    var Util;
    (function (Util) {
        var TelemetryConstants;
        (function (TelemetryConstants) {
            TelemetryConstants.EventName = "YammerEventName";
            TelemetryConstants.StartTime = "StartTime";
            TelemetryConstants.EndTime = "EndTime";
            TelemetryConstants.ExecutionTime = "ExecutionTime";
            TelemetryConstants.EventErrorCount = "ErrorCount";
            TelemetryConstants.EventErrorMessage = "ErrorMessage";
        })(TelemetryConstants = Util.TelemetryConstants || (Util.TelemetryConstants = {}));
    })(Util = Yammer.Util || (Yammer.Util = {}));
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    var Util;
    (function (Util) {
        var TelemetryHelper = (function () {
            function TelemetryHelper() {
            }
            TelemetryHelper.createEvent = function (eventName) {
                var event = new Util.YammerEvent();
                var eventParameters = new Array();
                TelemetryHelper.addEventParameter(event, Util.TelemetryConstants.EventName, eventName);
                event.eventName = eventName;
                var startTime = new Date();
                TelemetryHelper.addEventParameter(event, Util.TelemetryConstants.StartTime, startTime);
                event.startTime = startTime;
                event.errorCount = 0;
                event.eventParameters = eventParameters;
                return event;
            };
            TelemetryHelper.addEventParameter = function (event, name, value) {
                try {
                    if (!Util.IsNull(event) && !Util.IsNull(event.eventName) && !Util.IsNull(event.eventParameters) && !Util.IsNull(name)) {
                        if (!Util.IsNull(value)) {
                            var item = {
                                name: name,
                                value: value
                            };
                            event.eventParameters.push(item);
                        }
                        else {
                            var item = {
                                name: name + "_Time",
                                value: new Date()
                            };
                            event.eventParameters.push(item);
                        }
                    }
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                }
            };
            TelemetryHelper.report = function (componentName, name, value) {
                if (Util.IsNull(componentName)) {
                    return false;
                }
                try {
                    var yammerEvent = TelemetryHelper.createEvent(componentName);
                    if (!Util.IsNull(name)) {
                        TelemetryHelper.addEventParameter(yammerEvent, name, value);
                    }
                    TelemetryHelper.reportEvent(yammerEvent);
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                }
            };
            TelemetryHelper.updateEventExecutionTime = function (event) {
                if (Util.IsNull(event)) {
                    return false;
                }
                var currentEventName = event.eventName;
                var start = event.startTime;
                var end = new Date();
                try {
                    if (Util.IsNull(currentEventName) || Util.IsNull(start) || Util.IsNull(event.eventParameters)) {
                        return false;
                    }
                    TelemetryHelper.addEventParameter(event, Util.TelemetryConstants.EndTime, end);
                    TelemetryHelper.addEventParameter(event, Util.TelemetryConstants.ExecutionTime, (end.valueOf() - start.valueOf()));
                    TelemetryHelper.addEventParameter(event, Util.TelemetryConstants.EventErrorCount, event.errorCount);
                    return true;
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                    return false;
                }
            };
            TelemetryHelper.reportErrorEvent = function (componentName, value) {
                if (Yammer.Util.IsNull(componentName)) {
                    return false;
                }
                try {
                    var yammerEvent = TelemetryHelper.createEvent(componentName);
                    if (!Yammer.Util.IsNull(value)) {
                        TelemetryHelper.addError(yammerEvent, value);
                    }
                    else {
                        TelemetryHelper.addError(yammerEvent, "An Error occured");
                    }
                    TelemetryHelper.reportEvent(yammerEvent);
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                }
            };
            TelemetryHelper.addError = function (event, value) {
                var errorCount = 0;
                try {
                    if (!Util.IsNull(event) && !Util.IsNull(event.eventParameters)) {
                        var errorCount_1 = event.errorCount;
                        event.errorCount = errorCount_1 + 1;
                        TelemetryHelper.addEventParameter(event, Util.TelemetryConstants.EventErrorMessage + (errorCount_1 + 1), value);
                    }
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                }
            };
            TelemetryHelper.isErrorEvent = function (event) {
                try {
                    if (!Util.IsNull(event) && !Util.IsNull(event.errorCount)) {
                        return event.errorCount > 0;
                    }
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                }
                return false;
            };
            TelemetryHelper.reportEvent = function (event) {
                if (Util.IsNull(event) && Util.IsNull(event.eventParameters)) {
                    return;
                }
                try {
                    if (Xrm && Xrm.Reporting) {
                        TelemetryHelper.updateEventExecutionTime(event);
                        if (!TelemetryHelper.isErrorEvent(event)) {
                            Xrm.Reporting.reportSuccess(event.eventName, event.eventParameters);
                        }
                        else {
                            Xrm.Reporting.reportFailure(event.eventName, Error(event.eventName), "Check the stacktrace", event.eventParameters);
                        }
                    }
                }
                catch (Exception) {
                    console.assert(false, Exception.message);
                }
            };
            return TelemetryHelper;
        }());
        Util.TelemetryHelper = TelemetryHelper;
    })(Util = Yammer.Util || (Yammer.Util = {}));
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    var Util;
    (function (Util) {
        function IsNull(value) {
            return typeof (value) === 'undefined' || typeof (value) === 'unknown' || value === null;
        }
        Util.IsNull = IsNull;
    })(Util = Yammer.Util || (Yammer.Util = {}));
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    var Util;
    (function (Util) {
        var YammerEvent = (function () {
            function YammerEvent() {
            }
            return YammerEvent;
        }());
        Util.YammerEvent = YammerEvent;
    })(Util = Yammer.Util || (Yammer.Util = {}));
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    'use strict';
    var Dialog = (function () {
        function Dialog() {
        }
        Dialog.onLoad = function (eventContext) {
            var formContext = eventContext.getFormContext();
            var processingMessage = Xrm.Utility.getResourceString(Yammer.Constants.CommonWebResource, Yammer.Constants.Resx_Processing);
            Xrm.Utility.showProgressIndicator(processingMessage);
            var feedType = Dialog.getFeedType(formContext);
            var promises = Dialog.createPromises(formContext, feedType);
            Promise.all(promises).then(function (values) {
                Xrm.Utility.closeProgressIndicator();
                Dialog.refreshControl(formContext, values, feedType);
            }, function (fail) {
                Xrm.Utility.closeProgressIndicator();
                Yammer.Util.TelemetryHelper.reportErrorEvent(Dialog.EventShowYammerCommand, "Error while retrieve User Information and follow check for Entity : " + fail);
                formContext.data.attributes.get(Yammer.Constants.Param_ErrorCode).setValue(Yammer.Constants.Resx_GenericErrorCode);
            });
        };
        Dialog.refreshControl = function (formContext, values, feedType) {
            var systemUser = values[0];
            formContext.data.attributes.get(Yammer.Constants.Param_DomainName).setValue(Dialog.getEmailAddresses(systemUser));
            formContext.data.attributes.get(Yammer.Constants.Param_YammerUserId).setValue("" + systemUser[Yammer.Constants.SystemUser_YammerUserId]);
            formContext.data.attributes.get(Yammer.Constants.Param_YammerEmailAddress).setValue(systemUser[Yammer.Constants.SystemUser_YammerEmailAddress]);
            if (Dialog.isOpenGraphFeed(feedType) && Dialog.isYammerInPrivateMode(formContext)) {
                var postFollowed = 0;
                var yammerPostState = 0;
                var postFollowSet = values[1];
                if (!Yammer.Util.IsNull(postFollowSet) && !Yammer.Util.IsNull(postFollowSet.entities) && postFollowSet.entities.length > 0) {
                    postFollowed = 1;
                    yammerPostState = postFollowSet.entities[0][Yammer.Constants.PostFollow_YammerPostState];
                }
                formContext.data.attributes.get(Yammer.Constants.Param_PostFollowed).setValue("" + postFollowed);
                formContext.data.attributes.get(Yammer.Constants.Param_YammerPostState).setValue("" + yammerPostState);
            }
        };
        Dialog.isYammerInPrivateMode = function (formContext) {
            return Dialog.getYammerPostMethod(formContext) === Yammer.Constants.YammerPostMethod_Private;
        };
        Dialog.getYammerPostMethod = function (formContext) {
            if (!Yammer.Util.IsNull(formContext.data.attributes.get(Yammer.Constants.Param_YammerPostMethod))) {
                try {
                    return parseInt(formContext.data.attributes.get(Yammer.Constants.Param_YammerPostMethod).getValue());
                }
                catch (Exception) {
                }
            }
            return 0;
        };
        Dialog.getEmailAddresses = function (systemUser) {
            var domainNameJson = [];
            domainNameJson[0] = systemUser[Yammer.Constants.SystemUser_WindowsLiveId];
            domainNameJson[1] = systemUser[Yammer.Constants.SystemUser_InternalEmailAddress];
            domainNameJson[2] = systemUser[Yammer.Constants.SystemUser_PersonalEmailAddress];
            domainNameJson[3] = systemUser[Yammer.Constants.SystemUser_MobileAlertEmail];
            return JSON.stringify(domainNameJson);
        };
        Dialog.getFeedType = function (formContext) {
            var feedType = null;
            try {
                feedType = formContext.data.attributes.get(Yammer.Constants.Param_FeedType).getValue();
            }
            catch (Exception) {
                Yammer.Util.TelemetryHelper.reportErrorEvent(Dialog.EventShowYammerCommand, "Received exception while retrieving feed type value of Dialog param");
                formContext.data.attributes.get(Yammer.Constants.Param_ErrorCode).setValue(Yammer.Constants.Resx_GenericErrorCode);
            }
            if (Yammer.Util.IsNull(feedType)) {
                Yammer.Util.TelemetryHelper.report(Dialog.EventShowYammerCommand, "Feed Type Value is not set in the Dialog param");
                formContext.data.attributes.get(Yammer.Constants.Param_ErrorCode).setValue(Yammer.Constants.Resx_GenericErrorCode);
            }
            return feedType;
        };
        Dialog.createPromises = function (formContext, feedType) {
            var promises = [];
            var userId = Xrm.Utility.getGlobalContext().userSettings.userId;
            var systemUser = Xrm.WebApi.retrieveRecord(Yammer.Constants.Entity_SystemUser, userId, Yammer.Constants.Fetch_YammerSystemUserDetails);
            promises.push(systemUser);
            if (Dialog.isOpenGraphFeed(feedType)) {
                var regardingObjectId = Dialog.formatGuid(formContext.data.attributes.get(Yammer.Constants.Param_EntityId).getValue());
                var fetchXml = Dialog.getFetchPostFollowXml(regardingObjectId, userId);
                var postFollowSet = Xrm.WebApi.retrieveMultipleRecords(Yammer.Constants.Entity_PostFollow, fetchXml);
                promises.push(postFollowSet);
            }
            return promises;
        };
        Dialog.isOpenGraphFeed = function (feedType) {
            return feedType === Yammer.Constants.FeedType_OpenGraph;
        };
        Dialog.formatGuid = function (entityId) {
            if (entityId[0] === "{" && entityId[entityId.length - 1] === "}") {
                entityId = entityId.slice(1, -1);
            }
            else if (entityId[0] === "{") {
                entityId = entityId.slice(1);
            }
            else if (entityId[entityId.length - 1] === "}") {
                entityId = entityId.slice(0, -1);
            }
            return entityId;
        };
        Dialog.getFetchPostFollowXml = function (regardingObjectId, ownerId) {
            var fetchXml = "?$filter=" + Yammer.Constants.PostFollow_RegardingObjectId + " eq " + regardingObjectId + " and " + Yammer.Constants.PostFollow_OwnerId + " eq " + Dialog.formatGuid(ownerId);
            return fetchXml;
        };
        return Dialog;
    }());
    Dialog.EventShowYammerCommand = "Yammer.Commands.showYammer";
    Yammer.Dialog = Dialog;
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    'use strict';
    var Commands = (function () {
        function Commands() {
        }
        Commands.yammer = function (formContext) {
            var globalContext = Xrm.Utility.getGlobalContext();
            var userId = globalContext.userSettings.userId;
            var orgId = globalContext.organizationSettings.organizationId;
            var currentEntity = formContext.data.entity;
            Xrm.WebApi.retrieveRecord(Yammer.Constants.Entity_Organization, orgId, Yammer.Constants.Fetch_YammerOrgDetails).then(function (org) {
                Commands.openYammerDialog(formContext, Yammer.Constants.FeedType_OpenGraph, org[Yammer.Constants.Organization_YammerNetworkPermalink], org[Yammer.Constants.Organization_YammerGroupid], org[Yammer.Constants.Organization_YammerPostMethod]);
            }, function (fail) {
                Yammer.Commands.openYammerAlertDialog(Yammer.Constants.Resx_GenericErrorCode);
            });
        };
        Commands.openYammerDialog = function (formContext, feedType, yammerNetwork, yammerGroupId, yammerPostMethod) {
            var dialogOptions = {
                height: 2000,
                width: 500,
                position: 2
            };
            var dialogParams = {
                param_feedType: feedType,
                param_yammerNetwork: yammerNetwork,
                param_yammerGroupId: yammerGroupId,
                param_entityId: formContext.data.entity.getId(),
                param_entityType: formContext.data.entity.getEntityName(),
                param_entityName: formContext.data.entity.getPrimaryAttributeValue(),
                param_yammerPostMethod: yammerPostMethod
            };
            Xrm.Navigation.openDialog(Yammer.Commands.YammerDialog, dialogOptions, dialogParams).then(function (success) { }, function (error) {
                Yammer.Util.TelemetryHelper.reportErrorEvent(Commands.EventShowYammerCommand, "Error while opening Yammer Dialog: " + error);
            });
        };
        Commands.openYammerAlertDialog = function (errorCode) {
            var dialogOptions = {
                height: 2000,
                width: 500,
                position: 2
            };
            var dialogParams = {
                param_errorCode: errorCode
            };
            Xrm.Navigation.openDialog(Yammer.Commands.YammerDialog, dialogOptions, dialogParams).then(function (success) { }, function (error) {
                Yammer.Util.TelemetryHelper.reportErrorEvent(Commands.EventShowYammerCommand, "Error while opening Dialog for Error: " + error);
            });
        };
        return Commands;
    }());
    Commands.EventShowYammerCommand = "Yammer.Commands.showYammer";
    Commands.YammerDialog = "YammerDialog";
    Yammer.Commands = Commands;
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    'use strict';
    var Constants;
    (function (Constants) {
        Constants.Entity_SystemUser = "systemuser";
        Constants.Entity_Organization = "organization";
        Constants.Entity_PostFollow = "postfollow";
        Constants.Entity_PostConfig = "msdyn_postconfig";
        Constants.SystemUser_SystemUserId = "systemuserid";
        Constants.SystemUser_YammerEmailAddress = "yammeremailaddress";
        Constants.SystemUser_YammerUserId = "yammeruserid";
        Constants.SystemUser_WindowsLiveId = "windowsliveid";
        Constants.SystemUser_InternalEmailAddress = "internalemailaddress";
        Constants.SystemUser_PersonalEmailAddress = "personalemailaddress";
        Constants.SystemUser_MobileAlertEmail = "mobilealertemail";
        Constants.Organization_YammerNetworkPermalink = "yammernetworkpermalink";
        Constants.Organization_YammerGroupid = "yammergroupid";
        Constants.Organization_YammerOAuthAccessTokenExpired = "yammeroauthaccesstokenexpired";
        Constants.Organization_YammerPostMethod = "yammerpostmethod";
        Constants.Fetch_YammerOrgDetails = "?$select=" + Constants.Organization_YammerNetworkPermalink + "," + Constants.Organization_YammerGroupid + "," + Constants.Organization_YammerOAuthAccessTokenExpired + "," + Constants.Organization_YammerPostMethod;
        Constants.Fetch_YammerSystemUserDetails = "?$select=" + Constants.SystemUser_YammerUserId + "," + Constants.SystemUser_YammerEmailAddress + "," + Constants.SystemUser_SystemUserId + "," + Constants.SystemUser_WindowsLiveId + "," + Constants.SystemUser_InternalEmailAddress + "," + Constants.SystemUser_PersonalEmailAddress + "," + Constants.SystemUser_MobileAlertEmail;
        Constants.PostFollow_YammerPostState = "yammerpoststate";
        Constants.PostFollow_PostFollowId = "postfollowid";
        Constants.PostFollow_RegardingObjectId = "_regardingobjectid_value";
        Constants.PostFollow_OwnerId = "_ownerid_value";
        Constants.YammerPostMethod_Private = 1;
        Constants.YammerPostState_Followed = 1;
        Constants.Param_FeedType = "param_feedType";
        Constants.Param_YammerNetwork = "param_yammerNetwork";
        Constants.Param_YammerGroupId = "param_yammerGroupId";
        Constants.Param_YammerUserId = "param_yammerUserId";
        Constants.Param_YammerEmailAddress = "param_yammerEmailAddress";
        Constants.Param_DomainName = "param_domainName";
        Constants.Param_ErrorCode = "param_errorCode";
        Constants.Param_PostFollowed = "param_postFollowed";
        Constants.Param_YammerPostState = "param_yammerPostState";
        Constants.Param_EntityId = "param_entityId";
        Constants.Param_YammerPostMethod = "param_yammerPostMethod";
        Constants.FeedType_OpenGraph = "open-graph";
        Constants.FeedType_Group = "group";
        Constants.CommonWebResource = "msdyn_/Resources/YammerIntegration";
        Constants.Resx_GenericErrorCode = "YammerIntegration_Error_Text";
        Constants.Resx_UserLoginMismatch = "Error_Message_0x8004b016";
        Constants.Resx_Processing = "Msg_Progress_MOCA_Dialog";
        Constants.FCB_YammerPostsOnUCI = "YammerPostsOnUCI";
    })(Constants = Yammer.Constants || (Yammer.Constants = {}));
})(Yammer || (Yammer = {}));
var Yammer;
(function (Yammer) {
    'use strict';
    var Rules = (function () {
        function Rules() {
        }
        Rules.showYammer = function (formContext, entityLogicalName) {
            Yammer.Util.TelemetryHelper.report(Rules.EventShowYammerRule, "Rule showYammer execution started");
            if (!(Rules.YammerEnabledForOrg === null || Rules.YammerEnabledForOrg === undefined)) {
                return Rules.YammerEnabledForOrg;
            }
            else {
                if (Rules.isBrowser() && Rules.isCrmOnline() && Rules.isUCI() && Rules.isYammerPostsOnUCIEnabled() && Rules.isSystemUserEntity(entityLogicalName)) {
                    return Rules.isYammerConfigured().then(function (response) {
                        if (response) {
                            return Rules.isActivityWallEnabled(entityLogicalName).then(function (resp) {
                                if (resp) {
                                    Yammer.Util.TelemetryHelper.report(Rules.EventShowYammerRule, "Rule showYammer returns true");
                                    Rules.YammerEnabledForOrg = true;
                                    return true;
                                }
                                else {
                                    Yammer.Util.TelemetryHelper.report(Rules.EventShowYammerRule, "ActivityWall not enabled for the entity");
                                    Rules.YammerEnabledForOrg = false;
                                    return false;
                                }
                            });
                        }
                        else {
                            Yammer.Util.TelemetryHelper.report(Rules.EventShowYammerRule, "Yammer not enabled for the organization");
                            Rules.YammerEnabledForOrg = false;
                            return false;
                        }
                    });
                }
                else {
                    Yammer.Util.TelemetryHelper.report(Rules.EventShowYammerRule, "Rule showYammer returns false");
                    Rules.YammerEnabledForOrg = false;
                    return false;
                }
            }
        };
        Rules.isYammerPostsOnUCIEnabled = function () {
            var YammerPostsOnUCIEnabled = Xrm.Internal.isFeatureEnabled(Yammer.Constants.FCB_YammerPostsOnUCI);
            return YammerPostsOnUCIEnabled;
        };
        Rules.isCrmOnline = function () {
            var isCrmOnPremises = Xrm.Utility.getGlobalContext().isOnPremises();
            return !isCrmOnPremises;
        };
        Rules.isUCI = function () {
            return Xrm.Internal.isUci();
        };
        Rules.isBrowser = function () {
            var formFactor = Xrm.Utility.getGlobalContext().client.getFormFactor();
            return (formFactor === 1);
        };
        Rules.isSystemUserEntity = function (entityLogicalName) {
            if ((entityLogicalName === Yammer.Constants.Entity_SystemUser) || (entityLogicalName === Yammer.Constants.Entity_PostConfig)) {
                return false;
            }
            else {
                return true;
            }
        };
        Rules.isActivityWallEnabled = function (entityLogicalName) {
            var fetchXml = "<fetch mapping='logical'> <entity name='msdyn_postconfig'> <attribute name='msdyn_configurewall' /> <attribute name='msdyn_entityname' /> <filter type='and'> <condition attribute='msdyn_entityname' operator='eq' value='" + entityLogicalName + "' /> </filter> </entity> </fetch>";
            var isActivityWallEnabled = Xrm.WebApi.retrieveMultipleRecords("msdyn_postconfig", "?fetchXml=" + fetchXml).then(function (response) {
                if (response.entities[0]["msdyn_configurewall"] === true) {
                    return true;
                }
                else {
                    return false;
                }
            }, function (error) {
                Yammer.Util.TelemetryHelper.reportErrorEvent(Rules.EventShowYammerRule, "Received Network error while checking for ActivityWall enabled for the entity");
                return false;
            });
            return isActivityWallEnabled;
        };
        Rules.isYammerConfigured = function () {
            var orgId = Xrm.Utility.getGlobalContext().organizationSettings.organizationId;
            var isYammerConfigured = Xrm.WebApi.retrieveRecord(Yammer.Constants.Entity_Organization, orgId, Yammer.Constants.Fetch_YammerOrgDetails).then(function (response) {
                if (response[Yammer.Constants.Organization_YammerNetworkPermalink] === null || response[Yammer.Constants.Organization_YammerNetworkPermalink] === undefined) {
                    return false;
                }
                else if (response[Yammer.Constants.Organization_YammerGroupid] === null || response[Yammer.Constants.Organization_YammerGroupid] === undefined) {
                    return false;
                }
                else if (response[Yammer.Constants.Organization_YammerOAuthAccessTokenExpired] !== false) {
                    return false;
                }
                else {
                    return true;
                }
            }, function (error) {
                Yammer.Util.TelemetryHelper.reportErrorEvent(Rules.EventShowYammerRule, "Received Network error while checking for Yammer enabled for the organization");
                return false;
            });
            return isYammerConfigured;
        };
        return Rules;
    }());
    Rules.EventShowYammerRule = "Yammer.Rules.showYammer";
    Yammer.Rules = Rules;
})(Yammer || (Yammer = {}));
//# sourceMappingURL=Yammer.js.map</script></head>
<body>


</body></html>
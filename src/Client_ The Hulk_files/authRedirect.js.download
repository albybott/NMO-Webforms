(function () {
    var inOwnWindow = window.parent === window.self;

    if (inOwnWindow) {
        // If this is being loaded in it's own window, that means the user wasn't
        // logged in. Since it got to this page, we can now be sure the user has
        // logged into Azure. Now we just to set the authCompleted cookie so that
        // the tile page can reload and perform a silent auth in a hidden iframe.
        var cookieDate = new Date;
        cookieDate.setFullYear(cookieDate.getFullYear() + 2);
        document.cookie = "authCompleted=true;path=/;expires=" + cookieDate.toGMTString();        

        if (location.pathname
            && location.pathname.toLowerCase().indexOf("authredirectoutlook.html") !== -1) {
            // navigate back to CRM page after sign in.
            window.top.history.back();
        } else {
            window.close();
        }

        return;
    } else {
        var context = new AuthenticationContext(window.parent.AuthenticationContext().config);;
        if (context._deserialize(context._getHash(window.location.hash)).id_token) {
            // If state doesn't match what's stored in session storage, then there
            // are multiple integrations site iframes on this page, and each one is
            // requesting id_tokens. Each id_token request overwrites the previous
            // ones state guid in session storage. So only the last request can really
            // succeed. So in the case where state id doesn't match, just have this
            // iframe wait until that last id_token request succeeds.
            if (context._deserialize(context._getHash(window.location.hash)).state
                    !== context._getItem(context.CONSTANTS.STORAGE.STATE_LOGIN)) {
                // tell parent to wait for another iframe to complete login
                window.parent.adalWaitForSilentLoginCallback();
                return;
            }
        }
        context.handleWindowCallback();
        if (window.parent.adalLoginCallback) {
            window.parent.adalLoginCallback();
        }
    }
})();